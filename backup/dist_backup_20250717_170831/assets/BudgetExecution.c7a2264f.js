import{_ as j,d as G,r as F,c as X,B as x,o as R,b as i,e as t,y as B,A as C,F as k,g as I,t as a,k as L,h as z,G as J,v as g,f as U}from"./index.9dc00bb4.js";import{_ as Y,l as H,M as _,r as K}from"./FormAttachmentAndRemarks.c9862839.js";const Q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},ee={class:"overflow-x-auto my-6"},re={class:"w-full border-collapse border border-gray-300"},ue=["rowspan"],te={class:"border border-gray-300 px-4 py-2"},oe={class:"border border-gray-300 px-4 py-2"},ne={class:"w-full px-2 py-1"},se={class:"border border-gray-300 px-4 py-2"},ae=["onUpdate:modelValue","onInput"],le={class:"border border-gray-300 px-4 py-2"},ce={class:"font-medium"},de={class:"border border-gray-300 px-4 py-2"},pe=["rowspan"],ie={class:"border border-gray-300 px-4 py-2"},ge={class:"border border-gray-300 px-4 py-2"},ye={class:"w-full px-2 py-1"},he={class:"border border-gray-300 px-4 py-2"},me=["onUpdate:modelValue","onInput"],be={class:"border border-gray-300 px-4 py-2"},Fe={class:"font-medium"},_e={class:"border border-gray-300 px-4 py-2"},De=["rowspan"],ve={class:"border border-gray-300 px-4 py-2"},Ee={class:"border border-gray-300 px-4 py-2"},fe={class:"w-full px-2 py-1"},xe={class:"border border-gray-300 px-4 py-2"},Be=["onUpdate:modelValue","onInput"],Ce={class:"border border-gray-300 px-4 py-2"},Te={class:"font-medium"},Ae={class:"border border-gray-300 px-4 py-2"},Me={class:"bg-gray-50 font-bold"},we={class:"border border-gray-300 px-4 py-2"},ke={class:"border border-gray-300 px-4 py-2"},Ie={class:"border border-gray-300 px-4 py-2"},Ue={class:"border border-gray-300 px-4 py-2"},Se=G({__name:"BudgetExecution",setup(qe){var P;const T=J(),c=F(((P=T.query.period)==null?void 0:P.toString())||new Date().toISOString().slice(0,7)),m=F(""),b=F(""),D=()=>({equipment:[{customer:"\u4E0A\u6D77",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u56FD\u7F51",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u6C5F\u82CF",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u8F93\u914D\u7535\u5185\u914D",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u897F\u95E8\u5B50",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u540C\u4E1A",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u7528\u6237",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u5176\u5B83",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0}],components:[{customer:"\u7528\u6237",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0}],engineering:[{customer:"\u4E00\u5305",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u4E8C\u5305",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u57DF\u5185\u5408\u4F5C",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u57DF\u5916\u5408\u4F5C",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0},{customer:"\u5176\u5B83",yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0}]}),N=(e,r)=>{if(!r)return e;const u=(n,s=[])=>n.map(d=>{const p=s.find(h=>h.customer===d.customer);return p?{...d,...p}:d});return{equipment:u(e.equipment,r.equipment),components:u(e.components,r.components),engineering:u(e.engineering,r.engineering)}},o=F(D()),S=F([]),q=async e=>{try{const r=[],u=e.substring(0,4),n=parseInt(e.substring(5,7));for(let s=1;s<n;s++){const d=`${u}-${s.toString().padStart(2,"0")}`;try{const p=await fetch(`http://47.111.95.19:3000/budget-execution/${d}`);if(p.ok){const h=await p.json();h.data&&r.push({period:d,data:h.data})}}catch(p){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${d}:`,p)}}S.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(r){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",r)}},A=(e,r)=>{let u=0;for(const d of S.value){const p=d.data[e];if(p){const h=p.find(O=>O.customer===r);h&&h.currentMonth&&(u+=parseFloat(h.currentMonth.toString())||0)}}let n=[];e==="equipment"?n=o.value.equipment:e==="components"?n=o.value.components:e==="engineering"&&(n=o.value.engineering);const s=n.find(d=>d.customer===r);return s&&s.currentMonth&&(u+=parseFloat(s.currentMonth.toString())||0),u},M=()=>{o.value.equipment.forEach(e=>{const r=A("equipment",e.customer);e.currentTotal=r}),o.value.components.forEach(e=>{const r=A("components",e.customer);e.currentTotal=r}),o.value.engineering.forEach(e=>{const r=A("engineering",e.customer);e.currentTotal=r})},l=e=>{e.yearlyPlan>0?e.progress=parseFloat((e.currentTotal/e.yearlyPlan*100).toFixed(2)):e.progress=0},v=e=>isNaN(e)||e===null||e===void 0?"0.00%":e.toFixed(2)+"%",y=e=>isNaN(e)||e===null||e===void 0?"0.00":e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),E=X(()=>{const e={yearlyPlan:0,currentMonth:0,currentTotal:0,progress:0};return[...o.value.equipment,...o.value.components,...o.value.engineering].forEach(u=>{e.yearlyPlan+=u.yearlyPlan||0,e.currentMonth+=u.currentMonth||0,e.currentTotal+=u.currentTotal||0}),e.progress=e.yearlyPlan>0?e.currentTotal/e.yearlyPlan*100:0,e.progress=parseFloat(e.progress.toFixed(2)),e}),f=async e=>{console.log(`\u6B63\u5728\u52A0\u8F7D\u9884\u7B97\u6267\u884C\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);try{const r=await fetch(`http://47.111.95.19:3000/budget-execution/${e}`);if(!r.ok){if(r.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),o.value=D(),await q(e),M(),o.value.equipment.forEach(n=>l(n)),o.value.components.forEach(n=>l(n)),o.value.engineering.forEach(n=>l(n));return}const u=await r.json();if(console.log("\u52A0\u8F7D\u5230\u7684\u6570\u636E:",u),u.data){const n=N(D(),u.data);o.value=n,console.log("\u6570\u636E\u5408\u5E76\u5B8C\u6210:",o.value)}await q(e),M(),o.value.equipment.forEach(n=>l(n)),o.value.components.forEach(n=>l(n)),o.value.engineering.forEach(n=>l(n))}catch(r){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",r)}},w=async e=>{try{const r=await H(_.BUDGET_EXECUTION,e);m.value=r.remarks,b.value=r.suggestions}catch(r){console.error("\u52A0\u8F7D\u5907\u6CE8\u4FE1\u606F\u5931\u8D25:",r)}};x(c,e=>{e&&(f(e),w(e))}),x(()=>o.value,()=>{M(),o.value.equipment.forEach(e=>l(e)),o.value.components.forEach(e=>l(e)),o.value.engineering.forEach(e=>l(e))},{deep:!0}),x(()=>T.query.period,e=>{e&&(c.value=e.toString(),f(e.toString()))}),x(c,(e,r)=>{e&&e!==r&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${r} -> ${e}`),f(e),w())});const $=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u9884\u7B97\u6267\u884C\u6570\u636E ==="),console.log("\u671F\u95F4:",c.value),console.log("\u6A21\u5757ID:",_.BUDGET_EXECUTION),console.log("\u8868\u5355\u6570\u636E:",o.value),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const e=await fetch("http://47.111.95.19:3000/budget-execution",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:o.value})});if(!e.ok){const n=await e.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",n),new Error("\u4FDD\u5B58\u5931\u8D25")}const r=await e.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",r),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001..."),console.log("\u8C03\u7528\u53C2\u6570:",{moduleId:_.BUDGET_EXECUTION,period:c.value,formData:o.value,remarks:m.value,suggestions:b.value});const u=await K(_.BUDGET_EXECUTION,c.value,o.value,m.value,b.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",u),u?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(e){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},V=()=>{o.value=D()};return R(()=>{var r;const e=((r=T.query.period)==null?void 0:r.toString())||c.value;f(e),w(e)}),(e,r)=>(g(),i("div",Q,[t("div",W,[r[3]||(r[3]=t("h1",{class:"text-2xl font-bold"},"\u9884\u7B97\u6267\u884C\u60C5\u51B5",-1)),t("div",Z,[B(t("input",{"onUpdate:modelValue":r[0]||(r[0]=u=>c.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,c.value]])])]),t("div",ee,[t("table",re,[r[5]||(r[5]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u503C"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u503C"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),t("tbody",null,[(g(!0),i(k,null,I(o.value.equipment,(u,n)=>(g(),i("tr",{key:`equipment-${n}`},[n===0?(g(),i("td",{key:0,rowspan:o.value.equipment.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u8BBE\u5907 ",8,ue)):U("",!0),t("td",te,a(u.customer),1),t("td",oe,[t("span",ne,a(y(u.yearlyPlan)),1)]),t("td",se,[B(t("input",{"onUpdate:modelValue":s=>u.currentMonth=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(u)},null,40,ae),[[C,u.currentMonth,void 0,{number:!0}]])]),t("td",le,[t("span",ce,a(y(u.currentTotal)),1)]),t("td",de,a(v(u.progress)),1)]))),128)),(g(!0),i(k,null,I(o.value.components,(u,n)=>(g(),i("tr",{key:`components-${n}`},[n===0?(g(),i("td",{key:0,rowspan:o.value.components.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5143\u4EF6 ",8,pe)):U("",!0),t("td",ie,a(u.customer),1),t("td",ge,[t("span",ye,a(y(u.yearlyPlan)),1)]),t("td",he,[B(t("input",{"onUpdate:modelValue":s=>u.currentMonth=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(u)},null,40,me),[[C,u.currentMonth,void 0,{number:!0}]])]),t("td",be,[t("span",Fe,a(y(u.currentTotal)),1)]),t("td",_e,a(v(u.progress)),1)]))),128)),(g(!0),i(k,null,I(o.value.engineering,(u,n)=>(g(),i("tr",{key:`engineering-${n}`},[n===0?(g(),i("td",{key:0,rowspan:o.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,De)):U("",!0),t("td",ve,a(u.customer),1),t("td",Ee,[t("span",fe,a(y(u.yearlyPlan)),1)]),t("td",xe,[B(t("input",{"onUpdate:modelValue":s=>u.currentMonth=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(u)},null,40,Be),[[C,u.currentMonth,void 0,{number:!0}]])]),t("td",Ce,[t("span",Te,a(y(u.currentTotal)),1)]),t("td",Ae,a(v(u.progress)),1)]))),128)),t("tr",Me,[r[4]||(r[4]=t("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),t("td",we,a(y(E.value.yearlyPlan)),1),t("td",ke,a(y(E.value.currentMonth)),1),t("td",Ie,a(y(E.value.currentTotal)),1),t("td",Ue,a(v(E.value.progress)),1)])])])]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:$,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:V,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),L(Y,{"module-id":z(_).BUDGET_EXECUTION,period:c.value,remarks:m.value,"onUpdate:remarks":r[1]||(r[1]=u=>m.value=u),suggestions:b.value,"onUpdate:suggestions":r[2]||(r[2]=u=>b.value=u)},null,8,["module-id","period","remarks","suggestions"])]))}});var $e=j(Se,[["__scopeId","data-v-2543acf0"]]);export{$e as default};
