import{_ as I,d as J,r as b,B as w,c as L,o as M,b as x,e as r,y as _,A as C,F as T,g as q,t as n,k as H,h as Y,G,v as N,f as z}from"./index.e04f120e.js";import{_ as K,M as S,r as Q}from"./FormAttachmentAndRemarks.7ca62f94.js";const W={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},X={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},ee={class:"overflow-x-auto my-6"},te={class:"w-full border-collapse border border-gray-300"},re=["rowspan"],oe={class:"border border-gray-300 px-4 py-2"},ue={class:"border border-gray-300 px-4 py-2 text-right"},ae={class:"border border-gray-300 px-4 py-2 text-right"},ne={class:"border border-gray-300 px-4 py-2"},ie=["onUpdate:modelValue"],se={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"text-sm font-medium"},ce={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"border border-gray-300 px-4 py-2 text-right"},ge={class:"border border-gray-300 px-4 py-2"},ye={class:"border border-gray-300 px-4 py-2 text-right"},Ae={class:"text-sm font-medium"},pe={class:"bg-gray-50 font-bold"},me={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"border border-gray-300 px-4 py-2 text-right"},Be={class:"border border-gray-300 px-4 py-2 text-right"},Ee={class:"border border-gray-300 px-4 py-2 text-right"},ve={class:"text-sm font-bold"},fe=J({__name:"OverdueReceivables",setup(we){var $;const P=G(),l=b((($=P.query.period)==null?void 0:$.toString())||new Date().toISOString().slice(0,7)),k={items:[{customerAttribute:"\u4E00\u5305\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u4E8C\u5305\u9879\u76EE",yearBeginningBalance:5.94,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearBeginningBalance:129.3,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearBeginningBalance:12.28,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u65B0\u80FD\u6E90\u9879\u76EE",yearBeginningBalance:1.42,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u82CF\u5DDE\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u62A2\u4FEE\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0},{customerAttribute:"\u8FD0\u68C0\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0}]},s=b(JSON.parse(JSON.stringify(k))),u=b({yearBeginningBalance:0,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0}),A=b(""),p=b(""),c=t=>t===0?"0.00":t.toFixed(2),h=t=>t===0?"0.00":t.toFixed(2),B=async t=>{try{const[e]=t.split("-"),o=parseInt(t.split("-")[1]);for(let i of s.value.items){let m=0;for(let y=1;y<=o;y++){const j=`${e}-${y.toString().padStart(2,"0")}`;try{const f=await fetch(`http://47.111.95.19:3000/nanhua-overdue-receivables/${j}`);if(f.ok){const O=(await f.json()).data.items.find(R=>R.customerAttribute===i.customerAttribute);O&&(m+=O.currentPeriodAccumulatedCollection||0)}}catch(f){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${j}\u7684\u6570\u636E:`,f)}}i.yearNewAddition=m;const d=i.yearBeginningBalance+i.yearNewAddition;i.collectionProgress=d>0?i.currentPeriodAccumulatedCollection/d*100:0}let a=0;for(let i=1;i<=o;i++){const m=`${e}-${i.toString().padStart(2,"0")}`;try{const d=await fetch(`http://47.111.95.19:3000/nanhua-overdue-receivables/${m}`);if(d.ok){const y=await d.json();y.data.selfBuiltProject&&(a+=y.data.selfBuiltProject.currentPeriodAccumulatedCollection||0)}}catch(d){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${m}\u7684\u81EA\u5EFA\u9879\u76EE\u6570\u636E:`,d)}}u.value.yearNewAddition=a;const v=u.value.yearBeginningBalance+u.value.yearNewAddition;u.value.collectionProgress=v>0?u.value.currentPeriodAccumulatedCollection/v*100:0}catch(e){console.error("\u8BA1\u7B97\u672C\u5E74\u65B0\u589E\u5931\u8D25:",e)}};w(()=>s.value.items,t=>{t.forEach(e=>{const o=e.yearBeginningBalance+e.yearNewAddition;e.collectionProgress=o>0?e.currentPeriodAccumulatedCollection/o*100:0})},{deep:!0}),w(()=>u.value,t=>{const e=t.yearBeginningBalance+t.yearNewAddition;t.collectionProgress=e>0?t.currentPeriodAccumulatedCollection/e*100:0},{deep:!0});const E=L(()=>{const t={yearBeginningBalance:0,yearNewAddition:0,currentPeriodAccumulatedCollection:0,collectionProgress:0};s.value.items.forEach(o=>{t.yearBeginningBalance+=o.yearBeginningBalance||0,t.yearNewAddition+=o.yearNewAddition||0,t.currentPeriodAccumulatedCollection+=o.currentPeriodAccumulatedCollection||0}),t.yearBeginningBalance+=u.value.yearBeginningBalance||0,t.yearNewAddition+=u.value.yearNewAddition||0,t.currentPeriodAccumulatedCollection+=u.value.currentPeriodAccumulatedCollection||0;const e=t.yearBeginningBalance+t.yearNewAddition;return t.collectionProgress=e>0?t.currentPeriodAccumulatedCollection/e*100:0,t}),D=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/nanhua-overdue-receivables/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),g();return}const o=await e.json();o.data&&(o.data.items&&(s.value.items=o.data.items.map(a=>({customerAttribute:a.customerAttribute,yearBeginningBalance:Number(a.yearBeginningBalance)||0,currentPeriodNewAddition:Number(a.currentPeriodNewAddition)||0,currentPeriodAccumulatedCollection:Number(a.currentPeriodAccumulatedCollection)||0,yearNewAddition:Number(a.yearNewAddition)||0,collectionProgress:Number(a.collectionProgress)||0}))),o.data.selfBuiltProject&&(u.value={yearBeginningBalance:Number(o.data.selfBuiltProject.yearBeginningBalance)||0,currentPeriodNewAddition:Number(o.data.selfBuiltProject.currentPeriodNewAddition)||0,currentPeriodAccumulatedCollection:Number(o.data.selfBuiltProject.currentPeriodAccumulatedCollection)||0,yearNewAddition:Number(o.data.selfBuiltProject.yearNewAddition)||0,collectionProgress:Number(o.data.selfBuiltProject.collectionProgress)||0})),await B(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),g()}},g=()=>{s.value=JSON.parse(JSON.stringify(k)),u.value={yearBeginningBalance:0,currentPeriodNewAddition:0,currentPeriodAccumulatedCollection:0,yearNewAddition:0,collectionProgress:0}},F=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${S.NANHUA_OVERDUE_RECEIVABLES}/${t}`);if(e.ok){const o=await e.json();o.success&&o.data&&(A.value=o.data.remarks||"",p.value=o.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};w(()=>P.query.period,async t=>{t&&(l.value=t.toString(),g(),await D(t.toString()),await B(t.toString()),F(t.toString()))}),w(l,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),g(),await D(t),await B(t),F(t))});const U=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-overdue-receivables",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:l.value,data:{items:s.value.items,selfBuiltProject:u.value}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Q(S.NANHUA_OVERDUE_RECEIVABLES,l.value,{items:s.value.items,selfBuiltProject:u.value},A.value,p.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},V=()=>{g(),A.value="",p.value=""};return M(async()=>{var e;g();const t=((e=P.query.period)==null?void 0:e.toString())||l.value;await D(t),await B(t),F(t)}),(t,e)=>(N(),x("div",W,[r("div",X,[e[6]||(e[6]=r("h1",{class:"text-2xl font-bold"},"\u903E\u671F\u5E94\u6536\u8D26\u6B3E\u60C5\u51B5",-1)),r("div",Z,[e[4]||(e[4]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[5]||(e[5]=r("span",{class:"text-xs text-gray-500"},"\u672C\u5E74\u7D2F\u8BA1\u6536\u6B3E = \u7D2F\u8BA1\u4EE5\u524D\u6BCF\u4E2A\u6708\u7684\u5F53\u671F\u7D2F\u8BA1\u5DF2\u6536\u6B3E",-1)),_(r("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>l.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,l.value]])])]),r("div",ee,[r("table",te,[e[10]||(e[10]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u5E74\u7D2F\u8BA1\u6536\u6B3E"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u7D2F\u8BA1\u5DF2\u6536\u6B3E"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u6536\u6B3E\u8FDB\u5EA6")])],-1)),r("tbody",null,[(N(!0),x(T,null,q(s.value.items,(o,a)=>(N(),x("tr",{key:`item-${a}`},[a===0?(N(),x("td",{key:0,rowspan:s.value.items.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,re)):z("",!0),r("td",oe,n(o.customerAttribute),1),r("td",ue,n(c(o.yearBeginningBalance)),1),r("td",ae,n(c(o.yearNewAddition)),1),r("td",ne,[_(r("input",{"onUpdate:modelValue":v=>o.currentPeriodAccumulatedCollection=v,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ie),[[C,o.currentPeriodAccumulatedCollection]])]),r("td",se,[r("span",le,n(h(o.collectionProgress))+"%",1)])]))),128)),r("tr",null,[e[7]||(e[7]=r("td",{class:"border border-gray-300 px-4 py-2 font-medium text-center"},"\u81EA\u5EFA\u9879\u76EE",-1)),e[8]||(e[8]=r("td",{class:"border border-gray-300 px-4 py-2"},"\u81EA\u5EFA\u9879\u76EE",-1)),r("td",ce,n(c(u.value.yearBeginningBalance)),1),r("td",de,n(c(u.value.yearNewAddition)),1),r("td",ge,[_(r("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>u.value.currentPeriodAccumulatedCollection=o),type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,512),[[C,u.value.currentPeriodAccumulatedCollection]])]),r("td",ye,[r("span",Ae,n(h(u.value.collectionProgress))+"%",1)])]),r("tr",pe,[e[9]||(e[9]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",me,n(c(E.value.yearBeginningBalance)),1),r("td",be,n(c(E.value.yearNewAddition)),1),r("td",Be,n(c(E.value.currentPeriodAccumulatedCollection)),1),r("td",Ee,[r("span",ve,n(h(E.value.collectionProgress))+"%",1)])])])])]),H(K,{"module-id":Y(S).NANHUA_OVERDUE_RECEIVABLES,period:l.value,remarks:A.value,"onUpdate:remarks":e[2]||(e[2]=o=>A.value=o),suggestions:p.value,"onUpdate:suggestions":e[3]||(e[3]=o=>p.value=o)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:U,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:V,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var he=I(fe,[["__scopeId","data-v-76eda970"]]);export{he as default};
