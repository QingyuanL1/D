import{_ as V,d as T,r as F,c as O,B as m,o as j,b as _,e as a,y as E,A as x,F as R,g as q,t as l,k as L,h as G,G as J,v as A}from"./index.ddf2ed0e.js";import{_ as z,r as H,M as h,l as K}from"./FormAttachmentAndRemarks.1ffcb02e.js";const Q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Y={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},uu={class:"border border-gray-300 px-4 py-2 text-center"},eu={class:"border border-gray-300 px-4 py-2"},ru={class:"border border-gray-300 px-4 py-2"},au=["onUpdate:modelValue"],ou={class:"border border-gray-300 px-4 py-2"},tu=["onUpdate:modelValue"],su={class:"border border-gray-300 px-4 py-2"},nu={class:"font-medium"},lu={class:"border border-gray-300 px-4 py-2"},cu={class:"bg-gray-50 font-bold"},du={class:"border border-gray-300 px-4 py-2"},iu={class:"border border-gray-300 px-4 py-2"},yu={class:"border border-gray-300 px-4 py-2"},pu={class:"border border-gray-300 px-4 py-2"},gu=T({__name:"NonMainBusiness",setup(bu){var w;const f=J(),n=F(((w=f.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),d=F(""),i=F(""),v=()=>[{id:1,category:"\u56FA\u5B9A\u6536\u5165",yearlyPlan:100,currentPeriod:0,cumulative:0},{id:2,category:"\u623F\u5C4B\u79DF\u91D1",yearlyPlan:0,currentPeriod:0,cumulative:0},{id:3,category:"\u5229\u606F\u6536\u5165",yearlyPlan:0,currentPeriod:0,cumulative:0},{id:4,category:"\u6295\u8D44\u6536\u76CA",yearlyPlan:0,currentPeriod:0,cumulative:0},{id:5,category:"\u8865\u8D34\u6536\u5165",yearlyPlan:0,currentPeriod:0,cumulative:0},{id:6,category:"\u5176\u4ED6",yearlyPlan:0,currentPeriod:0,cumulative:0}],t=F(v()),N=u=>(u||0).toFixed(2),S=(u,e)=>u<=0?"0.00":(e/u*100).toFixed(2),y=O(()=>{const u={yearlyPlan:0,currentPeriod:0,cumulative:0,progress:0};return t.value.forEach(e=>{u.yearlyPlan+=e.yearlyPlan||0,u.currentPeriod+=e.currentPeriod||0,u.cumulative+=e.cumulative||0}),u.progress=u.yearlyPlan>0?u.cumulative/u.yearlyPlan*100:0,u}),k=(u,e)=>!Array.isArray(e)||e.length===0?u:u.map(r=>{const o=e.find(s=>s.id===r.id||s.category===r.category);return o?{id:r.id,category:r.category,yearlyPlan:r.category==="\u56FA\u5B9A\u6536\u5165"?100:Number(o.yearlyPlan)||0,currentPeriod:Number(o.currentPeriod)||Number(o.currentTotal)||0,cumulative:Number(o.cumulative)||0}:r}),D=async u=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u975E\u4E3B\u8425\u4E1A\u52A1\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const e=await fetch(`http://47.111.95.19:3000/non-main-business/${u}`);if(!e.ok){if(e.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u5E74\u5EA6\u8BA1\u5212\u4F46\u6E05\u7A7A\u5F53\u671F\u548C\u7D2F\u8BA1"),t.value=t.value.map(o=>({...o,yearlyPlan:o.category==="\u56FA\u5B9A\u6536\u5165"?100:o.yearlyPlan,currentPeriod:0,cumulative:0}));return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const r=await e.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data&&Array.isArray(r.data)){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."),t.value=k(v(),r.data);const o=t.value.find(s=>s.category==="\u56FA\u5B9A\u6536\u5165");o&&(o.yearlyPlan=100),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",t.value)}else await B(u)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e)}},c=new Map,B=async u=>{try{if(c.has(u)){const o=c.get(u);t.value=t.value.map(s=>({...s,cumulative:o.get(`${s.category}-${s.id}`)||0}));return}const[e]=u.split("-"),r=new Map;for(let o=1;o<=parseInt(u.split("-")[1]);o++){const s=`${e}-${o.toString().padStart(2,"0")}`;try{const p=await fetch(`http://47.111.95.19:3000/non-main-business/${s}`);if(p.ok){const g=await p.json();g.success&&g.data&&Array.isArray(g.data)&&g.data.forEach(b=>{const C=`${b.category}-${b.id}`,U=Number(b.currentPeriod||b.currentTotal||0);r.set(C,(r.get(C)||0)+U)})}}catch(p){console.log(`\u8DF3\u8FC7\u671F\u95F4 ${s} \u7684\u6570\u636E\u8BA1\u7B97:`,p)}}c.set(u,r),t.value=t.value.map(o=>({...o,cumulative:r.get(`${o.category}-${o.id}`)||0}))}catch(e){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",e)}};m(()=>f.query.period,u=>{u&&(n.value=u.toString(),D(u.toString()))}),m(n,(u,e)=>{u&&u!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${u}`),c.clear(),D(u),P())});const $=((u,e)=>{let r;return(...o)=>{clearTimeout(r),r=setTimeout(()=>u.apply(null,o),e)}})(async()=>{await B(n.value)},1e3);m(()=>t.value.map(u=>u.currentPeriod),()=>{$()},{deep:!0});const M=async()=>{try{const u={period:n.value,data:t.value};console.log("\u4FDD\u5B58\u6570\u636E:",u);const e=await fetch("http://47.111.95.19:3000/non-main-business",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!e.ok){const r=await e.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${e.status} - ${r}`)}await H(h.NON_MAIN_BUSINESS,n.value,t.value,d.value,i.value),c.clear(),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25: "+(u instanceof Error?u.message:"\u672A\u77E5\u9519\u8BEF"))}},I=()=>{t.value=v(),console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E\uFF0C\u56FA\u5B9A\u6536\u5165\u5E74\u5EA6\u8BA1\u5212\u4FDD\u6301\u4E3A100")},P=async()=>{const{remarks:u,suggestions:e}=await K(h.NON_MAIN_BUSINESS,n.value);d.value=u,i.value=e};return j(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",n.value),D(n.value),P()}),(u,e)=>(A(),_("div",Q,[a("div",W,[e[3]||(e[3]=a("h1",{class:"text-2xl font-bold"},"\u975E\u4E3B\u8425\u4E1A\u52A1\u60C5\u51B5\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),a("div",X,[E(a("input",{"onUpdate:modelValue":e[0]||(e[0]=r=>n.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[x,n.value]])])]),a("div",Y,[a("table",Z,[e[6]||(e[6]=a("thead",{class:"sticky top-0 bg-white"},[a("tr",{class:"bg-gray-50"},[a("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5E8F\u53F7"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u8D22\u52A1\u79D1\u76EE"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),a("tbody",null,[(A(!0),_(R,null,q(t.value,(r,o)=>(A(),_("tr",{key:o},[a("td",uu,l(r.id),1),a("td",eu,l(r.category),1),a("td",ru,[E(a("input",{"onUpdate:modelValue":s=>r.yearlyPlan=s,type:"number",class:"w-full px-2 py-1 border rounded bg-gray-100",step:"0.01",readonly:""},null,8,au),[[x,r.yearlyPlan,void 0,{number:!0}]])]),a("td",ou,[E(a("input",{"onUpdate:modelValue":s=>r.currentPeriod=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,tu),[[x,r.currentPeriod,void 0,{number:!0}]])]),a("td",su,[a("span",nu,l(N(r.cumulative)),1)]),a("td",lu,l(S(r.yearlyPlan,r.cumulative))+"% ",1)]))),128)),a("tr",cu,[e[4]||(e[4]=a("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),e[5]||(e[5]=a("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),a("td",du,l(y.value.yearlyPlan.toFixed(2)),1),a("td",iu,l(y.value.currentPeriod.toFixed(2)),1),a("td",yu,l(y.value.cumulative.toFixed(2)),1),a("td",pu,l(y.value.progress.toFixed(2))+"% ",1)])])])]),a("div",{class:"mt-4 flex justify-end space-x-4"},[a("button",{onClick:M,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),a("button",{onClick:I,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),L(z,{"module-id":G(h).NON_MAIN_BUSINESS,period:n.value,remarks:d.value,"onUpdate:remarks":e[1]||(e[1]=r=>d.value=r),suggestions:i.value,"onUpdate:suggestions":e[2]||(e[2]=r=>i.value=r)},null,8,["module-id","period","remarks","suggestions"])]))}});var mu=V(gu,[["__scopeId","data-v-0c164689"]]);export{mu as default};
