import{_ as W,d as X,r as v,h as Z,B as q,o as P,c as y,a as o,y as b,A as g,F as U,l as R,t as a,b as uu,m as eu,G as tu,f as A,k as $}from"./index.ef1fdd93.js";import{_ as ou,l as ru,M as j,r as nu}from"./FormAttachmentAndRemarks.b85f4df7.js";const su={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},au={class:"flex justify-between items-center mb-6"},cu={class:"flex items-center space-x-4"},lu={class:"overflow-x-auto my-6"},iu={class:"w-full border-collapse border border-gray-300"},pu=["rowspan"],mu={class:"border border-gray-300 px-4 py-2"},du={class:"border border-gray-300 px-4 py-2"},yu=["onUpdate:modelValue"],Au={class:"border border-gray-300 px-4 py-2"},vu=["onUpdate:modelValue"],Fu={class:"border border-gray-300 px-4 py-2 text-right"},bu={class:"font-medium"},gu={class:"border border-gray-300 px-4 py-2 text-right"},hu={class:"font-medium"},_u={class:"border border-gray-300 px-4 py-2 text-right"},Du=["rowspan"],fu={class:"border border-gray-300 px-4 py-2"},Eu={class:"border border-gray-300 px-4 py-2"},xu=["onUpdate:modelValue"],Cu={class:"border border-gray-300 px-4 py-2"},Bu=["onUpdate:modelValue"],Iu={class:"border border-gray-300 px-4 py-2 text-right"},Tu={class:"font-medium"},wu={class:"border border-gray-300 px-4 py-2 text-right"},qu={class:"font-medium"},ju={class:"border border-gray-300 px-4 py-2 text-right"},Nu=["rowspan"],ku={class:"border border-gray-300 px-4 py-2"},Su={class:"border border-gray-300 px-4 py-2"},Vu=["onUpdate:modelValue"],Uu={class:"border border-gray-300 px-4 py-2"},Ru=["onUpdate:modelValue"],$u={class:"border border-gray-300 px-4 py-2 text-right"},Mu={class:"font-medium"},Ou={class:"border border-gray-300 px-4 py-2 text-right"},Yu={class:"font-medium"},Lu={class:"border border-gray-300 px-4 py-2 text-right"},zu={class:"bg-gray-50 font-bold"},Gu={class:"border border-gray-300 px-4 py-2 text-right"},Ju={class:"border border-gray-300 px-4 py-2 text-right"},Hu={class:"border border-gray-300 px-4 py-2 text-right"},Ku={class:"border border-gray-300 px-4 py-2 text-right"},Qu={class:"border border-gray-300 px-4 py-2 text-right"},Wu=X({__name:"ContractInventory",setup(Xu){var L;const f=tu(),c=v(((L=f.query.period)==null?void 0:L.toString())||new Date().toISOString().slice(0,7)),s={equipment:{\u4E0A\u6D77:1200.5,\u56FD\u7F51:2300.75,\u6C5F\u82CF:800.25,\u8F93\u914D\u7535\u5185\u914D:150,\u897F\u95E8\u5B50:0,\u540C\u4E1A:950.6,\u7528\u6237:750.4,\u5176\u5B83:200.3},component:{\u7528\u6237:500.8},project:{\u4E00\u5305:300.2,\u4E8C\u5305:150.1,\u57DF\u5185\u5408\u4F5C:1100.9,\u57DF\u5916\u5408\u4F5C:650.75,\u5176\u5B83:400.5}},M=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialAmount:s.equipment.\u4E0A\u6D77,currentIncrease:0,cumulativeAmount:0},{customerType:"\u56FD\u7F51",initialAmount:s.equipment.\u56FD\u7F51,currentIncrease:0,cumulativeAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:s.equipment.\u6C5F\u82CF,currentIncrease:0,cumulativeAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:s.equipment.\u8F93\u914D\u7535\u5185\u914D,currentIncrease:0,cumulativeAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:s.equipment.\u897F\u95E8\u5B50,currentIncrease:0,cumulativeAmount:0},{customerType:"\u540C\u4E1A",initialAmount:s.equipment.\u540C\u4E1A,currentIncrease:0,cumulativeAmount:0},{customerType:"\u7528\u6237",initialAmount:s.equipment.\u7528\u6237,currentIncrease:0,cumulativeAmount:0},{customerType:"\u5176\u5B83",initialAmount:s.equipment.\u5176\u5B83,currentIncrease:0,cumulativeAmount:0}],component:[{customerType:"\u7528\u6237",initialAmount:s.component.\u7528\u6237,currentIncrease:0,cumulativeAmount:0}],project:[{customerType:"\u4E00\u5305",initialAmount:s.project.\u4E00\u5305,currentIncrease:0,cumulativeAmount:0},{customerType:"\u4E8C\u5305",initialAmount:s.project.\u4E8C\u5305,currentIncrease:0,cumulativeAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:s.project.\u57DF\u5185\u5408\u4F5C,currentIncrease:0,cumulativeAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:s.project.\u57DF\u5916\u5408\u4F5C,currentIncrease:0,cumulativeAmount:0},{customerType:"\u5176\u5B83",initialAmount:s.project.\u5176\u5B83,currentIncrease:0,cumulativeAmount:0}]}),G=(u,e)=>(!e||typeof e!="object"||(e.equipment&&Array.isArray(e.equipment)&&(u.equipment=u.equipment.map(t=>{const n=e.equipment.find(r=>r.customerType===t.customerType);return n?{...t,initialAmount:t.initialAmount,currentIncrease:Number(n.currentIncrease)||0,cumulativeAmount:0}:t})),e.component&&Array.isArray(e.component)&&(u.component=u.component.map(t=>{const n=e.component.find(r=>r.customerType===t.customerType);return n?{...t,initialAmount:t.initialAmount,currentIncrease:Number(n.currentIncrease)||0,cumulativeAmount:0}:t})),e.project&&Array.isArray(e.project)&&(u.project=u.project.map(t=>{const n=e.project.find(r=>r.customerType===t.customerType);return n?{...t,initialAmount:t.initialAmount,currentIncrease:Number(n.currentIncrease)||0,cumulativeAmount:0}:t}))),u),N=()=>{const u=M();l.value=u.equipment,i.value=u.component,p.value=u.project},l=v([]),i=v([]),p=v([]),E=v(""),x=v(""),O=v([]),m=v(null),C=async u=>{try{const e=await fetch(`http://47.111.95.19:3000/main-business-income/${u}`);if(e.ok){const t=await e.json();t.success&&t.data&&(m.value=t.data,console.log("\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u6570\u636E:",m.value))}}catch(e){console.error("\u52A0\u8F7D\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u6570\u636E\u5931\u8D25:",e)}},k=(u,e)=>{if(!m.value)return 0;let t=[];u==="equipment"?t=m.value.equipment||[]:u==="component"?t=m.value.components||[]:u==="project"&&(t=m.value.engineering||[]);const n=t.find(r=>r.customer===e);return n&&n.currentMonthIncome||0},J=()=>{if(!m.value)return 0;let u=0;return[...m.value.equipment||[],...m.value.components||[],...m.value.engineering||[]].forEach(t=>{u+=t.currentMonthIncome||0}),u},Y=async u=>{try{const e=[],t=u.substring(0,4),n=parseInt(u.substring(5,7));for(let r=1;r<n;r++){const _=`${t}-${r.toString().padStart(2,"0")}`;try{const F=await fetch(`http://47.111.95.19:3000/contract-inventory/${_}`);if(F.ok){const D=await F.json();D.success&&D.data&&e.push({period:_,data:D.data})}}catch(F){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${_}:`,F)}}O.value=e,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",e)}catch(e){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",e)}},S=(u,e)=>{var F,D;let t=0;u==="equipment"&&s.equipment[e]!==void 0?t=s.equipment[e]:u==="component"&&s.component[e]!==void 0?t=s.component[e]:u==="project"&&s.project[e]!==void 0&&(t=s.project[e]);let n=0;for(const w of O.value)if(w.data[u]){const z=w.data[u].find(Q=>Q.customerType===e);z&&(n+=parseFloat((F=z.currentIncrease)==null?void 0:F.toString())||0)}let r=[];u==="equipment"?r=l.value:u==="component"?r=i.value:u==="project"&&(r=p.value);const _=r.find(w=>w.customerType===e);return _&&(n+=parseFloat((D=_.currentIncrease)==null?void 0:D.toString())||0),t+n},h=()=>{l.value.forEach(u=>{const e=S("equipment",u.customerType);u.cumulativeAmount=e}),i.value.forEach(u=>{const e=S("component",u.customerType);u.cumulativeAmount=e}),p.value.forEach(u=>{const e=S("project",u.customerType);u.cumulativeAmount=e})},T=(u,e)=>u===0?e===0?"0.00":"N/A":((e-u)/u*100).toFixed(2),d=u=>isNaN(u)||u===null||u===void 0?"0.00":u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),B=Z(()=>{const u={initialAmount:0,currentIncrease:0,cumulativeAmount:0};return l.value.forEach(e=>{u.initialAmount+=Number(e.initialAmount)||0,u.currentIncrease+=Number(e.currentIncrease)||0,u.cumulativeAmount+=Number(e.cumulativeAmount)||0}),i.value.forEach(e=>{u.initialAmount+=Number(e.initialAmount)||0,u.currentIncrease+=Number(e.currentIncrease)||0,u.cumulativeAmount+=Number(e.cumulativeAmount)||0}),p.value.forEach(e=>{u.initialAmount+=Number(e.initialAmount)||0,u.currentIncrease+=Number(e.currentIncrease)||0,u.cumulativeAmount+=Number(e.cumulativeAmount)||0}),u}),I=async u=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u5408\u540C\u5B58\u91CF\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const e=await fetch(`http://47.111.95.19:3000/contract-inventory/${u}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),N(),await Y(u),h();return}const t=await e.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",t),t.success&&t.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const n=M(),r=G(n,t.data);l.value=r.equipment,i.value=r.component,p.value=r.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:l.value,componentData:i.value,projectData:p.value})}await Y(u),h(),await C(u)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),N()}},V=async()=>{const{remarks:u,suggestions:e}=await ru(j.CONTRACT_INVENTORY,c.value);E.value=u,x.value=e};q(c,u=>{I(u),V(),C(u)}),q(()=>f.query.period,u=>{u&&(c.value=u.toString(),I(u.toString()),C(u.toString()))}),q(()=>[l.value.map(u=>u.currentPeriod),i.value.map(u=>u.currentPeriod),p.value.map(u=>u.currentPeriod)],()=>{h()},{deep:!0}),q(c,(u,e)=>{u&&u!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${u}`),I(u),V())});const H=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u5408\u540C\u5B58\u91CF\u6570\u636E ==="),console.log("\u671F\u95F4:",c.value),console.log("\u6A21\u5757ID:",j.CONTRACT_INVENTORY);const u={equipment:l.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentIncrease:r.currentIncrease||0,cumulativeAmount:r.cumulativeAmount})),component:i.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentIncrease:r.currentIncrease||0,cumulativeAmount:r.cumulativeAmount})),project:p.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentIncrease:r.currentIncrease||0,cumulativeAmount:r.cumulativeAmount}))};console.log("\u8868\u5355\u6570\u636E:",u),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const e=await fetch("http://47.111.95.19:3000/contract-inventory",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:u})});if(!e.ok){const r=await e.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",r),new Error("\u4FDD\u5B58\u5931\u8D25")}const t=await e.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",t),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const n=await nu(j.CONTRACT_INVENTORY,c.value,u,E.value,x.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",n),n?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(u){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",u),alert("\u4FDD\u5B58\u5931\u8D25: "+(u instanceof Error?u.message:"\u672A\u77E5\u9519\u8BEF"))}},K=()=>{N(),E.value="",x.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return P(()=>{console.log("\u5408\u540C\u5B58\u91CF\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",c.value),f.query.period?(I(f.query.period.toString()),C(f.query.period.toString())):(I(c.value),C(c.value)),V()}),(u,e)=>(A(),y("div",su,[o("div",au,[e[3]||(e[3]=o("h1",{class:"text-2xl font-bold"},"\u5E93\u5B58\u60C5\u51B5(\u5408\u540C\u5B58\u91CF)\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),o("div",cu,[b(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),type:"month",class:"px-3 py-2 border rounded"},null,512),[[g,c.value]])])]),o("div",lu,[o("table",iu,[e[5]||(e[5]=o("thead",{class:"sticky top-0 bg-white"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u91CF"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u65B0\u589E"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u6536\u5165"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u5E93\u5B58"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),o("tbody",null,[(A(!0),y(U,null,R(l.value,(t,n)=>(A(),y("tr",{key:`equipment-${n}`},[n===0?(A(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u8BBE\u5907 ",8,pu)):$("",!0),o("td",mu,a(t.customerType),1),o("td",du,[b(o("input",{"onUpdate:modelValue":r=>t.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,yu),[[g,t.initialAmount,void 0,{number:!0}]])]),o("td",Au,[b(o("input",{"onUpdate:modelValue":r=>t.currentIncrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:h},null,40,vu),[[g,t.currentIncrease,void 0,{number:!0}]])]),o("td",Fu,[o("span",bu,a(d(k("equipment",t.customerType))),1)]),o("td",gu,[o("span",hu,a(d(t.cumulativeAmount)),1)]),o("td",_u,a(T(t.initialAmount,t.cumulativeAmount))+"% ",1)]))),128)),(A(!0),y(U,null,R(i.value,(t,n)=>(A(),y("tr",{key:`component-${n}`},[n===0?(A(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u5143\u4EF6 ",8,Du)):$("",!0),o("td",fu,a(t.customerType),1),o("td",Eu,[b(o("input",{"onUpdate:modelValue":r=>t.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,xu),[[g,t.initialAmount,void 0,{number:!0}]])]),o("td",Cu,[b(o("input",{"onUpdate:modelValue":r=>t.currentIncrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:h},null,40,Bu),[[g,t.currentIncrease,void 0,{number:!0}]])]),o("td",Iu,[o("span",Tu,a(d(k("component",t.customerType))),1)]),o("td",wu,[o("span",qu,a(d(t.cumulativeAmount)),1)]),o("td",ju,a(T(t.initialAmount,t.cumulativeAmount))+"% ",1)]))),128)),(A(!0),y(U,null,R(p.value,(t,n)=>(A(),y("tr",{key:`project-${n}`},[n===0?(A(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5DE5\u7A0B ",8,Nu)):$("",!0),o("td",ku,a(t.customerType),1),o("td",Su,[b(o("input",{"onUpdate:modelValue":r=>t.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,Vu),[[g,t.initialAmount,void 0,{number:!0}]])]),o("td",Uu,[b(o("input",{"onUpdate:modelValue":r=>t.currentIncrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:h},null,40,Ru),[[g,t.currentIncrease,void 0,{number:!0}]])]),o("td",$u,[o("span",Mu,a(d(k("project",t.customerType))),1)]),o("td",Ou,[o("span",Yu,a(d(t.cumulativeAmount)),1)]),o("td",Lu,a(T(t.initialAmount,t.cumulativeAmount))+"% ",1)]))),128)),o("tr",zu,[e[4]||(e[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",Gu,a(d(B.value.initialAmount)),1),o("td",Ju,a(d(B.value.currentIncrease)),1),o("td",Hu,a(d(J())),1),o("td",Ku,a(d(B.value.cumulativeAmount)),1),o("td",Qu,a(T(B.value.initialAmount,B.value.cumulativeAmount))+"% ",1)])])])]),o("div",{class:"mt-4 flex justify-end space-x-4"},[o("button",{onClick:H,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),o("button",{onClick:K,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),uu(ou,{"module-id":eu(j).CONTRACT_INVENTORY,period:c.value,remarks:E.value,"onUpdate:remarks":e[1]||(e[1]=t=>E.value=t),suggestions:x.value,"onUpdate:suggestions":e[2]||(e[2]=t=>x.value=t)},null,8,["module-id","period","remarks","suggestions"])]))}});var ue=W(Wu,[["__scopeId","data-v-6eb8b1ea"]]);export{ue as default};
