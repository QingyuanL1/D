import{_ as $,d as j,r as g,C as S,o as L,c as B,a as e,y as x,B as f,F as q,l as G,t as d,b as z,m as J,G as H,f as v}from"./index.7237b4cb.js";import{_ as K,l as Q,M as E,r as W}from"./FormAttachmentAndRemarks.84a79a09.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Y={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},tt={class:"overflow-x-auto my-6"},ut={class:"w-full border-collapse border border-gray-300"},et={class:"border border-gray-300 px-4 py-2"},ot={class:"border border-gray-300 px-4 py-2"},at={class:"w-full px-2 py-1"},rt={class:"border border-gray-300 px-4 py-2"},st=["onUpdate:modelValue"],nt={class:"border border-gray-300 px-4 py-2"},lt={class:"w-full px-2 py-1"},ct={class:"border border-gray-300 px-4 py-2"},dt={class:"w-full px-2 py-1"},pt={class:"border border-gray-300 px-4 py-2"},it={class:"w-full px-2 py-1"},gt={class:"border border-gray-300 px-4 py-2"},yt={class:"w-full px-2 py-1"},mt={class:"bg-gray-50 font-bold"},Ft={class:"border border-gray-300 px-4 py-2"},Et={class:"w-full px-2 py-1 font-bold"},bt={class:"border border-gray-300 px-4 py-2"},Dt={class:"border border-gray-300 px-4 py-2"},_t={class:"w-full px-2 py-1 font-bold"},ht={class:"border border-gray-300 px-4 py-2"},Bt={class:"w-full px-2 py-1 font-bold"},xt={class:"border border-gray-300 px-4 py-2"},ft={class:"w-full px-2 py-1 font-bold"},vt={class:"border border-gray-300 px-4 py-2"},At={class:"w-full px-2 py-1 font-bold"},Tt=j({__name:"DepartmentCostInput",setup(Ct){var M;const b=H(),n=g(((M=b.query.period)==null?void 0:M.toString())||new Date().toISOString().slice(0,7)),y=g(""),m=g(""),D=()=>({departments:[{department:"\u603B\u7ECF\u7406\u5BA4",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u4F01\u7BA1\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u8D22\u52A1\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u9500\u552E\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u5E02\u573A\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u8425\u8FD0\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u7814\u6280\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"C-GIS \u4E8B\u4E1A\u90E8",yearlyBudget:"1894.69",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""},{department:"\u5DE5\u7A0B\u4E8B\u4E1A\u90E8",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""}],total:{department:"\u5408\u8BA1",yearlyBudget:"",currentMonthIncome:"",accumulatedIncome:"",executionProgress:"",budgetToOutputRatio:"",actualToOutputRatio:""}}),P=(t,u)=>{if(!u)return t;console.log("\u90E8\u95E8\u6210\u672C\u6570\u636E\u5408\u5E76\u5F00\u59CB:",{initialData:t,loadedData:u});const o=t.departments.map(s=>{var l;const c=(l=u.departments)==null?void 0:l.find(p=>p.department===s.department);return c?(console.log(`\u5408\u5E76\u90E8\u95E8\u6570\u636E: ${s.department}`,c),{...s,...c,yearlyBudget:c.yearlyBudget||s.yearlyBudget}):s}),a=u.total?{...t.total,...u.total,yearlyBudget:u.total.yearlyBudget||t.total.yearlyBudget}:t.total;return console.log("\u90E8\u95E8\u6210\u672C\u6570\u636E\u5408\u5E76\u5B8C\u6210:",{departments:o,total:a}),{departments:o,total:a}},A=D(),i=g(A.departments),r=g(A.total),_=g([]),T=async t=>{try{const[u,o]=t.split("-"),a=parseInt(o),s=[];for(let c=1;c<=a;c++){const l=`${u}-${c.toString().padStart(2,"0")}`;try{const p=await fetch(`http://47.111.95.19:3000/department-cost-input/${l}`);if(p.ok){const F=await p.json();F.data&&s.push({period:l,data:F.data})}}catch(p){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${l}:`,p)}}_.value=s,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",s)}catch(u){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",u)}},k=(t,u="currentMonthIncome")=>{var c;let o=0;const a=n.value;for(const l of _.value){if(l.period===a)continue;const p=(c=l.data.departments)==null?void 0:c.find(F=>F.department===t);p&&p[u]&&(o+=parseFloat(p[u].toString().replace(/,/g,""))||0)}const s=i.value.find(l=>l.department===t);return s&&s[u]&&(o+=parseFloat(s[u].toString().replace(/,/g,""))||0),o.toLocaleString()},U=(t="currentMonthIncome")=>{let u=0;const o=n.value;for(const a of _.value)a.period!==o&&a.data.total&&a.data.total[t]&&(u+=parseFloat(a.data.total[t].toString().replace(/,/g,""))||0);return r.value[t]&&(u+=parseFloat(r.value[t].toString().replace(/,/g,""))||0),u.toLocaleString()},C=(t,u)=>{const o=parseFloat(t.replace(/,/g,""))||0,a=parseFloat(u.replace(/,/g,""))||0;return a===0?"0%":(o/a*100).toFixed(1)+"%"},I=t=>{if(!t||t==="")return"";const u=typeof t=="string"?parseFloat(t):t;return isNaN(u)?"":u.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},h=()=>{i.value.forEach(t=>{t.accumulatedIncome=k(t.department),t.executionProgress=C(t.accumulatedIncome,t.yearlyBudget),t.budgetToOutputRatio="",t.actualToOutputRatio=""}),r.value.accumulatedIncome=U(),r.value.executionProgress=C(r.value.accumulatedIncome,r.value.yearlyBudget),r.value.budgetToOutputRatio="",r.value.actualToOutputRatio=""},w=()=>{h()},R=async t=>{console.log(`\u6B63\u5728\u52A0\u8F7D\u90E8\u95E8\u6210\u672C\u4E2D\u5FC3\u6570\u636E\uFF0C\u671F\u95F4: ${t}`);try{const u=await fetch(`http://47.111.95.19:3000/department-cost-input/${t}`);if(!u.ok){if(u.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u4F7F\u7528\u7A7A\u767D\u6A21\u677F"),await T(t),h();return}const o=await u.json();if(console.log("\u52A0\u8F7D\u5230\u7684\u6570\u636E:",o),o.data){const a=P(D(),o.data);i.value=a.departments,r.value=a.total,console.log("\u6570\u636E\u5408\u5E76\u5B8C\u6210:",{departments:i.value,total:r.value})}await T(t),h()}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u)}},O=async t=>{try{const u=await Q(E.DEPARTMENT_COST_INPUT,t);y.value=u.remarks,m.value=u.suggestions}catch(u){console.error("\u52A0\u8F7D\u5907\u6CE8\u4FE1\u606F\u5931\u8D25:",u)}};S(n,t=>{t&&(R(t),O(t))}),S(()=>b.query.period,t=>{t&&(n.value=t.toString())});const N=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u90E8\u95E8\u6210\u672C\u4E2D\u5FC3\u8BA1\u5165\u635F\u76CA\u6570\u636E ==="),console.log("\u671F\u95F4:",n.value),console.log("\u6A21\u5757ID:",E.DEPARTMENT_COST_INPUT);const t={departments:i.value,total:r.value};console.log("\u8868\u5355\u6570\u636E:",t),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const u=await fetch("http://47.111.95.19:3000/department-cost-input",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:t})});if(!u.ok){const s=await u.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",s),new Error("\u4FDD\u5B58\u5931\u8D25")}const o=await u.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",o),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001..."),console.log("\u8C03\u7528\u53C2\u6570:",{moduleId:E.DEPARTMENT_COST_INPUT,period:n.value,formData:t,remarks:y.value,suggestions:m.value});const a=await W(E.DEPARTMENT_COST_INPUT,n.value,t,y.value,m.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",a),a?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(t){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",t),alert("\u4FDD\u5B58\u5931\u8D25: "+(t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"))}},V=()=>{const t=D();i.value=t.departments,r.value=t.total};return L(()=>{var u;const t=((u=b.query.period)==null?void 0:u.toString())||n.value;R(t),O(t)}),(t,u)=>(v(),B("div",X,[e("div",Y,[u[4]||(u[4]=e("h1",{class:"text-2xl font-bold"},"\u90E8\u95E8\u6210\u672C\u4E2D\u5FC3\u8BA1\u5165\u635F\u76CA\u60C5\u51B5\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e("div",Z,[x(e("input",{"onUpdate:modelValue":u[0]||(u[0]=o=>n.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[f,n.value]])])]),e("div",tt,[e("table",ut,[u[6]||(u[6]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2"},"\u90E8\u95E8\u5C5E\u6027"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u9884\u7B97"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u6267\u884C"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u6267\u884C"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u9884\u7B97\u5360\u4EA7\u503C\u6BD4"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5B9E\u9645\u5360\u4EA7\u503C\u6BD4")])],-1)),e("tbody",null,[(v(!0),B(q,null,G(i.value,(o,a)=>(v(),B("tr",{key:a},[e("td",et,d(o.department),1),e("td",ot,[e("span",at,d(I(o.yearlyBudget)),1)]),e("td",rt,[x(e("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,onInput:w,type:"text",class:"w-full px-2 py-1 border rounded"},null,40,st),[[f,o.currentMonthIncome]])]),e("td",nt,[e("span",lt,d(o.accumulatedIncome),1)]),e("td",ct,[e("span",dt,d(o.executionProgress),1)]),e("td",pt,[e("span",it,d(o.budgetToOutputRatio),1)]),e("td",gt,[e("span",yt,d(o.actualToOutputRatio),1)])]))),128)),e("tr",mt,[u[5]||(u[5]=e("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),e("td",Ft,[e("span",Et,d(I(r.value.yearlyBudget)),1)]),e("td",bt,[x(e("input",{"onUpdate:modelValue":u[1]||(u[1]=o=>r.value.currentMonthIncome=o),onInput:w,type:"text",class:"w-full px-2 py-1 border rounded font-bold"},null,544),[[f,r.value.currentMonthIncome]])]),e("td",Dt,[e("span",_t,d(r.value.accumulatedIncome),1)]),e("td",ht,[e("span",Bt,d(r.value.executionProgress),1)]),e("td",xt,[e("span",ft,d(r.value.budgetToOutputRatio),1)]),e("td",vt,[e("span",At,d(r.value.actualToOutputRatio),1)])])])])]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:N,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:V,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),z(K,{"module-id":J(E).DEPARTMENT_COST_INPUT,period:n.value,remarks:y.value,"onUpdate:remarks":u[2]||(u[2]=o=>y.value=o),suggestions:m.value,"onUpdate:suggestions":u[3]||(u[3]=o=>m.value=o)},null,8,["module-id","period","remarks","suggestions"])]))}});var Rt=$(Tt,[["__scopeId","data-v-17946180"]]);export{Rt as default};
