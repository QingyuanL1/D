import{_ as j,d as J,r as m,C as f,h as L,o as M,c as v,a as r,y as k,B as U,F as q,l as Y,t as a,q as R,b as z,m as G,G as H,f as B,k as K}from"./index.4d187047.js";import{_ as Q,M as C,r as W}from"./FormAttachmentAndRemarks.e918c8a2.js";const X={class:"max-w-[1800px] mx-auto bg-white rounded-lg shadow-lg p-6"},Z={class:"flex justify-between items-center mb-6"},ee={class:"flex items-center space-x-4"},te={class:"overflow-x-auto my-6"},re={class:"w-full border-collapse border border-gray-300"},ue=["rowspan"],se={class:"border border-gray-300 px-4 py-2"},oe={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ae={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ne={class:"border border-gray-300 px-4 py-2"},le=["onUpdate:modelValue"],ce={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"bg-gray-50 font-bold"},ge={class:"border border-gray-300 px-4 py-2 text-right"},ye={class:"border border-gray-300 px-4 py-2 text-right"},pe={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"border border-gray-300 px-4 py-2 text-right"},me={class:"border border-gray-300 px-4 py-2 text-right"},ve=J({__name:"OverdueReceivables",setup(Be){var F;const E=H(),n=m(((F=E.query.period)==null?void 0:F.toString())||new Date().toISOString().slice(0,7)),_={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0}]},o=m(JSON.parse(JSON.stringify(_))),d=m(""),g=m(""),l=e=>e===0?"0.00":e.toFixed(2),w=e=>e===0?"0.00":e.toFixed(2),A=e=>e>=80?"text-green-600":e>=60?"text-yellow-600":"text-red-600",V=e=>e===0?!0:o.value.items[e].segmentAttribute!==o.value.items[e-1].segmentAttribute,$=e=>o.value.items.filter(t=>t.segmentAttribute===e).length,y=async e=>{try{const[t]=e.split("-"),u=parseInt(e.split("-")[1]);for(let s of o.value.items){let p=0;for(let D=1;D<=u;D++){const S=`${t}-${D.toString().padStart(2,"0")}`;try{const b=await fetch(`http://47.111.95.19:3000/tuoyuan-overdue-receivables/${S}`);if(b.ok){const I=(await b.json()).data.items.find(O=>O.segmentAttribute===s.segmentAttribute&&O.customerAttribute===s.customerAttribute);I&&(p+=I.currentCollected||0)}}catch(b){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${S}\u7684\u6570\u636E:`,b)}}s.cumulativeCollected=p;const N=(s.yearBeginningBalance||0)+(s.yearNewIncrease||0);s.collectionProgress=N>0?s.cumulativeCollected/N*100:0}}catch(t){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u5DF2\u6536\u6B3E\u5931\u8D25:",t)}};f(()=>o.value.items,async e=>{await y(n.value)},{deep:!0});const c=L(()=>{const e={yearBeginningBalance:0,yearNewIncrease:0,currentCollected:0,cumulativeCollected:0,collectionProgress:0};o.value.items.forEach(u=>{e.yearBeginningBalance+=u.yearBeginningBalance||0,e.yearNewIncrease+=u.yearNewIncrease||0,e.currentCollected+=u.currentCollected||0,e.cumulativeCollected+=u.cumulativeCollected||0});const t=e.yearBeginningBalance+e.yearNewIncrease;return e.collectionProgress=t>0?e.cumulativeCollected/t*100:0,e}),x=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/tuoyuan-overdue-receivables/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),i();return}const u=await t.json();u.data&&u.data.items&&(o.value.items=u.data.items.map(s=>({segmentAttribute:s.segmentAttribute,customerAttribute:s.customerAttribute,yearBeginningBalance:Number(s.yearBeginningBalance)||0,yearNewIncrease:Number(s.yearNewIncrease)||0,currentCollected:Number(s.currentCollected)||0,cumulativeCollected:Number(s.cumulativeCollected)||0,collectionProgress:Number(s.collectionProgress)||0}))),await y(e)}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),i()}},i=()=>{o.value=JSON.parse(JSON.stringify(_))},h=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${C.TUOYUAN_OVERDUE_RECEIVABLES}/${e}`);if(t.ok){const u=await t.json();u.success&&u.data&&(d.value=u.data.remarks||"",g.value=u.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};f(()=>E.query.period,async e=>{e&&(n.value=e.toString(),i(),await x(e.toString()),await y(e.toString()),h(e.toString()))}),f(n,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),i(),await x(e),await y(e),h(e))});const P=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-overdue-receivables",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:{items:o.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await W(C.TUOYUAN_OVERDUE_RECEIVABLES,n.value,{items:o.value.items},d.value,g.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},T=()=>{i(),d.value="",g.value=""};return M(async()=>{var t;i();const e=((t=E.query.period)==null?void 0:t.toString())||n.value;await x(e),await y(e),h(e)}),(e,t)=>(B(),v("div",X,[r("div",Z,[t[5]||(t[5]=r("h1",{class:"text-2xl font-bold"},"\u903E\u671F\u5E94\u6536\u8D26\u6B3E\u60C5\u51B5",-1)),r("div",ee,[t[3]||(t[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),t[4]||(t[4]=r("span",{class:"text-xs text-gray-500"},"\u7D2F\u8BA1\u5DF2\u6536\u6B3E=\u524D\u9762\u5404\u6708\u5F53\u671F\u5DF2\u6536\u6B3E\u4E4B\u548C",-1)),k(r("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>n.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[U,n.value]])])]),r("div",te,[r("table",re,[t[7]||(t[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-20"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5E74\u521D\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u672C\u5E74\u65B0\u589E"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5F53\u671F\u5DF2\u6536\u6B3E"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u7D2F\u8BA1\u5DF2\u6536\u6B3E"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u6536\u6B3E\u8FDB\u5EA6")])],-1)),r("tbody",null,[(B(!0),v(q,null,Y(o.value.items,(u,s)=>(B(),v("tr",{key:`overdue-${s}`},[V(s)?(B(),v("td",{key:0,rowspan:$(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},a(u.segmentAttribute),9,ue)):K("",!0),r("td",se,a(u.customerAttribute),1),r("td",oe,a(l(u.yearBeginningBalance)),1),r("td",ae,a(l(u.yearNewIncrease)),1),r("td",ne,[k(r("input",{"onUpdate:modelValue":p=>u.currentCollected=p,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",placeholder:"0.00"},null,8,le),[[U,u.currentCollected]])]),r("td",ce,a(l(u.cumulativeCollected)),1),r("td",ie,[r("span",{class:R(["text-sm font-medium",A(u.collectionProgress)])},a(w(u.collectionProgress))+"% ",3)])]))),128)),r("tr",de,[t[6]||(t[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",ge,a(l(c.value.yearBeginningBalance)),1),r("td",ye,a(l(c.value.yearNewIncrease)),1),r("td",pe,a(l(c.value.currentCollected)),1),r("td",be,a(l(c.value.cumulativeCollected)),1),r("td",me,[r("span",{class:R(["text-sm font-bold",A(c.value.collectionProgress)])},a(w(c.value.collectionProgress))+"% ",3)])])])])]),z(Q,{"module-id":G(C).TUOYUAN_OVERDUE_RECEIVABLES,period:n.value,remarks:d.value,"onUpdate:remarks":t[1]||(t[1]=u=>d.value=u),suggestions:g.value,"onUpdate:suggestions":t[2]||(t[2]=u=>g.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:P,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:T,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var De=j(ve,[["__scopeId","data-v-7d2f00d2"]]);export{De as default};
