import{_ as Y,d as L,r as v,c as z,B,o as G,b as p,e as o,y as F,A as b,F as q,g as k,t as a,k as J,h as H,G as K,v as m,f as S}from"./index.950baf00.js";import{_ as Q,l as W,M as T,r as X}from"./FormAttachmentAndRemarks.efef948e.js";const Z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},uu={class:"flex justify-between items-center mb-6"},tu={class:"flex items-center space-x-4"},eu={class:"overflow-x-auto my-6"},ou={class:"w-full border-collapse border border-gray-300"},ru=["rowspan"],nu={class:"border border-gray-300 px-4 py-2"},su={class:"border border-gray-300 px-4 py-2"},au=["onUpdate:modelValue"],iu={class:"border border-gray-300 px-4 py-2"},cu=["onUpdate:modelValue"],lu={class:"border border-gray-300 px-4 py-2 text-right"},du={class:"font-medium"},pu={class:"border border-gray-300 px-4 py-2 text-right"},mu=["rowspan"],yu={class:"border border-gray-300 px-4 py-2"},Au={class:"border border-gray-300 px-4 py-2"},vu=["onUpdate:modelValue"],Fu={class:"border border-gray-300 px-4 py-2"},bu=["onUpdate:modelValue"],gu={class:"border border-gray-300 px-4 py-2 text-right"},Du={class:"font-medium"},hu={class:"border border-gray-300 px-4 py-2 text-right"},_u=["rowspan"],Eu={class:"border border-gray-300 px-4 py-2"},fu={class:"border border-gray-300 px-4 py-2"},xu=["onUpdate:modelValue"],Cu={class:"border border-gray-300 px-4 py-2"},Bu=["onUpdate:modelValue"],Tu={class:"border border-gray-300 px-4 py-2 text-right"},Pu={class:"font-medium"},wu={class:"border border-gray-300 px-4 py-2 text-right"},Nu={class:"bg-gray-50 font-bold"},ju={class:"border border-gray-300 px-4 py-2 text-right"},qu={class:"border border-gray-300 px-4 py-2 text-right"},ku={class:"border border-gray-300 px-4 py-2 text-right"},Su={class:"border border-gray-300 px-4 py-2 text-right"},Vu=L({__name:"ContractInventory",setup(Uu){var O;const x=K(),i=v(((O=x.query.period)==null?void 0:O.toString())||new Date().toISOString().slice(0,7)),s={equipment:{\u4E0A\u6D77:1200.5,\u56FD\u7F51:2300.75,\u6C5F\u82CF:800.25,\u8F93\u914D\u7535\u5185\u914D:150,\u897F\u95E8\u5B50:0,\u540C\u4E1A:950.6,\u7528\u6237:750.4,\u5176\u5B83:200.3},component:{\u7528\u6237:500.8},project:{\u4E00\u5305:300.2,\u4E8C\u5305:150.1,\u57DF\u5185\u5408\u4F5C:1100.9,\u57DF\u5916\u5408\u4F5C:650.75,\u5176\u5B83:400.5}},V=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialAmount:s.equipment.\u4E0A\u6D77,currentPeriod:0,cumulativeAmount:0},{customerType:"\u56FD\u7F51",initialAmount:s.equipment.\u56FD\u7F51,currentPeriod:0,cumulativeAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:s.equipment.\u6C5F\u82CF,currentPeriod:0,cumulativeAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:s.equipment.\u8F93\u914D\u7535\u5185\u914D,currentPeriod:0,cumulativeAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:s.equipment.\u897F\u95E8\u5B50,currentPeriod:0,cumulativeAmount:0},{customerType:"\u540C\u4E1A",initialAmount:s.equipment.\u540C\u4E1A,currentPeriod:0,cumulativeAmount:0},{customerType:"\u7528\u6237",initialAmount:s.equipment.\u7528\u6237,currentPeriod:0,cumulativeAmount:0},{customerType:"\u5176\u5B83",initialAmount:s.equipment.\u5176\u5B83,currentPeriod:0,cumulativeAmount:0}],component:[{customerType:"\u7528\u6237",initialAmount:s.component.\u7528\u6237,currentPeriod:0,cumulativeAmount:0}],project:[{customerType:"\u4E00\u5305",initialAmount:s.project.\u4E00\u5305,currentPeriod:0,cumulativeAmount:0},{customerType:"\u4E8C\u5305",initialAmount:s.project.\u4E8C\u5305,currentPeriod:0,cumulativeAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:s.project.\u57DF\u5185\u5408\u4F5C,currentPeriod:0,cumulativeAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:s.project.\u57DF\u5916\u5408\u4F5C,currentPeriod:0,cumulativeAmount:0},{customerType:"\u5176\u5B83",initialAmount:s.project.\u5176\u5B83,currentPeriod:0,cumulativeAmount:0}]}),$=(u,t)=>(!t||typeof t!="object"||(t.equipment&&Array.isArray(t.equipment)&&(u.equipment=u.equipment.map(e=>{const n=t.equipment.find(r=>r.customerType===e.customerType);return n?{...e,initialAmount:e.initialAmount,currentPeriod:Number(n.currentPeriod)||0,cumulativeAmount:0}:e})),t.component&&Array.isArray(t.component)&&(u.component=u.component.map(e=>{const n=t.component.find(r=>r.customerType===e.customerType);return n?{...e,initialAmount:e.initialAmount,currentPeriod:Number(n.currentPeriod)||0,cumulativeAmount:0}:e})),t.project&&Array.isArray(t.project)&&(u.project=u.project.map(e=>{const n=t.project.find(r=>r.customerType===e.customerType);return n?{...e,initialAmount:e.initialAmount,currentPeriod:Number(n.currentPeriod)||0,cumulativeAmount:0}:e}))),u),P=()=>{const u=V();c.value=u.equipment,l.value=u.component,d.value=u.project},c=v([]),l=v([]),d=v([]),D=v(""),h=v(""),U=v([]),R=async u=>{try{const t=[],e=u.substring(0,4),n=parseInt(u.substring(5,7));for(let r=1;r<n;r++){const y=`${e}-${r.toString().padStart(2,"0")}`;try{const A=await fetch(`http://47.111.95.19:3000/contract-inventory/${y}`);if(A.ok){const f=await A.json();f.success&&f.data&&t.push({period:y,data:f.data})}}catch(A){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${y}:`,A)}}U.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},w=(u,t)=>{let e=0;for(const y of U.value)if(y.data[u]){const A=y.data[u].find(f=>f.customerType===t);A&&A.currentPeriod&&(e+=parseFloat(A.currentPeriod.toString())||0)}let n=[];u==="equipment"?n=c.value:u==="component"?n=l.value:u==="project"&&(n=d.value);const r=n.find(y=>y.customerType===t);return r&&r.currentPeriod&&(e+=parseFloat(r.currentPeriod.toString())||0),e},N=()=>{c.value.forEach(u=>{const t=w("equipment",u.customerType);u.cumulativeAmount=t}),l.value.forEach(u=>{const t=w("component",u.customerType);u.cumulativeAmount=t}),d.value.forEach(u=>{const t=w("project",u.customerType);u.cumulativeAmount=t})},C=(u,t)=>u===0?t===0?"0.00":"N/A":((t-u)/u*100).toFixed(2),g=u=>isNaN(u)||u===null||u===void 0?"0.00":u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),_=z(()=>{const u={initialAmount:0,currentPeriod:0,cumulativeAmount:0};return c.value.forEach(t=>{u.initialAmount+=Number(t.initialAmount)||0,u.currentPeriod+=Number(t.currentPeriod)||0,u.cumulativeAmount+=Number(t.cumulativeAmount)||0}),l.value.forEach(t=>{u.initialAmount+=Number(t.initialAmount)||0,u.currentPeriod+=Number(t.currentPeriod)||0,u.cumulativeAmount+=Number(t.cumulativeAmount)||0}),d.value.forEach(t=>{u.initialAmount+=Number(t.initialAmount)||0,u.currentPeriod+=Number(t.currentPeriod)||0,u.cumulativeAmount+=Number(t.cumulativeAmount)||0}),u}),E=async u=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u5408\u540C\u5B58\u91CF\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const t=await fetch(`http://47.111.95.19:3000/contract-inventory/${u}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),P(),await R(u),N();return}const e=await t.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",e),e.success&&e.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const n=V(),r=$(n,e.data);c.value=r.equipment,l.value=r.component,d.value=r.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:c.value,componentData:l.value,projectData:d.value})}await R(u),N()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),P()}},j=async()=>{const{remarks:u,suggestions:t}=await W(T.CONTRACT_INVENTORY,i.value);D.value=u,h.value=t};B(i,u=>{E(u),j()}),B(()=>x.query.period,u=>{u&&(i.value=u.toString(),E(u.toString()))}),B(()=>[c.value.map(u=>u.currentPeriod),l.value.map(u=>u.currentPeriod),d.value.map(u=>u.currentPeriod)],()=>{N()},{deep:!0}),B(i,(u,t)=>{u&&u!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${u}`),E(u),j())});const I=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u5408\u540C\u5B58\u91CF\u6570\u636E ==="),console.log("\u671F\u95F4:",i.value),console.log("\u6A21\u5757ID:",T.CONTRACT_INVENTORY);const u={equipment:c.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentPeriod:r.currentPeriod,cumulativeAmount:r.cumulativeAmount})),component:l.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentPeriod:r.currentPeriod,cumulativeAmount:r.cumulativeAmount})),project:d.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentPeriod:r.currentPeriod,cumulativeAmount:r.cumulativeAmount}))};console.log("\u8868\u5355\u6570\u636E:",u),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const t=await fetch("http://47.111.95.19:3000/contract-inventory",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:i.value,data:u})});if(!t.ok){const r=await t.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",r),new Error("\u4FDD\u5B58\u5931\u8D25")}const e=await t.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",e),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const n=await X(T.CONTRACT_INVENTORY,i.value,u,D.value,h.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",n),n?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(u){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",u),alert("\u4FDD\u5B58\u5931\u8D25: "+(u instanceof Error?u.message:"\u672A\u77E5\u9519\u8BEF"))}},M=()=>{P(),D.value="",h.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return G(()=>{console.log("\u5408\u540C\u5B58\u91CF\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",i.value),x.query.period?E(x.query.period.toString()):E(i.value),j()}),(u,t)=>(m(),p("div",Z,[o("div",uu,[t[3]||(t[3]=o("h1",{class:"text-2xl font-bold"},"\u5E93\u5B58\u60C5\u51B5(\u5408\u540C\u5B58\u91CF)",-1)),o("div",tu,[F(o("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>i.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[b,i.value]])])]),o("div",eu,[o("table",ou,[t[5]||(t[5]=o("thead",{class:"sticky top-0 bg-white"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u91CF"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u5E93\u5B58"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u5E93\u5B58"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),o("tbody",null,[(m(!0),p(q,null,k(c.value,(e,n)=>(m(),p("tr",{key:`equipment-${n}`},[n===0?(m(),p("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u8BBE\u5907 ",8,ru)):S("",!0),o("td",nu,a(e.customerType),1),o("td",su,[F(o("input",{"onUpdate:modelValue":r=>e.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,au),[[b,e.initialAmount,void 0,{number:!0}]])]),o("td",iu,[F(o("input",{"onUpdate:modelValue":r=>e.currentPeriod=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,cu),[[b,e.currentPeriod,void 0,{number:!0}]])]),o("td",lu,[o("span",du,a(g(e.cumulativeAmount)),1)]),o("td",pu,a(C(e.initialAmount,e.cumulativeAmount))+"% ",1)]))),128)),(m(!0),p(q,null,k(l.value,(e,n)=>(m(),p("tr",{key:`component-${n}`},[n===0?(m(),p("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u5143\u4EF6 ",8,mu)):S("",!0),o("td",yu,a(e.customerType),1),o("td",Au,[F(o("input",{"onUpdate:modelValue":r=>e.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,vu),[[b,e.initialAmount,void 0,{number:!0}]])]),o("td",Fu,[F(o("input",{"onUpdate:modelValue":r=>e.currentPeriod=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,bu),[[b,e.currentPeriod,void 0,{number:!0}]])]),o("td",gu,[o("span",Du,a(g(e.cumulativeAmount)),1)]),o("td",hu,a(C(e.initialAmount,e.cumulativeAmount))+"% ",1)]))),128)),(m(!0),p(q,null,k(d.value,(e,n)=>(m(),p("tr",{key:`project-${n}`},[n===0?(m(),p("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u5DE5\u7A0B ",8,_u)):S("",!0),o("td",Eu,a(e.customerType),1),o("td",fu,[F(o("input",{"onUpdate:modelValue":r=>e.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,xu),[[b,e.initialAmount,void 0,{number:!0}]])]),o("td",Cu,[F(o("input",{"onUpdate:modelValue":r=>e.currentPeriod=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Bu),[[b,e.currentPeriod,void 0,{number:!0}]])]),o("td",Tu,[o("span",Pu,a(g(e.cumulativeAmount)),1)]),o("td",wu,a(C(e.initialAmount,e.cumulativeAmount))+"% ",1)]))),128)),o("tr",Nu,[t[4]||(t[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",ju,a(g(_.value.initialAmount)),1),o("td",qu,a(g(_.value.currentPeriod)),1),o("td",ku,a(g(_.value.cumulativeAmount)),1),o("td",Su,a(C(_.value.initialAmount,_.value.cumulativeAmount))+"% ",1)])])])]),o("div",{class:"mt-4 flex justify-end space-x-4"},[o("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),o("button",{onClick:M,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),J(Q,{"module-id":H(T).CONTRACT_INVENTORY,period:i.value,remarks:D.value,"onUpdate:remarks":t[1]||(t[1]=e=>D.value=e),suggestions:h.value,"onUpdate:suggestions":t[2]||(t[2]=e=>h.value=e)},null,8,["module-id","period","remarks","suggestions"])]))}});var $u=Y(Vu,[["__scopeId","data-v-51f22829"]]);export{$u as default};
