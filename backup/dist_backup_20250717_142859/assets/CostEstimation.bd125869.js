import{_ as J,d as H,r as F,c as K,B as A,o as Q,b as p,e as u,y,A as f,F as V,g as k,t as n,k as X,h as Z,G as ee,v as b,f as N}from"./index.950baf00.js";import{_ as re,l as te,M as C,r as oe}from"./FormAttachmentAndRemarks.efef948e.js";const ue={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},ae={class:"flex justify-between items-center mb-6"},ne={class:"flex items-center space-x-4"},se={class:"overflow-x-auto my-6"},ie={class:"w-full border-collapse border border-gray-300"},le=["rowspan"],ce={class:"border border-gray-300 px-4 py-2"},de={class:"border border-gray-300 px-4 py-2 text-right"},pe={class:"border border-gray-300 px-4 py-2"},ye=["onUpdate:modelValue"],fe={class:"border border-gray-300 px-4 py-2"},be=["onUpdate:modelValue"],me={class:"border border-gray-300 px-4 py-2 text-right"},ve={class:"font-medium"},ge={class:"border border-gray-300 px-4 py-2"},Fe=["onUpdate:modelValue"],_e=["rowspan"],he={class:"border border-gray-300 px-4 py-2"},Be={class:"border border-gray-300 px-4 py-2 text-right"},xe={class:"border border-gray-300 px-4 py-2"},De=["onUpdate:modelValue"],Te={class:"border border-gray-300 px-4 py-2"},Ee=["onUpdate:modelValue"],Oe={class:"border border-gray-300 px-4 py-2 text-right"},Ae={class:"font-medium"},Ce={class:"border border-gray-300 px-4 py-2"},We=["onUpdate:modelValue"],Re=["rowspan"],we={class:"border border-gray-300 px-4 py-2"},Pe={class:"border border-gray-300 px-4 py-2 text-right"},Se={class:"border border-gray-300 px-4 py-2"},Ve=["onUpdate:modelValue"],ke={class:"border border-gray-300 px-4 py-2"},Ne=["onUpdate:modelValue"],$e={class:"border border-gray-300 px-4 py-2 text-right"},Ue={class:"font-medium"},je={class:"border border-gray-300 px-4 py-2"},qe=["onUpdate:modelValue"],Ie={class:"bg-gray-50 font-bold"},Me={class:"border border-gray-300 px-4 py-2 text-right"},Le={class:"border border-gray-300 px-4 py-2 text-right"},Ye={class:"border border-gray-300 px-4 py-2 text-right"},ze={class:"border border-gray-300 px-4 py-2 text-right"},Ge={class:"border border-gray-300 px-4 py-2 text-right"},Je=H({__name:"CostEstimation",setup(He){var q;const T=ee(),s=F(((q=T.query.period)==null?void 0:q.toString())||new Date().toISOString().slice(0,7)),B=F(""),x=F(""),$=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u56FD\u7F51",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u6C5F\u82CF",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u897F\u95E8\u5B50",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u540C\u4E1A",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u7528\u6237",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u5176\u5B83",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0}],component:[{customerType:"\u7528\u6237",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0}],project:[{customerType:"\u4E00\u5305",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u4E8C\u5305",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u5176\u5B83",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0}]}),Y=(e,o)=>(!o||typeof o!="object"||(o.equipment&&Array.isArray(o.equipment)&&(e.equipment=e.equipment.map(r=>{const a=o.equipment.find(t=>t.customerType===r.customerType);return a?{...r,initialBalance:Number(a.initialBalance)||0,currentPeriod:Number(a.currentPeriod)||0,currentWriteOff:Number(a.currentWriteOff)||0,yearTotal:0,provisionRate:Number(a.provisionRate)||0}:r})),o.component&&Array.isArray(o.component)&&(e.component=e.component.map(r=>{const a=o.component.find(t=>t.customerType===r.customerType);return a?{...r,initialBalance:Number(a.initialBalance)||0,currentPeriod:Number(a.currentPeriod)||0,currentWriteOff:Number(a.currentWriteOff)||0,yearTotal:0,provisionRate:Number(a.provisionRate)||0}:r})),o.project&&Array.isArray(o.project)&&(e.project=e.project.map(r=>{const a=o.project.find(t=>t.customerType===r.customerType);return a?{...r,initialBalance:Number(a.initialBalance)||0,currentPeriod:Number(a.currentPeriod)||0,currentWriteOff:Number(a.currentWriteOff)||0,yearTotal:0,provisionRate:Number(a.provisionRate)||0}:r}))),e),W=()=>{const e=$();i.value=e.equipment,l.value=e.component,c.value=e.project},i=F([]),l=F([]),c=F([]),U=F([]),j=async e=>{try{const o=[],r=e.substring(0,4),a=parseInt(e.substring(5,7));for(let t=1;t<a;t++){const v=`${r}-${t.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/cost-estimation/${v}`);if(g.ok){const _=await g.json();_.success&&_.data&&o.push({period:v,data:_.data})}}catch(g){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${v}:`,g)}}U.value=o,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",o)}catch(o){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",o)}},R=(e,o)=>{var g,_,I,M;let r=0,a=0;console.log(`\u{1F50D} \u8BA1\u7B97\u7D2F\u8BA1\u6570\u636E: ${e}-${o}`);for(const m of U.value)if(m.data[e]){const h=m.data[e].find(O=>O.customerType===o);if(h){const O=parseFloat((g=h.currentPeriod)==null?void 0:g.toString())||0,L=parseFloat((_=h.currentWriteOff)==null?void 0:_.toString())||0;r+=O,a+=L,console.log(`\u{1F4C5} ${m.period}: ${o} \u65B0\u589E=${O}, \u51B2\u9500=${L}`)}}let t=[];e==="equipment"?t=i.value:e==="component"?t=l.value:e==="project"&&(t=c.value);const v=t.find(m=>m.customerType===o);if(v){const m=parseFloat((I=v.currentPeriod)==null?void 0:I.toString())||0,h=parseFloat((M=v.currentWriteOff)==null?void 0:M.toString())||0;r+=m,a+=h,console.log(`\u{1F4DD} \u5F53\u524D\u6708\u4EFD: ${o} \u65B0\u589E=${m}, \u51B2\u9500=${h}`)}return console.log(`\u2705 ${e}-${o} \u7D2F\u8BA1\u8BA1\u7B97\u5B8C\u6210: \u65B0\u589E=${r}, \u51B2\u9500=${a}`),{totalAddition:r,totalWriteOff:a}},w=()=>{i.value.forEach(e=>{const{totalAddition:o,totalWriteOff:r}=R("equipment",e.customerType);P(e,o,r)}),l.value.forEach(e=>{const{totalAddition:o,totalWriteOff:r}=R("component",e.customerType);P(e,o,r)}),c.value.forEach(e=>{const{totalAddition:o,totalWriteOff:r}=R("project",e.customerType);P(e,o,r)})},P=(e,o,r)=>{e.yearTotal=(e.initialBalance||0)+o-r},d=e=>isNaN(e)||e===null||e===void 0?"0.00":e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),D=K(()=>{const e=[...i.value,...l.value,...c.value],o={initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,averageProvisionRate:0};let r=0,a=0;return e.forEach(t=>{o.initialBalance+=t.initialBalance||0,o.currentPeriod+=t.currentPeriod||0,o.currentWriteOff+=t.currentWriteOff||0,o.yearTotal+=t.yearTotal||0,t.provisionRate>0&&(r+=t.provisionRate,a++)}),o.averageProvisionRate=a>0?r/a:0,o}),E=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u6210\u672C\u6682\u4F30\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const o=await fetch(`http://47.111.95.19:3000/cost-estimation/${e}`);if(!o.ok){if(o.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),W(),await j(e),w();return}const r=await o.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const a=$(),t=Y(a,r.data);i.value=t.equipment,l.value=t.component,c.value=t.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:i.value,componentData:l.value,projectData:c.value})}await j(e),w()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),W()}},S=async()=>{const{remarks:e,suggestions:o}=await te(C.COST_ESTIMATION,s.value);B.value=e,x.value=o};A(s,e=>{E(e),S()}),A(()=>T.query.period,e=>{e&&(s.value=e.toString())}),A(()=>[i.value.map(e=>e.currentPeriod),l.value.map(e=>e.currentPeriod),i.value.map(e=>e.currentWriteOff),l.value.map(e=>e.currentWriteOff),c.value.map(e=>e.currentPeriod),c.value.map(e=>e.currentWriteOff)],()=>{w()},{deep:!0}),A(s,e=>{E(e),S()});const z=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u6210\u672C\u6682\u4F30\u6570\u636E ==="),console.log("\u671F\u95F4:",s.value),console.log("\u6A21\u5757ID:",C.COST_ESTIMATION);const e={equipment:i.value.map(t=>({customerType:t.customerType,initialBalance:t.initialBalance,currentPeriod:t.currentPeriod,currentWriteOff:t.currentWriteOff,yearTotal:t.yearTotal,provisionRate:t.provisionRate})),component:l.value.map(t=>({customerType:t.customerType,initialBalance:t.initialBalance,currentPeriod:t.currentPeriod,currentWriteOff:t.currentWriteOff,yearTotal:t.yearTotal,provisionRate:t.provisionRate})),project:c.value.map(t=>({customerType:t.customerType,initialBalance:t.initialBalance,currentPeriod:t.currentPeriod,currentWriteOff:t.currentWriteOff,yearTotal:t.yearTotal,provisionRate:t.provisionRate}))};console.log("\u8868\u5355\u6570\u636E:",e),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const o=await fetch("http://47.111.95.19:3000/cost-estimation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:e})});if(!o.ok){const t=await o.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",t),new Error("\u4FDD\u5B58\u5931\u8D25")}const r=await o.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",r),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const a=await oe(C.COST_ESTIMATION,s.value,e,B.value,x.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",a),a?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(e){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},G=()=>{W(),B.value="",x.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return Q(()=>{console.log("\u6210\u672C\u6682\u4F30\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",s.value),T.query.period?E(T.query.period.toString()):E(s.value),S()}),(e,o)=>(b(),p("div",ue,[u("div",ae,[o[3]||(o[3]=u("h1",{class:"text-2xl font-bold"},"\u6210\u672C\u6682\u4F30\u5165\u5E93\u548C\u8BA1\u63D0\u60C5\u51B5",-1)),u("div",ne,[y(u("input",{"onUpdate:modelValue":o[0]||(o[0]=r=>s.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[f,s.value]])])]),u("div",se,[u("table",ie,[o[5]||(o[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u65B0\u589E"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u51B2\u9500"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u5E74\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u8BA1\u63D0\u7387")])],-1)),u("tbody",null,[(b(!0),p(V,null,k(i.value,(r,a)=>(b(),p("tr",{key:`equipment-${a}`},[a===0?(b(),p("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u8BBE\u5907 ",8,le)):N("",!0),u("td",ce,n(r.customerType),1),u("td",de,[u("span",null,n(d(r.initialBalance)),1)]),u("td",pe,[y(u("input",{"onUpdate:modelValue":t=>r.currentPeriod=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ye),[[f,r.currentPeriod,void 0,{number:!0}]])]),u("td",fe,[y(u("input",{"onUpdate:modelValue":t=>r.currentWriteOff=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,be),[[f,r.currentWriteOff,void 0,{number:!0}]])]),u("td",me,[u("span",ve,n(d(r.yearTotal)),1)]),u("td",ge,[y(u("input",{"onUpdate:modelValue":t=>r.provisionRate=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",min:"0",max:"100"},null,8,Fe),[[f,r.provisionRate,void 0,{number:!0}]])])]))),128)),(b(!0),p(V,null,k(l.value,(r,a)=>(b(),p("tr",{key:`component-${a}`},[a===0?(b(),p("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u5143\u4EF6 ",8,_e)):N("",!0),u("td",he,n(r.customerType),1),u("td",Be,[u("span",null,n(d(r.initialBalance)),1)]),u("td",xe,[y(u("input",{"onUpdate:modelValue":t=>r.currentPeriod=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,De),[[f,r.currentPeriod,void 0,{number:!0}]])]),u("td",Te,[y(u("input",{"onUpdate:modelValue":t=>r.currentWriteOff=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ee),[[f,r.currentWriteOff,void 0,{number:!0}]])]),u("td",Oe,[u("span",Ae,n(d(r.yearTotal)),1)]),u("td",Ce,[y(u("input",{"onUpdate:modelValue":t=>r.provisionRate=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",min:"0",max:"100"},null,8,We),[[f,r.provisionRate,void 0,{number:!0}]])])]))),128)),(b(!0),p(V,null,k(c.value,(r,a)=>(b(),p("tr",{key:`project-${a}`},[a===0?(b(),p("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u5DE5\u7A0B ",8,Re)):N("",!0),u("td",we,n(r.customerType),1),u("td",Pe,[u("span",null,n(d(r.initialBalance)),1)]),u("td",Se,[y(u("input",{"onUpdate:modelValue":t=>r.currentPeriod=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ve),[[f,r.currentPeriod,void 0,{number:!0}]])]),u("td",ke,[y(u("input",{"onUpdate:modelValue":t=>r.currentWriteOff=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ne),[[f,r.currentWriteOff,void 0,{number:!0}]])]),u("td",$e,[u("span",Ue,n(d(r.yearTotal)),1)]),u("td",je,[y(u("input",{"onUpdate:modelValue":t=>r.provisionRate=t,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",min:"0",max:"100"},null,8,qe),[[f,r.provisionRate,void 0,{number:!0}]])])]))),128)),u("tr",Ie,[o[4]||(o[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",Me,n(d(D.value.initialBalance)),1),u("td",Le,n(d(D.value.currentPeriod)),1),u("td",Ye,n(d(D.value.currentWriteOff)),1),u("td",ze,n(d(D.value.yearTotal)),1),u("td",Ge,n(d(D.value.averageProvisionRate))+"%",1)])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:z,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:G,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),X(re,{"module-id":Z(C).COST_ESTIMATION,period:s.value,remarks:B.value,"onUpdate:remarks":o[1]||(o[1]=r=>B.value=r),suggestions:x.value,"onUpdate:suggestions":o[2]||(o[2]=r=>x.value=r)},null,8,["module-id","period","remarks","suggestions"])]))}});var Xe=J(Je,[["__scopeId","data-v-0303c538"]]);export{Xe as default};
