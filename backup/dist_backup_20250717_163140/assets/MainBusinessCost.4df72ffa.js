import{_ as M,d as O,r as x,c as $,B as w,o as I,b as h,e,y as C,A as R,F as j,g as q,t as o,k as T,h as V,G as J,v as _,f as H}from"./index.e35cd37c.js";import{_ as L,M as f,r as G}from"./FormAttachmentAndRemarks.a9b1bd07.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},K={class:"mb-4"},Q={class:"flex items-center space-x-4"},W={class:"overflow-x-auto my-6"},X={class:"w-full border-collapse border border-gray-300"},Y=["rowspan"],Z={class:"border border-gray-300 px-4 py-2"},ee={class:"border border-gray-300 px-4 py-2 text-right"},te={class:"border border-gray-300 px-4 py-2"},ue=["onUpdate:modelValue"],re={class:"border border-gray-300 px-4 py-2 text-right"},ae={class:"border border-gray-300 px-4 py-2 text-right"},se={class:"text-sm font-medium"},oe={class:"border border-gray-300 px-4 py-2 text-right"},ne={class:"text-sm font-medium"},ce={class:"bg-gray-50 font-bold"},le={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"border border-gray-300 px-4 py-2 text-right"},ye={class:"border border-gray-300 px-4 py-2 text-right"},me={class:"text-sm font-bold"},pe={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"text-sm font-bold"},ge=O({__name:"MainBusinessCost",setup(ve){var N;const l=J(),a=x(((N=l.query.period)==null?void 0:N.toString())||new Date().toISOString().slice(0,7)),D={customers:[{customerName:"\u4E00\u5305\u9879\u76EE",yearlyPlan:4576.4,current:0,accumulated:0,revenueRatio:0},{customerName:"\u4E8C\u5305\u9879\u76EE",yearlyPlan:2441.97,current:0,accumulated:0,revenueRatio:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearlyPlan:3831.93,current:0,accumulated:0,revenueRatio:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearlyPlan:2410.82,current:0,accumulated:0,revenueRatio:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",yearlyPlan:3098.65,current:0,accumulated:0,revenueRatio:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",yearlyPlan:707.15,current:0,accumulated:0,revenueRatio:0},{customerName:"\u62A2\u4FEE\u9879\u76EE",yearlyPlan:183.74,current:0,accumulated:0,revenueRatio:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",yearlyPlan:1070.12,current:0,accumulated:0,revenueRatio:0},{customerName:"\u8BBE\u5907\u5916\u670D",yearlyPlan:242.25,current:0,accumulated:0,revenueRatio:0},{customerName:"\u6D3E\u9063",yearlyPlan:207.07,current:0,accumulated:0,revenueRatio:0},{customerName:"\u81EA\u5EFA\u9879\u76EE",yearlyPlan:0,current:0,accumulated:0,revenueRatio:0}]},n=x(JSON.parse(JSON.stringify(D))),i=x(""),y=x(""),c=u=>u===0?"0.00":u.toFixed(2),F=(u,t)=>!u||u===0?"0.00":(t/u*100).toFixed(2),d=$(()=>{const u={yearlyPlan:0,current:0,accumulated:0,revenueRatio:0};return n.value.customers.forEach(t=>{u.yearlyPlan+=t.yearlyPlan||0,u.current+=t.current||0,u.accumulated+=t.accumulated||0,u.revenueRatio+=t.revenueRatio||0}),u}),m=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/nanhua-main-business-cost/${u}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");return}const r=await t.json();r.data&&r.data.customers&&(n.value.customers=r.data.customers.map(s=>({customerName:s.customerName,yearlyPlan:Number(s.yearlyPlan)||0,current:Number(s.current)||0,accumulated:Number(s.accumulated)||0,revenueRatio:Number(s.revenueRatio)||0})))}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t)}},p=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${f.NANHUA_MAIN_BUSINESS_COST}/${u}`);if(t.ok){const r=await t.json();r.success&&r.data&&(i.value=r.data.remarks||"",y.value=r.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}},b=async u=>{try{const[t,r]=u.split("-"),s=parseInt(r);for(let g of n.value.customers){let A=0;for(let E=1;E<=s;E++){const S=`${t}-${E.toString().padStart(2,"0")}`;try{const v=await fetch(`http://47.111.95.19:3000/nanhua-main-business-cost/${S}`);if(v.ok){const B=(await v.json()).data.customers.find(U=>U.customerName===g.customerName);B&&(A+=B.current||0)}}catch(v){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${S}\u7684\u6570\u636E:`,v)}}g.accumulated=A}}catch(t){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u6570\u636E\u5931\u8D25:",t)}};w(()=>l.query.period,async u=>{u&&(a.value=u.toString(),await m(u.toString()),await b(u.toString()),p(u.toString()))}),w(a,async(u,t)=>{u&&u!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${u}`),await m(u),await b(u),p(u))});const k=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-main-business-cost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:a.value,data:n.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(f.NANHUA_MAIN_BUSINESS_COST,a.value,n.value,i.value,y.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25")}},P=()=>{n.value=JSON.parse(JSON.stringify(D)),i.value="",y.value=""};return I(async()=>{l.query.period?(await m(l.query.period.toString()),await b(l.query.period.toString()),p(l.query.period.toString())):(await m(a.value),await b(a.value),p(a.value))}),(u,t)=>(_(),h("div",z,[t[7]||(t[7]=e("div",{class:"flex justify-between items-center mb-6"},[e("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u7ED3\u6784\u4E0E\u8D28\u91CF"),e("div",{class:"flex items-center space-x-4"},[e("span",{class:"text-sm text-gray-600"},"\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09")])],-1)),e("div",K,[t[4]||(t[4]=e("h2",{class:"text-lg font-semibold mb-2"},"\u5BF9\u5E94\u5E74\u5EA6\u8BA1\u5212\uFF1A",-1)),e("div",Q,[t[3]||(t[3]=e("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),C(e("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>a.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[R,a.value]])])]),e("div",W,[e("table",X,[t[6]||(t[6]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u8BA1\u5212\u6267\u884C\u8FDB\u5EA6"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5360\u4E3B\u8425\u6536\u5165\u6BD4")])],-1)),e("tbody",null,[(_(!0),h(j,null,q(n.value.customers,(r,s)=>(_(),h("tr",{key:`customer-${s}`},[s===0?(_(),h("td",{key:0,rowspan:n.value.customers.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Y)):H("",!0),e("td",Z,o(r.customerName),1),e("td",ee,o(c(r.yearlyPlan)),1),e("td",te,[C(e("input",{"onUpdate:modelValue":g=>r.current=g,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ue),[[R,r.current]])]),e("td",re,o(c(r.accumulated)),1),e("td",ae,[e("span",se,o(F(r.yearlyPlan,r.accumulated))+"%",1)]),e("td",oe,[e("span",ne,o(c(r.revenueRatio))+"%",1)])]))),128)),e("tr",ce,[t[5]||(t[5]=e("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),e("td",le,o(c(d.value.yearlyPlan)),1),e("td",de,o(c(d.value.current)),1),e("td",ie,o(c(d.value.accumulated)),1),e("td",ye,[e("span",me,o(F(d.value.yearlyPlan,d.value.accumulated))+"%",1)]),e("td",pe,[e("span",be,o(c(d.value.revenueRatio))+"%",1)])])])])]),T(L,{"module-id":V(f).NANHUA_MAIN_BUSINESS_COST,period:a.value,remarks:i.value,"onUpdate:remarks":t[1]||(t[1]=r=>i.value=r),suggestions:y.value,"onUpdate:suggestions":t[2]||(t[2]=r=>y.value=r)},null,8,["module-id","period","remarks","suggestions"]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:k,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:P,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ee=M(ge,[["__scopeId","data-v-fa0b40b2"]]);export{Ee as default};
