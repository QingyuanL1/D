import{_ as z,d as Y,r as m,c as S,B as $,o as K,b as y,e as o,y as f,A as F,F as j,g as q,t as s,k as Q,h as W,G as X,v as p,f as N}from"./index.c6cffffe.js";import{M as Z,_ as ee,r as re,l as te}from"./FormAttachmentAndRemarks.e72709f6.js";const oe={class:"project-tracking-container"},ue={class:"mx-auto bg-white rounded-lg shadow-lg"},ae={class:"p-6 border-b border-gray-200"},ne={class:"flex justify-between items-center"},se={class:"flex items-center space-x-4"},le={class:"p-6"},ce={class:"overflow-x-auto rounded-lg border border-gray-300"},de={class:"w-full border-collapse text-base"},ie=["rowspan"],ye={class:"border border-gray-300 px-4 py-2 text-center"},pe={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ge={class:"border border-gray-300 px-4 py-2 text-right"},be=["onUpdate:modelValue"],me={class:"border border-gray-300 px-4 py-2 text-right"},he={class:"font-medium"},xe={class:"border border-gray-300 px-4 py-2 text-right"},ve=["rowspan"],_e={class:"border border-gray-300 px-4 py-2 text-center"},De={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},Te={class:"border border-gray-300 px-4 py-2 text-right"},Pe=["onUpdate:modelValue"],fe={class:"border border-gray-300 px-4 py-2 text-right"},Fe={class:"font-medium"},Ee={class:"border border-gray-300 px-4 py-2 text-right"},Ce=["rowspan"],Be={class:"border border-gray-300 px-4 py-2 text-center"},Ae={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},we={class:"border border-gray-300 px-4 py-2 text-right"},ke=["onUpdate:modelValue"],Se={class:"border border-gray-300 px-4 py-2 text-right"},$e={class:"font-medium"},je={class:"border border-gray-300 px-4 py-2 text-right"},qe={class:"bg-gray-50 font-bold"},Ne={class:"border border-gray-300 px-4 py-2 text-right"},Ue={class:"border border-gray-300 px-4 py-2 text-right"},Oe={class:"border border-gray-300 px-4 py-2 text-right"},Ve={class:"border border-gray-300 px-4 py-2 text-right"},Ie=Y({__name:"ProjectTracking",setup(Re){var M;const U=X(),i=m(((M=U.query.period)==null?void 0:M.toString())||new Date().toISOString().slice(0,7)),E=Z.PROJECT_TRACKING,x=m(""),v=m(""),_=()=>[{customerType:"\u4E0A\u6D77",yearlyPlan:5e5,currentPeriod:0,currentTotal:0},{customerType:"\u56FD\u7F51",yearlyPlan:105e4,currentPeriod:0,currentTotal:0},{customerType:"\u6C5F\u82CF",yearlyPlan:3e5,currentPeriod:0,currentTotal:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",yearlyPlan:0,currentPeriod:0,currentTotal:0},{customerType:"\u897F\u95E8\u5B50",yearlyPlan:0,currentPeriod:0,currentTotal:0},{customerType:"\u540C\u4E1A",yearlyPlan:0,currentPeriod:0,currentTotal:0},{customerType:"\u7528\u6237",yearlyPlan:2e4,currentPeriod:0,currentTotal:0},{customerType:"\u5176\u5B83",yearlyPlan:0,currentPeriod:0,currentTotal:0}],D=()=>[{customerType:"\u7528\u6237",yearlyPlan:0,currentPeriod:0,currentTotal:0}],T=()=>[{customerType:"\u4E00\u5305",yearlyPlan:15e4,currentPeriod:0,currentTotal:0},{customerType:"\u4E8C\u5305",yearlyPlan:600,currentPeriod:0,currentTotal:0},{customerType:"\u57DF\u5185\u5408\u4F5C",yearlyPlan:95e3,currentPeriod:0,currentTotal:0},{customerType:"\u57DF\u5916\u5408\u4F5C",yearlyPlan:5e3,currentPeriod:0,currentTotal:0},{customerType:"\u5176\u5B83",yearlyPlan:2e3,currentPeriod:0,currentTotal:0}],l=m(_()),c=m(D()),d=m(T()),O=S(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.yearlyPlan||0),0)),J=S(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.currentPeriod||0),0)),V=S(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.currentTotal||0),0)),I=m([]),R=async e=>{try{const t=[],r=e.substring(0,4),u=parseInt(e.substring(5,7));for(let n=1;n<u;n++){const a=`${r}-${n.toString().padStart(2,"0")}`;try{const b=await fetch(`http://47.111.95.19:3000/project-tracking/${a}`);if(b.ok){const h=await b.json();h.success&&h.data&&t.push({period:a,data:h.data})}}catch(b){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${a}:`,b)}}I.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},C=(e,t)=>{let r=0;for(const a of I.value)if(a.data[e]){const b=a.data[e].find(h=>h.customerType===t);b&&b.currentPeriod&&(r+=parseFloat(b.currentPeriod.toString())||0)}let u=[];e==="equipment"?u=l.value:e==="component"?u=c.value:e==="engineering"&&(u=d.value);const n=u.find(a=>a.customerType===t);return n&&n.currentPeriod&&(r+=parseFloat(n.currentPeriod.toString())||0),r},B=()=>{l.value.forEach(e=>{const t=C("equipment",e.customerType);e.currentTotal=t}),c.value.forEach(e=>{const t=C("component",e.customerType);e.currentTotal=t}),d.value.forEach(e=>{const t=C("engineering",e.customerType);e.currentTotal=t})},P=(e,t)=>!t||t===0?"0.00%":`${(e/t*100).toFixed(2)}%`,A=(e,t)=>!t||t===0?0:e/t*100,g=e=>e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),w=(e,t)=>e.map(r=>{const u=t.find(n=>n.customer===r.customerType);return u?(console.log(`\u5339\u914D\u6210\u529F: ${r.customerType} -> \u5F53\u671F: ${u.currentPeriod}`),{customerType:r.customerType,yearlyPlan:r.yearlyPlan,currentPeriod:Number(u.currentPeriod)||0,currentTotal:0}):(console.log(`\u672A\u5339\u914D\u5230\u6570\u636E: ${r.customerType}`),r)}),k=async e=>{try{const t=`http://47.111.95.19:3000/project-tracking/${e}`;console.log(`\u6B63\u5728\u52A0\u8F7D\u671F\u95F4 ${e} \u7684\u6570\u636E...`),console.log(`API URL: ${t}`);const r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("HTTP\u54CD\u5E94\u72B6\u6001:",r.status),console.log("HTTP\u54CD\u5E94\u5934:",Object.fromEntries(r.headers.entries())),!r.ok){if(r.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),l.value=_(),c.value=D(),d.value=T(),await R(e),B();return}const n=await r.text();throw console.error(`HTTP\u9519\u8BEF ${r.status}:`,n),new Error(`\u52A0\u8F7D\u6570\u636E\u5931\u8D25: ${r.status} - ${n}`)}const u=await r.json();console.log("API\u8FD4\u56DE\u7684\u5B8C\u6574\u6570\u636E:",JSON.stringify(u,null,2)),u.success&&u.data?(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5904\u7406..."),u.data.equipment&&Array.isArray(u.data.equipment)&&u.data.equipment.length>0&&(console.log("\u5904\u7406\u8BBE\u5907\u6570\u636E:",u.data.equipment),l.value=w(_(),u.data.equipment)),u.data.components&&Array.isArray(u.data.components)&&u.data.components.length>0&&(console.log("\u5904\u7406\u5143\u4EF6\u6570\u636E:",u.data.components),c.value=w(D(),u.data.components)),u.data.engineering&&Array.isArray(u.data.engineering)&&u.data.engineering.length>0&&(console.log("\u5904\u7406\u5DE5\u7A0B\u6570\u636E:",u.data.engineering),d.value=w(T(),u.data.engineering)),console.log("\u6570\u636E\u52A0\u8F7D\u5B8C\u6210\uFF01\u6700\u7EC8\u7ED3\u679C:"),console.log("equipmentData:",JSON.stringify(l.value,null,2)),console.log("componentData:",JSON.stringify(c.value,null,2)),console.log("engineeringData:",JSON.stringify(d.value,null,2))):console.log("API\u8FD4\u56DE\u683C\u5F0F\u4E0D\u6B63\u786E:",u),await R(e),B()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t)}};$(()=>[l.value.map(e=>e.currentPeriod),c.value.map(e=>e.currentPeriod),d.value.map(e=>e.currentPeriod)],()=>{B()},{deep:!0}),$(i,e=>{k(e)}),$(()=>U.query.period,e=>{e&&(i.value=e.toString(),k(e.toString()))});const L=async()=>{try{const e=l.value.map(a=>({customer:a.customerType||"",yearlyPlan:a.yearlyPlan||0,currentPeriod:a.currentPeriod||0,currentTotal:a.currentTotal||0,progress:A(a.currentTotal||0,a.yearlyPlan||0)})),t=c.value.map(a=>({customer:a.customerType||"",yearlyPlan:a.yearlyPlan||0,currentPeriod:a.currentPeriod||0,currentTotal:a.currentTotal||0,progress:A(a.currentTotal||0,a.yearlyPlan||0)})),r=d.value.map(a=>({customer:a.customerType||"",yearlyPlan:a.yearlyPlan||0,currentPeriod:a.currentPeriod||0,currentTotal:a.currentTotal||0,progress:A(a.currentTotal||0,a.yearlyPlan||0)})),u={period:i.value,data:{equipment:e,components:t,engineering:r}};console.log("\u4FDD\u5B58\u6570\u636E:",u);const n=await fetch("http://47.111.95.19:3000/project-tracking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!n.ok){const a=await n.text();throw new Error(`\u4FDD\u5B58\u5230project_tracking\u8868\u5931\u8D25: ${n.status} - ${a}`)}await re(E,i.value,u.data,x.value,v.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},G=()=>{l.value=_(),c.value=D(),d.value=T(),console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},H=async()=>{const{remarks:e,suggestions:t}=await te(E,i.value);x.value=e,v.value=t};return K(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",i.value),k(i.value),H()}),(e,t)=>(p(),y("div",oe,[o("div",ue,[o("div",ae,[o("div",ne,[t[3]||(t[3]=o("h1",{class:"text-2xl font-bold"},"\u9879\u76EE\u8DDF\u8E2A\u60C5\u51B5:",-1)),o("div",se,[f(o("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>i.value=r),type:"month",class:"px-4 py-2 border rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[F,i.value]])])])]),o("div",le,[o("div",ce,[o("table",de,[t[5]||(t[5]=o("thead",{class:"sticky top-0 bg-white shadow-sm z-10"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u677F\u5757 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u5BA2\u6237\u5C5E\u6027 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u5E74\u5EA6\u8BA1\u5212 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u5F53\u671F "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u7D2F\u8BA1 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u6267\u884C\u8FDB\u5EA6 ")])],-1)),o("tbody",null,[(p(!0),y(j,null,q(l.value,(r,u)=>(p(),y("tr",{key:`equipment-${u}`},[u===0?(p(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:l.value.length}," \u8BBE\u5907 ",8,ie)):N("",!0),o("td",ye,s(r.customerType),1),o("td",pe,s(g(r.yearlyPlan)),1),o("td",ge,[f(o("input",{"onUpdate:modelValue":n=>r.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,be),[[F,r.currentPeriod,void 0,{number:!0}]])]),o("td",me,[o("span",he,s(g(r.currentTotal)),1)]),o("td",xe,s(P(r.currentTotal,r.yearlyPlan)),1)]))),128)),(p(!0),y(j,null,q(c.value,(r,u)=>(p(),y("tr",{key:`component-${u}`},[u===0?(p(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:c.value.length}," \u5143\u4EF6 ",8,ve)):N("",!0),o("td",_e,s(r.customerType),1),o("td",De,s(g(r.yearlyPlan)),1),o("td",Te,[f(o("input",{"onUpdate:modelValue":n=>r.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Pe),[[F,r.currentPeriod,void 0,{number:!0}]])]),o("td",fe,[o("span",Fe,s(g(r.currentTotal)),1)]),o("td",Ee,s(P(r.currentTotal,r.yearlyPlan)),1)]))),128)),(p(!0),y(j,null,q(d.value,(r,u)=>(p(),y("tr",{key:`engineering-${u}`},[u===0?(p(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:d.value.length}," \u5DE5\u7A0B ",8,Ce)):N("",!0),o("td",Be,s(r.customerType),1),o("td",Ae,s(g(r.yearlyPlan)),1),o("td",we,[f(o("input",{"onUpdate:modelValue":n=>r.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ke),[[F,r.currentPeriod,void 0,{number:!0}]])]),o("td",Se,[o("span",$e,s(g(r.currentTotal)),1)]),o("td",je,s(P(r.currentTotal,r.yearlyPlan)),1)]))),128)),o("tr",qe,[t[4]||(t[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",Ne,s(g(O.value)),1),o("td",Ue,s(g(J.value)),1),o("td",Oe,s(g(V.value)),1),o("td",Ve,s(P(V.value,O.value)),1)])])])])]),o("div",{class:"p-6 border-t border-gray-200"},[o("div",{class:"flex justify-end space-x-4"},[o("button",{onClick:L,class:"px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"}," \u4FDD\u5B58 "),o("button",{onClick:G,class:"px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"}," \u91CD\u7F6E ")])]),Q(ee,{"module-id":W(E),period:i.value,remarks:x.value,"onUpdate:remarks":t[1]||(t[1]=r=>x.value=r),suggestions:v.value,"onUpdate:suggestions":t[2]||(t[2]=r=>v.value=r)},null,8,["module-id","period","remarks","suggestions"])])]))}});var Le=z(Ie,[["__scopeId","data-v-e3e7f434"]]);export{Le as default};
