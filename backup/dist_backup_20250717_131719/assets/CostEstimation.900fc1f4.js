import{_ as P,d as j,r as y,B as f,c as I,o as M,b as v,e as u,y as R,A as Y,F as V,g as J,t as c,k as q,h as L,G,v as _,f as z}from"./index.c6cffffe.js";import{_ as H,M as x,r as K}from"./FormAttachmentAndRemarks.e72709f6.js";const Q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Z={class:"overflow-x-auto my-6"},tt={class:"w-full border-collapse border border-gray-300"},et=["rowspan"],ut={class:"border border-gray-300 px-4 py-2"},rt={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"border border-gray-300 px-4 py-2"},ot=["onUpdate:modelValue"],st={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"border border-gray-300 px-4 py-2 text-right"},it={class:"text-sm font-medium"},ct={class:"bg-gray-50 font-bold"},mt={class:"border border-gray-300 px-4 py-2 text-right"},lt={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},gt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"text-sm font-bold"},bt=j({__name:"CostEstimation",setup(At){var F;const B=G(),i=y(((F=B.query.period)==null?void 0:F.toString())||new Date().toISOString().slice(0,7)),E={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0}]},a=y(JSON.parse(JSON.stringify(E))),g=y(""),p=y(""),b=t=>{if(t==null||isNaN(Number(t)))return"0.00";const e=Number(t);return e===0?"0.00":e.toFixed(2)},N=t=>{if(t==null||isNaN(Number(t)))return"0.00";const e=Number(t);return e===0?"0.00":e.toFixed(2)},$=t=>t===0?!0:a.value.items[t].segmentAttribute!==a.value.items[t-1].segmentAttribute,k=t=>a.value.items.filter(e=>e.segmentAttribute===t).length,O=async t=>{try{const[e]=t.split("-"),r=parseInt(t.split("-")[1]);for(let n of a.value.items){let o=0;for(let s=1;s<=r;s++){const d=`${e}-${s.toString().padStart(2,"0")}`;try{const m=await fetch(`http://47.111.95.19:3000/tuoyuan-cost-estimation/${d}`);if(m.ok){const C=(await m.json()).data.items.find(S=>S.segment_attribute===n.segmentAttribute&&S.customer_attribute===n.customerAttribute);C&&(o+=Number(C.current_period_new_amount)||0)}}catch(m){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${d}\u7684\u6570\u636E:`,m)}}if(t===i.value)try{const s=await fetch(`http://47.111.95.19:3000/tuoyuan-cost-estimation/${t}`);if(s.ok){const m=(await s.json()).data.items.find(h=>h.segment_attribute===n.segmentAttribute&&h.customer_attribute===n.customerAttribute);m&&(o=o-(Number(m.current_period_new_amount)||0)+(Number(n.currentPeriodNewAmount)||0))}}catch(s){console.warn("\u83B7\u53D6\u5F53\u524D\u6708\u4EFD\u6570\u636E\u5931\u8D25:",s)}n.currentYearCumulative=(Number(n.yearBeginningAmount)||0)+o,n.provisionRate=n.yearBeginningAmount>0?o/n.yearBeginningAmount*100:o!==0?o>0?100:-100:0,console.log(`${n.segmentAttribute}-${n.customerAttribute}: \u5E74\u521D=${n.yearBeginningAmount}, \u7D2F\u8BA1\u65B0\u589E=${o}, \u672C\u5E74\u7D2F\u8BA1=${n.currentYearCumulative}`)}}catch(e){console.error("\u8BA1\u7B97\u672C\u5E74\u7D2F\u8BA1\u5931\u8D25:",e)}};f(()=>a.value.items.map(t=>t.currentPeriodNewAmount),()=>{a.value.items.forEach(t=>{const e=Number(t.currentPeriodNewAmount)||0;t.currentYearCumulative=(Number(t.yearBeginningAmount)||0)+e,t.provisionRate=t.yearBeginningAmount>0?e/t.yearBeginningAmount*100:e!==0?e>0?100:-100:0})},{deep:!0});const A=I(()=>{const t={yearBeginningAmount:0,currentPeriodNewAmount:0,currentYearCumulative:0,provisionRate:0};a.value.items.forEach(r=>{t.yearBeginningAmount+=r.yearBeginningAmount||0,t.currentPeriodNewAmount+=r.currentPeriodNewAmount||0,t.currentYearCumulative+=r.currentYearCumulative||0});const e=t.currentYearCumulative-t.yearBeginningAmount;return t.provisionRate=t.yearBeginningAmount>0?e/t.yearBeginningAmount*100:e!==0?e>0?100:-100:0,t}),D=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-cost-estimation/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),l();return}const r=await e.json();if(console.log("API\u8FD4\u56DE\u7684\u6570\u636E:",r),r.data&&r.data.items){const n=r.data.items;console.log("\u6570\u636E\u5E93\u9879\u76EE:",n),a.value.items=E.items.map(o=>{const s=n.find(d=>d.segment_attribute===o.segmentAttribute&&d.customer_attribute===o.customerAttribute);return console.log(`\u5339\u914D\u9879\u76EE ${o.segmentAttribute}-${o.customerAttribute}:`,s),{segmentAttribute:o.segmentAttribute,customerAttribute:o.customerAttribute,yearBeginningAmount:s?Number(s.year_beginning_amount)||0:o.yearBeginningAmount,currentPeriodNewAmount:s&&Number(s.current_period_new_amount)||0,currentYearCumulative:s&&Number(s.current_year_cumulative)||0,provisionRate:s&&Number(s.provision_rate)||0}}),console.log("\u6700\u7EC8\u5904\u7406\u540E\u7684\u6570\u636E:",a.value.items)}await O(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),l()}},l=()=>{a.value=JSON.parse(JSON.stringify(E))},w=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${x.TUOYUAN_COST_ESTIMATION}/${t}`);if(e.ok){const r=await e.json();r.success&&r.data&&(g.value=r.data.remarks||"",p.value=r.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};f(()=>B.query.period,async t=>{t&&(i.value=t.toString(),l(),await D(t.toString()),w(t.toString()))}),f(i,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),l(),await D(t),w(t))});const T=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-cost-estimation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:i.value,data:{items:a.value.items.map(e=>({segmentAttribute:e.segmentAttribute,customerAttribute:e.customerAttribute,yearBeginningAmount:e.yearBeginningAmount,currentPeriodNewAmount:e.currentPeriodNewAmount}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await K(x.TUOYUAN_COST_ESTIMATION,i.value,{items:a.value.items},g.value,p.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},U=()=>{l(),g.value="",p.value=""};return M(async()=>{var e;l();const t=((e=B.query.period)==null?void 0:e.toString())||i.value;await D(t),w(t)}),(t,e)=>(_(),v("div",Q,[u("div",W,[e[5]||(e[5]=u("h1",{class:"text-2xl font-bold"},"\u62D3\u6E90\u6210\u672C\u6682\u4F30\u5165\u5E93\u548C\u8BA1\u63D0\u60C5\u51B5",-1)),u("div",X,[e[3]||(e[3]=u("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[4]||(e[4]=u("span",{class:"text-xs text-gray-500"},"\u672C\u5E74\u7D2F\u8BA1 = \u5E74\u521D\u91D1\u989D + \u5F53\u671F\u65B0\u589E\u7D2F\u8BA1",-1)),R(u("input",{"onUpdate:modelValue":e[0]||(e[0]=r=>i.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[Y,i.value]])])]),u("div",Z,[u("table",tt,[e[7]||(e[7]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u521D\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u65B0\u589E"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u672C\u5E74\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u8BA1\u63D0\u7387")])],-1)),u("tbody",null,[(_(!0),v(V,null,J(a.value.items,(r,n)=>(_(),v("tr",{key:`item-${n}`},[$(n)?(_(),v("td",{key:0,rowspan:k(r.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},c(r.segmentAttribute),9,et)):z("",!0),u("td",ut,c(r.customerAttribute),1),u("td",rt,c(b(r.yearBeginningAmount)),1),u("td",nt,[R(u("input",{"onUpdate:modelValue":o=>r.currentPeriodNewAmount=o,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ot),[[Y,r.currentPeriodNewAmount]])]),u("td",st,c(b(r.currentYearCumulative)),1),u("td",at,[u("span",it,c(N(r.provisionRate))+"%",1)])]))),128)),u("tr",ct,[e[6]||(e[6]=u("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u("td",mt,c(b(A.value.yearBeginningAmount)),1),u("td",lt,c(b(A.value.currentPeriodNewAmount)),1),u("td",dt,c(b(A.value.currentYearCumulative)),1),u("td",gt,[u("span",pt,c(N(A.value.provisionRate))+"%",1)])])])])]),q(H,{"module-id":L(x).TUOYUAN_COST_ESTIMATION,period:i.value,remarks:g.value,"onUpdate:remarks":e[1]||(e[1]=r=>g.value=r),suggestions:p.value,"onUpdate:suggestions":e[2]||(e[2]=r=>p.value=r)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:T,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:U,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var _t=P(bt,[["__scopeId","data-v-67034124"]]);export{_t as default};
