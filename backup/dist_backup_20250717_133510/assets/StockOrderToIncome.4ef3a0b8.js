import{_ as Y,d as G,r as v,c as D,B as A,o as J,b as p,e as u,y as b,A as F,F as T,g as M,t as a,k as z,h as H,G as Q,v as i,f as R}from"./index.5a957267.js";import{_ as W,M as E,r as X,l as Z}from"./FormAttachmentAndRemarks.4a953a70.js";const ee={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},oe={class:"flex justify-between items-center mb-6"},ue={class:"flex items-center space-x-4"},te={class:"overflow-x-auto my-6"},re={class:"w-full border-collapse border border-gray-300"},ne=["rowspan"],se={class:"border border-gray-300 px-4 py-2"},ae={class:"border border-gray-300 px-4 py-2"},ce={class:"border border-gray-300 px-4 py-2"},le=["onUpdate:modelValue","onInput"],de={class:"border border-gray-300 px-4 py-2"},pe=["onUpdate:modelValue","onInput"],ie={class:"border border-gray-300 px-4 py-2"},me={class:"font-medium"},ye={class:"border border-gray-300 px-4 py-2"},ge=["rowspan"],be={class:"border border-gray-300 px-4 py-2"},Fe={class:"border border-gray-300 px-4 py-2"},he={class:"border border-gray-300 px-4 py-2"},_e=["onUpdate:modelValue","onInput"],ve={class:"border border-gray-300 px-4 py-2"},De=["onUpdate:modelValue","onInput"],Ee={class:"border border-gray-300 px-4 py-2"},Ie={class:"font-medium"},fe={class:"border border-gray-300 px-4 py-2"},xe=["rowspan"],Be={class:"border border-gray-300 px-4 py-2"},Ce={class:"border border-gray-300 px-4 py-2"},ke={class:"border border-gray-300 px-4 py-2"},Oe=["onUpdate:modelValue","onInput"],Ae={class:"border border-gray-300 px-4 py-2"},Te=["onUpdate:modelValue","onInput"],Me={class:"border border-gray-300 px-4 py-2"},Re={class:"font-medium"},we={class:"border border-gray-300 px-4 py-2"},Se={class:"bg-gray-50 font-bold"},$e={class:"border border-gray-300 px-4 py-2"},qe={class:"border border-gray-300 px-4 py-2"},Ue={class:"border border-gray-300 px-4 py-2"},Ne={class:"border border-gray-300 px-4 py-2"},Ve={class:"border border-gray-300 px-4 py-2"},je=G({__name:"StockOrderToIncome",setup(Ke){var U;const I=Q(),c=v(((U=I.query.period)==null?void 0:U.toString())||new Date().toISOString().slice(0,7)),h=v(""),_=v(""),w=()=>({equipment:[{customer:"\u4E0A\u6D77",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u56FD\u7F51",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u6C5F\u82CF",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u8F93\u914D\u7535\u5185\u914D",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u897F\u95E8\u5B50",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u540C\u4E1A",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u7528\u6237",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u5176\u5B83",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0}],components:[{customer:"\u7528\u6237",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0}],engineering:[{customer:"\u4E00\u5305",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u4E8C\u5305",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u57DF\u5185\u5408\u4F5C",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u57DF\u5916\u5408\u4F5C",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u5176\u5B83",stockOrder:0,currentMonthIncome:0,incomeTotal:0,incomeRate:0}]}),r=v(w()),S=v([]),d=e=>e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),f=e=>isNaN(e)||e===null||e===void 0?"0.00%":e.toFixed(2)+"%",$=async e=>{try{const t=[],o=e.substring(0,4),n=parseInt(e.substring(5,7));for(let s=1;s<n;s++){const m=`${o}-${s.toString().padStart(2,"0")}`;try{const y=await fetch(`http://47.111.95.19:3000/stock-order-to-income/${m}`);if(y.ok){const g=await y.json();g.success&&g.data&&t.push({period:m,data:g.data})}}catch(y){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${m}:`,y)}}S.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},B=(e,t)=>{let o=0;for(const m of S.value){const y=m.data[e];if(y){const g=y.find(P=>P.customer===t);g&&g.currentMonthIncome&&(o+=g.currentMonthIncome)}}const s=r.value[e].find(m=>m.customer===t);return s&&s.currentMonthIncome&&(o+=s.currentMonthIncome),o},C=()=>{r.value.equipment.forEach(e=>{e.incomeTotal=B("equipment",e.customer)}),r.value.components.forEach(e=>{e.incomeTotal=B("components",e.customer)}),r.value.engineering.forEach(e=>{e.incomeTotal=B("engineering",e.customer)})},l=e=>{C(),e.stockOrder>0?e.incomeRate=parseFloat((e.incomeTotal/e.stockOrder*100).toFixed(2)):e.incomeRate=0},N=D(()=>[...r.value.equipment,...r.value.components,...r.value.engineering].reduce((t,o)=>t+(Number(o.yearlyPlan)||0),0)),k=D(()=>[...r.value.equipment,...r.value.components,...r.value.engineering].reduce((t,o)=>t+(Number(o.stockOrder)||0),0)),V=D(()=>[...r.value.equipment,...r.value.components,...r.value.engineering].reduce((t,o)=>t+(Number(o.currentMonthIncome)||0),0)),q=D(()=>[...r.value.equipment,...r.value.components,...r.value.engineering].reduce((t,o)=>t+(Number(o.incomeTotal)||0),0)),j=D(()=>k.value>0?parseFloat((q.value/k.value*100).toFixed(2)):0);A(()=>r.value,()=>{r.value.equipment.forEach(e=>l(e)),r.value.components.forEach(e=>l(e)),r.value.engineering.forEach(e=>l(e))},{deep:!0});const x=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u5B58\u91CF\u8BA2\u5355\u8F6C\u6536\u5165\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const t=await fetch(`http://47.111.95.19:3000/stock-order-to-income/${e}`);if(!t.ok){if(t.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u5E74\u5EA6\u8BA1\u5212\u4F46\u6E05\u7A7A\u5F53\u6708\u8F6C\u6536\u5165"),r.value.equipment.forEach(n=>{n.stockOrder=0,n.currentMonthIncome=0,n.incomeRate=0}),r.value.components.forEach(n=>{n.stockOrder=0,n.currentMonthIncome=0,n.incomeRate=0}),r.value.engineering.forEach(n=>{n.stockOrder=0,n.currentMonthIncome=0,n.incomeRate=0}),await $(e),C();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const o=await t.json();console.log("API\u8FD4\u56DE\u6570\u636E:",o),o.success&&o.data&&(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5904\u7406..."),r.value=o.data,console.log("API\u6570\u636E:",r.value)),await $(e),C(),r.value.equipment.forEach(n=>l(n)),r.value.components.forEach(n=>l(n)),r.value.engineering.forEach(n=>l(n))}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t)}};A(()=>I.query.period,e=>{e&&(c.value=e.toString(),x(e.toString()),O())}),A(c,e=>{x(e),O()});const K=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u5B58\u91CF\u8BA2\u5355\u8F6C\u6536\u5165\u6570\u636E ==="),console.log("\u671F\u95F4:",c.value),console.log("\u6A21\u5757ID:",E.STOCK_ORDER_TO_INCOME),console.log("\u8868\u5355\u6570\u636E:",r.value),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const e=await fetch("http://47.111.95.19:3000/stock-order-to-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:r.value})});if(!e.ok){const n=await e.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",n),new Error(`\u4FDD\u5B58\u5931\u8D25: ${e.status} - ${n}`)}const t=await e.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",t),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001..."),console.log("\u8C03\u7528\u53C2\u6570:",{moduleId:E.STOCK_ORDER_TO_INCOME,period:c.value,formData:r.value,remarks:h.value,suggestions:_.value});const o=await X(E.STOCK_ORDER_TO_INCOME,c.value,r.value,h.value,_.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",o),o?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(e){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},L=()=>{r.value=w(),h.value="",_.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},O=async()=>{const{remarks:e,suggestions:t}=await Z(E.STOCK_ORDER_TO_INCOME,c.value);h.value=e,_.value=t};return J(()=>{console.log("\u5B58\u91CF\u8BA2\u5355\u8F6C\u6536\u5165\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",c.value),I.query.period?x(I.query.period.toString()):x(c.value),O()}),(e,t)=>(i(),p("div",ee,[u("div",oe,[t[3]||(t[3]=u("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u2014\u2014\u5B58\u91CF\u8BA2\u5355\u8F6C\u6536\u5165",-1)),u("div",ue,[b(u("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>c.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[F,c.value]])])]),u("div",te,[u("table",re,[t[6]||(t[6]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u5B58\u91CF\u8BA2\u5355\u4F59\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u8F6C\u6536\u5165"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u8F6C\u6536\u5165"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F80\u5E74\u8BA2\u5355\u8F6C\u6536\u5165\u6BD4\u7387")])],-1)),u("tbody",null,[(i(!0),p(T,null,M(r.value.equipment,(o,n)=>(i(),p("tr",{key:`equipment-${n}`},[n===0?(i(),p("td",{key:0,rowspan:r.value.equipment.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u8BBE\u5907 ",8,ne)):R("",!0),u("td",se,a(o.customer),1),u("td",ae,a(d(o.yearlyPlan||0)),1),u("td",ce,[b(u("input",{"onUpdate:modelValue":s=>o.stockOrder=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(o)},null,40,le),[[F,o.stockOrder,void 0,{number:!0}]])]),u("td",de,[b(u("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(o)},null,40,pe),[[F,o.currentMonthIncome,void 0,{number:!0}]])]),u("td",ie,[u("span",me,a(d(o.incomeTotal||0)),1)]),u("td",ye,a(f(o.incomeRate)),1)]))),128)),(i(!0),p(T,null,M(r.value.components,(o,n)=>(i(),p("tr",{key:`components-${n}`},[n===0?(i(),p("td",{key:0,rowspan:r.value.components.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5143\u4EF6 ",8,ge)):R("",!0),u("td",be,a(o.customer),1),u("td",Fe,a(d(o.yearlyPlan||0)),1),u("td",he,[b(u("input",{"onUpdate:modelValue":s=>o.stockOrder=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(o)},null,40,_e),[[F,o.stockOrder,void 0,{number:!0}]])]),u("td",ve,[b(u("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(o)},null,40,De),[[F,o.currentMonthIncome,void 0,{number:!0}]])]),u("td",Ee,[u("span",Ie,a(d(o.incomeTotal||0)),1)]),u("td",fe,a(f(o.incomeRate)),1)]))),128)),(i(!0),p(T,null,M(r.value.engineering,(o,n)=>(i(),p("tr",{key:`engineering-${n}`},[n===0?(i(),p("td",{key:0,rowspan:r.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,xe)):R("",!0),u("td",Be,a(o.customer),1),u("td",Ce,a(d(o.yearlyPlan||0)),1),u("td",ke,[b(u("input",{"onUpdate:modelValue":s=>o.stockOrder=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(o)},null,40,Oe),[[F,o.stockOrder,void 0,{number:!0}]])]),u("td",Ae,[b(u("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:s=>l(o)},null,40,Te),[[F,o.currentMonthIncome,void 0,{number:!0}]])]),u("td",Me,[u("span",Re,a(d(o.incomeTotal||0)),1)]),u("td",we,a(f(o.incomeRate)),1)]))),128)),u("tr",Se,[t[4]||(t[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),t[5]||(t[5]=u("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),u("td",$e,a(d(N.value)),1),u("td",qe,a(d(k.value)),1),u("td",Ue,a(d(V.value)),1),u("td",Ne,a(d(q.value)),1),u("td",Ve,a(f(j.value)),1)])])])]),z(W,{"module-id":H(E).STOCK_ORDER_TO_INCOME,period:c.value,remarks:h.value,"onUpdate:remarks":t[1]||(t[1]=o=>h.value=o),suggestions:_.value,"onUpdate:suggestions":t[2]||(t[2]=o=>_.value=o)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:K,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:L,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ye=Y(je,[["__scopeId","data-v-3d1dba28"]]);export{Ye as default};
