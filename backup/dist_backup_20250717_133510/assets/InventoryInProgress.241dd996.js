import{_ as R,d as V,r as p,c as O,B as S,o as U,b as m,e as u,y as x,A as F,F as E,g as D,t as s,k as $,h as G,G as M,v as d,f as N}from"./index.5a957267.js";import{_ as L,M as T,r as Y}from"./FormAttachmentAndRemarks.4a953a70.js";const P={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},z={class:"flex justify-between items-center mb-6"},J={class:"flex items-center space-x-4"},H={class:"overflow-x-auto my-6"},K={class:"w-full border-collapse border border-gray-300"},Q=["rowspan"],W={class:"border border-gray-300 px-4 py-2"},X={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},Z={class:"border border-gray-300 px-4 py-2"},ee=["onUpdate:modelValue"],oe={class:"border border-gray-300 px-4 py-2 text-right"},te=["rowspan"],re={class:"border border-gray-300 px-4 py-2"},ue={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ne={class:"border border-gray-300 px-4 py-2"},se=["onUpdate:modelValue"],ae={class:"border border-gray-300 px-4 py-2 text-right"},le=["rowspan"],ce={class:"border border-gray-300 px-4 py-2"},ye={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},me={class:"border border-gray-300 px-4 py-2"},de=["onUpdate:modelValue"],pe={class:"border border-gray-300 px-4 py-2 text-right"},ge={class:"bg-gray-50 font-bold"},ie={class:"border border-gray-300 px-4 py-2 text-right"},he={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"border border-gray-300 px-4 py-2 text-right"},ve=V({__name:"InventoryInProgress",setup(_e){var w;const g=M(),a=p(((w=g.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),i=p(""),h=p(""),C=()=>({equipment:[{customerType:"\u4E0A\u6D77",yearlyBudget:0,monthlyIncome:0},{customerType:"\u56FD\u7F51",yearlyBudget:0,monthlyIncome:0},{customerType:"\u6C5F\u82CF",yearlyBudget:0,monthlyIncome:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",yearlyBudget:0,monthlyIncome:0},{customerType:"\u897F\u95E8\u5B50",yearlyBudget:0,monthlyIncome:0},{customerType:"\u540C\u4E1A",yearlyBudget:0,monthlyIncome:0},{customerType:"\u7528\u6237",yearlyBudget:0,monthlyIncome:0},{customerType:"\u5176\u5B83",yearlyBudget:0,monthlyIncome:0}],component:[{customerType:"\u7528\u6237",yearlyBudget:0,monthlyIncome:0}],project:[{customerType:"\u4E00\u5305",yearlyBudget:0,monthlyIncome:0},{customerType:"\u4E8C\u5305",yearlyBudget:0,monthlyIncome:0},{customerType:"\u57DF\u5185\u5408\u4F5C",yearlyBudget:0,monthlyIncome:0},{customerType:"\u57DF\u5916\u5408\u4F5C",yearlyBudget:0,monthlyIncome:0},{customerType:"\u5176\u5B83",yearlyBudget:0,monthlyIncome:0}]}),k=(o,e)=>(!e||typeof e!="object"||(e.equipment&&Array.isArray(e.equipment)&&(o.equipment=o.equipment.map(t=>{const r=e.equipment.find(n=>n.customerType===t.customerType);return r?{...t,yearlyBudget:Number(r.yearlyPlan)||Number(r.yearlyBudget)||0,monthlyIncome:Number(r.monthlyIncome)||Number(r.currentAmount)||0}:t})),e.component&&Array.isArray(e.component)&&(o.component=o.component.map(t=>{const r=e.component.find(n=>n.customerType===t.customerType);return r?{...t,yearlyBudget:Number(r.yearlyPlan)||Number(r.yearlyBudget)||0,monthlyIncome:Number(r.monthlyIncome)||Number(r.currentAmount)||0}:t})),e.project&&Array.isArray(e.project)&&(o.project=o.project.map(t=>{const r=e.project.find(n=>n.customerType===t.customerType);return r?{...t,yearlyBudget:Number(r.yearlyPlan)||Number(r.yearlyBudget)||0,monthlyIncome:Number(r.monthlyIncome)||Number(r.currentAmount)||0}:t}))),o),A=()=>{const o=C();l.value=o.equipment,c.value=o.component,y.value=o.project},l=p([]),c=p([]),y=p([]),f=(o,e)=>{const t=e==="equipment"?l.value.find(r=>r.customerType===o):e==="component"?c.value.find(r=>r.customerType===o):y.value.find(r=>r.customerType===o);return Number(t==null?void 0:t.monthlyIncome)||0},v=(o,e)=>e===0?"0.00":(o/e*100).toFixed(2),_=O(()=>{const o={yearlyBudget:0,monthlyIncome:0,cumulativeIncome:0};return l.value.forEach(e=>{o.yearlyBudget+=Number(e.yearlyBudget)||0,o.monthlyIncome+=Number(e.monthlyIncome)||0,o.cumulativeIncome+=f(e.customerType,"equipment")}),c.value.forEach(e=>{o.yearlyBudget+=Number(e.yearlyBudget)||0,o.monthlyIncome+=Number(e.monthlyIncome)||0,o.cumulativeIncome+=f(e.customerType,"component")}),y.value.forEach(e=>{o.yearlyBudget+=Number(e.yearlyBudget)||0,o.monthlyIncome+=Number(e.monthlyIncome)||0,o.cumulativeIncome+=f(e.customerType,"project")}),o}),B=async o=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u5728\u4EA7\u60C5\u51B5\u6570\u636E\uFF0C\u671F\u95F4: ${o}`);const e=await fetch(`http://47.111.95.19:3000/inventory-in-progress/${o}`);if(!e.ok){if(e.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u5E74\u5EA6\u9884\u7B97\u4F46\u6E05\u7A7A\u5F53\u6708\u6536\u5165"),l.value=l.value.map(r=>({...r,monthlyIncome:0})),c.value=c.value.map(r=>({...r,monthlyIncome:0})),y.value=y.value.map(r=>({...r,monthlyIncome:0}));return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const t=await e.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",t),t.success&&t.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const r=C(),n=k(r,t.data);l.value=n.equipment,c.value=n.component,y.value=n.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:l.value,componentData:c.value,projectData:y.value})}}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),A()}},I=async o=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${T.INVENTORY_IN_PROGRESS}/${o}`);if(e.ok){const t=await e.json();t.data&&(i.value=t.data.remarks||"",h.value=t.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};S(()=>g.query.period,o=>{o&&(a.value=o.toString(),B(o.toString()),I(o.toString()))}),S(a,(o,e)=>{o&&o!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${o}`),B(o),I(o))});const j=async()=>{try{const o={equipment:l.value,component:c.value,project:y.value};if(!(await fetch("http://47.111.95.19:3000/inventory-in-progress",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:a.value,data:o})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Y(T.INVENTORY_IN_PROGRESS,a.value,o,i.value,h.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(o){console.error("\u4FDD\u5B58\u5931\u8D25:",o),alert("\u4FDD\u5B58\u5931\u8D25")}},b=o=>isNaN(o)||o===null||o===void 0?"0.00":o.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),q=()=>{A(),i.value="",h.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return U(()=>{console.log("\u5728\u4EA7\u60C5\u51B5\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",a.value),g.query.period?(B(g.query.period.toString()),I(g.query.period.toString())):(B(a.value),I(a.value))}),(o,e)=>(d(),m("div",P,[u("div",z,[e[3]||(e[3]=u("h1",{class:"text-2xl font-bold"},"\u5728\u4EA7\u60C5\u51B5",-1)),u("div",J,[x(u("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.value=t),type:"month",class:"px-3 py-2 border rounded"},null,512),[[F,a.value]])])]),u("div",H,[u("table",K,[e[5]||(e[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u9884\u7B97"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u6267\u884C\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5B8C\u6210\u7387")])],-1)),u("tbody",null,[(d(!0),m(E,null,D(l.value,(t,r)=>(d(),m("tr",{key:`equipment-${r}`},[r===0?(d(),m("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u8BBE\u5907 ",8,Q)):N("",!0),u("td",W,s(t.customerType),1),u("td",X,s(b(t.yearlyBudget||0)),1),u("td",Z,[x(u("input",{"onUpdate:modelValue":n=>t.monthlyIncome=n,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,ee),[[F,t.monthlyIncome]])]),u("td",oe,s(v(t.monthlyIncome||0,t.yearlyBudget||0))+"% ",1)]))),128)),(d(!0),m(E,null,D(c.value,(t,r)=>(d(),m("tr",{key:`component-${r}`},[r===0?(d(),m("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u5143\u4EF6 ",8,te)):N("",!0),u("td",re,s(t.customerType),1),u("td",ue,s(b(t.yearlyBudget||0)),1),u("td",ne,[x(u("input",{"onUpdate:modelValue":n=>t.monthlyIncome=n,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,se),[[F,t.monthlyIncome]])]),u("td",ae,s(v(t.monthlyIncome||0,t.yearlyBudget||0))+"% ",1)]))),128)),(d(!0),m(E,null,D(y.value,(t,r)=>(d(),m("tr",{key:`project-${r}`},[r===0?(d(),m("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:y.value.length}," \u5DE5\u7A0B ",8,le)):N("",!0),u("td",ce,s(t.customerType),1),u("td",ye,s(b(t.yearlyBudget||0)),1),u("td",me,[x(u("input",{"onUpdate:modelValue":n=>t.monthlyIncome=n,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,de),[[F,t.monthlyIncome]])]),u("td",pe,s(v(t.monthlyIncome||0,t.yearlyBudget||0))+"% ",1)]))),128)),u("tr",ge,[e[4]||(e[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",ie,s(b(_.value.yearlyBudget)),1),u("td",he,s(b(_.value.monthlyIncome)),1),u("td",be,s(v(_.value.monthlyIncome,_.value.yearlyBudget))+"% ",1)])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:j,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:q,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),$(L,{"module-id":G(T).INVENTORY_IN_PROGRESS,period:a.value,remarks:i.value,"onUpdate:remarks":e[1]||(e[1]=t=>i.value=t),suggestions:h.value,"onUpdate:suggestions":e[2]||(e[2]=t=>h.value=t)},null,8,["module-id","period","remarks","suggestions"])]))}});var xe=R(ve,[["__scopeId","data-v-5cbf5a0a"]]);export{xe as default};
