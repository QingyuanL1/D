import{_ as $,d as R,r as y,B as D,c as I,o as J,b as x,e as r,y as S,A as N,F as V,g as M,t as n,k as G,h as q,G as K,v,f as Y}from"./index.5a957267.js";import{_ as L,M as E,r as z}from"./FormAttachmentAndRemarks.4a953a70.js";const H={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},W={class:"flex items-center space-x-4"},X={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},tt=["rowspan"],et={class:"border border-gray-300 px-4 py-2"},rt={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"border border-gray-300 px-4 py-2"},st=["onUpdate:modelValue"],at={class:"border border-gray-300 px-4 py-2 text-right"},ot={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"text-sm font-medium"},it={class:"bg-gray-50 font-bold"},lt={class:"border border-gray-300 px-4 py-2 text-right"},ct={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"border border-gray-300 px-4 py-2 text-right"},gt={class:"text-sm font-bold"},mt=R({__name:"ProjectTracking",setup(bt){var B;const A=K(),o=y(((B=A.query.period)==null?void 0:B.toString())||new Date().toISOString().slice(0,7)),F={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0}]},a=y(JSON.parse(JSON.stringify(F))),l=y(""),c=y(""),d=t=>t===0?"0.00":t.toFixed(2),P=t=>t===0?"0.00":t.toFixed(2),T=t=>t===0?!0:a.value.items[t].segmentAttribute!==a.value.items[t-1].segmentAttribute,O=t=>a.value.items.filter(e=>e.segmentAttribute===t).length,p=async t=>{try{const[e]=t.split("-"),u=parseInt(t.split("-")[1]);for(let s of a.value.items){let g=0;for(let _=1;_<u;_++){const C=`${e}-${_.toString().padStart(2,"0")}`;try{const b=await fetch(`http://47.111.95.19:3000/tuoyuan-project-tracking/${C}`);if(b.ok){const w=(await b.json()).data.items.find(k=>k.segmentAttribute===s.segmentAttribute&&k.customerAttribute===s.customerAttribute);w&&(g+=w.currentPeriod||0)}}catch(b){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${C}\u7684\u6570\u636E:`,b)}}g+=s.currentPeriod||0,s.currentCumulative=g,s.executionProgress=s.annualPlan>0?s.currentCumulative/s.annualPlan*100:0}}catch(e){console.error("\u8BA1\u7B97\u5F53\u671F\u7D2F\u8BA1\u5931\u8D25:",e)}};D(()=>a.value.items,async t=>{await p(o.value)},{deep:!0});const m=I(()=>{const t={annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0};return a.value.items.forEach(e=>{t.annualPlan+=e.annualPlan||0,t.currentPeriod+=e.currentPeriod||0,t.currentCumulative+=e.currentCumulative||0}),t.executionProgress=t.annualPlan>0?t.currentCumulative/t.annualPlan*100:0,t}),f=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-project-tracking/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),i();return}const u=await e.json();u.data&&u.data.items&&(a.value.items=u.data.items.map(s=>({segmentAttribute:s.segmentAttribute,customerAttribute:s.customerAttribute,annualPlan:Number(s.annualPlan)||0,currentPeriod:Number(s.currentPeriod)||0,currentCumulative:Number(s.currentCumulative)||0,executionProgress:Number(s.executionProgress)||0}))),await p(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),i()}},i=()=>{a.value=JSON.parse(JSON.stringify(F))},h=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${E.TUOYUAN_PROJECT_TRACKING}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(l.value=u.data.remarks||"",c.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};D(()=>A.query.period,async t=>{t&&(o.value=t.toString(),i(),await f(t.toString()),await p(t.toString()),h(t.toString()))}),D(o,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),i(),await f(t),await p(t),h(t))});const j=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-project-tracking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:o.value,data:{items:a.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await z(E.TUOYUAN_PROJECT_TRACKING,o.value,{items:a.value.items},l.value,c.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},U=()=>{i(),l.value="",c.value=""};return J(async()=>{var e;i();const t=((e=A.query.period)==null?void 0:e.toString())||o.value;await f(t),await p(t),h(t)}),(t,e)=>(v(),x("div",H,[r("div",Q,[e[5]||(e[5]=r("h1",{class:"text-2xl font-bold"},"\u62D3\u6E90\u9879\u76EE\u8DDF\u8E2A\u60C5\u51B5",-1)),r("div",W,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[4]||(e[4]=r("span",{class:"text-xs text-gray-500"},"\u5F53\u671F\u7D2F\u8BA1 = \u5F53\u671F + \u4E4B\u524D\u5404\u6708\u7D2F\u8BA1",-1)),S(r("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>o.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[N,o.value]])])]),r("div",X,[r("table",Z,[e[7]||(e[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u5EA6\u8BA1\u5212"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),r("tbody",null,[(v(!0),x(V,null,M(a.value.items,(u,s)=>(v(),x("tr",{key:`item-${s}`},[T(s)?(v(),x("td",{key:0,rowspan:O(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},n(u.segmentAttribute),9,tt)):Y("",!0),r("td",et,n(u.customerAttribute),1),r("td",rt,n(d(u.annualPlan)),1),r("td",ut,[S(r("input",{"onUpdate:modelValue":g=>u.currentPeriod=g,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,st),[[N,u.currentPeriod]])]),r("td",at,n(d(u.currentCumulative)),1),r("td",ot,[r("span",nt,n(P(u.executionProgress))+"%",1)])]))),128)),r("tr",it,[e[6]||(e[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",lt,n(d(m.value.annualPlan)),1),r("td",ct,n(d(m.value.currentPeriod)),1),r("td",dt,n(d(m.value.currentCumulative)),1),r("td",pt,[r("span",gt,n(P(m.value.executionProgress))+"%",1)])])])])]),G(L,{"module-id":q(E).TUOYUAN_PROJECT_TRACKING,period:o.value,remarks:l.value,"onUpdate:remarks":e[1]||(e[1]=u=>l.value=u),suggestions:c.value,"onUpdate:suggestions":e[2]||(e[2]=u=>c.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:j,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:U,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var At=$(mt,[["__scopeId","data-v-501f7c24"]]);export{At as default};
