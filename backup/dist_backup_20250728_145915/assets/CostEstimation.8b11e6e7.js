import{_ as X,d as Z,r as h,h as ee,B as $,o as re,c as b,a as o,y as B,A as D,F as N,l as k,t as s,b as te,m as ue,G as oe,f as g,k as I}from"./index.24e571cd.js";import{_ as ne,l as ae,M as w,r as se}from"./FormAttachmentAndRemarks.14d70233.js";const ie={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},ce={class:"flex justify-between items-center mb-6"},le={class:"flex items-center space-x-4"},pe={class:"overflow-x-auto my-6"},de={class:"w-full border-collapse border border-gray-300"},ye=["rowspan"],fe={class:"border border-gray-300 px-4 py-2"},me={class:"border border-gray-300 px-4 py-2 text-right"},Fe={class:"border border-gray-300 px-4 py-2"},be=["onUpdate:modelValue"],ge={class:"border border-gray-300 px-4 py-2"},ve=["onUpdate:modelValue"],he={class:"border border-gray-300 px-4 py-2 text-right"},Be={class:"font-medium"},De={class:"border border-gray-300 px-4 py-2 text-right"},_e={class:"font-medium"},Ee=["rowspan"],xe={class:"border border-gray-300 px-4 py-2"},Te={class:"border border-gray-300 px-4 py-2 text-right"},Ae={class:"border border-gray-300 px-4 py-2"},Ce=["onUpdate:modelValue"],Oe={class:"border border-gray-300 px-4 py-2"},we=["onUpdate:modelValue"],We={class:"border border-gray-300 px-4 py-2 text-right"},Re={class:"font-medium"},Pe={class:"border border-gray-300 px-4 py-2 text-right"},Se={class:"font-medium"},je=["rowspan"],qe={class:"border border-gray-300 px-4 py-2"},$e={class:"border border-gray-300 px-4 py-2 text-right"},Ne={class:"border border-gray-300 px-4 py-2"},ke=["onUpdate:modelValue"],Ie={class:"border border-gray-300 px-4 py-2"},Ve=["onUpdate:modelValue"],Me={class:"border border-gray-300 px-4 py-2 text-right"},Ue={class:"font-medium"},Ye={class:"border border-gray-300 px-4 py-2 text-right"},Le={class:"font-medium"},ze={class:"bg-gray-50 font-bold"},Ge={class:"border border-gray-300 px-4 py-2 text-right"},Je={class:"border border-gray-300 px-4 py-2 text-right"},He={class:"border border-gray-300 px-4 py-2 text-right"},Ke={class:"border border-gray-300 px-4 py-2 text-right"},Qe={class:"border border-gray-300 px-4 py-2 text-right"},Xe=Z({__name:"CostEstimation",setup(Ze){var L;const C=oe(),c=h(((L=C.query.period)==null?void 0:L.toString())||new Date().toISOString().slice(0,7)),x=h(""),T=h(""),V=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u56FD\u7F51",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u6C5F\u82CF",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u897F\u95E8\u5B50",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u540C\u4E1A",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u7528\u6237",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u5176\u5B83",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0}],component:[{customerType:"\u7528\u6237",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0}],project:[{customerType:"\u4E00\u5305",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u4E8C\u5305",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0},{customerType:"\u5176\u5B83",initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,provisionRate:0}]}),G=(e,t)=>(!t||typeof t!="object"||(t.equipment&&Array.isArray(t.equipment)&&(e.equipment=e.equipment.map(r=>{const n=t.equipment.find(u=>u.customerType===r.customerType);return n?{...r,initialBalance:Number(n.initialBalance)||0,currentPeriod:Number(n.currentPeriod)||0,currentWriteOff:Number(n.currentWriteOff)||0,yearTotal:0,provisionRate:Number(n.provisionRate)||0}:r})),t.component&&Array.isArray(t.component)&&(e.component=e.component.map(r=>{const n=t.component.find(u=>u.customerType===r.customerType);return n?{...r,initialBalance:Number(n.initialBalance)||0,currentPeriod:Number(n.currentPeriod)||0,currentWriteOff:Number(n.currentWriteOff)||0,yearTotal:0,provisionRate:Number(n.provisionRate)||0}:r})),t.project&&Array.isArray(t.project)&&(e.project=e.project.map(r=>{const n=t.project.find(u=>u.customerType===r.customerType);return n?{...r,initialBalance:Number(n.initialBalance)||0,currentPeriod:Number(n.currentPeriod)||0,currentWriteOff:Number(n.currentWriteOff)||0,yearTotal:0,provisionRate:Number(n.provisionRate)||0}:r}))),e),W=()=>{const e=V();p.value=e.equipment,d.value=e.component,y.value=e.project},p=h([]),d=h([]),y=h([]),M=h([]),_=h(null),R=async e=>{try{const t=e.substring(0,4),r=parseInt(e.substring(5,7)),n={equipment:{},component:{},project:{}};for(let u=1;u<=r;u++){const m=`${t}-${u.toString().padStart(2,"0")}`;try{const l=await fetch(`http://47.111.95.19:3000/main-business-income/${m}`);if(l.ok){const F=await l.json();if(F.success&&F.data){const v=F.data;v.equipment&&v.equipment.forEach(f=>{const a=f.customer;n.equipment[a]||(n.equipment[a]=0),n.equipment[a]+=Number(f.currentMonthIncome)||0}),v.components&&v.components.forEach(f=>{const a=f.customer;n.component[a]||(n.component[a]=0),n.component[a]+=Number(f.currentMonthIncome)||0}),v.engineering&&v.engineering.forEach(f=>{const a=f.customer;n.project[a]||(n.project[a]=0),n.project[a]+=Number(f.currentMonthIncome)||0})}}}catch(l){console.log(`\u8DF3\u8FC7\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u6708\u4EFD ${m}:`,l)}}_.value=n,console.log("\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u7D2F\u8BA1\u6570\u636E:",n)}catch(t){console.error("\u52A0\u8F7D\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u6570\u636E\u5931\u8D25:",t)}},U=async e=>{try{const t=[],r=e.substring(0,4),n=parseInt(e.substring(5,7));for(let u=1;u<n;u++){const m=`${r}-${u.toString().padStart(2,"0")}`;try{const l=await fetch(`http://47.111.95.19:3000/cost-estimation/${m}`);if(l.ok){const F=await l.json();F.success&&F.data&&t.push({period:m,data:F.data})}}catch(l){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${m}:`,l)}}M.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},P=(e,t)=>{var l,F,v,f;let r=0,n=0;console.log(`\u{1F50D} \u8BA1\u7B97\u7D2F\u8BA1\u6570\u636E: ${e}-${t}`);for(const a of M.value)if(a.data[e]){const E=a.data[e].find(O=>O.customerType===t);if(E){const O=parseFloat((l=E.currentPeriod)==null?void 0:l.toString())||0,z=parseFloat((F=E.currentWriteOff)==null?void 0:F.toString())||0;r+=O,n+=z,console.log(`\u{1F4C5} ${a.period}: ${t} \u65B0\u589E=${O}, \u51B2\u9500=${z}`)}}let u=[];e==="equipment"?u=p.value:e==="component"?u=d.value:e==="project"&&(u=y.value);const m=u.find(a=>a.customerType===t);if(m){const a=parseFloat((v=m.currentPeriod)==null?void 0:v.toString())||0,E=parseFloat((f=m.currentWriteOff)==null?void 0:f.toString())||0;r+=a,n+=E,console.log(`\u{1F4DD} \u5F53\u524D\u6708\u4EFD: ${t} \u65B0\u589E=${a}, \u51B2\u9500=${E}`)}return console.log(`\u2705 ${e}-${t} \u7D2F\u8BA1\u8BA1\u7B97\u5B8C\u6210: \u65B0\u589E=${r}, \u51B2\u9500=${n}`),{totalAddition:r,totalWriteOff:n}},S=()=>{p.value.forEach(e=>{const{totalAddition:t,totalWriteOff:r}=P("equipment",e.customerType);j(e,t,r)}),d.value.forEach(e=>{const{totalAddition:t,totalWriteOff:r}=P("component",e.customerType);j(e,t,r)}),y.value.forEach(e=>{const{totalAddition:t,totalWriteOff:r}=P("project",e.customerType);j(e,t,r)})},j=(e,t,r)=>{if(e.yearTotal=(e.initialBalance||0)+t-r,_.value){const n=J(e.customerType),u=H(n,e.customerType);u>0&&e.yearTotal>0?e.provisionRate=e.yearTotal/u*100:e.provisionRate=0}},J=e=>{const t=["\u4E0A\u6D77","\u56FD\u7F51","\u6C5F\u82CF","\u8F93\u914D\u7535\u5185\u914D","\u897F\u95E8\u5B50","\u540C\u4E1A","\u7528\u6237","\u5176\u5B83"],r=["\u7528\u6237"],n=["\u4E00\u5305","\u4E8C\u5305","\u57DF\u5185\u5408\u4F5C","\u57DF\u5916\u5408\u4F5C","\u5176\u5B83"];return t.includes(e)?"equipment":r.includes(e)?"component":n.includes(e)?"project":"equipment"},H=(e,t)=>!_.value||!_.value[e]?0:_.value[e][t]||0,i=e=>isNaN(e)||e===null||e===void 0?"0.00":e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),A=ee(()=>{const e=[...p.value,...d.value,...y.value],t={initialBalance:0,currentPeriod:0,currentWriteOff:0,yearTotal:0,averageProvisionRate:0};let r=0,n=0;return e.forEach(u=>{t.initialBalance+=u.initialBalance||0,t.currentPeriod+=u.currentPeriod||0,t.currentWriteOff+=u.currentWriteOff||0,t.yearTotal+=u.yearTotal||0,u.provisionRate>0&&(r+=u.provisionRate,n++)}),t.averageProvisionRate=n>0?r/n:0,t}),q=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u6210\u672C\u6682\u4F30\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const t=await fetch(`http://47.111.95.19:3000/cost-estimation/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),W(),await U(e),await R(e),S();return}const r=await t.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const n=V(),u=G(n,r.data);p.value=u.equipment,d.value=u.component,y.value=u.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:p.value,componentData:d.value,projectData:y.value})}await U(e),await R(e),S()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),W()}},Y=async()=>{const{remarks:e,suggestions:t}=await ae(w.COST_ESTIMATION,c.value);x.value=e,T.value=t};$(c,async e=>{await q(e),await Y()}),$(()=>C.query.period,e=>{e&&(c.value=e.toString())}),$(()=>[p.value.map(e=>e.currentPeriod),d.value.map(e=>e.currentPeriod),p.value.map(e=>e.currentWriteOff),d.value.map(e=>e.currentWriteOff),y.value.map(e=>e.currentPeriod),y.value.map(e=>e.currentWriteOff)],async()=>{_.value===null&&await R(c.value),S()},{deep:!0});const K=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u6210\u672C\u6682\u4F30\u6570\u636E ==="),console.log("\u671F\u95F4:",c.value),console.log("\u6A21\u5757ID:",w.COST_ESTIMATION);const e={equipment:p.value.map(u=>({customerType:u.customerType,initialBalance:u.initialBalance,currentPeriod:u.currentPeriod,currentWriteOff:u.currentWriteOff,yearTotal:u.yearTotal,provisionRate:u.provisionRate})),component:d.value.map(u=>({customerType:u.customerType,initialBalance:u.initialBalance,currentPeriod:u.currentPeriod,currentWriteOff:u.currentWriteOff,yearTotal:u.yearTotal,provisionRate:u.provisionRate})),project:y.value.map(u=>({customerType:u.customerType,initialBalance:u.initialBalance,currentPeriod:u.currentPeriod,currentWriteOff:u.currentWriteOff,yearTotal:u.yearTotal,provisionRate:u.provisionRate}))};console.log("\u8868\u5355\u6570\u636E:",e),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const t=await fetch("http://47.111.95.19:3000/cost-estimation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:e})});if(!t.ok){const u=await t.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",u),new Error("\u4FDD\u5B58\u5931\u8D25")}const r=await t.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",r),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const n=await se(w.COST_ESTIMATION,c.value,e,x.value,T.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",n),n?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(e){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},Q=()=>{W(),x.value="",T.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return re(()=>{console.log("\u6210\u672C\u6682\u4F30\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",c.value),C.query.period?q(C.query.period.toString()):q(c.value),Y()}),(e,t)=>(g(),b("div",ie,[o("div",ce,[t[3]||(t[3]=o("h1",{class:"text-2xl font-bold"},"\u6210\u672C\u6682\u4F30\u5165\u5E93\u548C\u8BA1\u63D0\u60C5\u51B5\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),o("div",le,[B(o("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>c.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[D,c.value]])])]),o("div",pe,[o("table",de,[t[5]||(t[5]=o("thead",{class:"sticky top-0 bg-white"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u989D"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u65B0\u589E"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u51B2\u9500"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u5E74\u7D2F\u8BA1"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u8BA1\u63D0\u7387")])],-1)),o("tbody",null,[(g(!0),b(N,null,k(p.value,(r,n)=>(g(),b("tr",{key:`equipment-${n}`},[n===0?(g(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u8BBE\u5907 ",8,ye)):I("",!0),o("td",fe,s(r.customerType),1),o("td",me,[o("span",null,s(i(r.initialBalance)),1)]),o("td",Fe,[B(o("input",{"onUpdate:modelValue":u=>r.currentPeriod=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,be),[[D,r.currentPeriod,void 0,{number:!0}]])]),o("td",ge,[B(o("input",{"onUpdate:modelValue":u=>r.currentWriteOff=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ve),[[D,r.currentWriteOff,void 0,{number:!0}]])]),o("td",he,[o("span",Be,s(i(r.yearTotal)),1)]),o("td",De,[o("span",_e,s(i(r.provisionRate))+"%",1)])]))),128)),(g(!0),b(N,null,k(d.value,(r,n)=>(g(),b("tr",{key:`component-${n}`},[n===0?(g(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u5143\u4EF6 ",8,Ee)):I("",!0),o("td",xe,s(r.customerType),1),o("td",Te,[o("span",null,s(i(r.initialBalance)),1)]),o("td",Ae,[B(o("input",{"onUpdate:modelValue":u=>r.currentPeriod=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ce),[[D,r.currentPeriod,void 0,{number:!0}]])]),o("td",Oe,[B(o("input",{"onUpdate:modelValue":u=>r.currentWriteOff=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,we),[[D,r.currentWriteOff,void 0,{number:!0}]])]),o("td",We,[o("span",Re,s(i(r.yearTotal)),1)]),o("td",Pe,[o("span",Se,s(i(r.provisionRate))+"%",1)])]))),128)),(g(!0),b(N,null,k(y.value,(r,n)=>(g(),b("tr",{key:`project-${n}`},[n===0?(g(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:y.value.length}," \u5DE5\u7A0B ",8,je)):I("",!0),o("td",qe,s(r.customerType),1),o("td",$e,[o("span",null,s(i(r.initialBalance)),1)]),o("td",Ne,[B(o("input",{"onUpdate:modelValue":u=>r.currentPeriod=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ke),[[D,r.currentPeriod,void 0,{number:!0}]])]),o("td",Ie,[B(o("input",{"onUpdate:modelValue":u=>r.currentWriteOff=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ve),[[D,r.currentWriteOff,void 0,{number:!0}]])]),o("td",Me,[o("span",Ue,s(i(r.yearTotal)),1)]),o("td",Ye,[o("span",Le,s(i(r.provisionRate))+"%",1)])]))),128)),o("tr",ze,[t[4]||(t[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",Ge,s(i(A.value.initialBalance)),1),o("td",Je,s(i(A.value.currentPeriod)),1),o("td",He,s(i(A.value.currentWriteOff)),1),o("td",Ke,s(i(A.value.yearTotal)),1),o("td",Qe,s(i(A.value.averageProvisionRate))+"%",1)])])])]),o("div",{class:"mt-4 flex justify-end space-x-4"},[o("button",{onClick:K,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),o("button",{onClick:Q,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),te(ne,{"module-id":ue(w).COST_ESTIMATION,period:c.value,remarks:x.value,"onUpdate:remarks":t[1]||(t[1]=r=>x.value=r),suggestions:T.value,"onUpdate:suggestions":t[2]||(t[2]=r=>T.value=r)},null,8,["module-id","period","remarks","suggestions"])]))}});var tr=X(Xe,[["__scopeId","data-v-d2a74b58"]]);export{tr as default};
