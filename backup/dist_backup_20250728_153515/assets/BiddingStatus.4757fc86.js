import{_ as N,d as I,r as p,c as T,B as F,o as O,b,e as n,y as D,A as h,F as $,g as V,t as d,k as j,h as J,G,v as m,f as M}from"./index.7af7369e.js";import{_ as q,M as f,r as Y}from"./FormAttachmentAndRemarks.003f3704.js";const L={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},z={class:"flex items-center space-x-4"},H={class:"overflow-x-auto my-6"},K={class:"w-full border-collapse border border-gray-300"},Q=["rowspan"],X={class:"border border-gray-300 px-4 py-2"},Z={class:"border border-gray-300 px-4 py-2"},P=["onUpdate:modelValue","onInput"],tt={class:"border border-gray-300 px-4 py-2"},et=["onUpdate:modelValue","onInput"],nt={class:"border border-gray-300 px-4 py-2 text-right"},st={class:"text-sm font-medium"},ut={class:"bg-gray-50 font-bold"},it={class:"border border-gray-300 px-4 py-2 text-right"},ot={class:"border border-gray-300 px-4 py-2 text-right"},rt={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"text-sm font-bold"},dt=I({__name:"BiddingStatus",setup(lt){var C;const B=G(),o=p(((C=B.query.period)==null?void 0:C.toString())||new Date().toISOString().slice(0,7)),y={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",collectiveBidding:0,winningBidCount:0,winningRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",collectiveBidding:0,winningBidCount:0,winningRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",collectiveBidding:0,winningBidCount:0,winningRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",collectiveBidding:0,winningBidCount:0,winningRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",collectiveBidding:0,winningBidCount:0,winningRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",collectiveBidding:0,winningBidCount:0,winningRate:0}]},i=p(JSON.parse(JSON.stringify(y))),l=p(""),c=p(""),E=t=>t===0?"0.00":t.toFixed(2),v=t=>{t.collectiveBidding&&t.collectiveBidding>0?t.winningRate=t.winningBidCount/t.collectiveBidding*100:t.winningRate=0},S=t=>t===0?!0:i.value.items[t].segmentAttribute!==i.value.items[t-1].segmentAttribute,R=t=>i.value.items.filter(e=>e.segmentAttribute===t).length,w=T(()=>{const t={collectiveBidding:0,winningBidCount:0,winningRate:0};return i.value.items.forEach(e=>{var s,r;t.collectiveBidding+=parseInt(((s=e.collectiveBidding)==null?void 0:s.toString())||"0")||0,t.winningBidCount+=parseInt(((r=e.winningBidCount)==null?void 0:r.toString())||"0")||0}),t.winningRate=t.collectiveBidding>0?t.winningBidCount/t.collectiveBidding*100:0,t}),_=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-bidding-status/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),a();return}const s=await e.json();if(s.data&&s.data.items){const r=s.data.items;i.value.items=y.items.map(u=>{const x=r.find(g=>g.segmentAttribute===u.segmentAttribute&&g.customerAttribute===u.customerAttribute);if(x){const g={segmentAttribute:u.segmentAttribute,customerAttribute:u.customerAttribute,collectiveBidding:Number(x.collectiveBidding)||0,winningBidCount:Number(x.winningBidCount)||0,winningRate:0};return v(g),g}else return{...u}})}}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),a()}},a=()=>{i.value=JSON.parse(JSON.stringify(y))},A=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${f.TUOYUAN_BIDDING_STATUS}/${t}`);if(e.ok){const s=await e.json();s.success&&s.data&&(l.value=s.data.remarks||"",c.value=s.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};F(()=>B.query.period,async t=>{t&&(o.value=t.toString(),a(),await _(t.toString()),A(t.toString()))}),F(o,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),a(),await _(t),A(t))});const k=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-bidding-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:o.value,data:{items:i.value.items.map(e=>({segmentAttribute:e.segmentAttribute,customerAttribute:e.customerAttribute,collectiveBidding:e.collectiveBidding,winningBidCount:e.winningBidCount}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Y(f.TUOYUAN_BIDDING_STATUS,o.value,{items:i.value.items},l.value,c.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},U=()=>{a(),l.value="",c.value=""};return O(async()=>{var e;a();const t=((e=B.query.period)==null?void 0:e.toString())||o.value;await _(t),A(t)}),(t,e)=>(m(),b("div",L,[n("div",W,[e[4]||(e[4]=n("h1",{class:"text-2xl font-bold"},"\u62D3\u6E90\u62DB\u6295\u6807\u60C5\u51B5",-1)),n("div",z,[e[3]||(e[3]=n("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u9879\uFF09",-1)),D(n("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>o.value=s),type:"month",class:"px-3 py-2 border rounded"},null,512),[[h,o.value]])])]),n("div",H,[n("table",K,[e[6]||(e[6]=n("thead",{class:"sticky top-0 bg-white"},[n("tr",{class:"bg-gray-50"},[n("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),n("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),n("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u96C6\u91C7\u6295\u6807"),n("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u4E2D\u6807\u6570\u8BA1"),n("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u4E2D\u6807\u7387")])],-1)),n("tbody",null,[(m(!0),b($,null,V(i.value.items,(s,r)=>(m(),b("tr",{key:`item-${r}`},[S(r)?(m(),b("td",{key:0,rowspan:R(s.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},d(s.segmentAttribute),9,Q)):M("",!0),n("td",X,d(s.customerAttribute),1),n("td",Z,[D(n("input",{"onUpdate:modelValue":u=>s.collectiveBidding=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"1",onInput:u=>v(s)},null,40,P),[[h,s.collectiveBidding]])]),n("td",tt,[D(n("input",{"onUpdate:modelValue":u=>s.winningBidCount=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"1",onInput:u=>v(s)},null,40,et),[[h,s.winningBidCount]])]),n("td",nt,[n("span",st,d(E(s.winningRate))+"%",1)])]))),128)),n("tr",ut,[e[5]||(e[5]=n("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),n("td",it,d(w.value.collectiveBidding),1),n("td",ot,d(w.value.winningBidCount),1),n("td",rt,[n("span",at,d(E(w.value.winningRate))+"%",1)])])])])]),j(q,{"module-id":J(f).TUOYUAN_BIDDING_STATUS,period:o.value,remarks:l.value,"onUpdate:remarks":e[1]||(e[1]=s=>l.value=s),suggestions:c.value,"onUpdate:suggestions":e[2]||(e[2]=s=>c.value=s)},null,8,["module-id","period","remarks","suggestions"]),n("div",{class:"mt-4 flex justify-end space-x-4"},[n("button",{onClick:k,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),n("button",{onClick:U,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var pt=N(dt,[["__scopeId","data-v-73ddb38a"]]);export{pt as default};
