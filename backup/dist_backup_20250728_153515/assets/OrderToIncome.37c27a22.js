import{_ as U,d as $,r as A,B as w,c as M,o as j,b as F,e as r,y as N,A as T,F as V,g as J,t as i,k as q,h as Y,G as L,v as C,f as G}from"./index.7af7369e.js";import{_ as z,M as D,r as H}from"./FormAttachmentAndRemarks.003f3704.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},W={class:"flex items-center space-x-4"},X={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},ee=["rowspan"],te={class:"border border-gray-300 px-4 py-2"},re={class:"border border-gray-300 px-4 py-2 text-right"},ue={class:"border border-gray-300 px-4 py-2"},oe=["onUpdate:modelValue"],ae={class:"border border-gray-300 px-4 py-2 text-right"},se={class:"border border-gray-300 px-4 py-2 text-right"},ne={class:"text-sm font-medium"},ie={class:"bg-gray-50 font-bold"},ce={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"border border-gray-300 px-4 py-2 text-right"},me={class:"border border-gray-300 px-4 py-2 text-right"},pe={class:"text-sm font-bold"},be=$({__name:"OrderToIncome",setup(ge){var E;const I=L(),n=A(((E=I.query.period)==null?void 0:E.toString())||new Date().toISOString().slice(0,7)),_={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",annualNewOrderCumulative:550.51,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",annualNewOrderCumulative:0,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",annualNewOrderCumulative:218.24,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",annualNewOrderCumulative:622.38,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",annualNewOrderCumulative:0,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",annualNewOrderCumulative:0,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0}]},a=A(JSON.parse(JSON.stringify(_))),l=A(""),m=A(""),p=e=>e===0?"0.00":e.toFixed(2),f=e=>e===0?"0.00":e.toFixed(2),P=e=>e===0?!0:a.value.items[e].segmentAttribute!==a.value.items[e-1].segmentAttribute,S=e=>a.value.items.filter(t=>t.segmentAttribute===e).length,b=async e=>{try{const[t]=e.split("-"),u=parseInt(e.split("-")[1]);for(let o of a.value.items){let s=0;for(let d=1;d<u;d++){const g=`${t}-${d.toString().padStart(2,"0")}`;try{const y=await fetch(`http://47.111.95.19:3000/tuoyuan-order-to-income/${g}`);if(y.ok){const B=(await y.json()).data.items.find(O=>O.segmentAttribute===o.segmentAttribute&&O.customerAttribute===o.customerAttribute);B&&(s+=B.currentPeriodIncome||0)}}catch(y){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${g}\u7684\u6570\u636E:`,y)}}s+=o.currentPeriodIncome||0,o.currentPeriodIncomeCumulative=s,o.orderToIncomeRatio=o.annualNewOrderCumulative>0?o.currentPeriodIncomeCumulative/o.annualNewOrderCumulative*100:0}}catch(t){console.error("\u8BA1\u7B97\u5F53\u671F\u8F6C\u6536\u5165\u7D2F\u8BA1\u5931\u8D25:",t)}};w(()=>a.value.items,async e=>{await b(n.value)},{deep:!0});const v=M(()=>{const e={annualNewOrderCumulative:0,currentPeriodIncome:0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0};return a.value.items.forEach(t=>{e.annualNewOrderCumulative+=t.annualNewOrderCumulative||0,e.currentPeriodIncome+=t.currentPeriodIncome||0,e.currentPeriodIncomeCumulative+=t.currentPeriodIncomeCumulative||0}),e.orderToIncomeRatio=e.annualNewOrderCumulative>0?e.currentPeriodIncomeCumulative/e.annualNewOrderCumulative*100:0,e}),x=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/tuoyuan-order-to-income/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),c();return}const u=await t.json();if(u.data&&u.data.items){const o=u.data.items;a.value.items=_.items.map(s=>{const d=o.find(g=>g.segmentAttribute===s.segmentAttribute&&g.customerAttribute===s.customerAttribute);return{segmentAttribute:s.segmentAttribute,customerAttribute:s.customerAttribute,annualNewOrderCumulative:s.annualNewOrderCumulative,currentPeriodIncome:d&&Number(d.currentPeriodIncome)||0,currentPeriodIncomeCumulative:0,orderToIncomeRatio:0}})}await b(e)}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),c()}},c=()=>{a.value=JSON.parse(JSON.stringify(_))},h=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${D.TUOYUAN_ORDER_TO_INCOME}/${e}`);if(t.ok){const u=await t.json();u.success&&u.data&&(l.value=u.data.remarks||"",m.value=u.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};w(()=>I.query.period,async e=>{e&&(n.value=e.toString(),c(),await x(e.toString()),await b(e.toString()),h(e.toString()))}),w(n,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),c(),await x(e),await b(e),h(e))});const R=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-order-to-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:{items:a.value.items.map(t=>({segmentAttribute:t.segmentAttribute,customerAttribute:t.customerAttribute,annualNewOrderCumulative:t.annualNewOrderCumulative,currentPeriodIncome:t.currentPeriodIncome}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await H(D.TUOYUAN_ORDER_TO_INCOME,n.value,{items:a.value.items},l.value,m.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},k=()=>{c(),l.value="",m.value=""};return j(async()=>{var t;c();const e=((t=I.query.period)==null?void 0:t.toString())||n.value;await x(e),await b(e),h(e)}),(e,t)=>(C(),F("div",K,[r("div",Q,[t[5]||(t[5]=r("h1",{class:"text-2xl font-bold"},"\u62D3\u6E90\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165",-1)),r("div",W,[t[3]||(t[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),t[4]||(t[4]=r("span",{class:"text-xs text-gray-500"},"\u5F53\u671F\u8F6C\u6536\u5165\u7D2F\u8BA1 = \u5F53\u671F\u8F6C\u6536\u5165 + \u4E4B\u524D\u5404\u6708\u7D2F\u8BA1",-1)),N(r("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>n.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[T,n.value]])])]),r("div",X,[r("table",Z,[t[7]||(t[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-40"},"\u5F53\u5E74\u65B0\u7B7E\u8BA2\u5355\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u8F6C\u6536\u5165"),r("th",{class:"border border-gray-300 px-4 py-2 w-40"},"\u5F53\u671F\u8F6C\u6536\u5165\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2 w-40"},"\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165\u6BD4\u7387")])],-1)),r("tbody",null,[(C(!0),F(V,null,J(a.value.items,(u,o)=>(C(),F("tr",{key:`item-${o}`},[P(o)?(C(),F("td",{key:0,rowspan:S(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},i(u.segmentAttribute),9,ee)):G("",!0),r("td",te,i(u.customerAttribute),1),r("td",re,i(p(u.annualNewOrderCumulative)),1),r("td",ue,[N(r("input",{"onUpdate:modelValue":s=>u.currentPeriodIncome=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,oe),[[T,u.currentPeriodIncome]])]),r("td",ae,i(p(u.currentPeriodIncomeCumulative)),1),r("td",se,[r("span",ne,i(f(u.orderToIncomeRatio))+"%",1)])]))),128)),r("tr",ie,[t[6]||(t[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",ce,i(p(v.value.annualNewOrderCumulative)),1),r("td",de,i(p(v.value.currentPeriodIncome)),1),r("td",le,i(p(v.value.currentPeriodIncomeCumulative)),1),r("td",me,[r("span",pe,i(f(v.value.orderToIncomeRatio))+"%",1)])])])])]),q(z,{"module-id":Y(D).TUOYUAN_ORDER_TO_INCOME,period:n.value,remarks:l.value,"onUpdate:remarks":t[1]||(t[1]=u=>l.value=u),suggestions:m.value,"onUpdate:suggestions":t[2]||(t[2]=u=>m.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:R,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:k,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Fe=U(be,[["__scopeId","data-v-7a341fbd"]]);export{Fe as default};
