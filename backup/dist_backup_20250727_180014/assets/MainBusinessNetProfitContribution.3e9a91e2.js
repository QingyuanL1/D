import{_ as M,d as O,r as _,h as $,B as w,o as T,c as x,a as e,y as B,A as C,F as j,l as q,t as i,b as V,m as J,G as H,f as E,k as L}from"./index.c1c40606.js";import{_ as G,M as P,r as Y}from"./FormAttachmentAndRemarks.518d63f2.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},K={class:"flex justify-between items-center mb-6"},Q={class:"flex items-center space-x-4"},W={class:"overflow-x-auto my-6"},X={class:"w-full border-collapse border border-gray-300"},Z=["rowspan"],tt={class:"border border-gray-300 px-4 py-2"},et={class:"border border-gray-300 px-4 py-2 text-right"},rt={class:"border border-gray-300 px-4 py-2"},ot=["onUpdate:modelValue"],at={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"border border-gray-300 px-4 py-2 text-right"},st={class:"text-sm font-medium"},nt={class:"border border-gray-300 px-4 py-2 text-right"},it={class:"text-sm font-medium"},lt={class:"bg-gray-50 font-bold"},ct={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},mt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"border border-gray-300 px-4 py-2 text-right"},yt={class:"text-sm font-bold"},bt=O({__name:"MainBusinessNetProfitContribution",setup(gt){var R;const c=H(),s=_(((R=c.query.period)==null?void 0:R.toString())||new Date().toISOString().slice(0,7)),D={customers:[{customerName:"\u4E00\u5305\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u4E8C\u5305\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u62A2\u4FEE\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u6D3E\u9063",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0},{customerName:"\u81EA\u5EFA",yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0,annualRatio:0}]},n=_(JSON.parse(JSON.stringify(D))),d=_(""),m=_(""),p=r=>r===0?"0.00":r.toFixed(2),N=r=>r===0?"0.00":r.toFixed(2),y=async r=>{try{const[t,o]=r.split("-"),l=parseInt(o);for(let u of n.value.customers){let f=0;for(let F=1;F<=l;F++){const S=`${t}-${F.toString().padStart(2,"0")}`;try{const h=await fetch(`http://47.111.95.19:3000/nanhua-main-business-net-profit/${S}`);if(h.ok){const A=(await h.json()).data.customers.find(U=>U.customerName===u.customerName);A&&(f+=A.currentPeriod||0)}}catch(h){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${S}\u7684\u6570\u636E:`,h)}}u.cumulative=f,u.yearlyPlan>0?u.decompositionRatio=u.cumulative/u.yearlyPlan*100:u.decompositionRatio=0}const a=n.value.customers.reduce((u,f)=>u+(f.yearlyPlan||0),0);n.value.customers.forEach(u=>{a>0?u.annualRatio=u.yearlyPlan/a*100:u.annualRatio=0})}catch(t){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u6570\u636E\u5931\u8D25:",t)}},b=$(()=>{const r={yearlyPlan:0,currentPeriod:0,cumulative:0,decompositionRatio:0};return n.value.customers.forEach(t=>{r.yearlyPlan+=t.yearlyPlan||0,r.currentPeriod+=t.currentPeriod||0,r.cumulative+=t.cumulative||0}),r.yearlyPlan>0&&(r.decompositionRatio=r.cumulative/r.yearlyPlan*100),r}),g=async r=>{try{const t=await fetch(`http://47.111.95.19:3000/nanhua-main-business-net-profit/${r}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");return}const o=await t.json();o.data&&o.data.customers&&(n.value.customers=D.customers.map(l=>{const a=o.data.customers.find(u=>u.customerName===l.customerName);return{customerName:l.customerName,yearlyPlan:a&&Number(a.yearlyPlan)||0,currentPeriod:a&&Number(a.currentPeriod)||0,cumulative:a&&Number(a.cumulative)||0,decompositionRatio:a&&Number(a.decompositionRatio)||0,annualRatio:a&&Number(a.annualRatio)||0}}))}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t)}},v=async r=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${P.NANHUA_MAIN_BUSINESS_NET_PROFIT}/${r}`);if(t.ok){const o=await t.json();o.success&&o.data&&(d.value=o.data.remarks||"",m.value=o.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};w(()=>c.query.period,async r=>{r&&(s.value=r.toString(),await g(r.toString()),await y(r.toString()),v(r.toString()))}),w(s,async(r,t)=>{r&&r!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${r}`),await g(r),await y(r),v(r))});const k=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:n.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Y(P.NANHUA_MAIN_BUSINESS_NET_PROFIT,s.value,n.value,d.value,m.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(r){console.error("\u4FDD\u5B58\u5931\u8D25:",r),alert("\u4FDD\u5B58\u5931\u8D25")}},I=()=>{n.value=JSON.parse(JSON.stringify(D)),d.value="",m.value=""};return T(async()=>{c.query.period?(await g(c.query.period.toString()),await y(c.query.period.toString()),v(c.query.period.toString())):(await g(s.value),await y(s.value),v(s.value))}),(r,t)=>(E(),x("div",z,[e("div",K,[t[4]||(t[4]=e("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),e("div",Q,[t[3]||(t[3]=e("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),B(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>s.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,s.value]])])]),e("div",W,[e("table",X,[t[7]||(t[7]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u76EE\u6807"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5206\u89E3\u5360\u6BD4"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u6BD4\u91CD")])],-1)),e("tbody",null,[(E(!0),x(j,null,q(n.value.customers,(o,l)=>(E(),x("tr",{key:`customer-${l}`},[l===0?(E(),x("td",{key:0,rowspan:n.value.customers.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Z)):L("",!0),e("td",tt,i(o.customerName),1),e("td",et,i(p(o.yearlyPlan)),1),e("td",rt,[B(e("input",{"onUpdate:modelValue":a=>o.currentPeriod=a,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ot),[[C,o.currentPeriod]])]),e("td",at,i(p(o.cumulative)),1),e("td",ut,[e("span",st,i(N(o.decompositionRatio))+"%",1)]),e("td",nt,[e("span",it,i(N(o.annualRatio))+"%",1)])]))),128)),e("tr",lt,[t[5]||(t[5]=e("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),e("td",ct,i(p(b.value.yearlyPlan)),1),e("td",dt,i(p(b.value.currentPeriod)),1),e("td",mt,i(p(b.value.cumulative)),1),e("td",pt,[e("span",yt,i(N(b.value.decompositionRatio))+"%",1)]),t[6]||(t[6]=e("td",{class:"border border-gray-300 px-4 py-2 text-right"},[e("span",{class:"text-sm font-bold"},"100.00%")],-1))])])])]),V(G,{"module-id":J(P).NANHUA_MAIN_BUSINESS_NET_PROFIT,period:s.value,remarks:d.value,"onUpdate:remarks":t[1]||(t[1]=o=>d.value=o),suggestions:m.value,"onUpdate:suggestions":t[2]||(t[2]=o=>m.value=o)},null,8,["module-id","period","remarks","suggestions"]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:k,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:I,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var _t=M(bt,[["__scopeId","data-v-7f6a6e3a"]]);export{_t as default};
