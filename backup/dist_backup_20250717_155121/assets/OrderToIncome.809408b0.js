import{_ as V,d as j,r as h,B,c as J,o as L,b as l,e as r,y as D,A as v,F as w,g as C,t as a,k as G,h as Y,G as z,v as i,f as A}from"./index.d08f7120.js";import{_ as H,l as K,M as x,r as Q}from"./FormAttachmentAndRemarks.f46940a7.js";const W={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},X={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},P={class:"overflow-x-auto my-6"},ee={class:"w-full border-collapse border border-gray-300"},oe=["rowspan"],re={class:"border border-gray-300 px-4 py-2"},te={class:"border border-gray-300 px-4 py-2"},ne={class:"border border-gray-300 px-4 py-2"},se=["onUpdate:modelValue"],ue={class:"border border-gray-300 px-4 py-2"},ae={class:"font-medium"},ce={class:"border border-gray-300 px-4 py-2"},de=["rowspan"],le={class:"border border-gray-300 px-4 py-2"},ie={class:"border border-gray-300 px-4 py-2"},me={class:"border border-gray-300 px-4 py-2"},pe=["onUpdate:modelValue"],ge={class:"border border-gray-300 px-4 py-2"},ye={class:"font-medium"},be={class:"border border-gray-300 px-4 py-2"},_e=["rowspan"],he={class:"border border-gray-300 px-4 py-2"},fe={class:"border border-gray-300 px-4 py-2"},Fe={class:"border border-gray-300 px-4 py-2"},De=["onUpdate:modelValue"],ve={class:"border border-gray-300 px-4 py-2"},xe={class:"font-medium"},Ee={class:"border border-gray-300 px-4 py-2"},Oe={class:"bg-gray-50 font-bold"},Ie={class:"border border-gray-300 px-4 py-2"},Re={class:"border border-gray-300 px-4 py-2"},Te={class:"border border-gray-300 px-4 py-2"},Be=j({__name:"OrderToIncome",setup(we){var q;const g=z(),m=h(((q=g.query.period)==null?void 0:q.toString())||new Date().toISOString().slice(0,7)),y=h(""),b=h(""),_=()=>({equipment:[{customer:"\u4E0A\u6D77",signedOrder:5593.15,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u56FD\u7F51",signedOrder:1358.11,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u6C5F\u82CF",signedOrder:1132.24,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u8F93\u914D\u7535\u5185\u914D",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u897F\u95E8\u5B50",signedOrder:9.94,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u540C\u4E1A",signedOrder:765.74,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u7528\u6237",signedOrder:90.95,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u5176\u5B83",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0}],components:[{customer:"\u7528\u6237",signedOrder:97.86,currentIncome:0,incomeTotal:0,incomeRate:0}],engineering:[{customer:"\u4E00\u5305",signedOrder:2029.79,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u4E8C\u5305",signedOrder:7.94,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u57DF\u5185\u5408\u4F5C",signedOrder:1744.52,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u57DF\u5916\u5408\u4F5C",signedOrder:12.7,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u5176\u5B83",signedOrder:238.62,currentIncome:0,incomeTotal:0,incomeRate:0}]}),M=(e,t)=>{const o=JSON.parse(JSON.stringify(e));return t.equipment&&o.equipment.forEach((u,n)=>{t.equipment[n]&&Object.assign(u,t.equipment[n])}),t.components&&o.components.forEach((u,n)=>{t.components[n]&&Object.assign(u,t.components[n])}),t.engineering&&o.engineering.forEach((u,n)=>{t.engineering[n]&&Object.assign(u,t.engineering[n])}),o},s=h(_()),k=h([]),E=e=>e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),S=async e=>{try{const t=[],o=e.substring(0,4),u=parseInt(e.substring(5,7));for(let n=1;n<u;n++){const c=`${o}-${n.toString().padStart(2,"0")}`;try{const d=await fetch(`http://47.111.95.19:3000/order-to-income/${c}`);if(d.ok){const p=await d.json();p.success&&p.data&&t.push({period:c,data:p.data})}}catch(d){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${c}:`,d)}}k.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},O=(e,t)=>{let o=0;for(const c of k.value){const d=c.data[e];if(d){const p=d.find($=>$.customer===t);p&&p.currentIncome&&(o+=p.currentIncome)}}const n=s.value[e].find(c=>c.customer===t);return n&&n.currentIncome&&(o+=n.currentIncome),o},I=()=>{s.value.equipment.forEach(e=>{e.incomeTotal=O("equipment",e.customer)}),s.value.components.forEach(e=>{e.incomeTotal=O("components",e.customer)}),s.value.engineering.forEach(e=>{e.incomeTotal=O("engineering",e.customer)})},R=e=>{I(),e.signedOrder>0?e.incomeRate=parseFloat((e.incomeTotal/e.signedOrder*100).toFixed(2)):e.incomeRate=0};B(()=>s.value,()=>{s.value.equipment.forEach(e=>R(e)),s.value.components.forEach(e=>R(e)),s.value.engineering.forEach(e=>R(e))},{deep:!0});const T=J(()=>{const e={signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0};return[...s.value.equipment,...s.value.components,...s.value.engineering].forEach(o=>{e.signedOrder+=o.signedOrder||0,e.currentIncome+=o.currentIncome||0,e.incomeTotal+=o.incomeTotal||0}),e.incomeRate=e.signedOrder>0?parseFloat((e.incomeTotal/e.signedOrder*100).toFixed(2)):0,e}),f=async e=>{try{const t=await K(x.ORDER_TO_INCOME,e);y.value=t.remarks||"",b.value=t.suggestions||""}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",t)}},F=async e=>{var t;console.log("\u5F00\u59CB\u52A0\u8F7D\u8BA2\u5355\u8F6C\u6536\u5165\u6570\u636E:",e);try{const o=await fetch(`http://47.111.95.19:3000/order-to-income/${e}`);let u=null;o.ok&&(u=(await o.json()).data,console.log("\u4E13\u7528\u8868\u6570\u636E:",u));const n=await fetch(`http://47.111.95.19:3000/forms/submission/${x.ORDER_TO_INCOME}/${e}`);let c=null;n.ok&&(c=(t=(await n.json()).data)==null?void 0:t.formData,console.log("\u7CFB\u7EDF\u8868\u6570\u636E:",c));const d=u||c;d?(s.value=M(_(),d),console.log("\u5408\u5E76\u540E\u6570\u636E:",s.value)):(s.value=_(),console.log("\u4F7F\u7528\u9ED8\u8BA4\u6570\u636E")),await S(e),I()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),s.value=_();try{await S(e),I()}catch(u){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",u)}}};B(()=>g.query.period,e=>{e&&(m.value=e.toString(),F(e.toString()),f(e.toString()))}),B(m,e=>{F(e),f(e)});const N=async()=>{try{await(async()=>{if(!(await fetch("http://47.111.95.19:3000/order-to-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:m.value,data:s.value})})).ok)throw new Error("\u4FDD\u5B58\u4E13\u7528\u8868\u5931\u8D25")})(),await Q(x.ORDER_TO_INCOME,m.value,s.value,y.value,b.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},U=()=>{s.value=_(),y.value="",b.value=""};return L(()=>{g.query.period?(F(g.query.period.toString()),f(g.query.period.toString())):(F(m.value),f(m.value))}),(e,t)=>(i(),l("div",W,[r("div",X,[t[3]||(t[3]=r("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u2014\u2014\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165",-1)),r("div",Z,[D(r("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[v,m.value]])])]),r("div",P,[r("table",ee,[t[7]||(t[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u5E74\u65B0\u7B7E\u8BA2\u5355\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u8F6C\u6536\u5165"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u8F6C\u6536\u5165"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165\u6BD4\u7387")])],-1)),r("tbody",null,[(i(!0),l(w,null,C(s.value.equipment,(o,u)=>(i(),l("tr",{key:`equipment-${u}`},[u===0?(i(),l("td",{key:0,rowspan:s.value.equipment.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u8BBE\u5907 ",8,oe)):A("",!0),r("td",re,a(o.customer),1),r("td",te,a(o.signedOrder.toFixed(2)),1),r("td",ne,[D(r("input",{"onUpdate:modelValue":n=>o.currentIncome=n,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,se),[[v,o.currentIncome,void 0,{number:!0}]])]),r("td",ue,[r("span",ae,a(E(o.incomeTotal||0)),1)]),r("td",ce,a(o.incomeRate)+"% ",1)]))),128)),(i(!0),l(w,null,C(s.value.components,(o,u)=>(i(),l("tr",{key:`components-${u}`},[u===0?(i(),l("td",{key:0,rowspan:s.value.components.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5143\u4EF6 ",8,de)):A("",!0),r("td",le,a(o.customer),1),r("td",ie,a(o.signedOrder.toFixed(2)),1),r("td",me,[D(r("input",{"onUpdate:modelValue":n=>o.currentIncome=n,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,pe),[[v,o.currentIncome,void 0,{number:!0}]])]),r("td",ge,[r("span",ye,a(E(o.incomeTotal||0)),1)]),r("td",be,a(o.incomeRate)+"% ",1)]))),128)),(i(!0),l(w,null,C(s.value.engineering,(o,u)=>(i(),l("tr",{key:`engineering-${u}`},[u===0?(i(),l("td",{key:0,rowspan:s.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,_e)):A("",!0),r("td",he,a(o.customer),1),r("td",fe,a(o.signedOrder.toFixed(2)),1),r("td",Fe,[D(r("input",{"onUpdate:modelValue":n=>o.currentIncome=n,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,De),[[v,o.currentIncome,void 0,{number:!0}]])]),r("td",ve,[r("span",xe,a(E(o.incomeTotal||0)),1)]),r("td",Ee,a(o.incomeRate)+"% ",1)]))),128)),r("tr",Oe,[t[4]||(t[4]=r("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),t[5]||(t[5]=r("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),t[6]||(t[6]=r("td",{class:"border border-gray-300 px-4 py-2"},"13,081.56",-1)),r("td",Ie,a(T.value.currentIncome.toFixed(2)),1),r("td",Re,a(T.value.incomeTotal.toFixed(2)),1),r("td",Te,a(T.value.incomeRate.toFixed(2))+"%",1)])])])]),G(H,{"module-id":Y(x).ORDER_TO_INCOME,period:m.value,remarks:y.value,"onUpdate:remarks":t[1]||(t[1]=o=>y.value=o),suggestions:b.value,"onUpdate:suggestions":t[2]||(t[2]=o=>b.value=o)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:N,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:U,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var ke=V(Be,[["__scopeId","data-v-aa9be4ca"]]);export{ke as default};
