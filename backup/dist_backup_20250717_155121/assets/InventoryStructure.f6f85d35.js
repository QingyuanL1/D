import{_ as G,d as z,r as b,c as O,B as T,o as H,b as l,e as u,y as N,A as C,F as P,g as B,t as s,k as K,h as Q,G as W,v as d,f as j}from"./index.d08f7120.js";import{_ as X,M as J,r as Z}from"./FormAttachmentAndRemarks.f46940a7.js";const rr={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},tr={class:"flex justify-between items-center mb-6"},er={class:"flex items-center space-x-4"},ur={class:"overflow-x-auto my-6"},or={class:"w-full border-collapse border border-gray-300"},nr=["rowspan"],sr={class:"border border-gray-300 px-4 py-2"},ar={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},cr={class:"border border-gray-300 px-4 py-2"},ir=["onUpdate:modelValue"],lr={class:"border border-gray-300 px-4 py-2 text-right"},dr={class:"font-medium"},pr={class:"border border-gray-300 px-4 py-2 text-right"},mr=["rowspan"],yr={class:"border border-gray-300 px-4 py-2"},gr={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},br={class:"border border-gray-300 px-4 py-2"},hr=["onUpdate:modelValue"],vr={class:"border border-gray-300 px-4 py-2 text-right"},Ar={class:"font-medium"},_r={class:"border border-gray-300 px-4 py-2 text-right"},fr=["rowspan"],xr={class:"border border-gray-300 px-4 py-2"},Dr={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},Fr={class:"border border-gray-300 px-4 py-2"},Er=["onUpdate:modelValue"],Sr={class:"border border-gray-300 px-4 py-2 text-right"},Tr={class:"font-medium"},Nr={class:"border border-gray-300 px-4 py-2 text-right"},Cr={class:"bg-gray-50 font-bold"},wr={class:"border border-gray-300 px-4 py-2 text-right"},kr={class:"border border-gray-300 px-4 py-2 text-right"},Or={class:"border border-gray-300 px-4 py-2 text-right"},Pr={class:"border border-gray-300 px-4 py-2 text-right"},Br=z({__name:"InventoryStructure",setup(jr){var R;const h=W(),p=b(((R=h.query.period)==null?void 0:R.toString())||new Date().toISOString().slice(0,7)),D=b(""),F=b(""),v=[{customerType:"\u4E0A\u6D77",initialAmount:39151.53,currentPeriod:0,currentAmount:0},{customerType:"\u56FD\u7F51",initialAmount:7841.48,currentPeriod:0,currentAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:6793.01,currentPeriod:0,currentAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:0,currentPeriod:0,currentAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:28.46,currentPeriod:0,currentAmount:0},{customerType:"\u540C\u4E1A",initialAmount:821.55,currentPeriod:0,currentAmount:0},{customerType:"\u7528\u6237",initialAmount:577.37,currentPeriod:0,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:220.08,currentPeriod:0,currentAmount:0}],A=[{customerType:"\u7528\u6237",initialAmount:26.6,currentPeriod:0,currentAmount:0}],_=[{customerType:"\u4E00\u5305",initialAmount:12720.17,currentPeriod:0,currentAmount:0},{customerType:"\u4E8C\u5305",initialAmount:960.55,currentPeriod:0,currentAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:1818.79,currentPeriod:0,currentAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:8063.91,currentPeriod:0,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:1973.08,currentPeriod:0,currentAmount:0}],a=b(JSON.parse(JSON.stringify(v))),c=b(JSON.parse(JSON.stringify(A))),i=b(JSON.parse(JSON.stringify(_))),m=r=>(Number(r)||0).toLocaleString(),q=b([]),U=async r=>{try{const t=[],e=r.substring(0,4),o=parseInt(r.substring(5,7));for(let n=1;n<o;n++){const y=`${e}-${n.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/inventory-structure/${y}`);if(g.ok){const x=await g.json();x.success&&x.data&&t.push({period:y,data:x.data})}}catch(g){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${y}:`,g)}}q.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},w=(r,t)=>{let e=0;for(const y of q.value)if(y.data[r]){const g=y.data[r].find(x=>x.customerType===t);g&&g.currentPeriod&&(e+=parseFloat(g.currentPeriod.toString())||0)}let o=[];r==="equipment"?o=a.value:r==="component"?o=c.value:r==="project"&&(o=i.value);const n=o.find(y=>y.customerType===t);return n&&n.currentPeriod&&(e+=parseFloat(n.currentPeriod.toString())||0),e},k=()=>{a.value.forEach(r=>{const t=w("equipment",r.customerType);r.currentAmount=t}),c.value.forEach(r=>{const t=w("component",r.customerType);r.currentAmount=t}),i.value.forEach(r=>{const t=w("project",r.customerType);r.currentAmount=t})},E=(r,t)=>r===0?"0.00":((t-r)/r*100).toFixed(2),V=O(()=>[...a.value,...c.value,...i.value].reduce((r,t)=>r+(Number(t.initialAmount)||0),0)),M=O(()=>[...a.value,...c.value,...i.value].reduce((r,t)=>r+(Number(t.currentPeriod)||0),0)),$=O(()=>[...a.value,...c.value,...i.value].reduce((r,t)=>r+(Number(t.currentAmount)||0),0)),f=async r=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${J.INVENTORY_STRUCTURE}/${r}`);if(t.ok){const e=await t.json();e.success&&e.data&&(D.value=e.data.remarks||"",F.value=e.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",t)}},I=(r,t)=>(t.equipment&&Array.isArray(t.equipment)&&(r.equipment=v.map(e=>{const o=t.equipment.find(n=>n.customerType===e.customerType);return o?{...e,initialAmount:e.initialAmount,currentPeriod:Number(o.currentPeriod)||0,currentAmount:0}:e})),t.component&&Array.isArray(t.component)&&(r.component=A.map(e=>{const o=t.component.find(n=>n.customerType===e.customerType);return o?{...e,initialAmount:e.initialAmount,currentPeriod:Number(o.currentPeriod)||0,currentAmount:0}:e})),t.project&&Array.isArray(t.project)&&(r.project=_.map(e=>{const o=t.project.find(n=>n.customerType===e.customerType);return o?{...e,initialAmount:e.initialAmount,currentPeriod:Number(o.currentPeriod)||0,currentAmount:0}:e})),r),S=async r=>{try{const t=await fetch(`http://47.111.95.19:3000/inventory-structure/${r}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),a.value=JSON.parse(JSON.stringify(v)),c.value=JSON.parse(JSON.stringify(A)),i.value=JSON.parse(JSON.stringify(_)),await U(r),k();return}const e=await t.json();if(e.success&&e.data){const o=I({equipment:v,component:A,project:_},e.data);a.value=o.equipment,c.value=o.component,i.value=o.project}await U(r),k()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t)}};T(()=>[a.value.map(r=>r.currentPeriod),c.value.map(r=>r.currentPeriod),i.value.map(r=>r.currentPeriod)],()=>{k()},{deep:!0}),T(p,r=>{S(r),f(r)}),T(()=>h.query.period,r=>{r&&(p.value=r.toString(),S(r.toString()),f(r.toString()))}),T(p,(r,t)=>{r&&r!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${r}`),S(r),f(r))});const Y=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/inventory-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:p.value,data:{equipment:a.value,component:c.value,project:i.value}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Z(J.INVENTORY_STRUCTURE,p.value,{equipment:a.value,component:c.value,project:i.value},D.value,F.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(r){console.error("\u4FDD\u5B58\u5931\u8D25:",r),alert("\u4FDD\u5B58\u5931\u8D25")}},L=()=>{a.value=JSON.parse(JSON.stringify(v)),c.value=JSON.parse(JSON.stringify(A)),i.value=JSON.parse(JSON.stringify(_))};return H(()=>{h.query.period?(S(h.query.period.toString()),f(h.query.period.toString())):f(p.value)}),(r,t)=>(d(),l("div",rr,[u("div",tr,[t[3]||(t[3]=u("h1",{class:"text-2xl font-bold"},"\u5B58\u91CF\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),u("div",er,[N(u("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>p.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,p.value]])])]),u("div",ur,[u("table",or,[t[5]||(t[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),u("tbody",null,[(d(!0),l(P,null,B(a.value,(e,o)=>(d(),l("tr",{key:`equipment-${o}`},[o===0?(d(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:a.value.length}," \u8BBE\u5907 ",8,nr)):j("",!0),u("td",sr,s(e.customerType),1),u("td",ar,[u("span",null,s(m(e.initialAmount)),1)]),u("td",cr,[N(u("input",{"onUpdate:modelValue":n=>e.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ir),[[C,e.currentPeriod,void 0,{number:!0}]])]),u("td",lr,[u("span",dr,s(m(e.currentAmount)),1)]),u("td",pr,s(E(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),(d(!0),l(P,null,B(c.value,(e,o)=>(d(),l("tr",{key:`component-${o}`},[o===0?(d(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u5143\u4EF6 ",8,mr)):j("",!0),u("td",yr,s(e.customerType),1),u("td",gr,[u("span",null,s(m(e.initialAmount)),1)]),u("td",br,[N(u("input",{"onUpdate:modelValue":n=>e.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,hr),[[C,e.currentPeriod,void 0,{number:!0}]])]),u("td",vr,[u("span",Ar,s(m(e.currentAmount)),1)]),u("td",_r,s(E(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),(d(!0),l(P,null,B(i.value,(e,o)=>(d(),l("tr",{key:`project-${o}`},[o===0?(d(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u5DE5\u7A0B ",8,fr)):j("",!0),u("td",xr,s(e.customerType),1),u("td",Dr,[u("span",null,s(m(e.initialAmount)),1)]),u("td",Fr,[N(u("input",{"onUpdate:modelValue":n=>e.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Er),[[C,e.currentPeriod,void 0,{number:!0}]])]),u("td",Sr,[u("span",Tr,s(m(e.currentAmount)),1)]),u("td",Nr,s(E(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),u("tr",Cr,[t[4]||(t[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",wr,s(m(V.value)),1),u("td",kr,s(m(M.value)),1),u("td",Or,s(m($.value)),1),u("td",Pr,s(E(V.value,$.value))+"% ",1)])])])]),K(X,{"module-id":Q(J).INVENTORY_STRUCTURE,period:p.value,remarks:D.value,"onUpdate:remarks":t[1]||(t[1]=e=>D.value=e),suggestions:F.value,"onUpdate:suggestions":t[2]||(t[2]=e=>F.value=e)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:Y,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:L,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ur=G(Br,[["__scopeId","data-v-77c78994"]]);export{Ur as default};
