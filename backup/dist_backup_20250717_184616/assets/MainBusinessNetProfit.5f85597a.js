import{_ as H,d as K,r as v,c as Q,B as R,o as W,b as h,e as t,y as k,A as S,F as N,g as $,t as p,k as X,h as Y,G as Z,v as _,f as j}from"./index.46f0422c.js";import{_ as ee,r as te,M as P,l as ue}from"./FormAttachmentAndRemarks.e711ebca.js";const oe={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},re={class:"flex justify-between items-center mb-6"},ae={class:"flex items-center space-x-4"},se={class:"overflow-x-auto my-6"},ne={class:"w-full border-collapse border border-gray-300"},le=["rowspan"],ce={class:"border border-gray-300 px-4 py-2"},pe={class:"border border-gray-300 px-4 py-2"},ie=["onUpdate:modelValue"],de={class:"border border-gray-300 px-4 py-2"},ye={class:"font-medium"},ge={class:"border border-gray-300 px-4 py-2"},me={class:"font-medium"},be={class:"border border-gray-300 px-4 py-2"},he=["rowspan"],_e={class:"border border-gray-300 px-4 py-2"},Fe={class:"border border-gray-300 px-4 py-2"},De=["onUpdate:modelValue"],Ee={class:"border border-gray-300 px-4 py-2"},ve={class:"font-medium"},fe={class:"border border-gray-300 px-4 py-2"},Be={class:"font-medium"},xe={class:"border border-gray-300 px-4 py-2"},Ae=["rowspan"],Me={class:"border border-gray-300 px-4 py-2"},Ce={class:"border border-gray-300 px-4 py-2"},Ve=["onUpdate:modelValue"],we={class:"border border-gray-300 px-4 py-2"},Te={class:"font-medium"},ke={class:"border border-gray-300 px-4 py-2"},Se={class:"font-medium"},Ie={class:"border border-gray-300 px-4 py-2"},Ne={class:"bg-gray-50 font-bold"},$e={class:"border border-gray-300 px-4 py-2"},je={class:"border border-gray-300 px-4 py-2"},Pe={class:"border border-gray-300 px-4 py-2"},Ue={class:"border border-gray-300 px-4 py-2"},qe=K({__name:"MainBusinessNetProfit",setup(Re){var U;const C=Z(),i=v(((U=C.query.period)==null?void 0:U.toString())||new Date().toISOString().slice(0,7)),f=v(""),B=v(""),x=()=>[{customerType:"\u4E0A\u6D77",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u56FD\u7F51",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u540C\u4E1A",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],A=()=>[{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],M=()=>[{customerType:"\u4E00\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u4E8C\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],y=v(x()),g=v(A()),m=v(M()),F=r=>r.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),O=async r=>{var o,e,s;try{const[u,n,l]=await Promise.all([fetch(`http://47.111.95.19:3000/main-business-income/${r}`),fetch(`http://47.111.95.19:3000/main-business-cost/${r}`),fetch(`http://47.111.95.19:3000/cost-center-structure/${r}`)]),a=await Promise.all([u.ok?u.json():null,n.ok?n.json():null,l.ok?l.json():null]);return{income:(o=a[0])!=null&&o.success?a[0].data:null,cost:(e=a[1])!=null&&e.success?a[1].data:null,center:(s=a[2])!=null&&s.success?a[2].data:null}}catch(u){return console.error(`\u83B7\u53D6${r}\u6570\u636E\u5931\u8D25:`,u),{income:null,cost:null,center:null}}},L=(r,o,e)=>{try{let s=0,u=0,n=0;if(e.income){const a={\u8BBE\u5907:"equipment",\u5143\u4EF6:"components",\u5DE5\u7A0B:"engineering"},c=e.income[a[o]];if(c&&Array.isArray(c)){const d=c.find(b=>b.customer===r.customerType);d&&(s=parseFloat(d.currentMonthIncome)||0)}}if(e.cost){const a={\u8BBE\u5907:"equipment",\u5143\u4EF6:"component",\u5DE5\u7A0B:"project"},c=e.cost[a[o]];if(c&&Array.isArray(c)){const d=c.find(b=>b.customerType===r.customerType);if(d){const b=parseFloat(d.currentMaterialCost)||0,T=parseFloat(d.currentLaborCost)||0;u=b+T}}}if(e.center){const a={\u8BBE\u5907:"equipmentData",\u5143\u4EF6:"componentData",\u5DE5\u7A0B:"engineeringData"},c=e.center[a[o]];if(c&&Array.isArray(c)){const d=c.find(b=>b.customerType===r.customerType);d&&(n=parseFloat(d.currentMonthIncome)||0)}}const l=s-u-n;return(s>0||u>0||n>0)&&console.log(`${o} - ${r.customerType}:`,{mainBusinessIncome:s,mainBusinessCost:u,costCenterActual:n,netProfit:l,incomeData:e.income?Object.keys(e.income):"null",costData:e.cost?Object.keys(e.cost):"null",centerData:e.center?Object.keys(e.center):"null"}),l}catch(s){return console.error("\u8BA1\u7B97\u5F53\u6708\u51C0\u5229\u6DA6\u5931\u8D25:",s),0}},V=Q(()=>{let r=0,o=0,e=0;y.value.forEach(u=>{var n,l,a;r+=parseFloat((n=u.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((l=u.currentMonthValue)==null?void 0:l.replace(/,/g,""))||0,e+=parseFloat((a=u.actual)==null?void 0:a.replace(/,/g,""))||0}),g.value.forEach(u=>{var n,l,a;r+=parseFloat((n=u.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((l=u.currentMonthValue)==null?void 0:l.replace(/,/g,""))||0,e+=parseFloat((a=u.actual)==null?void 0:a.replace(/,/g,""))||0}),m.value.forEach(u=>{var n,l,a;r+=parseFloat((n=u.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((l=u.currentMonthValue)==null?void 0:l.replace(/,/g,""))||0,e+=parseFloat((a=u.actual)==null?void 0:a.replace(/,/g,""))||0});let s="0.00%";return r!==0&&(s=`${(e/r*100).toFixed(2)}%`),{plan:r,currentMonthValue:o,actual:e,contribution:s}}),D=(r,o,e)=>r.map(s=>{var n;const u=o==null?void 0:o.find(l=>l.segment===e&&l.customerType===s.customerType);return u?{customerType:s.customerType,plan:((n=u.yearlyPlan)==null?void 0:n.toString())||"0",currentMonthValue:"0",actual:"0",contribution:"0.00%",yearlyPlan:u.yearlyPlan||0}:s}),w=async r=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u6570\u636E\uFF0C\u671F\u95F4: ${r}`);const o=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${r}`);let e=[];if(o.ok){const s=await o.json();console.log("API\u8FD4\u56DE\u6570\u636E:",s),s.success&&s.data&&Array.isArray(s.data)&&(e=s.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else o.status===404?(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),y.value=x(),g.value=A(),m.value=M()):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");y.value=D(x(),e,"\u8BBE\u5907"),g.value=D(A(),e,"\u5143\u4EF6"),m.value=D(M(),e,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:y.value,componentData:g.value,projectData:m.value}),await G()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),y.value=D(x(),[],"\u8BBE\u5907"),g.value=D(A(),[],"\u5143\u4EF6"),m.value=D(M(),[],"\u5DE5\u7A0B")}},G=async()=>{var r,o;try{const[e]=i.value.split("-"),s=parseInt(i.value.split("-")[1]),u=[];for(let a=1;a<=s;a++){const c=`${e}-${a.toString().padStart(2,"0")}`;u.push(O(c))}const n=await Promise.all(u),l=[...y.value.map(a=>({...a,segment:"\u8BBE\u5907"})),...g.value.map(a=>({...a,segment:"\u5143\u4EF6"})),...m.value.map(a=>({...a,segment:"\u5DE5\u7A0B"}))];for(const a of l){let c=0,d=0;for(let E=0;E<n.length;E++){const q=L(a,a.segment,n[E]);c+=q,E===n.length-1&&(d=q)}a.currentMonthValue=d.toFixed(2),a.actual=c.toFixed(2);const b=parseFloat(((r=a.plan)==null?void 0:r.replace(/,/g,""))||"0"),T=parseFloat(((o=a.actual)==null?void 0:o.replace(/,/g,""))||"0");if(!isNaN(b)&&!isNaN(T)&&b!==0){const E=(T/b*100).toFixed(2);a.contribution=`${E}%`}else a.contribution="0.00%"}console.log("\u6240\u6709\u9879\u76EE\u8BA1\u7B97\u5B8C\u6210")}catch(e){console.error("\u6279\u91CF\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",e)}};R(()=>C.query.period,r=>{r&&(i.value=r.toString(),w(r.toString()),I())}),R(i,r=>{w(r),I()});const J=async()=>{try{const r=[...y.value.map(u=>({...u,segment:"\u8BBE\u5907"})),...g.value.map(u=>({...u,segment:"\u5143\u4EF6"})),...m.value.map(u=>({...u,segment:"\u5DE5\u7A0B"}))],o={period:i.value,data:r};console.log("\u4FDD\u5B58\u6570\u636E:",o);const e=await fetch("http://47.111.95.19:3000/main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok){const u=await e.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${e.status} - ${u}`)}const s={equipment:y.value,component:g.value,project:m.value};await te(P.MAIN_BUSINESS_NET_PROFIT,i.value,s,f.value,B.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(r){console.error("\u4FDD\u5B58\u5931\u8D25:",r),alert("\u4FDD\u5B58\u5931\u8D25: "+(r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"))}},z=()=>{y.value=x(),g.value=A(),m.value=M(),f.value="",B.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},I=async()=>{const{remarks:r,suggestions:o}=await ue(P.MAIN_BUSINESS_NET_PROFIT,i.value);f.value=r,B.value=o};return W(()=>{console.log("\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",i.value),C.query.period?w(C.query.period.toString()):w(i.value),I()}),(r,o)=>(_(),h("div",oe,[t("div",re,[o[3]||(o[3]=t("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),t("div",ae,[k(t("input",{"onUpdate:modelValue":o[0]||(o[0]=e=>i.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[S,i.value]])])]),t("div",se,[t("table",ne,[o[5]||(o[5]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u677F\u5757"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5E74\u5EA6\u8BA1\u5212"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u6708\u503C"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u7D2F\u8BA1\u503C"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4")])],-1)),t("tbody",null,[(_(!0),h(N,null,$(y.value,(e,s)=>{var u;return _(),h("tr",{key:`equipment-${s}`},[s===0?(_(),h("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:y.value.length}," \u8BBE\u5907 ",8,le)):j("",!0),t("td",ce,p(e.customerType),1),t("td",pe,[k(t("input",{"onUpdate:modelValue":n=>e.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,ie),[[S,e.plan]])]),t("td",de,[t("span",ye,p(F(parseFloat((u=e.currentMonthValue)==null?void 0:u.replace(/,/g,""))||0)),1)]),t("td",ge,[t("span",me,p(e.actual),1)]),t("td",be,p(e.contribution),1)])}),128)),(_(!0),h(N,null,$(g.value,(e,s)=>{var u;return _(),h("tr",{key:`component-${s}`},[s===0?(_(),h("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:g.value.length}," \u5143\u4EF6 ",8,he)):j("",!0),t("td",_e,p(e.customerType),1),t("td",Fe,[k(t("input",{"onUpdate:modelValue":n=>e.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,De),[[S,e.plan]])]),t("td",Ee,[t("span",ve,p(F(parseFloat((u=e.currentMonthValue)==null?void 0:u.replace(/,/g,""))||0)),1)]),t("td",fe,[t("span",Be,p(e.actual),1)]),t("td",xe,p(e.contribution),1)])}),128)),(_(!0),h(N,null,$(m.value,(e,s)=>{var u;return _(),h("tr",{key:`project-${s}`},[s===0?(_(),h("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:m.value.length}," \u5DE5\u7A0B ",8,Ae)):j("",!0),t("td",Me,p(e.customerType),1),t("td",Ce,[k(t("input",{"onUpdate:modelValue":n=>e.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Ve),[[S,e.plan]])]),t("td",we,[t("span",Te,p(F(parseFloat((u=e.currentMonthValue)==null?void 0:u.replace(/,/g,""))||0)),1)]),t("td",ke,[t("span",Se,p(e.actual),1)]),t("td",Ie,p(e.contribution),1)])}),128)),t("tr",Ne,[o[4]||(o[4]=t("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),t("td",$e,p(F(V.value.plan)),1),t("td",je,p(F(V.value.currentMonthValue)),1),t("td",Pe,p(F(V.value.actual)),1),t("td",Ue,p(V.value.contribution),1)])])])]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:J,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:z,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),X(ee,{"module-id":Y(P).MAIN_BUSINESS_NET_PROFIT,period:i.value,remarks:f.value,"onUpdate:remarks":o[1]||(o[1]=e=>f.value=e),suggestions:B.value,"onUpdate:suggestions":o[2]||(o[2]=e=>B.value=e)},null,8,["module-id","period","remarks","suggestions"])]))}});var Ge=H(qe,[["__scopeId","data-v-0638c17f"]]);export{Ge as default};
