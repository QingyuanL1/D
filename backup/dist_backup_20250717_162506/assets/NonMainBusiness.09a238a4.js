import{_ as $,d as I,r as g,B as F,c as O,o as V,b as w,e as u,y as x,A as v,F as T,g as R,t as l,k as Y,h as L,G,v as N}from"./index.df4b3d60.js";import{_ as J,M as S,r as z}from"./FormAttachmentAndRemarks.6c281457.js";const H={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},K={class:"flex justify-between items-center mb-6"},Q={class:"flex items-center space-x-4"},W={class:"overflow-x-auto my-6"},X={class:"w-full border-collapse border border-gray-300"},Z={class:"border border-gray-300 px-4 py-2 text-center"},ee={class:"border border-gray-300 px-4 py-2"},te=["onUpdate:modelValue"],ue={class:"border border-gray-300 px-4 py-2"},re=["onUpdate:modelValue"],se={class:"border border-gray-300 px-4 py-2"},ae=["onUpdate:modelValue"],ne={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"text-sm font-medium"},ce={class:"bg-gray-50 font-bold"},ie={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"border border-gray-300 px-4 py-2 text-right"},pe={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"border border-gray-300 px-4 py-2 text-right"},me={class:"text-sm font-bold"},ye=I({__name:"NonMainBusiness",setup(ge){var A;const h=G(),n=g(((A=h.query.period)==null?void 0:A.toString())||new Date().toISOString().slice(0,7)),E=()=>({items:[{sequenceNumber:1,financialSubject:"\u65E0",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0},{sequenceNumber:2,financialSubject:"",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0}]}),a=g(E()),i=g(""),d=g(""),b=e=>e===0?"0.00":e.toFixed(2),B=e=>e===0?"0.00":e.toFixed(2),U=()=>{const e=a.value.items.length+1;a.value.items.push({sequenceNumber:e,financialSubject:"",annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0})},j=()=>{a.value.items.length>1&&a.value.items.pop()},p=async e=>{try{const[t]=e.split("-"),r=parseInt(e.split("-")[1]);for(let s of a.value.items){let o=0;for(let D=1;D<r;D++){const C=`${t}-${D.toString().padStart(2,"0")}`;try{const y=await fetch(`http://47.111.95.19:3000/tuoyuan-non-main-business/${C}`);if(y.ok){const P=(await y.json()).data.items.find(k=>k.sequenceNumber===s.sequenceNumber&&k.financialSubject===s.financialSubject);P&&(o+=P.currentPeriod||0)}}catch(y){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${C}\u7684\u6570\u636E:`,y)}}o+=s.currentPeriod||0,s.currentCumulative=o,s.executionProgress=s.annualPlan>0?s.currentCumulative/s.annualPlan*100:0}}catch(t){console.error("\u8BA1\u7B97\u5F53\u671F\u7D2F\u8BA1\u5931\u8D25:",t)}};F(()=>a.value.items,async e=>{await p(n.value)},{deep:!0});const m=O(()=>{const e={annualPlan:0,currentPeriod:0,currentCumulative:0,executionProgress:0};return a.value.items.forEach(t=>{e.annualPlan+=t.annualPlan||0,e.currentPeriod+=t.currentPeriod||0,e.currentCumulative+=t.currentCumulative||0}),e.executionProgress=e.annualPlan>0?e.currentCumulative/e.annualPlan*100:0,e}),f=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/tuoyuan-non-main-business/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),c();return}const r=await t.json();r.data&&r.data.items&&(a.value.items=r.data.items.map(s=>({sequenceNumber:Number(s.sequenceNumber)||0,financialSubject:s.financialSubject||"",annualPlan:Number(s.annualPlan)||0,currentPeriod:Number(s.currentPeriod)||0,currentCumulative:Number(s.currentCumulative)||0,executionProgress:Number(s.executionProgress)||0}))),await p(e)}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),c()}},c=()=>{a.value=E()},_=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${S.TUOYUAN_NON_MAIN_BUSINESS}/${e}`);if(t.ok){const r=await t.json();r.success&&r.data&&(i.value=r.data.remarks||"",d.value=r.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};F(()=>h.query.period,async e=>{e&&(n.value=e.toString(),c(),await f(e.toString()),await p(e.toString()),_(e.toString()))}),F(n,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),c(),await f(e),await p(e),_(e))});const q=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-non-main-business",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:{items:a.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await z(S.TUOYUAN_NON_MAIN_BUSINESS,n.value,{items:a.value.items},i.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},M=()=>{c(),i.value="",d.value=""};return V(async()=>{var t;c();const e=((t=h.query.period)==null?void 0:t.toString())||n.value;await f(e),await p(e),_(e)}),(e,t)=>(N(),w("div",H,[u("div",K,[t[5]||(t[5]=u("h1",{class:"text-2xl font-bold"},"\u975E\u4E3B\u8425\u4E1A\u52A1\u60C5\u51B5",-1)),u("div",Q,[t[3]||(t[3]=u("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),t[4]||(t[4]=u("span",{class:"text-xs text-gray-500"},"\u5F53\u671F\u7D2F\u8BA1 = \u5F53\u671F + \u4E4B\u524D\u5404\u6708\u7D2F\u8BA1",-1)),x(u("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>n.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[v,n.value]])])]),u("div",W,[u("table",X,[t[7]||(t[7]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2 w-16"},"\u5E8F\u53F7"),u("th",{class:"border border-gray-300 px-4 py-2 w-48"},"\u8D22\u52A1\u79D1\u76EE"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u5EA6\u8BA1\u5212"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),u("tbody",null,[(N(!0),w(T,null,R(a.value.items,(r,s)=>(N(),w("tr",{key:`item-${s}`},[u("td",Z,l(r.sequenceNumber),1),u("td",ee,[x(u("input",{"onUpdate:modelValue":o=>r.financialSubject=o,type:"text",class:"w-full px-2 py-1 border rounded",placeholder:"\u8BF7\u8F93\u5165\u8D22\u52A1\u79D1\u76EE"},null,8,te),[[v,r.financialSubject]])]),u("td",ue,[x(u("input",{"onUpdate:modelValue":o=>r.annualPlan=o,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,re),[[v,r.annualPlan]])]),u("td",se,[x(u("input",{"onUpdate:modelValue":o=>r.currentPeriod=o,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ae),[[v,r.currentPeriod]])]),u("td",ne,l(b(r.currentCumulative)),1),u("td",oe,[u("span",le,l(B(r.executionProgress))+"%",1)])]))),128)),u("tr",ce,[t[6]||(t[6]=u("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u("td",ie,l(b(m.value.annualPlan)),1),u("td",de,l(b(m.value.currentPeriod)),1),u("td",pe,l(b(m.value.currentCumulative)),1),u("td",be,[u("span",me,l(B(m.value.executionProgress))+"%",1)])])])])]),u("div",{class:"mb-4 flex justify-start space-x-4"},[u("button",{onClick:U,class:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"}," \u6DFB\u52A0\u884C "),u("button",{onClick:j,class:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"}," \u5220\u9664\u6700\u540E\u4E00\u884C ")]),Y(J,{"module-id":L(S).TUOYUAN_NON_MAIN_BUSINESS,period:n.value,remarks:i.value,"onUpdate:remarks":t[1]||(t[1]=r=>i.value=r),suggestions:d.value,"onUpdate:suggestions":t[2]||(t[2]=r=>d.value=r)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:q,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:M,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var fe=$(ye,[["__scopeId","data-v-9e01c2ce"]]);export{fe as default};
