import{_ as G,d as z,r as b,c as O,B as T,o as H,b as l,e as u,y as N,A as C,F as P,g as B,t as s,k as K,h as Q,G as W,v as d,f as j}from"./index.19706d64.js";import{_ as X,M as J,r as Z}from"./FormAttachmentAndRemarks.3ddcf740.js";const tt={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},rt={class:"flex justify-between items-center mb-6"},et={class:"flex items-center space-x-4"},ut={class:"overflow-x-auto my-6"},ot={class:"w-full border-collapse border border-gray-300"},nt=["rowspan"],st={class:"border border-gray-300 px-4 py-2"},at={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ct={class:"border border-gray-300 px-4 py-2"},it=["onUpdate:modelValue"],lt={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"font-medium"},pt={class:"border border-gray-300 px-4 py-2 text-right"},mt=["rowspan"],yt={class:"border border-gray-300 px-4 py-2"},gt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},bt={class:"border border-gray-300 px-4 py-2"},vt=["onUpdate:modelValue"],ht={class:"border border-gray-300 px-4 py-2 text-right"},At={class:"font-medium"},_t={class:"border border-gray-300 px-4 py-2 text-right"},ft=["rowspan"],xt={class:"border border-gray-300 px-4 py-2"},Dt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},Ft={class:"border border-gray-300 px-4 py-2"},Et=["onUpdate:modelValue"],St={class:"border border-gray-300 px-4 py-2 text-right"},Tt={class:"font-medium"},Nt={class:"border border-gray-300 px-4 py-2 text-right"},Ct={class:"bg-gray-50 font-bold"},wt={class:"border border-gray-300 px-4 py-2 text-right"},kt={class:"border border-gray-300 px-4 py-2 text-right"},Ot={class:"border border-gray-300 px-4 py-2 text-right"},Pt={class:"border border-gray-300 px-4 py-2 text-right"},Bt=z({__name:"InventoryStructure",setup(jt){var R;const v=W(),p=b(((R=v.query.period)==null?void 0:R.toString())||new Date().toISOString().slice(0,7)),D=b(""),F=b(""),h=[{customerType:"\u4E0A\u6D77",initialAmount:39151.53,currentPeriod:0,currentAmount:0},{customerType:"\u56FD\u7F51",initialAmount:7841.48,currentPeriod:0,currentAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:6793.01,currentPeriod:0,currentAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:0,currentPeriod:0,currentAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:28.46,currentPeriod:0,currentAmount:0},{customerType:"\u540C\u4E1A",initialAmount:821.55,currentPeriod:0,currentAmount:0},{customerType:"\u7528\u6237",initialAmount:577.37,currentPeriod:0,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:220.08,currentPeriod:0,currentAmount:0}],A=[{customerType:"\u7528\u6237",initialAmount:26.6,currentPeriod:0,currentAmount:0}],_=[{customerType:"\u4E00\u5305",initialAmount:12720.17,currentPeriod:0,currentAmount:0},{customerType:"\u4E8C\u5305",initialAmount:960.55,currentPeriod:0,currentAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:1818.79,currentPeriod:0,currentAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:8063.91,currentPeriod:0,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:1973.08,currentPeriod:0,currentAmount:0}],a=b(JSON.parse(JSON.stringify(h))),c=b(JSON.parse(JSON.stringify(A))),i=b(JSON.parse(JSON.stringify(_))),m=t=>(Number(t)||0).toLocaleString(),q=b([]),U=async t=>{try{const r=[],e=t.substring(0,4),o=parseInt(t.substring(5,7));for(let n=1;n<o;n++){const y=`${e}-${n.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/inventory-structure/${y}`);if(g.ok){const x=await g.json();x.success&&x.data&&r.push({period:y,data:x.data})}}catch(g){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${y}:`,g)}}q.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(r){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",r)}},w=(t,r)=>{let e=0;for(const y of q.value)if(y.data[t]){const g=y.data[t].find(x=>x.customerType===r);g&&g.currentPeriod&&(e+=parseFloat(g.currentPeriod.toString())||0)}let o=[];t==="equipment"?o=a.value:t==="component"?o=c.value:t==="project"&&(o=i.value);const n=o.find(y=>y.customerType===r);return n&&n.currentPeriod&&(e+=parseFloat(n.currentPeriod.toString())||0),e},k=()=>{a.value.forEach(t=>{const r=w("equipment",t.customerType);t.currentAmount=r}),c.value.forEach(t=>{const r=w("component",t.customerType);t.currentAmount=r}),i.value.forEach(t=>{const r=w("project",t.customerType);t.currentAmount=r})},E=(t,r)=>t===0?"0.00":((r-t)/t*100).toFixed(2),V=O(()=>[...a.value,...c.value,...i.value].reduce((t,r)=>t+(Number(r.initialAmount)||0),0)),M=O(()=>[...a.value,...c.value,...i.value].reduce((t,r)=>t+(Number(r.currentPeriod)||0),0)),$=O(()=>[...a.value,...c.value,...i.value].reduce((t,r)=>t+(Number(r.currentAmount)||0),0)),f=async t=>{try{const r=await fetch(`http://47.111.95.19:3000/forms/submission/${J.INVENTORY_STRUCTURE}/${t}`);if(r.ok){const e=await r.json();e.success&&e.data&&(D.value=e.data.remarks||"",F.value=e.data.suggestions||"")}}catch(r){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",r)}},I=(t,r)=>(r.equipment&&Array.isArray(r.equipment)&&(t.equipment=h.map(e=>{const o=r.equipment.find(n=>n.customerType===e.customerType);return o?{...e,initialAmount:e.initialAmount,currentPeriod:Number(o.currentPeriod)||0,currentAmount:0}:e})),r.component&&Array.isArray(r.component)&&(t.component=A.map(e=>{const o=r.component.find(n=>n.customerType===e.customerType);return o?{...e,initialAmount:e.initialAmount,currentPeriod:Number(o.currentPeriod)||0,currentAmount:0}:e})),r.project&&Array.isArray(r.project)&&(t.project=_.map(e=>{const o=r.project.find(n=>n.customerType===e.customerType);return o?{...e,initialAmount:e.initialAmount,currentPeriod:Number(o.currentPeriod)||0,currentAmount:0}:e})),t),S=async t=>{try{const r=await fetch(`http://47.111.95.19:3000/inventory-structure/${t}`);if(!r.ok){if(r.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),a.value=JSON.parse(JSON.stringify(h)),c.value=JSON.parse(JSON.stringify(A)),i.value=JSON.parse(JSON.stringify(_)),await U(t),k();return}const e=await r.json();if(e.success&&e.data){const o=I({equipment:h,component:A,project:_},e.data);a.value=o.equipment,c.value=o.component,i.value=o.project}await U(t),k()}catch(r){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",r)}};T(()=>[a.value.map(t=>t.currentPeriod),c.value.map(t=>t.currentPeriod),i.value.map(t=>t.currentPeriod)],()=>{k()},{deep:!0}),T(p,t=>{S(t),f(t)}),T(()=>v.query.period,t=>{t&&(p.value=t.toString(),S(t.toString()),f(t.toString()))}),T(p,(t,r)=>{t&&t!==r&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${r} -> ${t}`),S(t),f(t))});const Y=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/inventory-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:p.value,data:{equipment:a.value,component:c.value,project:i.value}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Z(J.INVENTORY_STRUCTURE,p.value,{equipment:a.value,component:c.value,project:i.value},D.value,F.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},L=()=>{a.value=JSON.parse(JSON.stringify(h)),c.value=JSON.parse(JSON.stringify(A)),i.value=JSON.parse(JSON.stringify(_))};return H(()=>{v.query.period?(S(v.query.period.toString()),f(v.query.period.toString())):f(p.value)}),(t,r)=>(d(),l("div",tt,[u("div",rt,[r[3]||(r[3]=u("h1",{class:"text-2xl font-bold"},"\u5B58\u91CF\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),u("div",et,[N(u("input",{"onUpdate:modelValue":r[0]||(r[0]=e=>p.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,p.value]])])]),u("div",ut,[u("table",ot,[r[5]||(r[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u91D1\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),u("tbody",null,[(d(!0),l(P,null,B(a.value,(e,o)=>(d(),l("tr",{key:`equipment-${o}`},[o===0?(d(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:a.value.length}," \u8BBE\u5907 ",8,nt)):j("",!0),u("td",st,s(e.customerType),1),u("td",at,[u("span",null,s(m(e.initialAmount)),1)]),u("td",ct,[N(u("input",{"onUpdate:modelValue":n=>e.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,it),[[C,e.currentPeriod,void 0,{number:!0}]])]),u("td",lt,[u("span",dt,s(m(e.currentAmount)),1)]),u("td",pt,s(E(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),(d(!0),l(P,null,B(c.value,(e,o)=>(d(),l("tr",{key:`component-${o}`},[o===0?(d(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u5143\u4EF6 ",8,mt)):j("",!0),u("td",yt,s(e.customerType),1),u("td",gt,[u("span",null,s(m(e.initialAmount)),1)]),u("td",bt,[N(u("input",{"onUpdate:modelValue":n=>e.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,vt),[[C,e.currentPeriod,void 0,{number:!0}]])]),u("td",ht,[u("span",At,s(m(e.currentAmount)),1)]),u("td",_t,s(E(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),(d(!0),l(P,null,B(i.value,(e,o)=>(d(),l("tr",{key:`project-${o}`},[o===0?(d(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u5DE5\u7A0B ",8,ft)):j("",!0),u("td",xt,s(e.customerType),1),u("td",Dt,[u("span",null,s(m(e.initialAmount)),1)]),u("td",Ft,[N(u("input",{"onUpdate:modelValue":n=>e.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Et),[[C,e.currentPeriod,void 0,{number:!0}]])]),u("td",St,[u("span",Tt,s(m(e.currentAmount)),1)]),u("td",Nt,s(E(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),u("tr",Ct,[r[4]||(r[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",wt,s(m(V.value)),1),u("td",kt,s(m(M.value)),1),u("td",Ot,s(m($.value)),1),u("td",Pt,s(E(V.value,$.value))+"% ",1)])])])]),K(X,{"module-id":Q(J).INVENTORY_STRUCTURE,period:p.value,remarks:D.value,"onUpdate:remarks":r[1]||(r[1]=e=>D.value=e),suggestions:F.value,"onUpdate:suggestions":r[2]||(r[2]=e=>F.value=e)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:Y,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:L,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ut=G(Bt,[["__scopeId","data-v-4791a77d"]]);export{Ut as default};
