import{_ as G,d as J,r as _,c as Y,B as h,o as z,b as F,e as u,y as A,A as w,F as j,g as q,t as c,k as H,h as K,G as Q,v as E,f as V}from"./index.c4217200.js";import{_ as W,r as X,M as N,l as Z}from"./FormAttachmentAndRemarks.4875c6d1.js";const ee={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},te={class:"flex justify-between items-center mb-6"},re={class:"flex items-center space-x-4"},ue={class:"overflow-x-auto my-6"},se={class:"w-full border-collapse border border-gray-300"},ae=["rowspan"],oe={class:"border border-gray-300 px-4 py-2"},ce={class:"border border-gray-300 px-4 py-2"},le={class:"w-full px-2 py-1"},ne={class:"border border-gray-300 px-4 py-2"},pe=["onUpdate:modelValue"],de={class:"border border-gray-300 px-4 py-2"},ie={class:"font-medium"},ye={class:"border border-gray-300 px-4 py-2"},ge=["rowspan"],Fe={class:"border border-gray-300 px-4 py-2"},Ee={class:"border border-gray-300 px-4 py-2"},_e={class:"w-full px-2 py-1"},be={class:"border border-gray-300 px-4 py-2"},me=["onUpdate:modelValue"],ve={class:"border border-gray-300 px-4 py-2"},he={class:"font-medium"},De={class:"border border-gray-300 px-4 py-2"},fe=["rowspan"],xe={class:"border border-gray-300 px-4 py-2"},Re={class:"border border-gray-300 px-4 py-2"},Be={class:"w-full px-2 py-1"},Te={class:"border border-gray-300 px-4 py-2"},Ce=["onUpdate:modelValue"],Ae={class:"border border-gray-300 px-4 py-2"},we={class:"font-medium"},Se={class:"border border-gray-300 px-4 py-2"},ke={class:"bg-gray-50 font-bold"},Ue={class:"border border-gray-300 px-4 py-2"},$e={class:"border border-gray-300 px-4 py-2"},je={class:"border border-gray-300 px-4 py-2"},qe={class:"border border-gray-300 px-4 py-2"},Ve=J({__name:"ReceiptStructure",setup(Ne){var O;const v=Q(),d=_(((O=v.query.period)==null?void 0:O.toString())||new Date().toISOString().slice(0,7)),D=_(""),f=_(""),x=()=>[{customerType:"\u4E0A\u6D77",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u56FD\u7F51",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u540C\u4E1A",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u7528\u6237",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"}],R=()=>[{customerType:"\u7528\u6237",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"}],B=()=>[{customerType:"\u4E00\u5305",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u4E8C\u5305",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentReceipt:"0",actual:"0",progress:"0.00%"}],l=_(x()),n=_(R()),p=_(B()),M=_([]),S=e=>e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),I=async e=>{try{const t=[],r=e.substring(0,4),a=parseInt(e.substring(5,7));for(let s=1;s<a;s++){const i=`${r}-${s.toString().padStart(2,"0")}`;try{const y=await fetch(`http://47.111.95.19:3000/receipt-structure/${i}`);if(y.ok){const o=await y.json();o.success&&o.data&&t.push({period:i,data:o.data})}}catch(y){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${i}:`,y)}}M.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},k=(e,t)=>{let r=0;for(const i of M.value){let y=[];e==="equipment"?y=i.data.filter(g=>g.segment==="\u8BBE\u5907"):e==="component"?y=i.data.filter(g=>g.segment==="\u5143\u4EF6"):e==="project"&&(y=i.data.filter(g=>g.segment==="\u5DE5\u7A0B"));const o=y.find(g=>g.customerType===t);o&&o.currentReceipt&&(r+=parseFloat(o.currentReceipt.toString().replace(/,/g,""))||0)}let a=[];e==="equipment"?a=l.value:e==="component"?a=n.value:e==="project"&&(a=p.value);const s=a.find(i=>i.customerType===t);return s&&s.currentReceipt&&(r+=parseFloat(s.currentReceipt.toString().replace(/,/g,""))||0),r},U=()=>{l.value.forEach(e=>{const t=k("equipment",e.customerType);e.actual=t.toFixed(2)}),n.value.forEach(e=>{const t=k("component",e.customerType);e.actual=t.toFixed(2)}),p.value.forEach(e=>{const t=k("project",e.customerType);e.actual=t.toFixed(2)})},$=e=>{const t=parseFloat(e.plan.replace(/,/g,"")),r=parseFloat(e.actual.replace(/,/g,""));if(!isNaN(t)&&!isNaN(r)&&t!==0){const a=(r/t*100).toFixed(2);e.progress=`${a}%`}else r>0,e.progress="0.00%"},T=Y(()=>{let e=0,t=0,r=0;l.value.forEach(s=>{e+=parseFloat(s.plan.replace(/,/g,""))||0,t+=parseFloat(s.currentReceipt.replace(/,/g,""))||0,r+=parseFloat(s.actual.replace(/,/g,""))||0}),n.value.forEach(s=>{e+=parseFloat(s.plan.replace(/,/g,""))||0,t+=parseFloat(s.currentReceipt.replace(/,/g,""))||0,r+=parseFloat(s.actual.replace(/,/g,""))||0}),p.value.forEach(s=>{e+=parseFloat(s.plan.replace(/,/g,""))||0,t+=parseFloat(s.currentReceipt.replace(/,/g,""))||0,r+=parseFloat(s.actual.replace(/,/g,""))||0});let a="0.00%";return e!==0&&(a=`${(r/e*100).toFixed(2)}%`),{plan:e,currentReceipt:t,actual:r,progress:a}}),b=(e,t,r)=>e.map(a=>{var i,y;const s=t==null?void 0:t.find(o=>o.segment===r&&o.customerType===a.customerType);if(s)return{customerType:a.customerType,plan:((i=s.yearlyPlan)==null?void 0:i.toString())||"0",currentReceipt:s.currentReceipt||"0",actual:s.actual||"0",progress:s.progress||"0.00%",yearlyPlan:s.yearlyPlan||0};{const o=t==null?void 0:t.find(g=>(g.segment===r||g.category===r)&&(g.customerType===a.customerType||g.customer===a.customerType));return{customerType:a.customerType,plan:((y=o==null?void 0:o.yearlyPlan)==null?void 0:y.toString())||a.plan||"0",currentReceipt:"0",actual:"0",progress:"0.00%",yearlyPlan:(o==null?void 0:o.yearlyPlan)||0}}}),m=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u6536\u6B3E\u7ED3\u6784\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const t=await fetch(`http://47.111.95.19:3000/receipt-structure/${e}`);let r=[];if(t.ok){const a=await t.json();console.log("API\u8FD4\u56DE\u6570\u636E:",a),a.success&&a.data&&Array.isArray(a.data)&&(r=a.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else t.status===404?(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u521D\u59CB\u5316"),r=[]):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");l.value=b(x(),r,"\u8BBE\u5907"),n.value=b(R(),r,"\u5143\u4EF6"),p.value=b(B(),r,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:l.value,componentData:n.value,projectData:p.value}),await I(e),U()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),l.value=b(x(),[],"\u8BBE\u5907"),n.value=b(R(),[],"\u5143\u4EF6"),p.value=b(B(),[],"\u5DE5\u7A0B");try{await I(e),U()}catch(r){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",r)}}};h(()=>v.query.period,e=>{e&&(d.value=e.toString(),m(e.toString()))}),h(d,(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),m(e),C())});const L=async()=>{try{const e=[...l.value.map(s=>({...s,segment:"\u8BBE\u5907"})),...n.value.map(s=>({...s,segment:"\u5143\u4EF6"})),...p.value.map(s=>({...s,segment:"\u5DE5\u7A0B"}))],t={period:d.value,data:e};console.log("\u4FDD\u5B58\u6570\u636E:",t);const r=await fetch("http://47.111.95.19:3000/receipt-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok){const s=await r.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${r.status} - ${s}`)}const a={equipment:l.value,component:n.value,project:p.value};await X(N.RECEIPT_STRUCTURE,d.value,a,D.value,f.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},P=()=>{l.value=x(),n.value=R(),p.value=B(),console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},C=async()=>{const{remarks:e,suggestions:t}=await Z(N.RECEIPT_STRUCTURE,d.value);D.value=e,f.value=t};return h(()=>v.query.period,e=>{e&&(d.value=e.toString(),m(e.toString()),C())}),h(d,e=>{m(e),C()}),h([l,n,p],()=>{U(),l.value.forEach(e=>$(e)),n.value.forEach(e=>$(e)),p.value.forEach(e=>$(e))},{deep:!0}),z(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",d.value),v.query.period?m(v.query.period.toString()):m(d.value),C()}),(e,t)=>(E(),F("div",ee,[u("div",te,[t[3]||(t[3]=u("h1",{class:"text-2xl font-bold"},"\u6536\u6B3E\u7ED3\u6784\u4E0E\u8D28\u91CF",-1)),t[4]||(t[4]=u("div",{class:"text-gray-500"},"(\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3)",-1)),u("div",re,[A(u("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>d.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[w,d.value]])])]),u("div",ue,[u("table",se,[t[6]||(t[6]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u6536\u6B3E"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u6536\u6B3E"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),u("tbody",null,[(E(!0),F(j,null,q(l.value,(r,a)=>(E(),F("tr",{key:`equipment-${a}`},[a===0?(E(),F("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u8BBE\u5907 ",8,ae)):V("",!0),u("td",oe,c(r.customerType),1),u("td",ce,[u("span",le,c(r.plan),1)]),u("td",ne,[A(u("input",{"onUpdate:modelValue":s=>r.currentReceipt=s,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,pe),[[w,r.currentReceipt]])]),u("td",de,[u("span",ie,c(r.actual),1)]),u("td",ye,c(r.progress),1)]))),128)),(E(!0),F(j,null,q(n.value,(r,a)=>(E(),F("tr",{key:`component-${a}`},[a===0?(E(),F("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:n.value.length}," \u5143\u4EF6 ",8,ge)):V("",!0),u("td",Fe,c(r.customerType),1),u("td",Ee,[u("span",_e,c(r.plan),1)]),u("td",be,[A(u("input",{"onUpdate:modelValue":s=>r.currentReceipt=s,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,me),[[w,r.currentReceipt]])]),u("td",ve,[u("span",he,c(r.actual),1)]),u("td",De,c(r.progress),1)]))),128)),(E(!0),F(j,null,q(p.value,(r,a)=>(E(),F("tr",{key:`project-${a}`},[a===0?(E(),F("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5DE5\u7A0B ",8,fe)):V("",!0),u("td",xe,c(r.customerType),1),u("td",Re,[u("span",Be,c(r.plan),1)]),u("td",Te,[A(u("input",{"onUpdate:modelValue":s=>r.currentReceipt=s,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,Ce),[[w,r.currentReceipt]])]),u("td",Ae,[u("span",we,c(r.actual),1)]),u("td",Se,c(r.progress),1)]))),128)),u("tr",ke,[t[5]||(t[5]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",Ue,c(S(T.value.plan)),1),u("td",$e,c(S(T.value.currentReceipt)),1),u("td",je,c(S(T.value.actual)),1),u("td",qe,c(T.value.progress),1)])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:L,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:P,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),H(W,{"module-id":K(N).RECEIPT_STRUCTURE,period:d.value,remarks:D.value,"onUpdate:remarks":t[1]||(t[1]=r=>D.value=r),suggestions:f.value,"onUpdate:suggestions":t[2]||(t[2]=r=>f.value=r)},null,8,["module-id","period","remarks","suggestions"])]))}});var Oe=G(Ve,[["__scopeId","data-v-87a51f6a"]]);export{Oe as default};
