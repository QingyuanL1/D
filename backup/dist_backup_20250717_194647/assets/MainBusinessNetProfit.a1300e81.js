import{_ as Y,d as L,r as h,c as O,B as $,o as G,b as y,e,y as f,A,F as T,g as S,t as s,k as J,h as z,G as H,v as g,f as k}from"./index.c4217200.js";import{_ as K,r as Q,M as I,l as W}from"./FormAttachmentAndRemarks.4875c6d1.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Z={class:"flex justify-between items-center mb-6"},uu={class:"flex items-center space-x-4"},eu={class:"overflow-x-auto my-6"},ou={class:"w-full border-collapse border border-gray-300"},tu=["rowspan"],ru={class:"border border-gray-300 px-4 py-2"},au={class:"border border-gray-300 px-4 py-2"},su=["onUpdate:modelValue"],nu={class:"border border-gray-300 px-4 py-2"},lu={class:"font-medium"},cu={class:"border border-gray-300 px-4 py-2"},pu={class:"font-medium"},du={class:"border border-gray-300 px-4 py-2"},iu={class:"border border-gray-300 px-4 py-2"},yu={class:"text-blue-600"},gu=["rowspan"],Fu={class:"border border-gray-300 px-4 py-2"},bu={class:"border border-gray-300 px-4 py-2"},Eu=["onUpdate:modelValue"],hu={class:"border border-gray-300 px-4 py-2"},_u={class:"font-medium"},Du={class:"border border-gray-300 px-4 py-2"},mu={class:"font-medium"},Bu={class:"border border-gray-300 px-4 py-2"},vu={class:"border border-gray-300 px-4 py-2"},xu={class:"text-blue-600"},Cu=["rowspan"],fu={class:"border border-gray-300 px-4 py-2"},Au={class:"border border-gray-300 px-4 py-2"},Mu=["onUpdate:modelValue"],wu={class:"border border-gray-300 px-4 py-2"},Vu={class:"font-medium"},Tu={class:"border border-gray-300 px-4 py-2"},Su={class:"font-medium"},ku={class:"border border-gray-300 px-4 py-2"},Iu={class:"border border-gray-300 px-4 py-2"},Nu={class:"text-blue-600"},Uu={class:"bg-gray-50 font-bold"},$u={class:"border border-gray-300 px-4 py-2"},qu={class:"border border-gray-300 px-4 py-2"},ju={class:"border border-gray-300 px-4 py-2"},Pu={class:"border border-gray-300 px-4 py-2"},Ru=L({__name:"MainBusinessNetProfit",setup(Yu){var U;const _=H(),l=h(((U=_.query.period)==null?void 0:U.toString())||new Date().toISOString().slice(0,7)),D=h(""),m=h(""),B=()=>[{customerType:"\u4E0A\u6D77",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u56FD\u7F51",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u540C\u4E1A",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],v=()=>[{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],x=()=>[{customerType:"\u4E00\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u4E8C\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],c=h(B()),p=h(v()),d=h(x()),F=t=>t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),q=async t=>{try{const o=await fetch(`http://47.111.95.19:3000/main-business-net-profit/monthly-data/${t}`);if(o.ok){const u=await o.json();if(u.success)return u.data}return console.error(`\u83B7\u53D6${t}\u6708\u5EA6\u6570\u636E\u5931\u8D25:`,o.status),null}catch(o){return console.error(`\u83B7\u53D6${t}\u6708\u5EA6\u6570\u636E\u5931\u8D25:`,o),null}},M=(t,o)=>{var u,a;o&&(t.currentMonthValue=((u=o.currentMonthValue)==null?void 0:u.toFixed(2))||"0",t.actual=((a=o.cumulativeValue)==null?void 0:a.toFixed(2))||"0",t.contribution=o.contribution||"0.00%",t.currentLaborCost=0)},C=O(()=>{let t=0,o=0,u=0;c.value.forEach(r=>{var n,i,b;t+=parseFloat((n=r.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((i=r.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,u+=parseFloat((b=r.actual)==null?void 0:b.replace(/,/g,""))||0}),p.value.forEach(r=>{var n,i,b;t+=parseFloat((n=r.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((i=r.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,u+=parseFloat((b=r.actual)==null?void 0:b.replace(/,/g,""))||0}),d.value.forEach(r=>{var n,i,b;t+=parseFloat((n=r.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((i=r.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,u+=parseFloat((b=r.actual)==null?void 0:b.replace(/,/g,""))||0});let a="0.00%";return t!==0&&(a=`${(u/t*100).toFixed(2)}%`),{plan:t,currentMonthValue:o,actual:u,contribution:a}}),E=(t,o,u)=>t.map(a=>{var n;const r=o==null?void 0:o.find(i=>i.segment===u&&i.customerType===a.customerType);return r?{customerType:a.customerType,plan:((n=r.yearlyPlan)==null?void 0:n.toString())||"0",currentMonthValue:"0",actual:"0",contribution:"0.00%",yearlyPlan:r.yearlyPlan||0}:a}),w=async t=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u6570\u636E\uFF0C\u671F\u95F4: ${t}`);const o=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${t}`);let u=[];if(o.ok){const a=await o.json();console.log("API\u8FD4\u56DE\u6570\u636E:",a),a.success&&a.data&&Array.isArray(a.data)&&(u=a.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else o.status===404?(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),c.value=B(),p.value=v(),d.value=x()):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");c.value=E(B(),u,"\u8BBE\u5907"),p.value=E(v(),u,"\u5143\u4EF6"),d.value=E(x(),u,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:c.value,componentData:p.value,projectData:d.value}),await N()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),c.value=E(B(),[],"\u8BBE\u5907"),p.value=E(v(),[],"\u5143\u4EF6"),d.value=E(x(),[],"\u5DE5\u7A0B")}},N=async()=>{try{console.log("\u5F00\u59CB\u83B7\u53D6\u6708\u5EA6\u6570\u636E\uFF0C\u671F\u95F4:",l.value);const t=await q(l.value);if(!t){console.error("\u83B7\u53D6\u6708\u5EA6\u6570\u636E\u5931\u8D25");return}c.value.forEach(o=>{var a;const u=(a=t.equipment)==null?void 0:a.find(r=>r.customer===o.customerType);M(o,u)}),p.value.forEach(o=>{var a;const u=(a=t.components)==null?void 0:a.find(r=>r.customer===o.customerType);M(o,u)}),d.value.forEach(o=>{var a;const u=(a=t.engineering)==null?void 0:a.find(r=>r.customer===o.customerType);M(o,u)}),console.log("=== \u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u6570\u636E\u66F4\u65B0\u5B8C\u6210 ==="),console.log("\u5F53\u524D\u671F\u95F4:",l.value)}catch(t){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",t)}};$(()=>_.query.period,t=>{t&&(l.value=t.toString(),w(t.toString()),V())}),$(l,t=>{w(t),V()});const j=async()=>{try{const t=[...c.value.map(r=>({...r,segment:"\u8BBE\u5907"})),...p.value.map(r=>({...r,segment:"\u5143\u4EF6"})),...d.value.map(r=>({...r,segment:"\u5DE5\u7A0B"}))],o={period:l.value,data:t};console.log("\u4FDD\u5B58\u6570\u636E:",o);const u=await fetch("http://47.111.95.19:3000/main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!u.ok){const r=await u.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${u.status} - ${r}`)}const a={equipment:c.value,component:p.value,project:d.value};await Q(I.MAIN_BUSINESS_NET_PROFIT,l.value,a,D.value,m.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25: "+(t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"))}},P=()=>{c.value=B(),p.value=v(),d.value=x(),D.value="",m.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},V=async()=>{const{remarks:t,suggestions:o}=await W(I.MAIN_BUSINESS_NET_PROFIT,l.value);D.value=t,m.value=o},R=()=>{console.log("=== \u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8BA1\u7B97\u516C\u5F0F\u6D4B\u8BD5 ==="),console.log("\u8BA1\u7B97\u516C\u5F0F\uFF1A\u5F53\u6708\u503C = \u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u5206\u89E3\u4E2D\u7684\u5F53\u6708\u6536\u5165 - \u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u7ED3\u6784\u4E0E\u8D28\u91CF\u4E2D\u7684\u5F53\u671F\u76F4\u63A5\u8D39\u7528 - \u6210\u672C\u4E2D\u5FC3\u7ED3\u6784\u4E2D\u7684\u5F53\u6708\u5B9E\u9645"),console.log("\u7D2F\u8BA1\u503C = \u5404\u4E2A\u5F53\u6708\u503C\u76F8\u52A0\uFF08\u4ECE1\u6708\u5230\u5F53\u524D\u6708\uFF09"),console.log("\u5F53\u524D\u671F\u95F4:",l.value),console.log("\u8BBE\u5907\u677F\u5757\u6570\u636E:",c.value.length,"\u9879"),console.log("\u5143\u4EF6\u677F\u5757\u6570\u636E:",p.value.length,"\u9879"),console.log("\u5DE5\u7A0B\u677F\u5757\u6570\u636E:",d.value.length,"\u9879"),console.log("API\u8C03\u7528\u8BF4\u660E:"),console.log("- \u4E3B\u8425\u4E1A\u52A1\u6536\u5165: /main-business-income/{period}-01 (\u9700\u8981\u65E5\u671F\u683C\u5F0F)"),console.log("- \u4E3B\u8425\u4E1A\u52A1\u6210\u672C: /main-business-cost/{period} (YYYY-MM\u683C\u5F0F)"),console.log("- \u6210\u672C\u4E2D\u5FC3\u7ED3\u6784: /cost-center-structure/{period} (YYYY-MM\u683C\u5F0F)"),console.log("=== \u6D4B\u8BD5\u5B8C\u6210 ===")};return G(()=>{var o;console.log("=== \u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u7EC4\u4EF6\u6302\u8F7D ==="),console.log("\u5F53\u524D\u671F\u95F4:",l.value),console.log("\u8DEF\u7531\u67E5\u8BE2\u53C2\u6570:",_.query.period),console.log("\u5C06\u8981\u52A0\u8F7D\u7684\u671F\u95F4:",_.query.period||l.value),R();const t=((o=_.query.period)==null?void 0:o.toString())||l.value;console.log("\u5F00\u59CB\u52A0\u8F7D\u6570\u636E\uFF0C\u671F\u95F4:",t),w(t),V()}),(t,o)=>(g(),y("div",X,[e("div",Z,[o[3]||(o[3]=e("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),e("div",uu,[e("button",{onClick:N,class:"px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u91CD\u65B0\u8BA1\u7B97 "),f(e("input",{"onUpdate:modelValue":o[0]||(o[0]=u=>l.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[A,l.value]])])]),e("div",eu,[e("table",ou,[o[5]||(o[5]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u677F\u5757"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5E74\u5EA6\u8BA1\u5212"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u6708\u503C"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u7D2F\u8BA1\u503C"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u671F\u4EBA\u5DE5\u8D39")])],-1)),e("tbody",null,[(g(!0),y(T,null,S(c.value,(u,a)=>{var r;return g(),y("tr",{key:`equipment-${a}`},[a===0?(g(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u8BBE\u5907 ",8,tu)):k("",!0),e("td",ru,s(u.customerType),1),e("td",au,[f(e("input",{"onUpdate:modelValue":n=>u.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,su),[[A,u.plan]])]),e("td",nu,[e("span",lu,s(F(parseFloat((r=u.currentMonthValue)==null?void 0:r.replace(/,/g,""))||0)),1)]),e("td",cu,[e("span",pu,s(u.actual),1)]),e("td",du,s(u.contribution),1),e("td",iu,[e("span",yu,s(F(u.currentLaborCost||0)),1)])])}),128)),(g(!0),y(T,null,S(p.value,(u,a)=>{var r;return g(),y("tr",{key:`component-${a}`},[a===0?(g(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5143\u4EF6 ",8,gu)):k("",!0),e("td",Fu,s(u.customerType),1),e("td",bu,[f(e("input",{"onUpdate:modelValue":n=>u.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Eu),[[A,u.plan]])]),e("td",hu,[e("span",_u,s(F(parseFloat((r=u.currentMonthValue)==null?void 0:r.replace(/,/g,""))||0)),1)]),e("td",Du,[e("span",mu,s(u.actual),1)]),e("td",Bu,s(u.contribution),1),e("td",vu,[e("span",xu,s(F(u.currentLaborCost||0)),1)])])}),128)),(g(!0),y(T,null,S(d.value,(u,a)=>{var r;return g(),y("tr",{key:`project-${a}`},[a===0?(g(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u5DE5\u7A0B ",8,Cu)):k("",!0),e("td",fu,s(u.customerType),1),e("td",Au,[f(e("input",{"onUpdate:modelValue":n=>u.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Mu),[[A,u.plan]])]),e("td",wu,[e("span",Vu,s(F(parseFloat((r=u.currentMonthValue)==null?void 0:r.replace(/,/g,""))||0)),1)]),e("td",Tu,[e("span",Su,s(u.actual),1)]),e("td",ku,s(u.contribution),1),e("td",Iu,[e("span",Nu,s(F(u.currentLaborCost||0)),1)])])}),128)),e("tr",Uu,[o[4]||(o[4]=e("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),e("td",$u,s(F(C.value.plan)),1),e("td",qu,s(F(C.value.currentMonthValue)),1),e("td",ju,s(F(C.value.actual)),1),e("td",Pu,s(C.value.contribution),1)])])])]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:j,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:P,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),J(K,{"module-id":z(I).MAIN_BUSINESS_NET_PROFIT,period:l.value,remarks:D.value,"onUpdate:remarks":o[1]||(o[1]=u=>D.value=u),suggestions:m.value,"onUpdate:suggestions":o[2]||(o[2]=u=>m.value=u)},null,8,["module-id","period","remarks","suggestions"])]))}});var Gu=Y(Ru,[["__scopeId","data-v-edff4744"]]);export{Gu as default};
