import{_ as M,d as U,r as y,B as D,h as V,o as $,c as f,a as u,y as E,A as v,F as I,l as O,t as c,b as T,m as J,G as R,f as N}from"./index.1b6f7afa.js";import{_ as H,M as C,r as L}from"./FormAttachmentAndRemarks.2ea5fac5.js";const G={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},z={class:"flex justify-between items-center mb-6"},K={class:"flex items-center space-x-4"},Q={class:"overflow-x-auto my-6"},W={class:"w-full border-collapse border border-gray-300"},X={class:"border border-gray-300 px-4 py-2 text-center"},Y={class:"border border-gray-300 px-4 py-2"},Z=["onUpdate:modelValue"],ee={class:"border border-gray-300 px-4 py-2"},te=["onUpdate:modelValue"],ue={class:"border border-gray-300 px-4 py-2"},re=["onUpdate:modelValue"],ne={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"border border-gray-300 px-4 py-2 text-right"},ae={class:"text-sm font-medium"},se={class:"bg-gray-50 font-bold"},ce={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"border border-gray-300 px-4 py-2 text-right"},pe={class:"text-sm font-bold"},xe=U({__name:"MajorInvestment",setup(me){var P;const b=R(),o=y(((P=b.query.period)==null?void 0:P.toString())||new Date().toISOString().slice(0,7)),w={items:[{sequenceNo:1,projectName:"\u56FA\u5B9A\u8D44\u4EA7\u91CD\u5EFA\u3001\u8D2D\u7F6E",annualPlan:60.41,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:2,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:3,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:4,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:5,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:6,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:7,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:8,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:9,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0},{sequenceNo:10,projectName:"",annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0}]},s=y(JSON.parse(JSON.stringify(w))),i=y(""),d=y(""),x=e=>e===0?"0.00":e.toFixed(2),A=e=>e===0?"0.00":e.toFixed(2),p=async e=>{try{const[t]=e.split("-"),r=parseInt(e.split("-")[1]);for(let n of s.value.items){let a=0;for(let F=1;F<r;F++){const j=`${t}-${F.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/nanhua-major-investment/${j}`);if(g.ok){const B=(await g.json()).data.items.find(k=>k.sequenceNo===n.sequenceNo);B&&(a+=B.currentExecution||0)}}catch(g){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${j}\u7684\u6570\u636E:`,g)}}a+=n.currentExecution||0,n.currentExecutionCumulative=a,n.executionProgress=n.annualPlan>0?n.currentExecutionCumulative/n.annualPlan*100:0}}catch(t){console.error("\u8BA1\u7B97\u5F53\u671F\u6267\u884C\u7D2F\u8BA1\u5931\u8D25:",t)}};D(()=>s.value.items,async e=>{await p(o.value)},{deep:!0});const m=V(()=>{const e={annualPlan:0,currentExecution:0,currentExecutionCumulative:0,executionProgress:0};return s.value.items.forEach(t=>{e.annualPlan+=t.annualPlan||0,e.currentExecution+=t.currentExecution||0,e.currentExecutionCumulative+=t.currentExecutionCumulative||0}),e.executionProgress=e.annualPlan>0?e.currentExecutionCumulative/e.annualPlan*100:0,e}),h=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/nanhua-major-investment/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),l();return}const r=await t.json();r.data&&r.data.items&&(s.value.items=r.data.items.map(n=>({sequenceNo:n.sequenceNo,projectName:n.projectName||"",annualPlan:Number(n.annualPlan)||0,currentExecution:Number(n.currentExecution)||0,currentExecutionCumulative:Number(n.currentExecutionCumulative)||0,executionProgress:Number(n.executionProgress)||0}))),await p(e)}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),l()}},l=()=>{s.value=JSON.parse(JSON.stringify(w))},_=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${C.NANHUA_MAJOR_INVESTMENT}/${e}`);if(t.ok){const r=await t.json();r.success&&r.data&&(i.value=r.data.remarks||"",d.value=r.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};D(()=>b.query.period,async e=>{e&&(o.value=e.toString(),l(),await h(e.toString()),await p(e.toString()),_(e.toString()))}),D(o,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),l(),await h(e),await p(e),_(e))});const S=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-major-investment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:o.value,data:{items:s.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await L(C.NANHUA_MAJOR_INVESTMENT,o.value,{items:s.value.items},i.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},q=()=>{l(),i.value="",d.value=""};return $(async()=>{var t;l();const e=((t=b.query.period)==null?void 0:t.toString())||o.value;await h(e),await p(e),_(e)}),(e,t)=>(N(),f("div",G,[u("div",z,[t[5]||(t[5]=u("h1",{class:"text-2xl font-bold"},"\u5E74\u5EA6\u91CD\u5927\u6295\u8D44\u60C5\u51B5",-1)),u("div",K,[t[3]||(t[3]=u("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),t[4]||(t[4]=u("span",{class:"text-xs text-gray-500"},"\u5F53\u671F\u6267\u884C\u7D2F\u8BA1 = \u5F53\u671F\u6267\u884C + \u4E4B\u524D\u5404\u6708\u7D2F\u8BA1",-1)),E(u("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>o.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[v,o.value]])])]),u("div",Q,[u("table",W,[t[7]||(t[7]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2 w-16"},"\u5E8F\u53F7"),u("th",{class:"border border-gray-300 px-4 py-2 w-80"},"\u9879\u76EE\u540D\u79F0"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u5EA6\u8BA1\u5212"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u6267\u884C"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u6267\u884C\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),u("tbody",null,[(N(!0),f(I,null,O(s.value.items,(r,n)=>(N(),f("tr",{key:`item-${n}`},[u("td",X,c(r.sequenceNo),1),u("td",Y,[E(u("input",{"onUpdate:modelValue":a=>r.projectName=a,type:"text",class:"w-full px-2 py-1 border rounded",placeholder:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0"},null,8,Z),[[v,r.projectName]])]),u("td",ee,[E(u("input",{"onUpdate:modelValue":a=>r.annualPlan=a,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,te),[[v,r.annualPlan]])]),u("td",ue,[E(u("input",{"onUpdate:modelValue":a=>r.currentExecution=a,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,re),[[v,r.currentExecution]])]),u("td",ne,c(x(r.currentExecutionCumulative)),1),u("td",oe,[u("span",ae,c(A(r.executionProgress))+"%",1)])]))),128)),u("tr",se,[t[6]||(t[6]=u("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u("td",ce,c(x(m.value.annualPlan)),1),u("td",le,c(x(m.value.currentExecution)),1),u("td",ie,c(x(m.value.currentExecutionCumulative)),1),u("td",de,[u("span",pe,c(A(m.value.executionProgress))+"%",1)])])])])]),T(H,{"module-id":J(C).NANHUA_MAJOR_INVESTMENT,period:o.value,remarks:i.value,"onUpdate:remarks":t[1]||(t[1]=r=>i.value=r),suggestions:d.value,"onUpdate:suggestions":t[2]||(t[2]=r=>d.value=r)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:S,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:q,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var ve=M(xe,[["__scopeId","data-v-564409da"]]);export{ve as default};
