import{_ as O,d as P,r as m,h as k,B as w,o as V,c as g,a as u,y as _,A as v,F as M,l as $,t as i,b as j,m as J,G as q,f as B,k as Y}from"./index.1b6f7afa.js";import{_ as L,M as D,r as G}from"./FormAttachmentAndRemarks.2ea5fac5.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},H={class:"flex justify-between items-center mb-6"},K={class:"flex items-center space-x-4"},Q={class:"overflow-x-auto my-6"},W={class:"w-full border-collapse border border-gray-300"},X=["rowspan"],Z={class:"border border-gray-300 px-4 py-2"},tt={class:"border border-gray-300 px-4 py-2"},et=["onUpdate:modelValue"],ut={class:"border border-gray-300 px-4 py-2"},rt=["onUpdate:modelValue","onInput"],st={class:"border border-gray-300 px-4 py-2"},ot=["onUpdate:modelValue"],at={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"text-sm font-medium"},it={class:"bg-gray-50 font-bold"},lt={class:"border border-gray-300 px-4 py-2 text-right"},ct={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"border border-gray-300 px-4 py-2 text-right"},bt={class:"text-sm font-bold"},yt=P({__name:"MainBusinessNetProfitContribution",setup(mt){var N;const E=q(),n=m(((N=E.query.period)==null?void 0:N.toString())||new Date().toISOString().slice(0,7)),f={items:[{businessType:"\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u7535\u4E1A\u9879\u76EE",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0},{businessType:"\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u7528\u6237\u9879\u76EE",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0},{businessType:"\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u8D38\u6613",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0},{businessType:"\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0},{businessType:"\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0},{businessType:"\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0},{businessType:"\u975E\u4E3B\u8425\u4E1A\u52A1",customerAttribute:"\u5176\u4ED6",annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:0}]},o=m(JSON.parse(JSON.stringify(f))),c=m(""),d=m(""),x=e=>e===0?"0.00":e.toFixed(2),F=e=>e===0?"0.00":e.toFixed(2),S=e=>{T()},T=()=>{const e=o.value.items.reduce((t,r)=>{var a;return t+(parseFloat(((a=r.cumulative)==null?void 0:a.toString())||"0")||0)},0);o.value.items.forEach(t=>{e&&e!==0?t.contributionRatio=t.cumulative/e*100:t.contributionRatio=0})},R=e=>e===0?!0:o.value.items[e].businessType!==o.value.items[e-1].businessType,C=e=>o.value.items.filter(t=>t.businessType===e).length,b=k(()=>{const e={annualBudget:0,currentPeriod:0,cumulative:0,contributionRatio:100};return o.value.items.forEach(t=>{var r,a,s;e.annualBudget+=parseFloat(((r=t.annualBudget)==null?void 0:r.toString())||"0")||0,e.currentPeriod+=parseFloat(((a=t.currentPeriod)==null?void 0:a.toString())||"0")||0,e.cumulative+=parseFloat(((s=t.cumulative)==null?void 0:s.toString())||"0")||0}),e}),y=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/tuoyuan-main-business-net-profit-contribution/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),l();return}const r=await t.json();if(r.data&&r.data.items){const a=r.data.items;o.value.items=f.items.map(s=>{const p=a.find(h=>h.businessType===s.businessType&&h.customerAttribute===s.customerAttribute);return p?{businessType:s.businessType,customerAttribute:s.customerAttribute,annualBudget:Number(p.annualBudget)||0,currentPeriod:Number(p.currentPeriod)||0,cumulative:Number(p.cumulative)||0,contributionRatio:Number(p.contributionRatio)||0}:{...s}}),T()}}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),l()}},l=()=>{o.value=JSON.parse(JSON.stringify(f))},A=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${D.TUOYUAN_MAIN_BUSINESS_NET_PROFIT_CONTRIBUTION}/${e}`);if(t.ok){const r=await t.json();r.success&&r.data&&(c.value=r.data.remarks||"",d.value=r.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};w(()=>E.query.period,async e=>{e&&(n.value=e.toString(),l(),await y(e.toString()),A(e.toString()))}),w(n,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),l(),await y(e),A(e))});const U=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-main-business-net-profit-contribution",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:{items:o.value.items.map(t=>({businessType:t.businessType,customerAttribute:t.customerAttribute,annualBudget:t.annualBudget,currentPeriod:t.currentPeriod}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(D.TUOYUAN_MAIN_BUSINESS_NET_PROFIT_CONTRIBUTION,n.value,{items:o.value.items},c.value,d.value),await y(n.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},I=()=>{l(),c.value="",d.value=""};return V(async()=>{var t;l();const e=((t=E.query.period)==null?void 0:t.toString())||n.value;await y(e),A(e)}),(e,t)=>(B(),g("div",z,[u("div",H,[t[4]||(t[4]=u("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),u("div",K,[t[3]||(t[3]=u("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),_(u("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>n.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[v,n.value]])])]),u("div",Q,[u("table",W,[t[6]||(t[6]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u4E1A\u52A1\u7C7B\u578B"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u5EA6\u9884\u7B97"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4")])],-1)),u("tbody",null,[(B(!0),g(M,null,$(o.value.items,(r,a)=>(B(),g("tr",{key:`item-${a}`},[R(a)?(B(),g("td",{key:0,rowspan:C(r.businessType),class:"border border-gray-300 px-4 py-2 font-medium text-center"},i(r.businessType),9,X)):Y("",!0),u("td",Z,i(r.customerAttribute),1),u("td",tt,[_(u("input",{"onUpdate:modelValue":s=>r.annualBudget=s,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-100",step:"0.01",readonly:""},null,8,et),[[v,r.annualBudget]])]),u("td",ut,[_(u("input",{"onUpdate:modelValue":s=>r.currentPeriod=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:s=>S()},null,40,rt),[[v,r.currentPeriod]])]),u("td",st,[_(u("input",{"onUpdate:modelValue":s=>r.cumulative=s,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-100",step:"0.01",readonly:""},null,8,ot),[[v,r.cumulative]])]),u("td",at,[u("span",nt,i(F(r.contributionRatio))+"%",1)])]))),128)),u("tr",it,[t[5]||(t[5]=u("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u("td",lt,i(x(b.value.annualBudget)),1),u("td",ct,i(x(b.value.currentPeriod)),1),u("td",dt,i(x(b.value.cumulative)),1),u("td",pt,[u("span",bt,i(F(b.value.contributionRatio))+"%",1)])])])])]),j(L,{"module-id":J(D).TUOYUAN_MAIN_BUSINESS_NET_PROFIT_CONTRIBUTION,period:n.value,remarks:c.value,"onUpdate:remarks":t[1]||(t[1]=r=>c.value=r),suggestions:d.value,"onUpdate:suggestions":t[2]||(t[2]=r=>d.value=r)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:U,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:I,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var vt=O(yt,[["__scopeId","data-v-f4e451bc"]]);export{vt as default};
