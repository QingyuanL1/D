import{_ as V,d as U,r as S,h as N,B as A,o as F,c as d,a as u,y as f,A as m,F as O,l as k,t as c,b as I,m as R,G as $,f as b,k as D}from"./index.1b6f7afa.js";import{_ as j,M as C,r as J}from"./FormAttachmentAndRemarks.2ea5fac5.js";const M={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},q={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Y={class:"overflow-x-auto my-6"},L={class:"w-full border-collapse border border-gray-300"},G=["rowspan"],z={key:1,class:"border border-gray-300 px-4 py-2 font-medium text-center"},H={key:2,class:"border border-gray-300 px-4 py-2"},K={class:"border border-gray-300 px-4 py-2"},Q=["onUpdate:modelValue"],W={class:"border border-gray-300 px-4 py-2"},Z=["onUpdate:modelValue"],tt={class:"border border-gray-300 px-4 py-2"},et=["onUpdate:modelValue"],rt={class:"border border-gray-300 px-4 py-2"},ut=["onUpdate:modelValue"],ot={class:"bg-gray-50 font-bold"},st={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"border border-gray-300 px-4 py-2 text-right"},lt={class:"border border-gray-300 px-4 py-2 text-right"},ct=U({__name:"ConstructionExecutionStatus",setup(it){var v;const _=$(),n=S(((v=_.query.period)==null?void 0:v.toString())||new Date().toISOString().slice(0,7)),h={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0},{segmentAttribute:"",customerAttribute:"\u81EA\u884C\u65BD\u5DE5\u7387%",yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0,selfConstructionPercentage:0}]},o=S(JSON.parse(JSON.stringify(h))),p=S(""),y=S(""),g=e=>e===0?"0.00":e.toFixed(2),T=e=>{if(e===0)return!0;const t=o.value.items[e],r=o.value.items[e-1];return t.segmentAttribute!==r.segmentAttribute},B=e=>o.value.items.filter(t=>t.segmentAttribute===e).length,a=N(()=>{const e={yearlyPlanProductionValue:0,selfConstruction:0,semiSelfSubcontract:0,outsourceTransfer:0};return o.value.items.forEach(t=>{t.customerAttribute!=="\u81EA\u884C\u65BD\u5DE5\u7387%"&&(e.yearlyPlanProductionValue+=t.yearlyPlanProductionValue||0,e.selfConstruction+=t.selfConstruction||0,e.semiSelfSubcontract+=t.semiSelfSubcontract||0,e.outsourceTransfer+=t.outsourceTransfer||0)}),e});A(o,()=>{const e=o.value.items.find(t=>t.customerAttribute==="\u81EA\u884C\u65BD\u5DE5\u7387%");if(e){const t=a.value.yearlyPlanProductionValue;t>0&&(e.selfConstruction=a.value.selfConstruction/t*100,e.semiSelfSubcontract=a.value.semiSelfSubcontract/t*100,e.outsourceTransfer=a.value.outsourceTransfer/t*100)}},{deep:!0});const x=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/tuoyuan-construction-execution-status/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),i();return}const r=await t.json();r.data&&r.data.items&&(o.value.items=r.data.items.map(s=>({segmentAttribute:s.segmentAttribute,customerAttribute:s.customerAttribute,yearlyPlanProductionValue:Number(s.yearlyPlanProductionValue)||0,selfConstruction:Number(s.selfConstruction)||0,semiSelfSubcontract:Number(s.semiSelfSubcontract)||0,outsourceTransfer:Number(s.outsourceTransfer)||0,selfConstructionPercentage:Number(s.selfConstructionPercentage)||0})))}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),i()}},i=()=>{o.value=JSON.parse(JSON.stringify(h))},E=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${C.TUOYUAN_CONSTRUCTION_EXECUTION_STATUS}/${e}`);if(t.ok){const r=await t.json();r.success&&r.data&&(p.value=r.data.remarks||"",y.value=r.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};A(()=>_.query.period,async e=>{e&&(n.value=e.toString(),i(),await x(e.toString()),E(e.toString()))}),A(n,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),i(),await x(e),E(e))});const P=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-construction-execution-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:{items:o.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await J(C.TUOYUAN_CONSTRUCTION_EXECUTION_STATUS,n.value,{items:o.value.items},p.value,y.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},w=()=>{i(),p.value="",y.value=""};return F(async()=>{var t;i();const e=((t=_.query.period)==null?void 0:t.toString())||n.value;await x(e),E(e)}),(e,t)=>(b(),d("div",M,[u("div",q,[t[3]||(t[3]=u("h1",{class:"text-2xl font-bold"},"\u65BD\u5DE5\u6267\u884C\u60C5\u51B5",-1)),u("div",X,[f(u("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>n.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[m,n.value]])])]),u("div",Y,[u("table",L,[t[5]||(t[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2 w-20"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u5E74\u5EA6\u8BA1\u5212\u4EA7\u503C"),u("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u81EA\u5236/\u81EA\u884C\u65BD\u5DE5"),u("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u534A\u81EA\u5236/\u5206\u5305"),u("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5916\u53D1/\u8F6C\u5305")])],-1)),u("tbody",null,[(b(!0),d(O,null,k(o.value.items,(r,s)=>(b(),d("tr",{key:`execution-${s}`},[r.segmentAttribute&&T(s)?(b(),d("td",{key:0,rowspan:B(r.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},c(r.segmentAttribute),9,G)):r.segmentAttribute?D("",!0):(b(),d("td",z,c(r.customerAttribute),1)),r.segmentAttribute?(b(),d("td",H,c(r.customerAttribute),1)):D("",!0),u("td",K,[f(u("input",{"onUpdate:modelValue":l=>r.yearlyPlanProductionValue=l,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Q),[[m,r.yearlyPlanProductionValue]])]),u("td",W,[f(u("input",{"onUpdate:modelValue":l=>r.selfConstruction=l,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Z),[[m,r.selfConstruction]])]),u("td",tt,[f(u("input",{"onUpdate:modelValue":l=>r.semiSelfSubcontract=l,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,et),[[m,r.semiSelfSubcontract]])]),u("td",rt,[f(u("input",{"onUpdate:modelValue":l=>r.outsourceTransfer=l,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ut),[[m,r.outsourceTransfer]])])]))),128)),u("tr",ot,[t[4]||(t[4]=u("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1\u4EA7\u503C",-1)),u("td",st,c(g(a.value.yearlyPlanProductionValue)),1),u("td",nt,c(g(a.value.selfConstruction)),1),u("td",at,c(g(a.value.semiSelfSubcontract)),1),u("td",lt,c(g(a.value.outsourceTransfer)),1)])])])]),I(j,{"module-id":R(C).TUOYUAN_CONSTRUCTION_EXECUTION_STATUS,period:n.value,remarks:p.value,"onUpdate:remarks":t[1]||(t[1]=r=>p.value=r),suggestions:y.value,"onUpdate:suggestions":t[2]||(t[2]=r=>y.value=r)},null,8,["module-id","period","remarks","suggestions"]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:P,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:w,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var pt=V(ct,[["__scopeId","data-v-13277c33"]]);export{pt as default};
