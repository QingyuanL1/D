import{_ as O,d as C,r as y,c as I,B as R,o as V,b as A,e as a,y as v,A as E,F as $,g as Y,t as o,k as j,h as J,G as M,v as f,f as q}from"./index.ecbb4849.js";import{_ as L,M as D,r as G}from"./FormAttachmentAndRemarks.a0b77378.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},H={class:"flex justify-between items-center mb-6"},K={class:"flex items-center space-x-4"},Q={class:"overflow-x-auto my-6"},W={class:"w-full border-collapse border border-gray-300"},X=["rowspan"],Z={class:"border border-gray-300 px-4 py-2"},P={class:"border border-gray-300 px-4 py-2"},tt=["onUpdate:modelValue"],et={class:"border border-gray-300 px-4 py-2"},at=["onUpdate:modelValue","onInput"],ut={class:"border border-gray-300 px-4 py-2 text-right"},rt={class:"text-sm font-medium"},nt={class:"border border-gray-300 px-4 py-2 text-right"},st={class:"text-sm font-medium"},ot={class:"bg-gray-50 font-bold"},lt={class:"border border-gray-300 px-4 py-2 text-right"},it={class:"border border-gray-300 px-4 py-2 text-right"},ct={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"text-sm font-bold"},bt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"text-sm font-bold"},mt=C({__name:"InventoryStatus",setup(gt){var w;const _=M(),s=y(((w=_.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),B={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",initialBalance:614.32,currentAmount:-614.32,balance:0,fluctuationRate:-100},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",initialBalance:0,currentAmount:14.45,balance:14.45,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",initialBalance:0,currentAmount:0,balance:0,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",initialBalance:225.08,currentAmount:319.75,balance:544.83,fluctuationRate:142.06},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",initialBalance:0,currentAmount:0,balance:0,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",initialBalance:0,currentAmount:0,balance:0,fluctuationRate:0}]},n=y(JSON.parse(JSON.stringify(B))),c=y(""),d=y(""),m=t=>t===0?"0.00":t.toFixed(2),F=t=>t===0?"0.00":t.toFixed(2),S=t=>{t.balance=t.initialBalance+t.currentAmount,t.initialBalance&&t.initialBalance!==0?t.fluctuationRate=t.currentAmount/t.initialBalance*100:t.fluctuationRate=t.currentAmount!==0?t.currentAmount>0?100:-100:0},N=t=>t===0?!0:n.value.items[t].segmentAttribute!==n.value.items[t-1].segmentAttribute,k=t=>n.value.items.filter(e=>e.segmentAttribute===t).length,g=I(()=>{const t={initialBalance:0,currentAmount:0,balance:0,fluctuationRate:0};return n.value.items.forEach(e=>{var u,l,r;t.initialBalance+=parseFloat(((u=e.initialBalance)==null?void 0:u.toString())||"0")||0,t.currentAmount+=parseFloat(((l=e.currentAmount)==null?void 0:l.toString())||"0")||0,t.balance+=parseFloat(((r=e.balance)==null?void 0:r.toString())||"0")||0}),t.initialBalance&&t.initialBalance!==0?t.fluctuationRate=t.currentAmount/t.initialBalance*100:t.fluctuationRate=t.currentAmount!==0?t.currentAmount>0?100:-100:0,t}),x=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-inventory-status/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),i();return}const u=await e.json();if(u.data&&u.data.items){const l=u.data.items;n.value.items=B.items.map(r=>{const b=l.find(p=>p.segmentAttribute===r.segmentAttribute&&p.customerAttribute===r.customerAttribute);if(b){const p={segmentAttribute:r.segmentAttribute,customerAttribute:r.customerAttribute,initialBalance:Number(b.initialBalance)||0,currentAmount:Number(b.currentAmount)||0,balance:Number(b.balance)||0,fluctuationRate:Number(b.fluctuationRate)||0};return S(p),p}else return{...r}})}}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),i()}},i=()=>{n.value=JSON.parse(JSON.stringify(B))},h=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${D.TUOYUAN_INVENTORY_STATUS}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(c.value=u.data.remarks||"",d.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};R(()=>_.query.period,async t=>{t&&(s.value=t.toString(),i(),await x(t.toString()),h(t.toString()))}),R(s,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),i(),await x(t),h(t))});const U=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-inventory-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:{items:n.value.items.map(e=>({segmentAttribute:e.segmentAttribute,customerAttribute:e.customerAttribute,initialBalance:e.initialBalance,currentAmount:e.currentAmount,balance:e.balance,fluctuationRate:e.fluctuationRate}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(D.TUOYUAN_INVENTORY_STATUS,s.value,{items:n.value.items},c.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},T=()=>{i(),c.value="",d.value=""};return V(async()=>{var e;i();const t=((e=_.query.period)==null?void 0:e.toString())||s.value;await x(t),h(t)}),(t,e)=>(f(),A("div",z,[a("div",H,[e[4]||(e[4]=a("h1",{class:"text-2xl font-bold"},"\u62D3\u6E90\u5E93\u5B58\u60C5\u51B5",-1)),a("div",K,[e[3]||(e[3]=a("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),v(a("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>s.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[E,s.value]])])]),a("div",Q,[a("table",W,[e[6]||(e[6]=a("thead",{class:"sticky top-0 bg-white"},[a("tr",{class:"bg-gray-50"},[a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u521D\u4F59\u91CF"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u4F59\u989D"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u4F59\u989D"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u6CE2\u52A8\u7387")])],-1)),a("tbody",null,[(f(!0),A($,null,Y(n.value.items,(u,l)=>(f(),A("tr",{key:`item-${l}`},[N(l)?(f(),A("td",{key:0,rowspan:k(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},o(u.segmentAttribute),9,X)):q("",!0),a("td",Z,o(u.customerAttribute),1),a("td",P,[v(a("input",{"onUpdate:modelValue":r=>u.initialBalance=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-100",step:"0.01",readonly:""},null,8,tt),[[E,u.initialBalance]])]),a("td",et,[v(a("input",{"onUpdate:modelValue":r=>u.currentAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:r=>S(u)},null,40,at),[[E,u.currentAmount]])]),a("td",ut,[a("span",rt,o(m(u.balance)),1)]),a("td",nt,[a("span",st,o(F(u.fluctuationRate))+"%",1)])]))),128)),a("tr",ot,[e[5]||(e[5]=a("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),a("td",lt,o(m(g.value.initialBalance)),1),a("td",it,o(m(g.value.currentAmount)),1),a("td",ct,[a("span",dt,o(m(g.value.balance)),1)]),a("td",bt,[a("span",pt,o(F(g.value.fluctuationRate))+"%",1)])])])])]),j(L,{"module-id":J(D).TUOYUAN_INVENTORY_STATUS,period:s.value,remarks:c.value,"onUpdate:remarks":e[1]||(e[1]=u=>c.value=u),suggestions:d.value,"onUpdate:suggestions":e[2]||(e[2]=u=>d.value=u)},null,8,["module-id","period","remarks","suggestions"]),a("div",{class:"mt-4 flex justify-end space-x-4"},[a("button",{onClick:U,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),a("button",{onClick:T,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var ft=O(mt,[["__scopeId","data-v-1f0b5e7e"]]);export{ft as default};
