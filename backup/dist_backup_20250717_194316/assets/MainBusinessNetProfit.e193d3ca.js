import{_ as uu,d as eu,r as M,c as tu,B as Q,o as ou,b as B,e as u,y as $,A as U,F as Y,g as O,t as c,k as au,h as ru,G as su,v as _,f as G}from"./index.ce81c7a7.js";import{_ as nu,r as lu,M as J,l as cu}from"./FormAttachmentAndRemarks.aee9f644.js";const pu={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},iu={class:"flex justify-between items-center mb-6"},du={class:"flex items-center space-x-4"},yu={class:"overflow-x-auto my-6"},Fu={class:"w-full border-collapse border border-gray-300"},gu=["rowspan"],bu={class:"border border-gray-300 px-4 py-2"},hu={class:"border border-gray-300 px-4 py-2"},Du=["onUpdate:modelValue"],Eu={class:"border border-gray-300 px-4 py-2"},Bu={class:"font-medium"},_u={class:"border border-gray-300 px-4 py-2"},mu={class:"font-medium"},vu={class:"border border-gray-300 px-4 py-2"},Au={class:"border border-gray-300 px-4 py-2"},Cu={class:"text-blue-600"},fu=["rowspan"],xu={class:"border border-gray-300 px-4 py-2"},Vu={class:"border border-gray-300 px-4 py-2"},Mu=["onUpdate:modelValue"],Tu={class:"border border-gray-300 px-4 py-2"},wu={class:"font-medium"},Nu={class:"border border-gray-300 px-4 py-2"},Su={class:"font-medium"},ku={class:"border border-gray-300 px-4 py-2"},Iu={class:"border border-gray-300 px-4 py-2"},Pu={class:"text-blue-600"},Lu=["rowspan"],$u={class:"border border-gray-300 px-4 py-2"},Uu={class:"border border-gray-300 px-4 py-2"},qu=["onUpdate:modelValue"],ju={class:"border border-gray-300 px-4 py-2"},Ru={class:"font-medium"},Yu={class:"border border-gray-300 px-4 py-2"},Ou={class:"font-medium"},Gu={class:"border border-gray-300 px-4 py-2"},Ju={class:"border border-gray-300 px-4 py-2"},zu={class:"text-blue-600"},Hu={class:"bg-gray-50 font-bold"},Ku={class:"border border-gray-300 px-4 py-2"},Qu={class:"border border-gray-300 px-4 py-2"},Wu={class:"border border-gray-300 px-4 py-2"},Xu={class:"border border-gray-300 px-4 py-2"},Zu=eu({__name:"MainBusinessNetProfit",setup(ue){var H;const T=su(),p=M(((H=T.query.period)==null?void 0:H.toString())||new Date().toISOString().slice(0,7)),w=M(""),N=M(""),S=()=>[{customerType:"\u4E0A\u6D77",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u56FD\u7F51",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u540C\u4E1A",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],k=()=>[{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],I=()=>[{customerType:"\u4E00\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u4E8C\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],d=M(S()),y=M(k()),F=M(I()),m=r=>r.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),L=tu(()=>{let r=0,o=0,t=0;d.value.forEach(a=>{var l,i,D;r+=parseFloat((l=a.plan)==null?void 0:l.replace(/,/g,""))||0,o+=parseFloat((i=a.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,t+=parseFloat((D=a.actual)==null?void 0:D.replace(/,/g,""))||0}),y.value.forEach(a=>{var l,i,D;r+=parseFloat((l=a.plan)==null?void 0:l.replace(/,/g,""))||0,o+=parseFloat((i=a.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,t+=parseFloat((D=a.actual)==null?void 0:D.replace(/,/g,""))||0}),F.value.forEach(a=>{var l,i,D;r+=parseFloat((l=a.plan)==null?void 0:l.replace(/,/g,""))||0,o+=parseFloat((i=a.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,t+=parseFloat((D=a.actual)==null?void 0:D.replace(/,/g,""))||0});let s="0.00%";return r!==0&&(s=`${(t/r*100).toFixed(2)}%`),{plan:r,currentMonthValue:o,actual:t,contribution:s}}),V=(r,o,t)=>r.map(s=>{var l;const a=o==null?void 0:o.find(i=>i.segment===t&&i.customerType===s.customerType);return a?{customerType:s.customerType,plan:((l=a.yearlyPlan)==null?void 0:l.toString())||"0",currentMonthValue:"0",actual:"0",contribution:"0.00%",yearlyPlan:a.yearlyPlan||0}:s}),q=async r=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u6570\u636E\uFF0C\u671F\u95F4: ${r}`);const o=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${r}`);let t=[];if(o.ok){const s=await o.json();console.log("API\u8FD4\u56DE\u6570\u636E:",s),s.success&&s.data&&Array.isArray(s.data)&&(t=s.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else o.status===404?(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),d.value=S(),y.value=k(),F.value=I()):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");d.value=V(S(),t,"\u8BBE\u5907"),y.value=V(k(),t,"\u5143\u4EF6"),F.value=V(I(),t,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:d.value,componentData:y.value,projectData:F.value}),await z()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),d.value=V(S(),[],"\u8BBE\u5907"),y.value=V(k(),[],"\u5143\u4EF6"),F.value=V(I(),[],"\u5DE5\u7A0B")}},z=async()=>{var r,o,t,s,a,l;try{const[i]=p.value.split("-"),D=parseInt(p.value.split("-")[1]),K=[];for(let e=1;e<=D;e++){const E=`${i}-${e.toString().padStart(2,"0")}`;K.push(fetchAllDataForPeriod(E))}const g=await Promise.all(K);for(const e of d.value){let E=0,v=0;for(let n=0;n<g.length;n++){const C=calculateMonthlyValue(e,"\u8BBE\u5907",g[n]);if(E+=C,n===g.length-1){v=C;const f=g[n];if(f.cost){const h=f.cost.equipment;if(h&&Array.isArray(h)){const x=h.find(P=>P.customerType===e.customerType);x&&(e.currentLaborCost=parseFloat(x.currentLaborCost)||0)}}}}e.currentMonthValue=v.toFixed(2),e.actual=E.toFixed(2);const b=parseFloat(((r=e.plan)==null?void 0:r.replace(/,/g,""))||"0"),A=parseFloat(((o=e.actual)==null?void 0:o.replace(/,/g,""))||"0");if(!isNaN(b)&&!isNaN(A)&&b!==0){const n=(A/b*100).toFixed(2);e.contribution=`${n}%`}else e.contribution="0.00%"}for(const e of y.value){let E=0,v=0;for(let n=0;n<g.length;n++){const C=calculateMonthlyValue(e,"\u5143\u4EF6",g[n]);if(E+=C,n===g.length-1){v=C;const f=g[n];if(f.cost){const h=f.cost.component;if(h&&Array.isArray(h)){const x=h.find(P=>P.customerType===e.customerType);x&&(e.currentLaborCost=parseFloat(x.currentLaborCost)||0)}}}}e.currentMonthValue=v.toFixed(2),e.actual=E.toFixed(2);const b=parseFloat(((t=e.plan)==null?void 0:t.replace(/,/g,""))||"0"),A=parseFloat(((s=e.actual)==null?void 0:s.replace(/,/g,""))||"0");if(!isNaN(b)&&!isNaN(A)&&b!==0){const n=(A/b*100).toFixed(2);e.contribution=`${n}%`}else e.contribution="0.00%"}for(const e of F.value){let E=0,v=0;for(let n=0;n<g.length;n++){const C=calculateMonthlyValue(e,"\u5DE5\u7A0B",g[n]);if(E+=C,n===g.length-1){v=C;const f=g[n];if(f.cost){const h=f.cost.project;if(h&&Array.isArray(h)){const x=h.find(P=>P.customerType===e.customerType);x&&(e.currentLaborCost=parseFloat(x.currentLaborCost)||0)}}}}e.currentMonthValue=v.toFixed(2),e.actual=E.toFixed(2);const b=parseFloat(((a=e.plan)==null?void 0:a.replace(/,/g,""))||"0"),A=parseFloat(((l=e.actual)==null?void 0:l.replace(/,/g,""))||"0");if(!isNaN(b)&&!isNaN(A)&&b!==0){const n=(A/b*100).toFixed(2);e.contribution=`${n}%`}else e.contribution="0.00%"}console.log("=== \u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8BA1\u7B97\u5B8C\u6210 ==="),console.log("\u5F53\u524D\u671F\u95F4:",p.value),console.log("\u8BBE\u5907\u677F\u5757:",d.value.map(e=>({\u5BA2\u6237:e.customerType,\u5F53\u6708\u503C:e.currentMonthValue,\u7D2F\u8BA1\u503C:e.actual,\u8D21\u732E\u5360\u6BD4:e.contribution,\u4EBA\u5DE5\u8D39:e.currentLaborCost}))),console.log("\u5143\u4EF6\u677F\u5757:",y.value.map(e=>({\u5BA2\u6237:e.customerType,\u5F53\u6708\u503C:e.currentMonthValue,\u7D2F\u8BA1\u503C:e.actual,\u8D21\u732E\u5360\u6BD4:e.contribution,\u4EBA\u5DE5\u8D39:e.currentLaborCost}))),console.log("\u5DE5\u7A0B\u677F\u5757:",F.value.map(e=>({\u5BA2\u6237:e.customerType,\u5F53\u6708\u503C:e.currentMonthValue,\u7D2F\u8BA1\u503C:e.actual,\u8D21\u732E\u5360\u6BD4:e.contribution,\u4EBA\u5DE5\u8D39:e.currentLaborCost})));const R=d.value.find(e=>e.customerType==="\u4E0A\u6D77");R&&(console.log("=== \u4E0A\u6D77\u5BA2\u6237\u9A8C\u8BC1 ==="),console.log("\u671F\u671B\u7ED3\u679C: 430.57 - 233.86 - 0 = 196.71"),console.log("\u5B9E\u9645\u5F53\u6708\u503C:",R.currentMonthValue),console.log("\u5B9E\u9645\u4EBA\u5DE5\u8D39:",R.currentLaborCost)),console.log("=== \u8BA1\u7B97\u5B8C\u6210 ===")}catch(i){console.error("\u6279\u91CF\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",i)}};Q(()=>T.query.period,r=>{r&&(p.value=r.toString(),q(r.toString()),j())}),Q(p,r=>{q(r),j()});const W=async()=>{try{const r=[...d.value.map(a=>({...a,segment:"\u8BBE\u5907"})),...y.value.map(a=>({...a,segment:"\u5143\u4EF6"})),...F.value.map(a=>({...a,segment:"\u5DE5\u7A0B"}))],o={period:p.value,data:r};console.log("\u4FDD\u5B58\u6570\u636E:",o);const t=await fetch("http://47.111.95.19:3000/main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!t.ok){const a=await t.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${t.status} - ${a}`)}const s={equipment:d.value,component:y.value,project:F.value};await lu(J.MAIN_BUSINESS_NET_PROFIT,p.value,s,w.value,N.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(r){console.error("\u4FDD\u5B58\u5931\u8D25:",r),alert("\u4FDD\u5B58\u5931\u8D25: "+(r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"))}},X=()=>{d.value=S(),y.value=k(),F.value=I(),w.value="",N.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},j=async()=>{const{remarks:r,suggestions:o}=await cu(J.MAIN_BUSINESS_NET_PROFIT,p.value);w.value=r,N.value=o},Z=()=>{console.log("=== \u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8BA1\u7B97\u516C\u5F0F\u6D4B\u8BD5 ==="),console.log("\u8BA1\u7B97\u516C\u5F0F\uFF1A\u5F53\u6708\u503C = \u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u5206\u89E3\u4E2D\u7684\u5F53\u6708\u6536\u5165 - \u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u7ED3\u6784\u4E0E\u8D28\u91CF\u4E2D\u7684\u5F53\u671F\u76F4\u63A5\u8D39\u7528 - \u6210\u672C\u4E2D\u5FC3\u7ED3\u6784\u4E2D\u7684\u5F53\u6708\u5B9E\u9645"),console.log("\u7D2F\u8BA1\u503C = \u5404\u4E2A\u5F53\u6708\u503C\u76F8\u52A0\uFF08\u4ECE1\u6708\u5230\u5F53\u524D\u6708\uFF09"),console.log("\u5F53\u524D\u671F\u95F4:",p.value),console.log("\u8BBE\u5907\u677F\u5757\u6570\u636E:",d.value.length,"\u9879"),console.log("\u5143\u4EF6\u677F\u5757\u6570\u636E:",y.value.length,"\u9879"),console.log("\u5DE5\u7A0B\u677F\u5757\u6570\u636E:",F.value.length,"\u9879"),console.log("API\u8C03\u7528\u8BF4\u660E:"),console.log("- \u4E3B\u8425\u4E1A\u52A1\u6536\u5165: /main-business-income/{period}-01 (\u9700\u8981\u65E5\u671F\u683C\u5F0F)"),console.log("- \u4E3B\u8425\u4E1A\u52A1\u6210\u672C: /main-business-cost/{period} (YYYY-MM\u683C\u5F0F)"),console.log("- \u6210\u672C\u4E2D\u5FC3\u7ED3\u6784: /cost-center-structure/{period} (YYYY-MM\u683C\u5F0F)"),console.log("=== \u6D4B\u8BD5\u5B8C\u6210 ===")};return ou(()=>{var o;console.log("=== \u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u7EC4\u4EF6\u6302\u8F7D ==="),console.log("\u5F53\u524D\u671F\u95F4:",p.value),console.log("\u8DEF\u7531\u67E5\u8BE2\u53C2\u6570:",T.query.period),console.log("\u5C06\u8981\u52A0\u8F7D\u7684\u671F\u95F4:",T.query.period||p.value),Z();const r=((o=T.query.period)==null?void 0:o.toString())||p.value;console.log("\u5F00\u59CB\u52A0\u8F7D\u6570\u636E\uFF0C\u671F\u95F4:",r),q(r),j()}),(r,o)=>(_(),B("div",pu,[u("div",iu,[o[3]||(o[3]=u("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),u("div",du,[u("button",{onClick:z,class:"px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u91CD\u65B0\u8BA1\u7B97 "),$(u("input",{"onUpdate:modelValue":o[0]||(o[0]=t=>p.value=t),type:"month",class:"px-3 py-2 border rounded"},null,512),[[U,p.value]])])]),u("div",yu,[u("table",Fu,[o[5]||(o[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5E74\u5EA6\u8BA1\u5212"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u6708\u503C"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u7D2F\u8BA1\u503C"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u671F\u4EBA\u5DE5\u8D39")])],-1)),u("tbody",null,[(_(!0),B(Y,null,O(d.value,(t,s)=>{var a;return _(),B("tr",{key:`equipment-${s}`},[s===0?(_(),B("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u8BBE\u5907 ",8,gu)):G("",!0),u("td",bu,c(t.customerType),1),u("td",hu,[$(u("input",{"onUpdate:modelValue":l=>t.plan=l,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Du),[[U,t.plan]])]),u("td",Eu,[u("span",Bu,c(m(parseFloat((a=t.currentMonthValue)==null?void 0:a.replace(/,/g,""))||0)),1)]),u("td",_u,[u("span",mu,c(t.actual),1)]),u("td",vu,c(t.contribution),1),u("td",Au,[u("span",Cu,c(m(t.currentLaborCost||0)),1)])])}),128)),(_(!0),B(Y,null,O(y.value,(t,s)=>{var a;return _(),B("tr",{key:`component-${s}`},[s===0?(_(),B("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:y.value.length}," \u5143\u4EF6 ",8,fu)):G("",!0),u("td",xu,c(t.customerType),1),u("td",Vu,[$(u("input",{"onUpdate:modelValue":l=>t.plan=l,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Mu),[[U,t.plan]])]),u("td",Tu,[u("span",wu,c(m(parseFloat((a=t.currentMonthValue)==null?void 0:a.replace(/,/g,""))||0)),1)]),u("td",Nu,[u("span",Su,c(t.actual),1)]),u("td",ku,c(t.contribution),1),u("td",Iu,[u("span",Pu,c(m(t.currentLaborCost||0)),1)])])}),128)),(_(!0),B(Y,null,O(F.value,(t,s)=>{var a;return _(),B("tr",{key:`project-${s}`},[s===0?(_(),B("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:F.value.length}," \u5DE5\u7A0B ",8,Lu)):G("",!0),u("td",$u,c(t.customerType),1),u("td",Uu,[$(u("input",{"onUpdate:modelValue":l=>t.plan=l,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,qu),[[U,t.plan]])]),u("td",ju,[u("span",Ru,c(m(parseFloat((a=t.currentMonthValue)==null?void 0:a.replace(/,/g,""))||0)),1)]),u("td",Yu,[u("span",Ou,c(t.actual),1)]),u("td",Gu,c(t.contribution),1),u("td",Ju,[u("span",zu,c(m(t.currentLaborCost||0)),1)])])}),128)),u("tr",Hu,[o[4]||(o[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",Ku,c(m(L.value.plan)),1),u("td",Qu,c(m(L.value.currentMonthValue)),1),u("td",Wu,c(m(L.value.actual)),1),u("td",Xu,c(L.value.contribution),1)])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:W,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:X,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),au(nu,{"module-id":ru(J).MAIN_BUSINESS_NET_PROFIT,period:p.value,remarks:w.value,"onUpdate:remarks":o[1]||(o[1]=t=>w.value=t),suggestions:N.value,"onUpdate:suggestions":o[2]||(o[2]=t=>N.value=t)},null,8,["module-id","period","remarks","suggestions"])]))}});var oe=uu(Zu,[["__scopeId","data-v-9cb02d3a"]]);export{oe as default};
