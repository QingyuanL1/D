import{_ as K,d as P,r as h,h as Q,C as L,o as W,c as s,a as n,y as f,B as M,F as $,l as V,t as c,q as g,b as X,m as Y,G as Z,f as l,k as U}from"./index.d001ed47.js";import{_ as ee,M as te,r as ue,l as ne}from"./FormAttachmentAndRemarks.e157dde2.js";const oe={class:"max-w-[1600px] mx-auto bg-white rounded-lg shadow-lg p-6"},re={class:"flex justify-between items-center mb-6"},ae={class:"flex items-center space-x-4"},ce={class:"overflow-x-auto my-6"},se={class:"w-full border-collapse border border-gray-300"},le=["rowspan"],me={class:"border border-gray-300 px-4 py-2"},pe={class:"font-medium"},de={class:"border border-gray-300 px-4 py-2"},ie=["onUpdate:modelValue","onInput"],ge={key:1,class:"font-medium"},ve={class:"border border-gray-300 px-4 py-2"},ye=["rowspan"],he={class:"border border-gray-300 px-4 py-2"},Ie={class:"font-medium"},be={class:"border border-gray-300 px-4 py-2"},Fe=["onUpdate:modelValue","onInput"],De={key:1,class:"font-medium"},fe={class:"border border-gray-300 px-4 py-2"},Me=["rowspan"],xe={class:"border border-gray-300 px-4 py-2"},_e={class:"font-medium"},Ee={class:"border border-gray-300 px-4 py-2"},Ce=["onUpdate:modelValue","onInput"],we={key:1,class:"font-medium"},Te={class:"border border-gray-300 px-4 py-2"},Be={class:"bg-purple-50"},ke={class:"border border-gray-300 px-4 py-2"},Ae={class:"font-medium"},Se={class:"border border-gray-300 px-4 py-2"},$e={class:"border border-gray-300 px-4 py-2"},Ve={class:"bg-gray-100 font-bold"},Ue={class:"border border-gray-300 px-4 py-2 text-right"},qe={class:"border border-gray-300 px-4 py-2 text-right"},Ne={class:"border border-gray-300 px-4 py-2 text-right"},Re=P({__name:"CostCenterStructure",setup(je){var j;const q=Z(),m=h(((j=q.query.period)==null?void 0:j.toString())||new Date().toISOString().slice(0,7)),C=te.COST_CENTER_STRUCTURE,x=h(""),_=h(""),w=h([]),p=h([{customerType:"\u4E0A\u6D77",cumulativeIncome:2363.98,currentMonthIncome:717.46,percentage:"30.35"},{customerType:"\u56FD\u7F51",cumulativeIncome:884.59,currentMonthIncome:122.03,percentage:"13.80"},{customerType:"\u6C5F\u82CF",cumulativeIncome:119.81,currentMonthIncome:16.53,percentage:"13.80"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u897F\u95E8\u5B50",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u540C\u4E1A",cumulativeIncome:67.98,currentMonthIncome:.99,percentage:"1.46"},{customerType:"\u7528\u6237",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u5176\u4ED6",cumulativeIncome:26.41,currentMonthIncome:138.55,percentage:"524.61"}]),d=h([{customerType:"\u7528\u6237",cumulativeIncome:3.09,currentMonthIncome:2.43,percentage:"78.64"}]),i=h([{customerType:"\u4E00\u5305",cumulativeIncome:-.01,currentMonthIncome:.15,percentage:"-1645.00"},{customerType:"\u4E8C\u5305",cumulativeIncome:297.01,currentMonthIncome:19.23,percentage:"6.47"},{customerType:"\u57DF\u5185\u5408\u4F5C",cumulativeIncome:717.23,currentMonthIncome:44.14,percentage:"6.15"},{customerType:"\u57DF\u5916\u5408\u4F5C",cumulativeIncome:522.45,currentMonthIncome:35.99,percentage:"6.89"},{customerType:"\u5176\u5B83",cumulativeIncome:145.39,currentMonthIncome:17.74,percentage:"12.20"}]),a=h({customerType:"",cumulativeIncome:123.28,currentMonthIncome:32.59,percentage:"26.44"}),T=Q(()=>{const t=p.value.reduce((o,r)=>o+r.cumulativeIncome,0)+d.value.reduce((o,r)=>o+r.cumulativeIncome,0)+i.value.reduce((o,r)=>o+r.cumulativeIncome,0)+a.value.cumulativeIncome,u=p.value.reduce((o,r)=>o+r.currentMonthIncome,0)+d.value.reduce((o,r)=>o+r.currentMonthIncome,0)+i.value.reduce((o,r)=>o+r.currentMonthIncome,0)+a.value.currentMonthIncome,e=t>0?(u/t*100).toFixed(2):"0.00";return{cumulativeIncome:t,currentMonthIncome:u,percentage:e}}),B=t=>{A(),t.cumulativeIncome&&t.cumulativeIncome!==0?t.percentage=(t.currentMonthIncome/t.cumulativeIncome*100).toFixed(2):t.percentage="0.00",N()},N=()=>{A(),a.value.cumulativeIncome&&a.value.cumulativeIncome!==0?a.value.percentage=(a.value.currentMonthIncome/a.value.cumulativeIncome*100).toFixed(2):a.value.percentage="0.00"},v=t=>t.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),E=t=>{const u=parseFloat(t);return u<0?"text-red-600":u>100?"text-orange-600":u>50?"text-green-600":"text-gray-700"},D=()=>({equipmentData:[{customerType:"\u4E0A\u6D77",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u56FD\u7F51",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u6C5F\u82CF",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u897F\u95E8\u5B50",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u540C\u4E1A",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u7528\u6237",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u5176\u4ED6",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"}],componentData:[{customerType:"\u7528\u6237",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"}],engineeringData:[{customerType:"\u4E00\u5305",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u4E8C\u5305",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u57DF\u5185\u5408\u4F5C",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u57DF\u5916\u5408\u4F5C",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"},{customerType:"\u5176\u5B83",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"}],nonMainBusiness:{customerType:"",cumulativeIncome:0,currentMonthIncome:0,percentage:"0.00"}}),z=async t=>{try{const[u,e]=t.split("-"),o=parseInt(e),r=[];for(let I=1;I<=o;I++){const y=`${u}-${I.toString().padStart(2,"0")}`;try{const b=await fetch(`http://47.111.95.19:3000/cost-center-structure/${y}`);if(b.ok){const F=await b.json();F.data&&r.push({period:y,data:F.data})}}catch(b){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${y}:`,b)}}w.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(u){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",u)}},k=(t,u)=>{let e=0;const o=m.value;for(const y of w.value){if(y.period===o)continue;const b=y.data[t];if(b){const F=b.find(O=>O.customerType===u);F&&F.currentMonthIncome&&(e+=parseFloat(F.currentMonthIncome.toString())||0)}}let r=[];t==="equipmentData"?r=p.value:t==="componentData"?r=d.value:t==="engineeringData"&&(r=i.value);const I=r.find(y=>y.customerType===u);return I&&I.currentMonthIncome&&(e+=parseFloat(I.currentMonthIncome.toString())||0),e},G=()=>{let t=0;const u=m.value;for(const e of w.value)e.period!==u&&e.data.nonMainBusiness&&e.data.nonMainBusiness.currentMonthIncome&&(t+=parseFloat(e.data.nonMainBusiness.currentMonthIncome.toString())||0);return a.value.currentMonthIncome&&(t+=parseFloat(a.value.currentMonthIncome.toString())||0),t},A=()=>{p.value.forEach(t=>{t.cumulativeIncome=k("equipmentData",t.customerType)}),d.value.forEach(t=>{t.cumulativeIncome=k("componentData",t.customerType)}),i.value.forEach(t=>{t.cumulativeIncome=k("engineeringData",t.customerType)}),a.value.cumulativeIncome=G()},S=async t=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u6210\u672C\u4E2D\u5FC3\u6570\u636E\uFF0C\u671F\u95F4: ${t}`);const u=await fetch(`http://47.111.95.19:3000/cost-center-structure/${t}`);if(!u.ok){if(u.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u73B0\u6709\u6570\u636E\u4F46\u6E05\u7A7A\u5F53\u671F\u7D2F\u8BA1"),p.value=p.value.map(o=>({...o,currentMonthIncome:0,percentage:"0.00"})),d.value=d.value.map(o=>({...o,currentMonthIncome:0,percentage:"0.00"})),i.value=i.value.map(o=>({...o,currentMonthIncome:0,percentage:"0.00"})),a.value={...a.value,currentMonthIncome:0,percentage:"0.00"},await z(t),A();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const e=await u.json();console.log("API\u8FD4\u56DE\u6570\u636E:",e),e.success&&e.data&&(p.value=e.data.equipmentData||D().equipmentData,d.value=e.data.componentData||D().componentData,i.value=e.data.engineeringData||D().engineeringData,a.value=e.data.nonMainBusiness||D().nonMainBusiness)}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u)}};L(()=>q.query.period,t=>{t&&(m.value=t.toString(),S(t.toString()))}),L(m,(t,u)=>{t&&t!==u&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${u} -> ${t}`),S(t),R())});const J=async()=>{try{const t={period:m.value,data:{equipmentData:p.value,componentData:d.value,engineeringData:i.value,nonMainBusiness:a.value}};console.log("\u4FDD\u5B58\u6570\u636E:",t);const u=await fetch("http://47.111.95.19:3000/cost-center-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!u.ok){const e=await u.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${u.status} - ${e}`)}await ue(C,m.value,t.data,x.value,_.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25: "+(t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"))}},H=()=>{const t=D();p.value=t.equipmentData,d.value=t.componentData,i.value=t.engineeringData,a.value=t.nonMainBusiness,console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},R=async()=>{const{remarks:t,suggestions:u}=await ne(C,m.value);x.value=t,_.value=u};return W(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",m.value),S(m.value),R()}),(t,u)=>(l(),s("div",oe,[n("div",re,[u[4]||(u[4]=n("h1",{class:"text-2xl font-bold"},"\u6210\u672C\u4E2D\u5FC3\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),n("div",ae,[f(n("input",{"onUpdate:modelValue":u[0]||(u[0]=e=>m.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[M,m.value]])])]),u[10]||(u[10]=n("div",{class:"mb-4"},[n("h2",{class:"text-lg font-semibold text-gray-700"},"\u5BF9\u5E94\u5F53\u671F\u6536\u5165\uFF1A")],-1)),n("div",ce,[n("table",se,[u[9]||(u[9]=n("thead",{class:"sticky top-0 bg-white"},[n("tr",{class:"bg-gray-50"},[n("th",{class:"border border-gray-300 px-4 py-2 w-24",rowspan:"2"},"\u677F\u5757"),n("th",{class:"border border-gray-300 px-4 py-2 w-32",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),n("th",{class:"border border-gray-300 px-4 py-2 w-32",rowspan:"2"},"\u7D2F\u8BA1\u6267\u884C\uFF08\u4E07\u5143\uFF09"),n("th",{class:"border border-gray-300 px-4 py-2 w-32",rowspan:"2"},"\u5F53\u6708\u5B9E\u9645\uFF08\u4E07\u5143\uFF09"),n("th",{class:"border border-gray-300 px-4 py-2 w-32",rowspan:"2"},"\u5206\u9879\u5360\u6536\u5165\u6BD4")])],-1)),n("tbody",null,[(l(!0),s($,null,V(p.value,(e,o)=>(l(),s("tr",{key:`equipment-${o}`,class:g(e.isCategory?"bg-blue-50":"")},[o===0?(l(),s("td",{key:0,class:"border border-gray-300 px-4 py-2 font-medium bg-blue-100 text-center",rowspan:p.value.length},"\u8BBE\u5907",8,le)):U("",!0),n("td",{class:g(["border border-gray-300 px-4 py-2",e.isCategory?"font-medium bg-blue-50":""])},c(e.customerType),3),n("td",me,[n("span",pe,c(v(e.cumulativeIncome)),1)]),n("td",de,[e.isCategory?(l(),s("span",ge,c(v(e.currentMonthIncome)),1)):f((l(),s("input",{key:0,"onUpdate:modelValue":r=>e.currentMonthIncome=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:r=>B(e)},null,40,ie)),[[M,e.currentMonthIncome,void 0,{number:!0}]])]),n("td",ve,[n("span",{class:g(["font-medium",E(e.percentage)])},c(e.percentage)+"% ",3)])],2))),128)),(l(!0),s($,null,V(d.value,(e,o)=>(l(),s("tr",{key:`component-${o}`,class:g(e.isCategory?"bg-green-50":"")},[o===0?(l(),s("td",{key:0,class:"border border-gray-300 px-4 py-2 font-medium bg-green-100 text-center",rowspan:d.value.length},"\u5143\u4EF6",8,ye)):U("",!0),n("td",{class:g(["border border-gray-300 px-4 py-2",e.isCategory?"font-medium bg-green-50":""])},c(e.customerType),3),n("td",he,[n("span",Ie,c(v(e.cumulativeIncome)),1)]),n("td",be,[e.isCategory?(l(),s("span",De,c(v(e.currentMonthIncome)),1)):f((l(),s("input",{key:0,"onUpdate:modelValue":r=>e.currentMonthIncome=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:r=>B(e)},null,40,Fe)),[[M,e.currentMonthIncome,void 0,{number:!0}]])]),n("td",fe,[n("span",{class:g(["font-medium",E(e.percentage)])},c(e.percentage)+"% ",3)])],2))),128)),(l(!0),s($,null,V(i.value,(e,o)=>(l(),s("tr",{key:`engineering-${o}`,class:g(e.isCategory?"bg-yellow-50":"")},[o===0?(l(),s("td",{key:0,class:"border border-gray-300 px-4 py-2 font-medium bg-yellow-100 text-center",rowspan:i.value.length},"\u5DE5\u7A0B",8,Me)):U("",!0),n("td",{class:g(["border border-gray-300 px-4 py-2",e.isCategory?"font-medium bg-yellow-50":""])},c(e.customerType),3),n("td",xe,[n("span",_e,c(v(e.cumulativeIncome)),1)]),n("td",Ee,[e.isCategory?(l(),s("span",we,c(v(e.currentMonthIncome)),1)):f((l(),s("input",{key:0,"onUpdate:modelValue":r=>e.currentMonthIncome=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:r=>B(e)},null,40,Ce)),[[M,e.currentMonthIncome,void 0,{number:!0}]])]),n("td",Te,[n("span",{class:g(["font-medium",E(e.percentage)])},c(e.percentage)+"% ",3)])],2))),128)),n("tr",Be,[u[5]||(u[5]=n("td",{class:"border border-gray-300 px-4 py-2 font-medium bg-purple-100 text-center"},"\u975E\u4E3B\u8425\u4E1A\u52A1",-1)),u[6]||(u[6]=n("td",{class:"border border-gray-300 px-4 py-2 font-medium bg-purple-50"},null,-1)),n("td",ke,[n("span",Ae,c(v(a.value.cumulativeIncome)),1)]),n("td",Se,[f(n("input",{"onUpdate:modelValue":u[1]||(u[1]=e=>a.value.currentMonthIncome=e),type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:N},null,544),[[M,a.value.currentMonthIncome,void 0,{number:!0}]])]),n("td",$e,[n("span",{class:g(["font-medium",E(a.value.percentage)])},c(a.value.percentage)+"% ",3)])]),n("tr",Ve,[u[7]||(u[7]=n("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u[8]||(u[8]=n("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),n("td",Ue,c(v(T.value.cumulativeIncome)),1),n("td",qe,c(v(T.value.currentMonthIncome)),1),n("td",Ne,c(T.value.percentage)+"%",1)])])])]),n("div",{class:"mt-4 flex justify-end space-x-4"},[n("button",{onClick:J,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),n("button",{onClick:H,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),X(ee,{"module-id":Y(C),period:m.value,remarks:x.value,"onUpdate:remarks":u[2]||(u[2]=e=>x.value=e),suggestions:_.value,"onUpdate:suggestions":u[3]||(u[3]=e=>_.value=e)},null,8,["module-id","period","remarks","suggestions"])]))}});var ze=K(Re,[["__scopeId","data-v-423d47cc"]]);export{ze as default};
