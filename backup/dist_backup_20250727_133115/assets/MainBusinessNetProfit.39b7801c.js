import{_ as R,d as O,r as _,h as L,C as U,o as G,c as y,a as t,y as A,B as C,F as T,l as S,t as n,b as J,m as z,G as H,f as g,k}from"./index.d001ed47.js";import{_ as K,r as Q,M as I,l as W}from"./FormAttachmentAndRemarks.e157dde2.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Y={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},uu={class:"overflow-x-auto my-6"},eu={class:"w-full border-collapse border border-gray-300"},tu=["rowspan"],ou={class:"border border-gray-300 px-4 py-2"},ru={class:"border border-gray-300 px-4 py-2"},au=["onUpdate:modelValue"],su={class:"border border-gray-300 px-4 py-2"},nu={class:"font-medium"},lu={class:"border border-gray-300 px-4 py-2"},cu={class:"font-medium"},pu={class:"border border-gray-300 px-4 py-2"},du=["rowspan"],iu={class:"border border-gray-300 px-4 py-2"},yu={class:"border border-gray-300 px-4 py-2"},gu=["onUpdate:modelValue"],bu={class:"border border-gray-300 px-4 py-2"},Fu={class:"font-medium"},hu={class:"border border-gray-300 px-4 py-2"},_u={class:"font-medium"},mu={class:"border border-gray-300 px-4 py-2"},Eu=["rowspan"],Du={class:"border border-gray-300 px-4 py-2"},vu={class:"border border-gray-300 px-4 py-2"},fu=["onUpdate:modelValue"],xu={class:"border border-gray-300 px-4 py-2"},Bu={class:"font-medium"},Au={class:"border border-gray-300 px-4 py-2"},Cu={class:"font-medium"},Vu={class:"border border-gray-300 px-4 py-2"},wu={class:"bg-gray-50 font-bold"},Mu={class:"border border-gray-300 px-4 py-2"},Tu={class:"border border-gray-300 px-4 py-2"},Su={class:"border border-gray-300 px-4 py-2"},ku={class:"border border-gray-300 px-4 py-2"},Iu=O({__name:"MainBusinessNetProfit",setup(Nu){var N;const x=H(),l=_(((N=x.query.period)==null?void 0:N.toString())||new Date().toISOString().slice(0,7)),m=_(""),E=_(""),D=()=>[{customerType:"\u4E0A\u6D77",plan:"2145.03",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u56FD\u7F51",plan:"621.55",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u540C\u4E1A",plan:"553.08",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u7528\u6237",plan:"323.8",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],v=()=>[{customerType:"\u7528\u6237",plan:"-26.21",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],f=()=>[{customerType:"\u4E00\u5305",plan:"328.91",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u4E8C\u5305",plan:"14.4",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"-35.24",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"69.6",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],c=_(D()),p=_(v()),d=_(f()),F=o=>o.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),$=async o=>{try{const u=await fetch(`http://47.111.95.19:3000/main-business-net-profit/monthly-data/${o}`);if(u.ok){const e=await u.json();if(e.success)return e.data}return console.error(`\u83B7\u53D6${o}\u6708\u5EA6\u6570\u636E\u5931\u8D25:`,u.status),null}catch(u){return console.error(`\u83B7\u53D6${o}\u6708\u5EA6\u6570\u636E\u5931\u8D25:`,u),null}},V=(o,u)=>{var e,a;u&&(o.currentMonthValue=((e=u.currentMonthValue)==null?void 0:e.toFixed(2))||"0",o.actual=((a=u.cumulativeValue)==null?void 0:a.toFixed(2))||"0",o.contribution=u.contribution||"0.00%",o.currentLaborCost=0)},B=L(()=>{let o=0,u=0,e=0;c.value.forEach(r=>{var s,i,b;o+=parseFloat((s=r.plan)==null?void 0:s.replace(/,/g,""))||0,u+=parseFloat((i=r.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,e+=parseFloat((b=r.actual)==null?void 0:b.replace(/,/g,""))||0}),p.value.forEach(r=>{var s,i,b;o+=parseFloat((s=r.plan)==null?void 0:s.replace(/,/g,""))||0,u+=parseFloat((i=r.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,e+=parseFloat((b=r.actual)==null?void 0:b.replace(/,/g,""))||0}),d.value.forEach(r=>{var s,i,b;o+=parseFloat((s=r.plan)==null?void 0:s.replace(/,/g,""))||0,u+=parseFloat((i=r.currentMonthValue)==null?void 0:i.replace(/,/g,""))||0,e+=parseFloat((b=r.actual)==null?void 0:b.replace(/,/g,""))||0});let a="0.00%";return o!==0&&(a=`${(e/o*100).toFixed(2)}%`),{plan:o,currentMonthValue:u,actual:e,contribution:a}}),h=(o,u,e)=>o.map(a=>{var s;const r=u==null?void 0:u.find(i=>i.segment===e&&i.customerType===a.customerType);return r?{customerType:a.customerType,plan:((s=r.yearlyPlan)==null?void 0:s.toString())||"0",currentMonthValue:"0",actual:"0",contribution:"0.00%",yearlyPlan:r.yearlyPlan||0}:a}),w=async o=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u6570\u636E\uFF0C\u671F\u95F4: ${o}`);const u=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${o}`);let e=[];if(u.ok){const a=await u.json();console.log("API\u8FD4\u56DE\u6570\u636E:",a),a.success&&a.data&&Array.isArray(a.data)&&(e=a.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else u.status===404?(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),c.value=D(),p.value=v(),d.value=f()):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");c.value=h(D(),e,"\u8BBE\u5907"),p.value=h(v(),e,"\u5143\u4EF6"),d.value=h(f(),e,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:c.value,componentData:p.value,projectData:d.value}),await j()}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u),c.value=h(D(),[],"\u8BBE\u5907"),p.value=h(v(),[],"\u5143\u4EF6"),d.value=h(f(),[],"\u5DE5\u7A0B")}},j=async()=>{try{console.log("\u5F00\u59CB\u83B7\u53D6\u6708\u5EA6\u6570\u636E\uFF0C\u671F\u95F4:",l.value);const o=await $(l.value);if(!o){console.error("\u83B7\u53D6\u6708\u5EA6\u6570\u636E\u5931\u8D25");return}c.value.forEach(u=>{var a;const e=(a=o.equipment)==null?void 0:a.find(r=>r.customer===u.customerType);V(u,e)}),p.value.forEach(u=>{var a;const e=(a=o.components)==null?void 0:a.find(r=>r.customer===u.customerType);V(u,e)}),d.value.forEach(u=>{var a;const e=(a=o.engineering)==null?void 0:a.find(r=>r.customer===u.customerType);V(u,e)}),console.log("=== \u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u6570\u636E\u66F4\u65B0\u5B8C\u6210 ==="),console.log("\u5F53\u524D\u671F\u95F4:",l.value)}catch(o){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",o)}};U(()=>x.query.period,o=>{o&&(l.value=o.toString(),w(o.toString()),M())}),U(l,o=>{w(o),M()});const q=async()=>{try{const o=[...c.value.map(r=>({...r,segment:"\u8BBE\u5907"})),...p.value.map(r=>({...r,segment:"\u5143\u4EF6"})),...d.value.map(r=>({...r,segment:"\u5DE5\u7A0B"}))],u={period:l.value,data:o};console.log("\u4FDD\u5B58\u6570\u636E:",u);const e=await fetch("http://47.111.95.19:3000/main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!e.ok){const r=await e.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${e.status} - ${r}`)}const a={equipment:c.value,component:p.value,project:d.value};await Q(I.MAIN_BUSINESS_NET_PROFIT,l.value,a,m.value,E.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(o){console.error("\u4FDD\u5B58\u5931\u8D25:",o),alert("\u4FDD\u5B58\u5931\u8D25: "+(o instanceof Error?o.message:"\u672A\u77E5\u9519\u8BEF"))}},P=()=>{c.value=D(),p.value=v(),d.value=f(),m.value="",E.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},M=async()=>{const{remarks:o,suggestions:u}=await W(I.MAIN_BUSINESS_NET_PROFIT,l.value);m.value=o,E.value=u};return G(()=>{var u;console.log("=== \u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u7EC4\u4EF6\u6302\u8F7D ==="),console.log("\u5F53\u524D\u671F\u95F4:",l.value),console.log("\u8DEF\u7531\u67E5\u8BE2\u53C2\u6570:",x.query.period);const o=((u=x.query.period)==null?void 0:u.toString())||l.value;console.log("\u5F00\u59CB\u52A0\u8F7D\u6570\u636E\uFF0C\u671F\u95F4:",o),w(o),M()}),(o,u)=>(g(),y("div",X,[t("div",Y,[u[3]||(u[3]=t("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),t("div",Z,[A(t("input",{"onUpdate:modelValue":u[0]||(u[0]=e=>l.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,l.value]])])]),t("div",uu,[t("table",eu,[u[5]||(u[5]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u677F\u5757"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5E74\u5EA6\u8BA1\u5212"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u6708\u503C"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u7D2F\u8BA1\u503C"),t("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4")])],-1)),t("tbody",null,[(g(!0),y(T,null,S(c.value,(e,a)=>{var r;return g(),y("tr",{key:`equipment-${a}`},[a===0?(g(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u8BBE\u5907 ",8,tu)):k("",!0),t("td",ou,n(e.customerType),1),t("td",ru,[A(t("input",{"onUpdate:modelValue":s=>e.plan=s,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,au),[[C,e.plan]])]),t("td",su,[t("span",nu,n(F(parseFloat((r=e.currentMonthValue)==null?void 0:r.replace(/,/g,""))||0)),1)]),t("td",lu,[t("span",cu,n(e.actual),1)]),t("td",pu,n(e.contribution),1)])}),128)),(g(!0),y(T,null,S(p.value,(e,a)=>{var r;return g(),y("tr",{key:`component-${a}`},[a===0?(g(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5143\u4EF6 ",8,du)):k("",!0),t("td",iu,n(e.customerType),1),t("td",yu,[A(t("input",{"onUpdate:modelValue":s=>e.plan=s,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,gu),[[C,e.plan]])]),t("td",bu,[t("span",Fu,n(F(parseFloat((r=e.currentMonthValue)==null?void 0:r.replace(/,/g,""))||0)),1)]),t("td",hu,[t("span",_u,n(e.actual),1)]),t("td",mu,n(e.contribution),1)])}),128)),(g(!0),y(T,null,S(d.value,(e,a)=>{var r;return g(),y("tr",{key:`project-${a}`},[a===0?(g(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u5DE5\u7A0B ",8,Eu)):k("",!0),t("td",Du,n(e.customerType),1),t("td",vu,[A(t("input",{"onUpdate:modelValue":s=>e.plan=s,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,fu),[[C,e.plan]])]),t("td",xu,[t("span",Bu,n(F(parseFloat((r=e.currentMonthValue)==null?void 0:r.replace(/,/g,""))||0)),1)]),t("td",Au,[t("span",Cu,n(e.actual),1)]),t("td",Vu,n(e.contribution),1)])}),128)),t("tr",wu,[u[4]||(u[4]=t("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),t("td",Mu,n(F(B.value.plan)),1),t("td",Tu,n(F(B.value.currentMonthValue)),1),t("td",Su,n(F(B.value.actual)),1),t("td",ku,n(B.value.contribution),1)])])])]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:q,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:P,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),J(K,{"module-id":z(I).MAIN_BUSINESS_NET_PROFIT,period:l.value,remarks:m.value,"onUpdate:remarks":u[1]||(u[1]=e=>m.value=e),suggestions:E.value,"onUpdate:suggestions":u[2]||(u[2]=e=>E.value=e)},null,8,["module-id","period","remarks","suggestions"])]))}});var ju=R(Iu,[["__scopeId","data-v-53b02f64"]]);export{ju as default};
