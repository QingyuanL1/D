import{_ as M,d as P,r as y,B as x,h as j,o as U,c as v,a as r,y as C,A as w,F as V,l as J,t as n,b as q,m as K,G as L,f as B,k as G}from"./index.3bd45b70.js";import{_ as z,M as f,r as H}from"./FormAttachmentAndRemarks.59ca49fe.js";const Q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Y={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},tt=["rowspan"],et={class:"border border-gray-300 px-4 py-2"},rt={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"border border-gray-300 px-4 py-2"},ot=["onUpdate:modelValue"],st={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"text-sm font-medium"},ct={class:"bg-gray-50 font-bold"},it={class:"border border-gray-300 px-4 py-2 text-right"},lt={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},mt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"text-sm font-bold"},bt=P({__name:"StockOrderToIncome",setup(gt){var D;const F=L(),a=y(((D=F.query.period)==null?void 0:D.toString())||new Date().toISOString().slice(0,7)),h={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",initialStockOrderBalance:1104.53,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",initialStockOrderBalance:374.66,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",initialStockOrderBalance:0,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",initialStockOrderBalance:861.89,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",initialStockOrderBalance:0,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",initialStockOrderBalance:0,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0}]},s=y(JSON.parse(JSON.stringify(h))),i=y(""),l=y(""),d=t=>t===0?"0.00":t.toFixed(2),O=t=>t===0?"0.00":t.toFixed(2),R=t=>t===0?!0:s.value.items[t].segmentAttribute!==s.value.items[t-1].segmentAttribute,N=t=>s.value.items.filter(e=>e.segmentAttribute===t).length,m=async t=>{try{const[e]=t.split("-"),u=parseInt(t.split("-")[1]);for(let o of s.value.items){let p=0;for(let k=1;k<u;k++){const A=`${e}-${k.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/tuoyuan-stock-order-to-income/${A}`);if(g.ok){const E=(await g.json()).data.items.find(S=>S.segmentAttribute===o.segmentAttribute&&S.customerAttribute===o.customerAttribute);E&&(p+=E.currentPeriodIncome||0)}}catch(g){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${A}\u7684\u6570\u636E:`,g)}}p+=o.currentPeriodIncome||0,o.currentIncomeCumulative=p,o.stockOrderIncomeRatio=o.initialStockOrderBalance>0?o.currentIncomeCumulative/o.initialStockOrderBalance*100:0}}catch(e){console.error("\u8BA1\u7B97\u5F53\u671F\u8F6C\u6536\u5165\u7D2F\u8BA1\u5931\u8D25:",e)}};x(()=>s.value.items,async t=>{await m(a.value)},{deep:!0});const b=j(()=>{const t={initialStockOrderBalance:0,currentPeriodIncome:0,currentIncomeCumulative:0,stockOrderIncomeRatio:0};return s.value.items.forEach(e=>{t.initialStockOrderBalance+=e.initialStockOrderBalance||0,t.currentPeriodIncome+=e.currentPeriodIncome||0,t.currentIncomeCumulative+=e.currentIncomeCumulative||0}),t.stockOrderIncomeRatio=t.initialStockOrderBalance>0?t.currentIncomeCumulative/t.initialStockOrderBalance*100:0,t}),I=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-stock-order-to-income/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),c();return}const u=await e.json();u.data&&u.data.items&&(s.value.items=u.data.items.map(o=>({segmentAttribute:o.segmentAttribute,customerAttribute:o.customerAttribute,initialStockOrderBalance:Number(o.initialStockOrderBalance)||0,currentPeriodIncome:Number(o.currentPeriodIncome)||0,currentIncomeCumulative:Number(o.currentIncomeCumulative)||0,stockOrderIncomeRatio:Number(o.stockOrderIncomeRatio)||0}))),await m(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),c()}},c=()=>{s.value=JSON.parse(JSON.stringify(h))},_=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${f.STOCK_ORDER_TO_INCOME}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(i.value=u.data.remarks||"",l.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};x(()=>F.query.period,async t=>{t&&(a.value=t.toString(),c(),await I(t.toString()),await m(t.toString()),_(t.toString()))}),x(a,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),c(),await I(t),await m(t),_(t))});const T=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-stock-order-to-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:a.value,data:{items:s.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await H(f.STOCK_ORDER_TO_INCOME,a.value,{items:s.value.items},i.value,l.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},$=()=>{c(),i.value="",l.value=""};return U(async()=>{var e;c();const t=((e=F.query.period)==null?void 0:e.toString())||a.value;await I(t),await m(t),_(t)}),(t,e)=>(B(),v("div",Q,[r("div",W,[e[5]||(e[5]=r("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u2014\u2014\u5B58\u91CF\u8BA2\u5355\u8F6C\u6536\u5165",-1)),r("div",X,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[4]||(e[4]=r("span",{class:"text-xs text-gray-500"},"\u5F53\u671F\u8F6C\u6536\u5165\u7D2F\u8BA1 = \u5F53\u671F\u8F6C\u6536\u5165 + \u4E4B\u524D\u5404\u6708\u7D2F\u8BA1",-1)),C(r("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>a.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[w,a.value]])])]),r("div",Y,[r("table",Z,[e[7]||(e[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u671F\u521D\u5B58\u91CF\u8BA2\u5355\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u8F6C\u6536\u5165"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u8F6C\u6536\u5165\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5B58\u91CF\u8BA2\u5355\u8F6C\u6536\u5165\u6BD4\u7387")])],-1)),r("tbody",null,[(B(!0),v(V,null,J(s.value.items,(u,o)=>(B(),v("tr",{key:`stock-${o}`},[R(o)?(B(),v("td",{key:0,rowspan:N(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},n(u.segmentAttribute),9,tt)):G("",!0),r("td",et,n(u.customerAttribute),1),r("td",rt,n(d(u.initialStockOrderBalance)),1),r("td",ut,[C(r("input",{"onUpdate:modelValue":p=>u.currentPeriodIncome=p,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ot),[[w,u.currentPeriodIncome]])]),r("td",st,n(d(u.currentIncomeCumulative)),1),r("td",at,[r("span",nt,n(O(u.stockOrderIncomeRatio))+"%",1)])]))),128)),r("tr",ct,[e[6]||(e[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",it,n(d(b.value.initialStockOrderBalance)),1),r("td",lt,n(d(b.value.currentPeriodIncome)),1),r("td",dt,n(d(b.value.currentIncomeCumulative)),1),r("td",mt,[r("span",pt,n(O(b.value.stockOrderIncomeRatio))+"%",1)])])])])]),q(z,{"module-id":K(f).STOCK_ORDER_TO_INCOME,period:a.value,remarks:i.value,"onUpdate:remarks":e[1]||(e[1]=u=>i.value=u),suggestions:l.value,"onUpdate:suggestions":e[2]||(e[2]=u=>l.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:T,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:$,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ft=M(bt,[["__scopeId","data-v-b40b7994"]]);export{Ft as default};
