import{_ as $,d as M,r as A,B,c as Y,o as j,b as _,e as r,y as U,A as N,F as q,g as Q,t as l,k as V,h as J,G as L,v as x,f as G}from"./index.71d2d362.js";import{_ as z,M as F,r as H}from"./FormAttachmentAndRemarks.1812c8cf.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Z={class:"overflow-x-auto my-6"},tt={class:"w-full border-collapse border border-gray-300"},et=["rowspan"],rt={class:"border border-gray-300 px-4 py-2"},ut={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"border border-gray-300 px-4 py-2"},st=["onUpdate:modelValue"],ot={class:"border border-gray-300 px-4 py-2 text-right"},lt={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"text-sm font-medium"},it={class:"border border-gray-300 px-4 py-2 text-right"},ct={class:"text-sm font-medium"},yt={class:"bg-gray-50 font-bold"},dt={class:"border border-gray-300 px-4 py-2 text-right"},mt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"border border-gray-300 px-4 py-2 text-right"},bt={class:"border border-gray-300 px-4 py-2 text-right"},gt={class:"text-sm font-bold"},At=M({__name:"MainBusinessCostStructureQuality",setup(_t){var S;const E=L(),n=A(((S=E.query.period)==null?void 0:S.toString())||new Date().toISOString().slice(0,7)),C={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0,cumulativeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0,cumulativeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0,cumulativeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0,cumulativeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0,cumulativeRatio:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0,cumulativeRatio:0}]},s=A(JSON.parse(JSON.stringify(C))),c=A(""),y=A(""),d=t=>t===0?"0.00":t.toFixed(2),v=t=>t===0?"0.00":t.toFixed(2),T=t=>t===0?!0:s.value.items[t].segmentAttribute!==s.value.items[t-1].segmentAttribute,k=t=>s.value.items.filter(e=>e.segmentAttribute===t).length,m=async t=>{try{const[e]=t.split("-"),u=parseInt(t.split("-")[1]);for(let a of s.value.items){let b=0;for(let D=1;D<=u;D++){const P=`${e}-${D.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/tuoyuan-main-business-cost-structure-quality/${P}`);if(g.ok){const w=(await g.json()).data.items.find(R=>R.segmentAttribute===a.segmentAttribute&&R.customerAttribute===a.customerAttribute);w&&(b+=w.currentPeriod||0)}}catch(g){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${P}\u7684\u6570\u636E:`,g)}}a.yearlyAccumulated=b,a.yearlyPlanCompletionRate=a.yearlyPlan>0?a.yearlyAccumulated/a.yearlyPlan*100:0}const o=s.value.items.reduce((a,b)=>a+b.yearlyAccumulated,0);s.value.items.forEach(a=>{a.cumulativeRatio=o>0?a.yearlyAccumulated/o*100:0})}catch(e){console.error("\u8BA1\u7B97\u672C\u5E74\u7D2F\u8BA1\u5931\u8D25:",e)}};B(()=>s.value.items,async t=>{await m(n.value)},{deep:!0});const p=Y(()=>{const t={yearlyPlan:0,currentPeriod:0,yearlyAccumulated:0,yearlyPlanCompletionRate:0};return s.value.items.forEach(e=>{t.yearlyPlan+=e.yearlyPlan||0,t.currentPeriod+=e.currentPeriod||0,t.yearlyAccumulated+=e.yearlyAccumulated||0}),t.yearlyPlanCompletionRate=t.yearlyPlan>0?t.yearlyAccumulated/t.yearlyPlan*100:0,t}),h=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-main-business-cost-structure-quality/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),i();return}const u=await e.json();u.data&&u.data.items&&(s.value.items=u.data.items.map(o=>({segmentAttribute:o.segmentAttribute,customerAttribute:o.customerAttribute,yearlyPlan:Number(o.yearlyPlan)||0,currentPeriod:Number(o.currentPeriod)||0,yearlyAccumulated:Number(o.yearlyAccumulated)||0,yearlyPlanCompletionRate:Number(o.yearlyPlanCompletionRate)||0,cumulativeRatio:Number(o.cumulativeRatio)||0}))),await m(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),i()}},i=()=>{s.value=JSON.parse(JSON.stringify(C))},f=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${F.TUOYUAN_MAIN_BUSINESS_COST_STRUCTURE_QUALITY}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(c.value=u.data.remarks||"",y.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};B(()=>E.query.period,async t=>{t&&(n.value=t.toString(),i(),await h(t.toString()),await m(t.toString()),f(t.toString()))}),B(n,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),i(),await h(t),await m(t),f(t))});const I=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-main-business-cost-structure-quality",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:{items:s.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await H(F.TUOYUAN_MAIN_BUSINESS_COST_STRUCTURE_QUALITY,n.value,{items:s.value.items},c.value,y.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},O=()=>{i(),c.value="",y.value=""};return j(async()=>{var e;i();const t=((e=E.query.period)==null?void 0:e.toString())||n.value;await h(t),await m(t),f(t)}),(t,e)=>(x(),_("div",K,[r("div",W,[e[5]||(e[5]=r("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u53E3\u5F84\u5206\u89E3\uFF09",-1)),r("div",X,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[4]||(e[4]=r("span",{class:"text-xs text-gray-500"},"\u672C\u5E74\u7D2F\u8BA1=\u524D\u9762\u5404\u6708\u5F53\u671F\u503C\u4E4B\u548C",-1)),U(r("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>n.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[N,n.value]])])]),r("div",Z,[r("table",tt,[e[8]||(e[8]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u5E74\u5EA6\u8BA1\u5212"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u5F53\u671F"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u672C\u5E74\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u8BA1\u5212\u6267\u884C\u8FDB\u5EA6"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u5360\u4E3B\u8425\u6536\u5165\u6BD4")])],-1)),r("tbody",null,[(x(!0),_(q,null,Q(s.value.items,(u,o)=>(x(),_("tr",{key:`cost-${o}`},[T(o)?(x(),_("td",{key:0,rowspan:k(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},l(u.segmentAttribute),9,et)):G("",!0),r("td",rt,l(u.customerAttribute),1),r("td",ut,l(d(u.yearlyPlan)),1),r("td",at,[U(r("input",{"onUpdate:modelValue":a=>u.currentPeriod=a,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,st),[[N,u.currentPeriod]])]),r("td",ot,l(d(u.yearlyAccumulated)),1),r("td",lt,[r("span",nt,l(v(u.yearlyPlanCompletionRate))+"%",1)]),r("td",it,[r("span",ct,l(v(u.cumulativeRatio))+"%",1)])]))),128)),r("tr",yt,[e[6]||(e[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",dt,l(d(p.value.yearlyPlan)),1),r("td",mt,l(d(p.value.currentPeriod)),1),r("td",pt,l(d(p.value.yearlyAccumulated)),1),r("td",bt,[r("span",gt,l(v(p.value.yearlyPlanCompletionRate))+"%",1)]),e[7]||(e[7]=r("td",{class:"border border-gray-300 px-4 py-2 text-right"},[r("span",{class:"text-sm font-bold"},"100.00%")],-1))])])])]),V(z,{"module-id":J(F).TUOYUAN_MAIN_BUSINESS_COST_STRUCTURE_QUALITY,period:n.value,remarks:c.value,"onUpdate:remarks":e[1]||(e[1]=u=>c.value=u),suggestions:y.value,"onUpdate:suggestions":e[2]||(e[2]=u=>y.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:O,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var ht=$(At,[["__scopeId","data-v-4e92d89e"]]);export{ht as default};
