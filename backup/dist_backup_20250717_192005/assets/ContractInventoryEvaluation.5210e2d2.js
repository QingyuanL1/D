import{_ as k,d as O,r as g,B as b,c as T,o as I,b as y,e as a,y as B,A as N,F as U,g as V,t as i,l as A,k as $,h as j,G as J,v as p,f as L}from"./index.783577c6.js";import{_ as M,M as F,r as Y}from"./FormAttachmentAndRemarks.2126132d.js";const q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},H={class:"flex justify-between items-center mb-6"},z={class:"flex items-center space-x-4"},G={class:"overflow-x-auto my-6"},K={class:"w-full border-collapse border border-gray-300"},Q=["rowspan"],W={class:"border border-gray-300 px-4 py-2"},X={class:"border border-gray-300 px-4 py-2 text-right"},Z={class:"border border-gray-300 px-4 py-2"},P=["onUpdate:modelValue"],tt={class:"border border-gray-300 px-4 py-2 text-right"},et={class:"bg-gray-50 font-bold"},at={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"border border-gray-300 px-4 py-2 text-right"},rt={class:"border border-gray-300 px-4 py-2 text-right"},nt=O({__name:"ContractInventoryEvaluation",setup(ot){var D;const E=J(),r=g(((D=E.query.period)==null?void 0:D.toString())||new Date().toISOString().slice(0,7)),x={customers:[{customerName:"\u4E00\u5305\u9879\u76EE",yearBeginning:1900,currentEvaluation:0,fluctuationRate:0},{customerName:"\u4E8C\u5305\u9879\u76EE",yearBeginning:500,currentEvaluation:0,fluctuationRate:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearBeginning:500,currentEvaluation:0,fluctuationRate:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearBeginning:180,currentEvaluation:0,fluctuationRate:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",yearBeginning:280,currentEvaluation:0,fluctuationRate:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",yearBeginning:460,currentEvaluation:0,fluctuationRate:0},{customerName:"\u62A2\u4FEE\u9879\u76EE",yearBeginning:0,currentEvaluation:0,fluctuationRate:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",yearBeginning:0,currentEvaluation:0,fluctuationRate:0},{customerName:"\u81EA\u5EFA\u9879\u76EE",yearBeginning:0,currentEvaluation:0,fluctuationRate:0}]},n=g(JSON.parse(JSON.stringify(x))),l=g(""),c=g(""),v=t=>t===0?"0.00":t.toFixed(2),_=t=>t===0?"/":`${t>0?"+":""}${t.toFixed(2)}%`,h=t=>t===0?"text-gray-500":t>0?"text-green-600":"text-red-600",C=t=>{if(t.yearBeginning===0){t.fluctuationRate=0;return}const e=t.currentEvaluation-t.yearBeginning;t.fluctuationRate=e/t.yearBeginning*100};b(()=>n.value.customers,t=>{t.forEach(e=>{C(e)})},{deep:!0});const d=T(()=>{const t={yearBeginning:0,currentEvaluation:0,fluctuationRate:0};if(n.value.customers.forEach(e=>{t.yearBeginning+=e.yearBeginning||0,t.currentEvaluation+=e.currentEvaluation||0}),t.yearBeginning>0){const e=t.currentEvaluation-t.yearBeginning;t.fluctuationRate=e/t.yearBeginning*100}return t}),s=()=>{n.value=JSON.parse(JSON.stringify(x))},m=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/nanhua-contract-inventory-evaluation/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),s();return}const u=await e.json();u.data&&u.data.customers&&(n.value.customers=u.data.customers.map(o=>({customerName:o.customerName,yearBeginning:Number(o.yearBeginning)||0,currentEvaluation:Number(o.currentEvaluation)||0,fluctuationRate:Number(o.fluctuationRate)||0})))}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),s()}},f=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${F.NANHUA_CONTRACT_INVENTORY_EVALUATION}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(l.value=u.data.remarks||"",c.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};b(()=>E.query.period,async t=>{t&&(r.value=t.toString(),s(),await m(t.toString()),f(t.toString()))}),b(r,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),s(),await m(t),f(t))});const R=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-contract-inventory-evaluation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:r.value,data:n.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Y(F.NANHUA_CONTRACT_INVENTORY_EVALUATION,r.value,n.value,l.value,c.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},w=()=>{s(),l.value="",c.value=""};return I(async()=>{var e;s();const t=((e=E.query.period)==null?void 0:e.toString())||r.value;await m(t),f(t)}),(t,e)=>(p(),y("div",q,[a("div",H,[e[4]||(e[4]=a("h1",{class:"text-2xl font-bold"},"\u5728\u5EFA\u5DE5\u7A0B\uFF08\u5408\u540C\u5B58\u91CF\uFF09",-1)),a("div",z,[e[3]||(e[3]=a("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),B(a("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>r.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[N,r.value]])])]),a("div",G,[a("table",K,[e[6]||(e[6]=a("thead",{class:"sticky top-0 bg-white"},[a("tr",{class:"bg-gray-50"},[a("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u8BC4\u4F30\u6570\u636E"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u8BC4\u4F30\u6570\u636E"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),a("tbody",null,[(p(!0),y(U,null,V(n.value.customers,(u,o)=>(p(),y("tr",{key:`customer-${o}`},[o===0?(p(),y("td",{key:0,rowspan:n.value.customers.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Q)):L("",!0),a("td",W,i(u.customerName),1),a("td",X,i(v(u.yearBeginning)),1),a("td",Z,[B(a("input",{"onUpdate:modelValue":S=>u.currentEvaluation=S,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,P),[[N,u.currentEvaluation]])]),a("td",tt,[a("span",{class:A(h(u.fluctuationRate))},i(_(u.fluctuationRate)),3)])]))),128)),a("tr",et,[e[5]||(e[5]=a("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),a("td",at,i(v(d.value.yearBeginning)),1),a("td",ut,i(v(d.value.currentEvaluation)),1),a("td",rt,[a("span",{class:A([h(d.value.fluctuationRate),"font-bold"])},i(_(d.value.fluctuationRate)),3)])])])])]),$(M,{"module-id":j(F).NANHUA_CONTRACT_INVENTORY_EVALUATION,period:r.value,remarks:l.value,"onUpdate:remarks":e[1]||(e[1]=u=>l.value=u),suggestions:c.value,"onUpdate:suggestions":e[2]||(e[2]=u=>c.value=u)},null,8,["module-id","period","remarks","suggestions"]),a("div",{class:"mt-4 flex justify-end space-x-4"},[a("button",{onClick:R,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),a("button",{onClick:w,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var lt=k(nt,[["__scopeId","data-v-49532eb4"]]);export{lt as default};
