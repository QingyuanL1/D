import{_ as $,d as T,r as m,B as E,h as j,o as J,c as y,a as r,y as f,A as D,F as L,l as M,t as a,b as q,m as Y,G,f as B,k as z}from"./index.9e7a26fd.js";import{_ as H,M as F,r as K}from"./FormAttachmentAndRemarks.aafbd6d2.js";const Q={class:"max-w-[1800px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Z={class:"overflow-x-auto my-6"},P={class:"w-full border-collapse border border-gray-300"},ee=["rowspan"],te={class:"border border-gray-300 px-4 py-2"},re={class:"border border-gray-300 px-4 py-2 text-right"},ue={class:"border border-gray-300 px-4 py-2"},ne=["onUpdate:modelValue"],ae={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"border border-gray-300 px-4 py-2"},ce=["onUpdate:modelValue"],se={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"bg-gray-50 font-bold"},de={class:"border border-gray-300 px-4 py-2 text-right"},ge={class:"border border-gray-300 px-4 py-2 text-right"},ve={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"border border-gray-300 px-4 py-2 text-right"},pe={class:"border border-gray-300 px-4 py-2 text-right"},me={class:"border border-gray-300 px-4 py-2 text-right"},ye=T({__name:"AccountsReceivable",setup(Be){var w;const h=G(),s=m(((w=h.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),I={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0}]},o=m(JSON.parse(JSON.stringify(I))),g=m(""),v=m(""),c=e=>e===0?"0.00":e.toFixed(2),k=e=>e===0?!0:o.value.items[e].segmentAttribute!==o.value.items[e-1].segmentAttribute,U=e=>o.value.items.filter(t=>t.segmentAttribute===e).length,b=async e=>{try{const[t]=e.split("-"),u=parseInt(e.split("-")[1]);for(let n of o.value.items){let d=0,S=0;for(let A=1;A<=u;A++){const R=`${t}-${A.toString().padStart(2,"0")}`;try{const p=await fetch(`http://47.111.95.19:3000/tuoyuan-accounts-receivable/${R}`);if(p.ok){const C=(await p.json()).data.items.find(N=>N.segmentAttribute===n.segmentAttribute&&N.customerAttribute===n.customerAttribute);C&&(d+=C.currentInvoicing||0,S+=C.currentCollection||0)}}catch(p){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${R}\u7684\u6570\u636E:`,p)}}n.cumulativeInvoicing=d,n.cumulativeCollection=S,n.currentReceivableBalance=n.yearBeginningBalance+n.cumulativeInvoicing-n.cumulativeCollection}}catch(t){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",t)}};E(()=>o.value.items,async e=>{await b(s.value)},{deep:!0});const i=j(()=>{const e={yearBeginningBalance:0,currentInvoicing:0,cumulativeInvoicing:0,currentCollection:0,cumulativeCollection:0,currentReceivableBalance:0};return o.value.items.forEach(t=>{e.yearBeginningBalance+=t.yearBeginningBalance||0,e.currentInvoicing+=t.currentInvoicing||0,e.cumulativeInvoicing+=t.cumulativeInvoicing||0,e.currentCollection+=t.currentCollection||0,e.cumulativeCollection+=t.cumulativeCollection||0,e.currentReceivableBalance+=t.currentReceivableBalance||0}),e}),x=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/tuoyuan-accounts-receivable/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),l();return}const u=await t.json();u.data&&u.data.items&&(o.value.items=u.data.items.map(n=>({segmentAttribute:n.segmentAttribute,customerAttribute:n.customerAttribute,yearBeginningBalance:Number(n.yearBeginningBalance)||0,currentInvoicing:Number(n.currentInvoicing)||0,cumulativeInvoicing:Number(n.cumulativeInvoicing)||0,currentCollection:Number(n.currentCollection)||0,cumulativeCollection:Number(n.cumulativeCollection)||0,currentReceivableBalance:Number(n.currentReceivableBalance)||0}))),await b(e)}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),l()}},l=()=>{o.value=JSON.parse(JSON.stringify(I))},_=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${F.TUOYUAN_ACCOUNTS_RECEIVABLE}/${e}`);if(t.ok){const u=await t.json();u.success&&u.data&&(g.value=u.data.remarks||"",v.value=u.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};E(()=>h.query.period,async e=>{e&&(s.value=e.toString(),l(),await x(e.toString()),await b(e.toString()),_(e.toString()))}),E(s,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),l(),await x(e),await b(e),_(e))});const O=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-accounts-receivable",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:{items:o.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await K(F.TUOYUAN_ACCOUNTS_RECEIVABLE,s.value,{items:o.value.items},g.value,v.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},V=()=>{l(),g.value="",v.value=""};return J(async()=>{var t;l();const e=((t=h.query.period)==null?void 0:t.toString())||s.value;await x(e),await b(e),_(e)}),(e,t)=>(B(),y("div",Q,[r("div",W,[t[5]||(t[5]=r("h1",{class:"text-2xl font-bold"},"\u5E94\u6536\u8D26\u6B3E\u60C5\u51B5",-1)),r("div",X,[t[3]||(t[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),t[4]||(t[4]=r("span",{class:"text-xs text-gray-500"},"\u7D2F\u8BA1=\u524D\u9762\u5404\u6708\u5F53\u671F\u503C\u4E4B\u548C",-1)),f(r("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>s.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[D,s.value]])])]),r("div",Z,[r("table",P,[t[7]||(t[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-20"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5E74\u521D\u5E94\u6536\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5F53\u671F\u5F00\u7968"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u7D2F\u8BA1\u5F00\u7968"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5F53\u671F\u6536\u6B3E"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u7D2F\u8BA1\u6536\u6B3E"),r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u5F53\u671F\u5E94\u6536\u4F59\u989D")])],-1)),r("tbody",null,[(B(!0),y(L,null,M(o.value.items,(u,n)=>(B(),y("tr",{key:`accounts-${n}`},[k(n)?(B(),y("td",{key:0,rowspan:U(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},a(u.segmentAttribute),9,ee)):z("",!0),r("td",te,a(u.customerAttribute),1),r("td",re,a(c(u.yearBeginningBalance)),1),r("td",ue,[f(r("input",{"onUpdate:modelValue":d=>u.currentInvoicing=d,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",placeholder:"0.00"},null,8,ne),[[D,u.currentInvoicing]])]),r("td",ae,a(c(u.cumulativeInvoicing)),1),r("td",oe,[f(r("input",{"onUpdate:modelValue":d=>u.currentCollection=d,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",placeholder:"0.00"},null,8,ce),[[D,u.currentCollection]])]),r("td",se,a(c(u.cumulativeCollection)),1),r("td",ie,a(c(u.currentReceivableBalance)),1)]))),128)),r("tr",le,[t[6]||(t[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",de,a(c(i.value.yearBeginningBalance)),1),r("td",ge,a(c(i.value.currentInvoicing)),1),r("td",ve,a(c(i.value.cumulativeInvoicing)),1),r("td",be,a(c(i.value.currentCollection)),1),r("td",pe,a(c(i.value.cumulativeCollection)),1),r("td",me,a(c(i.value.currentReceivableBalance)),1)])])])]),q(H,{"module-id":Y(F).TUOYUAN_ACCOUNTS_RECEIVABLE,period:s.value,remarks:g.value,"onUpdate:remarks":t[1]||(t[1]=u=>g.value=u),suggestions:v.value,"onUpdate:suggestions":t[2]||(t[2]=u=>v.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:O,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:V,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ae=$(ye,[["__scopeId","data-v-20424a3c"]]);export{Ae as default};
