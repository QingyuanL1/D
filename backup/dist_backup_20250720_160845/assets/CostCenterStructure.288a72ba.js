import{_ as M,d as O,r as D,c as V,B as S,o as j,b as y,e as t,y as N,A as C,F as w,g as P,t as c,k as q,h as J,G as H,v as p,f as k}from"./index.dd551b11.js";import{_ as L,M as A,r as G}from"./FormAttachmentAndRemarks.326374c9.js";const z={class:"max-w-[1600px] mx-auto bg-white rounded-lg shadow-lg p-6"},K={class:"flex justify-between items-center mb-6"},Q={class:"flex items-center space-x-4"},W={class:"overflow-x-auto my-6"},X={class:"w-full border-collapse border border-gray-300"},Y=["rowspan"],Z={class:"border border-gray-300 px-4 py-2"},ee={class:"border border-gray-300 px-4 py-2 text-right"},te={class:"border border-gray-300 px-4 py-2"},re=["onUpdate:modelValue"],ne={class:"border border-gray-300 px-4 py-2 text-right"},ue={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"text-sm font-medium"},ae=["rowspan"],ce={class:"border border-gray-300 px-4 py-2"},se={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"border border-gray-300 px-4 py-2"},de=["onUpdate:modelValue"],me={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"border border-gray-300 px-4 py-2 text-right"},ye={class:"text-sm font-medium"},pe={class:"bg-gray-50 font-bold"},be={class:"border border-gray-300 px-4 py-2 text-right"},ge={class:"border border-gray-300 px-4 py-2 text-right"},Ie={class:"border border-gray-300 px-4 py-2 text-right"},he={class:"border border-gray-300 px-4 py-2 text-right"},_e={class:"text-sm font-bold"},xe=O({__name:"CostCenterStructure",setup(fe){var R;const b=H(),s=D(((R=b.query.period)==null?void 0:R.toString())||new Date().toISOString().slice(0,7)),B={engineering:[{customerName:"\u4E00\u5305\u9879\u76EE",yearlyPlannedIncome:284.22,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u4E8C\u5305\u9879\u76EE",yearlyPlannedIncome:106.53,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearlyPlannedIncome:41.41,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearlyPlannedIncome:17.07,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",yearlyPlannedIncome:157.09,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",yearlyPlannedIncome:12.88,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u6295\u6807\u9879\u76EE",yearlyPlannedIncome:41.77,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",yearlyPlannedIncome:68.06,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u81EA\u5EFA\u9879\u76EE",yearlyPlannedIncome:0,currentIncome:0,accumulatedIncome:0,contributionRate:0}],nonMainBusiness:[{customerName:"\u5B58\u8D27\u76D8\u76C8",yearlyPlannedIncome:.47,currentIncome:0,accumulatedIncome:0,contributionRate:0},{customerName:"\u5229\u606F\u6536\u5165",yearlyPlannedIncome:5.91,currentIncome:0,accumulatedIncome:0,contributionRate:0}]},a=D(JSON.parse(JSON.stringify(B))),g=D(""),I=D(""),l=r=>r===0?"0.00":r.toFixed(2),x=async r=>{try{const[e,n]=r.split("-"),u=parseInt(n);for(let o of a.value.engineering){let m=0;for(let i=1;i<=u;i++){const h=`${e}-${i.toString().padStart(2,"0")}`;try{const d=await fetch(`http://47.111.95.19:3000/nanhua-cost-center-structure/${h}`);if(d.ok){const _=(await d.json()).data.engineering.find(v=>v.customerName===o.customerName);_&&(m+=_.currentIncome||0)}}catch(d){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${h}\u7684\u6570\u636E:`,d)}}o.accumulatedIncome=m,o.contributionRate=o.yearlyPlannedIncome>0?m/o.yearlyPlannedIncome*100:0}for(let o of a.value.nonMainBusiness){let m=0;for(let i=1;i<=u;i++){const h=`${e}-${i.toString().padStart(2,"0")}`;try{const d=await fetch(`http://47.111.95.19:3000/nanhua-cost-center-structure/${h}`);if(d.ok){const _=(await d.json()).data.nonMainBusiness.find(v=>v.customerName===o.customerName);_&&(m+=_.currentIncome||0)}}catch(d){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${h}\u7684\u6570\u636E:`,d)}}o.accumulatedIncome=m,o.contributionRate=o.yearlyPlannedIncome>0?m/o.yearlyPlannedIncome*100:0}}catch(e){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u6536\u5165\u5931\u8D25:",e)}},f=V(()=>{const r={yearlyPlannedIncome:0,currentIncome:0,accumulatedIncome:0,contributionRate:0};return a.value.engineering.forEach(e=>{r.yearlyPlannedIncome+=e.yearlyPlannedIncome||0,r.currentIncome+=e.currentIncome||0,r.accumulatedIncome+=e.accumulatedIncome||0}),a.value.nonMainBusiness.forEach(e=>{r.yearlyPlannedIncome+=e.yearlyPlannedIncome||0,r.currentIncome+=e.currentIncome||0,r.accumulatedIncome+=e.accumulatedIncome||0}),r.contributionRate=r.yearlyPlannedIncome>0?r.accumulatedIncome/r.yearlyPlannedIncome*100:0,r}),E=async r=>{try{const e=await fetch(`http://47.111.95.19:3000/nanhua-cost-center-structure/${r}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");return}const n=await e.json();n.data&&(n.data.engineering&&(a.value.engineering=n.data.engineering.map(u=>({customerName:u.customerName,yearlyPlannedIncome:Number(u.yearlyPlannedIncome)||0,currentIncome:Number(u.currentIncome)||0,accumulatedIncome:Number(u.accumulatedIncome)||0,contributionRate:Number(u.contributionRate)||0}))),n.data.nonMainBusiness&&(a.value.nonMainBusiness=n.data.nonMainBusiness.map(u=>({customerName:u.customerName,yearlyPlannedIncome:Number(u.yearlyPlannedIncome)||0,currentIncome:Number(u.currentIncome)||0,accumulatedIncome:Number(u.accumulatedIncome)||0,contributionRate:Number(u.contributionRate)||0}))))}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e)}},F=async r=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${A.NANHUA_COST_CENTER_STRUCTURE}/${r}`);if(e.ok){const n=await e.json();n.success&&n.data&&(g.value=n.data.remarks||"",I.value=n.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};S(()=>b.query.period,async r=>{r&&(s.value=r.toString(),await E(r.toString()),await x(r.toString()),F(r.toString()))}),S(s,async(r,e)=>{r&&r!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${r}`),await E(r),await x(r),F(r))});const U=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-cost-center-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:a.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(A.NANHUA_COST_CENTER_STRUCTURE,s.value,a.value,g.value,I.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(r){console.error("\u4FDD\u5B58\u5931\u8D25:",r),alert("\u4FDD\u5B58\u5931\u8D25")}},$=()=>{a.value=JSON.parse(JSON.stringify(B)),g.value="",I.value=""};return j(async()=>{b.query.period?(await E(b.query.period.toString()),await x(b.query.period.toString()),F(b.query.period.toString())):(await E(s.value),await x(s.value),F(s.value))}),(r,e)=>(p(),y("div",z,[t("div",K,[e[4]||(e[4]=t("h1",{class:"text-2xl font-bold"},"\u6210\u672C\u4E2D\u5FC3\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),t("div",Q,[e[3]||(e[3]=t("span",{class:"text-sm text-gray-600"},"\u5BF9\u5E94\u5F53\u671F\u6536\u5165\uFF1A\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),N(t("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>s.value=n),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,s.value]])])]),t("div",W,[t("table",X,[e[6]||(e[6]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u8BA1\u5212\u6536\u5165"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u8BA1\u5165\u635F\u76CA"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u8BA1\u5165\u635F\u76CA"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5206\u644A\u635F\u76CA\u5360\u6BD4")])],-1)),t("tbody",null,[(p(!0),y(w,null,P(a.value.engineering,(n,u)=>(p(),y("tr",{key:`engineering-${u}`},[u===0?(p(),y("td",{key:0,rowspan:a.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Y)):k("",!0),t("td",Z,c(n.customerName),1),t("td",ee,c(l(n.yearlyPlannedIncome)),1),t("td",te,[N(t("input",{"onUpdate:modelValue":o=>n.currentIncome=o,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,re),[[C,n.currentIncome]])]),t("td",ne,c(l(n.accumulatedIncome)),1),t("td",ue,[t("span",oe,c(l(n.contributionRate))+"%",1)])]))),128)),(p(!0),y(w,null,P(a.value.nonMainBusiness,(n,u)=>(p(),y("tr",{key:`nonmain-${u}`},[u===0?(p(),y("td",{key:0,rowspan:a.value.nonMainBusiness.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u975E\u4E3B\u8425\u4E1A\u52A1 ",8,ae)):k("",!0),t("td",ce,c(n.customerName),1),t("td",se,c(l(n.yearlyPlannedIncome)),1),t("td",le,[N(t("input",{"onUpdate:modelValue":o=>n.currentIncome=o,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,de),[[C,n.currentIncome]])]),t("td",me,c(l(n.accumulatedIncome)),1),t("td",ie,[t("span",ye,c(l(n.contributionRate))+"%",1)])]))),128)),t("tr",pe,[e[5]||(e[5]=t("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),t("td",be,c(l(f.value.yearlyPlannedIncome)),1),t("td",ge,c(l(f.value.currentIncome)),1),t("td",Ie,c(l(f.value.accumulatedIncome)),1),t("td",he,[t("span",_e,c(l(f.value.contributionRate))+"%",1)])])])])]),q(L,{"module-id":J(A).NANHUA_COST_CENTER_STRUCTURE,period:s.value,remarks:g.value,"onUpdate:remarks":e[1]||(e[1]=n=>g.value=n),suggestions:I.value,"onUpdate:suggestions":e[2]||(e[2]=n=>I.value=n)},null,8,["module-id","period","remarks","suggestions"]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:U,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:$,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var De=M(xe,[["__scopeId","data-v-0011f366"]]);export{De as default};
