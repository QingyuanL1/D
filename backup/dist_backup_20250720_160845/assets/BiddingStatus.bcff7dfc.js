import{_ as $,d as j,r as h,B as x,c as M,o as G,b as c,e as n,y as m,A as b,F as R,g as S,t as a,k as O,h as L,G as J,v as d,f as k}from"./index.dd551b11.js";import{_ as Y,l as z,M as f,r as H}from"./FormAttachmentAndRemarks.326374c9.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Z={class:"overflow-x-auto my-6"},P={class:"w-full border-collapse border border-gray-300"},uu=["rowspan"],eu={class:"border border-gray-300 px-4 py-2"},tu={class:"border border-gray-300 px-4 py-2"},nu=["onUpdate:modelValue"],ou={class:"border border-gray-300 px-4 py-2"},ru=["onUpdate:modelValue"],su={class:"border border-gray-300 px-4 py-2 text-right"},au={class:"font-medium"},iu={class:"border border-gray-300 px-4 py-2 text-right"},cu=["rowspan"],du={class:"border border-gray-300 px-4 py-2"},lu={class:"border border-gray-300 px-4 py-2"},pu=["onUpdate:modelValue"],mu={class:"border border-gray-300 px-4 py-2"},bu=["onUpdate:modelValue"],gu={class:"border border-gray-300 px-4 py-2 text-right"},yu={class:"font-medium"},Au={class:"border border-gray-300 px-4 py-2 text-right"},Fu=["rowspan"],wu={class:"border border-gray-300 px-4 py-2"},hu={class:"border border-gray-300 px-4 py-2"},_u=["onUpdate:modelValue"],Du={class:"border border-gray-300 px-4 py-2"},vu=["onUpdate:modelValue"],xu={class:"border border-gray-300 px-4 py-2 text-right"},fu={class:"font-medium"},Eu={class:"border border-gray-300 px-4 py-2 text-right"},Bu={class:"bg-gray-50 font-bold"},Wu={class:"border border-gray-300 px-4 py-2 text-right"},Cu={class:"border border-gray-300 px-4 py-2 text-right"},Ru={class:"border border-gray-300 px-4 py-2 text-right"},Su={class:"border border-gray-300 px-4 py-2 text-right"},ku=j({__name:"BiddingStatus",setup(qu){var N;const _=J(),i=h(((N=_.query.period)==null?void 0:N.toString())||new Date().toISOString().slice(0,7)),g=()=>({equipment:[{customer:"\u4E0A\u6D77",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u56FD\u7F51",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u6C5F\u82CF",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u8F93\u914D\u7535\u5185\u914D",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u897F\u95E8\u5B50",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u540C\u4E1A",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u7528\u6237",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u5176\u5B83",bidAmount:0,currentWin:0,winAmount:0,winRate:0}],components:[{customer:"\u7528\u6237",bidAmount:0,currentWin:0,winAmount:0,winRate:0}],engineering:[{customer:"\u4E00\u5305",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u4E8C\u5305",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u57DF\u5185\u5408\u4F5C",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u57DF\u5916\u5408\u4F5C",bidAmount:0,currentWin:0,winAmount:0,winRate:0},{customer:"\u5176\u5B83",bidAmount:0,currentWin:0,winAmount:0,winRate:0}]}),V=(u,t)=>(!t||typeof t!="object"||(t.equipment&&Array.isArray(t.equipment)&&(u.equipment=u.equipment.map(e=>{const r=t.equipment.find(s=>s.customer===e.customer);return r?{customer:e.customer,bidAmount:Number(r.bidAmount)||0,currentWin:Number(r.currentWin)||0,winAmount:0,winRate:0}:e})),t.components&&Array.isArray(t.components)&&(u.components=u.components.map(e=>{const r=t.components.find(s=>s.customer===e.customer);return r?{customer:e.customer,bidAmount:Number(r.bidAmount)||0,currentWin:Number(r.currentWin)||0,winAmount:0,winRate:0}:e})),t.engineering&&Array.isArray(t.engineering)&&(u.engineering=u.engineering.map(e=>{const r=t.engineering.find(s=>s.customer===e.customer);return r?{customer:e.customer,bidAmount:Number(r.bidAmount)||0,currentWin:Number(r.currentWin)||0,winAmount:0,winRate:0}:e}))),u),y=u=>(Number(u)||0).toLocaleString(),q=h([]),U=async u=>{try{const t=[],e=u.substring(0,4),r=parseInt(u.substring(5,7));for(let s=1;s<r;s++){const l=`${e}-${s.toString().padStart(2,"0")}`;try{const p=await fetch(`http://47.111.95.19:3000/bidding-status/${l}`);if(p.ok){const w=await p.json();w.success&&w.data&&t.push({period:l,data:w.data})}}catch(p){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${l}:`,p)}}q.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},E=(u,t)=>{let e=0;for(const l of q.value)if(l.data[u]){const p=l.data[u].find(w=>w.customer===t);p&&p.currentWin&&(e+=parseFloat(p.currentWin.toString())||0)}let r=[];u==="equipment"?r=o.value.equipment:u==="components"?r=o.value.components:u==="engineering"&&(r=o.value.engineering);const s=r.find(l=>l.customer===t);return s&&s.currentWin&&(e+=parseFloat(s.currentWin.toString())||0),e},B=()=>{o.value.equipment.forEach(u=>{const t=E("equipment",u.customer);u.winAmount=t}),o.value.components.forEach(u=>{const t=E("components",u.customer);u.winAmount=t}),o.value.engineering.forEach(u=>{const t=E("engineering",u.customer);u.winAmount=t})},o=h(g()),A=h(""),F=h(""),W=(u,t)=>t===0?0:parseFloat((u/t*100).toFixed(2));x(o,()=>{o.value.equipment.forEach(u=>{u.winRate=W(u.winAmount,u.bidAmount)}),o.value.components.forEach(u=>{u.winRate=W(u.winAmount,u.bidAmount)}),o.value.engineering.forEach(u=>{u.winRate=W(u.winAmount,u.bidAmount)})},{deep:!0});const D=M(()=>{const u={bidAmount:0,currentWin:0,winAmount:0,winRate:0};return[...o.value.equipment,...o.value.components,...o.value.engineering].forEach(e=>{u.bidAmount+=e.bidAmount||0,u.currentWin+=e.currentWin||0,u.winAmount+=e.winAmount||0}),u.winRate=u.bidAmount>0?u.winAmount/u.bidAmount*100:0,u}),v=async u=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u62DB\u6295\u6807\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const t=await fetch(`http://47.111.95.19:3000/bidding-status/${u}`);if(!t.ok){if(t.status===404){console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),o.value=g(),await U(u),B();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const e=await t.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",e),e.success&&e.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const r=g(),s=V(r,e.data);o.value=s,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",o.value)}else console.log("\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),o.value=g();await U(u),B()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),o.value=g()}},C=async()=>{const{remarks:u,suggestions:t}=await z(f.BIDDING_STATUS,i.value);A.value=u,F.value=t};x(()=>[o.value.equipment.map(u=>u.currentWin),o.value.components.map(u=>u.currentWin),o.value.engineering.map(u=>u.currentWin)],()=>{B()},{deep:!0}),x(()=>_.query.period,u=>{u&&(i.value=u.toString(),v(u.toString()),C())}),x(i,u=>{v(u),C()});const I=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u62DB\u6295\u6807\u6570\u636E ==="),console.log("\u671F\u95F4:",i.value),console.log("\u6A21\u5757ID:",f.BIDDING_STATUS),console.log("\u8868\u5355\u6570\u636E:",o.value),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const u=await fetch("http://47.111.95.19:3000/bidding-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:i.value,data:o.value})});if(!u.ok){const r=await u.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",r),new Error("\u4FDD\u5B58\u5931\u8D25")}const t=await u.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",t),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const e=await H(f.BIDDING_STATUS,i.value,o.value,A.value,F.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",e),e?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(u){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",u),alert("\u4FDD\u5B58\u5931\u8D25: "+(u instanceof Error?u.message:"\u672A\u77E5\u9519\u8BEF"))}},T=()=>{o.value=g(),A.value="",F.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return G(()=>{console.log("\u62DB\u6295\u6807\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",i.value),_.query.period?v(_.query.period.toString()):v(i.value),C()}),(u,t)=>(d(),c("div",K,[n("div",Q,[t[3]||(t[3]=n("h1",{class:"text-2xl font-bold"},"\u62DB\u6295\u6807\u60C5\u51B5",-1)),n("div",X,[m(n("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>i.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[b,i.value]])])]),n("div",Z,[n("table",P,[t[5]||(t[5]=n("thead",{class:"sticky top-0 bg-white"},[n("tr",{class:"bg-gray-50"},[n("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),n("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),n("th",{class:"border border-gray-300 px-4 py-2"},"\u96C6\u91C7\u6295\u6807"),n("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u4E2D\u6807"),n("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u4E2D\u6807"),n("th",{class:"border border-gray-300 px-4 py-2"},"\u4E2D\u6807\u7387")])],-1)),n("tbody",null,[(d(!0),c(R,null,S(o.value.equipment,(e,r)=>(d(),c("tr",{key:`equipment-${r}`},[r===0?(d(),c("td",{key:0,rowspan:o.value.equipment.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u8BBE\u5907 ",8,uu)):k("",!0),n("td",eu,a(e.customer),1),n("td",tu,[m(n("input",{"onUpdate:modelValue":s=>e.bidAmount=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,nu),[[b,e.bidAmount,void 0,{number:!0}]])]),n("td",ou,[m(n("input",{"onUpdate:modelValue":s=>e.currentWin=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ru),[[b,e.currentWin,void 0,{number:!0}]])]),n("td",su,[n("span",au,a(y(e.winAmount)),1)]),n("td",iu,a(e.winRate.toFixed(2))+"% ",1)]))),128)),(d(!0),c(R,null,S(o.value.components,(e,r)=>(d(),c("tr",{key:`components-${r}`},[r===0?(d(),c("td",{key:0,rowspan:o.value.components.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5143\u4EF6 ",8,cu)):k("",!0),n("td",du,a(e.customer),1),n("td",lu,[m(n("input",{"onUpdate:modelValue":s=>e.bidAmount=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,pu),[[b,e.bidAmount,void 0,{number:!0}]])]),n("td",mu,[m(n("input",{"onUpdate:modelValue":s=>e.currentWin=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,bu),[[b,e.currentWin,void 0,{number:!0}]])]),n("td",gu,[n("span",yu,a(y(e.winAmount)),1)]),n("td",Au,a(e.winRate.toFixed(2))+"% ",1)]))),128)),(d(!0),c(R,null,S(o.value.engineering,(e,r)=>(d(),c("tr",{key:`engineering-${r}`},[r===0?(d(),c("td",{key:0,rowspan:o.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Fu)):k("",!0),n("td",wu,a(e.customer),1),n("td",hu,[m(n("input",{"onUpdate:modelValue":s=>e.bidAmount=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,_u),[[b,e.bidAmount,void 0,{number:!0}]])]),n("td",Du,[m(n("input",{"onUpdate:modelValue":s=>e.currentWin=s,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,vu),[[b,e.currentWin,void 0,{number:!0}]])]),n("td",xu,[n("span",fu,a(y(e.winAmount)),1)]),n("td",Eu,a(e.winRate.toFixed(2))+"% ",1)]))),128)),n("tr",Bu,[t[4]||(t[4]=n("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),n("td",Wu,a(y(D.value.bidAmount)),1),n("td",Cu,a(y(D.value.currentWin)),1),n("td",Ru,a(y(D.value.winAmount)),1),n("td",Su,a(D.value.winRate.toFixed(2))+"% ",1)])])])]),O(Y,{"module-id":L(f).BIDDING_STATUS,period:i.value,remarks:A.value,"onUpdate:remarks":t[1]||(t[1]=e=>A.value=e),suggestions:F.value,"onUpdate:suggestions":t[2]||(t[2]=e=>F.value=e)},null,8,["module-id","period","remarks","suggestions"]),n("div",{class:"mt-4 flex justify-end space-x-4"},[n("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),n("button",{onClick:T,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Vu=$(ku,[["__scopeId","data-v-5d64595c"]]);export{Vu as default};
