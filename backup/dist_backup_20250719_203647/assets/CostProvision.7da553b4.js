import{_ as O,d as $,r as b,c as U,B as I,o as V,b as _,e as t,y as S,A as w,F as j,g as q,t as n,k as T,h as J,G as M,v as x,f as H}from"./index.442dcde9.js";import{_ as L,M as D,r as G}from"./FormAttachmentAndRemarks.09d8028c.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},K={class:"flex justify-between items-center mb-6"},Q={class:"flex items-center space-x-4"},W={class:"overflow-x-auto my-6"},X={class:"w-full border-collapse border border-gray-300"},Y=["rowspan"],Z={class:"border border-gray-300 px-4 py-2"},P={class:"border border-gray-300 px-4 py-2 text-right"},ee={class:"border border-gray-300 px-4 py-2"},te=["onUpdate:modelValue"],ae={class:"border border-gray-300 px-4 py-2 text-right"},re={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"text-sm font-medium"},se={class:"bg-gray-50 font-bold"},ue={class:"border border-gray-300 px-4 py-2 text-right"},ne={class:"border border-gray-300 px-4 py-2 text-right"},ce={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"text-sm font-bold"},de=$({__name:"CostProvision",setup(ye){var E;const l=M(),o=b(((E=l.query.period)==null?void 0:E.toString())||new Date().toISOString().slice(0,7)),f={customers:[{customerName:"\u4E00\u5305\u9879\u76EE",yearBeginBalance:1164.76,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u4E8C\u5305\u9879\u76EE",yearBeginBalance:426.9,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearBeginBalance:474.41,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearBeginBalance:661.56,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",yearBeginBalance:730.12,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",yearBeginBalance:93.99,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u62A2\u4FEE\u9879\u76EE",yearBeginBalance:0,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",yearBeginBalance:242.66,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u6D3E\u9063",yearBeginBalance:19.5,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0},{customerName:"\u81EA\u5EFA",yearBeginBalance:0,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0}]},u=b(JSON.parse(JSON.stringify(f))),i=b(""),d=b(""),c=a=>a===0?"0.00":a.toFixed(2),y=async a=>{try{const[e,r]=a.split("-"),s=parseInt(r);for(let h of u.value.customers){let F=0;for(let B=1;B<=s;B++){const A=`${e}-${B.toString().padStart(2,"0")}`;try{const v=await fetch(`http://47.111.95.19:3000/nanhua-cost-provision/${A}`);if(v.ok){const N=(await v.json()).data.customers.find(k=>k.customerName===h.customerName);N&&(F+=N.monthlyIncrease||0)}}catch(v){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${A}\u7684\u6570\u636E:`,v)}}h.yearlyAccumulated=F}}catch(e){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u6570\u636E\u5931\u8D25:",e)}},p=U(()=>{const a={yearBeginBalance:0,monthlyIncrease:0,yearlyAccumulated:0,provisionRate:0};return u.value.customers.forEach(e=>{a.yearBeginBalance+=e.yearBeginBalance||0,a.monthlyIncrease+=e.monthlyIncrease||0,a.yearlyAccumulated+=e.yearlyAccumulated||0,a.provisionRate+=e.provisionRate||0}),a}),m=async a=>{try{const e=await fetch(`http://47.111.95.19:3000/nanhua-cost-provision/${a}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");return}const r=await e.json();r.data&&r.data.customers&&(u.value.customers=r.data.customers.map(s=>({customerName:s.customerName,yearBeginBalance:Number(s.yearBeginBalance)||0,monthlyIncrease:Number(s.monthlyIncrease)||0,yearlyAccumulated:Number(s.yearlyAccumulated)||0,provisionRate:Number(s.provisionRate)||0})))}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e)}},g=async a=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${D.NANHUA_COST_PROVISION}/${a}`);if(e.ok){const r=await e.json();r.success&&r.data&&(i.value=r.data.remarks||"",d.value=r.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};I(()=>l.query.period,async a=>{a&&(o.value=a.toString(),await m(a.toString()),await y(a.toString()),g(a.toString()))}),I(o,async(a,e)=>{a&&a!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${a}`),await m(a),await y(a),g(a))});const C=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-cost-provision",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:o.value,data:u.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(D.NANHUA_COST_PROVISION,o.value,u.value,i.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(a){console.error("\u4FDD\u5B58\u5931\u8D25:",a),alert("\u4FDD\u5B58\u5931\u8D25")}},R=()=>{u.value=JSON.parse(JSON.stringify(f)),i.value="",d.value=""};return V(async()=>{l.query.period?(await m(l.query.period.toString()),await y(l.query.period.toString()),g(l.query.period.toString())):(await m(o.value),await y(o.value),g(o.value))}),(a,e)=>(x(),_("div",z,[t("div",K,[e[4]||(e[4]=t("h1",{class:"text-2xl font-bold"},"\u6210\u672C\u4E2D\u5FC3\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),t("div",Q,[e[3]||(e[3]=t("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),S(t("input",{"onUpdate:modelValue":e[0]||(e[0]=r=>o.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[w,o.value]])])]),t("div",W,[t("table",X,[e[6]||(e[6]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u989D"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u8BA1\u63D0\u7387")])],-1)),t("tbody",null,[(x(!0),_(j,null,q(u.value.customers,(r,s)=>(x(),_("tr",{key:`customer-${s}`},[s===0?(x(),_("td",{key:0,rowspan:u.value.customers.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Y)):H("",!0),t("td",Z,n(r.customerName),1),t("td",P,n(c(r.yearBeginBalance)),1),t("td",ee,[S(t("input",{"onUpdate:modelValue":h=>r.monthlyIncrease=h,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,te),[[w,r.monthlyIncrease]])]),t("td",ae,n(c(r.yearlyAccumulated)),1),t("td",re,[t("span",oe,n(c(r.provisionRate))+"%",1)])]))),128)),t("tr",se,[e[5]||(e[5]=t("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),t("td",ue,n(c(p.value.yearBeginBalance)),1),t("td",ne,n(c(p.value.monthlyIncrease)),1),t("td",ce,n(c(p.value.yearlyAccumulated)),1),t("td",le,[t("span",ie,n(c(p.value.provisionRate))+"%",1)])])])])]),T(L,{"module-id":J(D).NANHUA_COST_PROVISION,period:o.value,remarks:i.value,"onUpdate:remarks":e[1]||(e[1]=r=>i.value=r),suggestions:d.value,"onUpdate:suggestions":e[2]||(e[2]=r=>d.value=r)},null,8,["module-id","period","remarks","suggestions"]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:C,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:R,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var he=O(de,[["__scopeId","data-v-b533416e"]]);export{he as default};
