import{_ as I,d as P,r as p,B as x,c as U,o as O,b as g,e as r,y as B,A as D,F as C,g as R,t as n,l as h,k as T,h as $,G as V,v as b,f as j}from"./index.de390106.js";import{_ as J,M as f,r as G}from"./FormAttachmentAndRemarks.b839a129.js";const q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Y={class:"flex justify-between items-center mb-6"},L={class:"flex items-center space-x-4"},z={class:"overflow-x-auto my-6"},H={class:"w-full border-collapse border border-gray-300"},K=["rowspan"],Q={class:"border border-gray-300 px-4 py-2"},W={class:"border border-gray-300 px-4 py-2 text-right"},X={class:"border border-gray-300 px-4 py-2"},Z=["onUpdate:modelValue"],tt={class:"border border-gray-300 px-4 py-2 text-right"},et={class:"bg-gray-50 font-bold"},rt={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"border border-gray-300 px-4 py-2 text-right"},st={class:"border border-gray-300 px-4 py-2 text-right"},at=P({__name:"MainBusinessProfitMargin",setup(ot){var F;const m=V(),a=p(((F=m.query.period)==null?void 0:F.toString())||new Date().toISOString().slice(0,7)),_={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearlyPlan:8,currentActual:0,deviation:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearlyPlan:0,currentActual:0,deviation:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearlyPlan:0,currentActual:0,deviation:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearlyPlan:24.99,currentActual:0,deviation:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearlyPlan:0,currentActual:0,deviation:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearlyPlan:100,currentActual:0,deviation:0}]},s=p(JSON.parse(JSON.stringify(_))),i=p(""),d=p(""),c=t=>t===0?"0.00":t.toFixed(2),S=t=>t===0?!0:s.value.items[t].segmentAttribute!==s.value.items[t-1].segmentAttribute,w=t=>s.value.items.filter(e=>e.segmentAttribute===t).length,A=()=>{s.value.items.forEach(t=>{t.deviation=(t.currentActual||0)-(t.yearlyPlan||0)})};x(()=>s.value.items,()=>{A()},{deep:!0});const y=U(()=>{const t={yearlyPlan:0,currentActual:0,deviation:0};return s.value.items.forEach(e=>{t.yearlyPlan+=e.yearlyPlan||0,t.currentActual+=e.currentActual||0}),t.deviation=t.currentActual-t.yearlyPlan,t}),v=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-main-business-profit-margin/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),l();return}const u=await e.json();u.data&&u.data.items&&(s.value.items=u.data.items.map(o=>({segmentAttribute:o.segmentAttribute,customerAttribute:o.customerAttribute,yearlyPlan:Number(o.yearlyPlan)||0,currentActual:Number(o.currentActual)||0,deviation:Number(o.deviation)||0}))),A()}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),l()}},l=()=>{s.value=JSON.parse(JSON.stringify(_)),A()},E=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${f.TUOYUAN_MAIN_BUSINESS_PROFIT_MARGIN}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(i.value=u.data.remarks||"",d.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};x(()=>m.query.period,async t=>{t&&(a.value=t.toString(),l(),await v(t.toString()),E(t.toString()))}),x(a,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),l(),await v(t),E(t))});const N=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-main-business-profit-margin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:a.value,data:{items:s.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(f.TUOYUAN_MAIN_BUSINESS_PROFIT_MARGIN,a.value,{items:s.value.items},i.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},k=()=>{l(),i.value="",d.value=""};return O(async()=>{var e;l();const t=((e=m.query.period)==null?void 0:e.toString())||a.value;await v(t),E(t)}),(t,e)=>(b(),g("div",q,[r("div",Y,[e[6]||(e[6]=r("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u6BDB\u5229\u7387\u7ED3\u6784\u4E0E\u8D28\u91CF",-1)),r("div",L,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),e[4]||(e[4]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A%\uFF09",-1)),e[5]||(e[5]=r("span",{class:"text-xs text-gray-500"},"\u504F\u5DEE=\u5F53\u671F\u5B9E\u9645-\u5E74\u5EA6\u8BA1\u5212",-1)),B(r("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>a.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[D,a.value]])])]),r("div",z,[r("table",H,[e[8]||(e[8]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u5E74\u5EA6\u8BA1\u5212"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u5F53\u671F\u5B9E\u9645"),r("th",{class:"border border-gray-300 px-4 py-2 w-28"},"\u504F\u5DEE")])],-1)),r("tbody",null,[(b(!0),g(C,null,R(s.value.items,(u,o)=>(b(),g("tr",{key:`profit-margin-${o}`},[S(o)?(b(),g("td",{key:0,rowspan:w(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},n(u.segmentAttribute),9,K)):j("",!0),r("td",Q,n(u.customerAttribute),1),r("td",W,n(c(u.yearlyPlan))+"% ",1),r("td",X,[B(r("input",{"onUpdate:modelValue":M=>u.currentActual=M,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",placeholder:"0.00"},null,8,Z),[[D,u.currentActual]])]),r("td",tt,[r("span",{class:h(["text-sm font-medium",u.deviation>=0?"text-green-600":"text-red-600"])},n(c(u.deviation))+"% ",3)])]))),128)),r("tr",et,[e[7]||(e[7]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",rt,n(c(y.value.yearlyPlan))+"% ",1),r("td",ut,n(c(y.value.currentActual))+"% ",1),r("td",st,[r("span",{class:h(["text-sm font-bold",y.value.deviation>=0?"text-green-600":"text-red-600"])},n(c(y.value.deviation))+"% ",3)])])])])]),T(J,{"module-id":$(f).TUOYUAN_MAIN_BUSINESS_PROFIT_MARGIN,period:a.value,remarks:i.value,"onUpdate:remarks":e[1]||(e[1]=u=>i.value=u),suggestions:d.value,"onUpdate:suggestions":e[2]||(e[2]=u=>d.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:N,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:k,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var it=I(at,[["__scopeId","data-v-b8b49e74"]]);export{it as default};
