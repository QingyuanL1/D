import{_ as $,d as M,r as y,c as I,B as N,o as V,b as i,e as r,y as L,A as Y,F as T,g as O,t as s,k as G,h as z,G as H,v as l,f as k}from"./index.de390106.js";import{_ as K,M as B,r as Q}from"./FormAttachmentAndRemarks.b839a129.js";const W={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},X={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},P={class:"overflow-x-auto my-6"},tt={class:"w-full border-collapse border border-gray-300"},et=["rowspan"],rt={class:"border border-gray-300 px-4 py-2"},ut={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ot={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},st={class:"font-medium"},nt={class:"border border-gray-300 px-4 py-2 text-right"},at=["rowspan"],ct={class:"border border-gray-300 px-4 py-2"},it={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},lt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},pt={class:"font-medium"},dt={class:"border border-gray-300 px-4 py-2 text-right"},yt=["rowspan"],mt={class:"border border-gray-300 px-4 py-2"},gt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},bt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},_t={class:"font-medium"},vt={class:"border border-gray-300 px-4 py-2 text-right"},At={class:"bg-gray-50 font-bold"},ht={class:"border border-gray-300 px-4 py-2 text-right"},ft={class:"border border-gray-300 px-4 py-2 text-right"},xt={class:"border border-gray-300 px-4 py-2 text-right"},Dt=M({__name:"InventoryStructure",setup(St){var w;const m=H(),p=y(((w=m.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),v=y(""),A=y(""),h=[{customerType:"\u4E0A\u6D77",initialAmount:39151.53,currentAmount:0},{customerType:"\u56FD\u7F51",initialAmount:7841.48,currentAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:6793.01,currentAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:0,currentAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:28.46,currentAmount:0},{customerType:"\u540C\u4E1A",initialAmount:821.55,currentAmount:0},{customerType:"\u7528\u6237",initialAmount:577.37,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:220.08,currentAmount:0}],f=[{customerType:"\u7528\u6237",initialAmount:26.6,currentAmount:0}],x=[{customerType:"\u4E00\u5305",initialAmount:12720.17,currentAmount:0},{customerType:"\u4E8C\u5305",initialAmount:960.55,currentAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:1818.79,currentAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:8063.91,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:1973.08,currentAmount:0}],n=y(JSON.parse(JSON.stringify(h))),a=y(JSON.parse(JSON.stringify(f))),c=y(JSON.parse(JSON.stringify(x))),d=u=>(Number(u)||0).toLocaleString(),D=(u,t)=>u===0?"0.00":((t-u)/u*100).toFixed(2),J=I(()=>[...n.value,...a.value,...c.value].reduce((u,t)=>u+(Number(t.initialAmount)||0),0)),C=I(()=>[...n.value,...a.value,...c.value].reduce((u,t)=>u+(Number(t.currentAmount)||0),0)),g=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${B.INVENTORY_STRUCTURE}/${u}`);if(t.ok){const e=await t.json();e.success&&e.data&&(v.value=e.data.remarks||"",A.value=e.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",t)}},j=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/bid-fulfillment/${u}`);if(t.ok){const e=await t.json();if(e.success&&e.data)return e.data}}catch(t){console.error("\u52A0\u8F7Dbid_fulfillment\u6570\u636E\u5931\u8D25:",t)}return null},R=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/inventory-in-progress/${u}`);if(t.ok){const e=await t.json();if(e.success&&e.data)return e.data}}catch(t){console.error("\u52A0\u8F7Dinventory_in_progress\u6570\u636E\u5931\u8D25:",t)}return null},F=(u,t,e,o)=>{let E=0;if(e&&e.length>0){const b=e.find(_=>_.category===u&&_.customer_type===t);b&&(E+=Number(b.current_amount)||0)}if(o&&o.length>0){const b=o.find(_=>_.category===u&&_.customer_type===t);b&&(E+=Number(b.current_amount)||0)}return E},S=async u=>{try{const[t,e]=await Promise.all([j(u),R(u)]);n.value=JSON.parse(JSON.stringify(h)),a.value=JSON.parse(JSON.stringify(f)),c.value=JSON.parse(JSON.stringify(x)),n.value.forEach(o=>{o.currentAmount=F("\u8BBE\u5907",o.customerType,t,e)}),a.value.forEach(o=>{o.currentAmount=F("\u5143\u4EF6",o.customerType,t,e)}),c.value.forEach(o=>{o.currentAmount=F("\u5DE5\u7A0B",o.customerType,t,e)}),console.log("\u6570\u636E\u52A0\u8F7D\u5B8C\u6210:",{bidFulfillmentData:t,inventoryInProgressData:e,equipmentData:n.value,componentData:a.value,projectData:c.value})}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),n.value=JSON.parse(JSON.stringify(h)),a.value=JSON.parse(JSON.stringify(f)),c.value=JSON.parse(JSON.stringify(x))}};N(p,u=>{S(u),g(u)}),N(()=>m.query.period,u=>{u&&(p.value=u.toString(),S(u.toString()),g(u.toString()))}),N(p,(u,t)=>{u&&u!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${u}`),S(u),g(u))});const q=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/inventory-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:p.value,data:{equipment:n.value.map(t=>({customerType:t.customerType,initialAmount:t.initialAmount})),component:a.value.map(t=>({customerType:t.customerType,initialAmount:t.initialAmount})),project:c.value.map(t=>({customerType:t.customerType,initialAmount:t.initialAmount}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await Q(B.INVENTORY_STRUCTURE,p.value,{equipment:n.value,component:a.value,project:c.value},v.value,A.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25")}},U=()=>{n.value=JSON.parse(JSON.stringify(h)),a.value=JSON.parse(JSON.stringify(f)),c.value=JSON.parse(JSON.stringify(x))};return V(()=>{m.query.period?(S(m.query.period.toString()),g(m.query.period.toString())):g(p.value)}),(u,t)=>(l(),i("div",W,[r("div",X,[t[3]||(t[3]=r("h1",{class:"text-2xl font-bold"},"\u5B58\u91CF\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),r("div",Z,[L(r("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>p.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[Y,p.value]])])]),r("div",P,[r("table",tt,[t[5]||(t[5]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u91D1\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u91D1\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),r("tbody",null,[(l(!0),i(T,null,O(n.value,(e,o)=>(l(),i("tr",{key:`equipment-${o}`},[o===0?(l(),i("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:n.value.length}," \u8BBE\u5907 ",8,et)):k("",!0),r("td",rt,s(e.customerType),1),r("td",ut,[r("span",null,s(d(e.initialAmount)),1)]),r("td",ot,[r("span",st,s(d(e.currentAmount)),1)]),r("td",nt,s(D(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),(l(!0),i(T,null,O(a.value,(e,o)=>(l(),i("tr",{key:`component-${o}`},[o===0?(l(),i("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:a.value.length}," \u5143\u4EF6 ",8,at)):k("",!0),r("td",ct,s(e.customerType),1),r("td",it,[r("span",null,s(d(e.initialAmount)),1)]),r("td",lt,[r("span",pt,s(d(e.currentAmount)),1)]),r("td",dt,s(D(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),(l(!0),i(T,null,O(c.value,(e,o)=>(l(),i("tr",{key:`project-${o}`},[o===0?(l(),i("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u5DE5\u7A0B ",8,yt)):k("",!0),r("td",mt,s(e.customerType),1),r("td",gt,[r("span",null,s(d(e.initialAmount)),1)]),r("td",bt,[r("span",_t,s(d(e.currentAmount)),1)]),r("td",vt,s(D(e.initialAmount,e.currentAmount))+"% ",1)]))),128)),r("tr",At,[t[4]||(t[4]=r("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),r("td",ht,s(d(J.value)),1),r("td",ft,s(d(C.value)),1),r("td",xt,s(D(J.value,C.value))+"% ",1)])])])]),G(K,{"module-id":z(B).INVENTORY_STRUCTURE,period:p.value,remarks:v.value,"onUpdate:remarks":t[1]||(t[1]=e=>v.value=e),suggestions:A.value,"onUpdate:suggestions":t[2]||(t[2]=e=>A.value=e)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:q,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:U,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Nt=$(Dt,[["__scopeId","data-v-31b9f6a4"]]);export{Nt as default};
