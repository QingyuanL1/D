import{_ as P,d as h,r as C,D as j,C as A,o as L,c as q,a as e,y as a,B as r,b as G,m as J,G as z,f as H}from"./index.8c66e47c.js";import{_ as K,r as Q,M as S,l as W}from"./FormAttachmentAndRemarks.5b7c3920.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Y={class:"flex justify-between items-center mb-6"},Z={class:"flex items-center space-x-4"},ss={class:"overflow-x-auto my-6"},ts={class:"w-full border-collapse border border-gray-300"},es={class:"border border-gray-300 px-4 py-2"},ns={class:"border border-gray-300 px-4 py-2"},us={class:"border border-gray-300 px-4 py-2"},os={class:"border border-gray-300 px-4 py-2"},as={class:"border border-gray-300 px-4 py-2"},rs={class:"border border-gray-300 px-4 py-2"},ls={class:"border border-gray-300 px-4 py-2"},is={class:"border border-gray-300 px-4 py-2"},ds={class:"bg-gray-50 font-bold"},ps={class:"border border-gray-300 px-4 py-2"},cs={class:"border border-gray-300 px-4 py-2"},ms={class:"border border-gray-300 px-4 py-2"},gs={class:"border border-gray-300 px-4 py-2"},ys=h({__name:"NetProfitStructure",setup(bs){var T;const U=z(),l=C(((T=U.query.period)==null?void 0:T.toString())||new Date().toISOString().slice(0,7)),B=C(""),x=C(""),M=()=>({mainBusiness:{plan:"0",current:"0",cumulative:"0",progress:"0.00%"},nonMainBusiness:{plan:"0",current:"0",cumulative:"0",progress:"0.00%"},total:{plan:"0",current:"0",cumulative:"0",progress:"0.00%"}}),t=j(M()),F=u=>{const s=parseFloat(t[u].plan.replace(/,/g,"")),n=parseFloat(t[u].cumulative.replace(/,/g,""));if(!isNaN(s)&&!isNaN(n)&&s!==0){const i=(n/s*100).toFixed(2);t[u].progress=`${i}%`}else t[u].progress="0.00%";V()},V=()=>{const u=parseFloat(t.mainBusiness.plan.replace(/,/g,""))||0,s=parseFloat(t.nonMainBusiness.plan.replace(/,/g,""))||0,n=parseFloat(t.mainBusiness.current.replace(/,/g,""))||0,i=parseFloat(t.nonMainBusiness.current.replace(/,/g,""))||0,m=parseFloat(t.mainBusiness.cumulative.replace(/,/g,""))||0,g=parseFloat(t.nonMainBusiness.cumulative.replace(/,/g,""))||0,d=u+s,y=n+i,b=m+g;if(t.total.plan=d.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),t.total.current=y.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),t.total.cumulative=b.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),d!==0){const p=(b/d*100).toFixed(2);t.total.progress=`${p}%`}else t.total.progress="0.00%"};A(()=>U.query.period,u=>{u&&(l.value=u.toString(),w(u.toString()))}),A(l,(u,s)=>{u&&u!==s&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${s} -> ${u}`),w(u),_())}),A(()=>[t.mainBusiness.current,t.nonMainBusiness.current],async()=>{await N()},{deep:!0});const N=async()=>{var u,s,n,i;try{const[m]=l.value.split("-");let g=0,d=0;for(let y=1;y<=parseInt(l.value.split("-")[1]);y++){const b=`${m}-${y.toString().padStart(2,"0")}`;try{const p=await fetch(`http://47.111.95.19:3000/net-profit-structure/${b}`);if(p.ok){const c=await p.json();if(c.success&&c.data){const v=parseFloat(((u=c.data.mainBusiness)==null?void 0:u.current)||((s=c.data.mainBusiness)==null?void 0:s.actual)||0),D=parseFloat(((n=c.data.nonMainBusiness)==null?void 0:n.current)||((i=c.data.nonMainBusiness)==null?void 0:i.actual)||0);g+=v,d+=D}}}catch(p){console.log(`\u8DF3\u8FC7\u671F\u95F4 ${b} \u7684\u6570\u636E\u8BA1\u7B97:`,p)}}t.mainBusiness.cumulative=g.toFixed(2),t.nonMainBusiness.cumulative=d.toFixed(2),t.total.cumulative=(g+d).toFixed(2),F("mainBusiness"),F("nonMainBusiness")}catch(m){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",m)}},w=async u=>{var s,n,i,m,g,d,y,b,p,c,v,D,k,$,R;try{console.log(`\u6B63\u5728\u52A0\u8F7D\u51C0\u5229\u6DA6\u7ED3\u6784\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const f=await fetch(`http://47.111.95.19:3000/net-profit-structure/${u}`);let o=null;if(f.ok){const E=await f.json();console.log("API\u8FD4\u56DE\u6570\u636E:",E),E.success&&E.data&&(o=E.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."),t.mainBusiness={plan:((s=o.mainBusiness)==null?void 0:s.plan)||"0",current:((n=o.mainBusiness)==null?void 0:n.current)||((i=o.mainBusiness)==null?void 0:i.actual)||"0",cumulative:((m=o.mainBusiness)==null?void 0:m.cumulative)||"0",progress:((g=o.mainBusiness)==null?void 0:g.progress)||"0.00%"},t.nonMainBusiness={plan:((d=o.nonMainBusiness)==null?void 0:d.plan)||"0",current:((y=o.nonMainBusiness)==null?void 0:y.current)||((b=o.nonMainBusiness)==null?void 0:b.actual)||"0",cumulative:((p=o.nonMainBusiness)==null?void 0:p.cumulative)||"0",progress:((c=o.nonMainBusiness)==null?void 0:c.progress)||"0.00%"},t.total={plan:((v=o.total)==null?void 0:v.plan)||"0",current:((D=o.total)==null?void 0:D.current)||((k=o.total)==null?void 0:k.actual)||"0",cumulative:(($=o.total)==null?void 0:$.cumulative)||"0",progress:((R=o.total)==null?void 0:R.progress)||"0.00%"},V(),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",t))}else throw console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25"),new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}catch(f){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",f);const o=M();t.mainBusiness={...o.mainBusiness},t.nonMainBusiness={...o.nonMainBusiness},t.total={...o.total}}},I=async()=>{try{const u={mainBusiness:t.mainBusiness,nonMainBusiness:t.nonMainBusiness,total:t.total},s={period:l.value,data:u};console.log("\u4FDD\u5B58\u6570\u636E:",s);const n=await fetch("http://47.111.95.19:3000/net-profit-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!n.ok){const i=await n.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${n.status} - ${i}`)}await Q(S.NET_PROFIT_STRUCTURE,l.value,u,B.value,x.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25: "+(u instanceof Error?u.message:"\u672A\u77E5\u9519\u8BEF"))}},O=()=>{const u=M();t.mainBusiness={...u.mainBusiness},t.nonMainBusiness={...u.nonMainBusiness},t.total={...u.total},console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},_=async()=>{const{remarks:u,suggestions:s}=await W(S.NET_PROFIT_STRUCTURE,l.value);B.value=u,x.value=s};return L(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",l.value),w(l.value),_()}),(u,s)=>(H(),q("div",X,[e("div",Y,[s[17]||(s[17]=e("h1",{class:"text-2xl font-bold"},"\u51C0\u5229\u6DA6\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),s[18]||(s[18]=e("div",{class:"text-gray-500"},"(\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3)",-1)),e("div",Z,[a(e("input",{"onUpdate:modelValue":s[0]||(s[0]=n=>l.value=n),type:"month",class:"px-3 py-2 border rounded"},null,512),[[r,l.value]])])]),e("div",ss,[e("table",ts,[s[24]||(s[24]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E8F\u53F7"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u8D22\u52A1\u79D1\u76EE"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),e("tbody",null,[e("tr",null,[s[19]||(s[19]=e("td",{class:"border border-gray-300 px-4 py-2 text-center"},"1",-1)),s[20]||(s[20]=e("td",{class:"border border-gray-300 px-4 py-2"},"\u4E3B\u8425\u4E1A\u52A1",-1)),e("td",es,[a(e("input",{"onUpdate:modelValue":s[1]||(s[1]=n=>t.mainBusiness.plan=n),type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,512),[[r,t.mainBusiness.plan]])]),e("td",ns,[a(e("input",{"onUpdate:modelValue":s[2]||(s[2]=n=>t.mainBusiness.current=n),type:"text",class:"w-full px-2 py-1 border rounded",onInput:s[3]||(s[3]=n=>F("mainBusiness"))},null,544),[[r,t.mainBusiness.current]])]),e("td",us,[a(e("input",{"onUpdate:modelValue":s[4]||(s[4]=n=>t.mainBusiness.cumulative=n),type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,512),[[r,t.mainBusiness.cumulative]])]),e("td",os,[a(e("input",{"onUpdate:modelValue":s[5]||(s[5]=n=>t.mainBusiness.progress=n),type:"text",class:"w-full px-2 py-1 border rounded"},null,512),[[r,t.mainBusiness.progress]])])]),e("tr",null,[s[21]||(s[21]=e("td",{class:"border border-gray-300 px-4 py-2 text-center"},"2",-1)),s[22]||(s[22]=e("td",{class:"border border-gray-300 px-4 py-2"},"\u975E\u4E3B\u8425\u4E1A\u52A1",-1)),e("td",as,[a(e("input",{"onUpdate:modelValue":s[6]||(s[6]=n=>t.nonMainBusiness.plan=n),type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,512),[[r,t.nonMainBusiness.plan]])]),e("td",rs,[a(e("input",{"onUpdate:modelValue":s[7]||(s[7]=n=>t.nonMainBusiness.current=n),type:"text",class:"w-full px-2 py-1 border rounded",onInput:s[8]||(s[8]=n=>F("nonMainBusiness"))},null,544),[[r,t.nonMainBusiness.current]])]),e("td",ls,[a(e("input",{"onUpdate:modelValue":s[9]||(s[9]=n=>t.nonMainBusiness.cumulative=n),type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,512),[[r,t.nonMainBusiness.cumulative]])]),e("td",is,[a(e("input",{"onUpdate:modelValue":s[10]||(s[10]=n=>t.nonMainBusiness.progress=n),type:"text",class:"w-full px-2 py-1 border rounded"},null,512),[[r,t.nonMainBusiness.progress]])])]),e("tr",ds,[s[23]||(s[23]=e("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),e("td",ps,[a(e("input",{"onUpdate:modelValue":s[11]||(s[11]=n=>t.total.plan=n),type:"text",class:"w-full px-2 py-1 border rounded font-bold",readonly:""},null,512),[[r,t.total.plan]])]),e("td",cs,[a(e("input",{"onUpdate:modelValue":s[12]||(s[12]=n=>t.total.current=n),type:"text",class:"w-full px-2 py-1 border rounded font-bold",readonly:""},null,512),[[r,t.total.current]])]),e("td",ms,[a(e("input",{"onUpdate:modelValue":s[13]||(s[13]=n=>t.total.cumulative=n),type:"text",class:"w-full px-2 py-1 border rounded font-bold",readonly:""},null,512),[[r,t.total.cumulative]])]),e("td",gs,[a(e("input",{"onUpdate:modelValue":s[14]||(s[14]=n=>t.total.progress=n),type:"text",class:"w-full px-2 py-1 border rounded font-bold",readonly:""},null,512),[[r,t.total.progress]])])])])])]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:O,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),G(K,{"module-id":J(S).NET_PROFIT_STRUCTURE,period:l.value,remarks:B.value,"onUpdate:remarks":s[15]||(s[15]=n=>B.value=n),suggestions:x.value,"onUpdate:suggestions":s[16]||(s[16]=n=>x.value=n)},null,8,["module-id","period","remarks","suggestions"])]))}});var Fs=P(ys,[["__scopeId","data-v-7c70f3e8"]]);export{Fs as default};
