import{_ as q,d as R,r as m,c as B,B as D,o as U,b as s,e,y as $,A as M,F as T,g as S,t as n,k as V,h as I,G as L,v as a,f as E}from"./index.7df532c5.js";import{_ as Y,M as N,r as G}from"./FormAttachmentAndRemarks.370bf5d3.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},H={class:"flex justify-between items-center mb-6"},K={class:"flex items-center space-x-4"},Q={class:"overflow-x-auto my-6"},W={class:"w-full border-collapse border border-gray-300"},X=["rowspan"],Z={class:"border border-gray-300 px-4 py-2"},P={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},tt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},rt={class:"font-medium"},et={class:"border border-gray-300 px-4 py-2 text-right"},ut=["rowspan"],ot={class:"border border-gray-300 px-4 py-2"},nt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},st={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},at={class:"font-medium"},it={class:"border border-gray-300 px-4 py-2 text-right"},ct=["rowspan"],pt={class:"border border-gray-300 px-4 py-2"},lt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},dt={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},mt={class:"font-medium"},yt={class:"border border-gray-300 px-4 py-2 text-right"},gt={class:"bg-gray-50 font-bold"},bt={class:"border border-gray-300 px-4 py-2 text-right"},At={class:"border border-gray-300 px-4 py-2 text-right"},_t={class:"border border-gray-300 px-4 py-2 text-right"},vt=R({__name:"InventoryStructure",setup(ht){var k;const y=L(),i=m(((k=y.query.period)==null?void 0:k.toString())||new Date().toISOString().slice(0,7)),h=m(""),x=m(""),g=[{customerType:"\u4E0A\u6D77",initialAmount:39151.53,currentAmount:0},{customerType:"\u56FD\u7F51",initialAmount:7841.48,currentAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:6793.01,currentAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:0,currentAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:28.46,currentAmount:0},{customerType:"\u540C\u4E1A",initialAmount:821.55,currentAmount:0},{customerType:"\u7528\u6237",initialAmount:577.37,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:220.08,currentAmount:0}],b=[{customerType:"\u7528\u6237",initialAmount:26.6,currentAmount:0}],A=[{customerType:"\u4E00\u5305",initialAmount:12720.17,currentAmount:0},{customerType:"\u4E8C\u5305",initialAmount:960.55,currentAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:1818.79,currentAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:8063.91,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:1973.08,currentAmount:0}],c=m(JSON.parse(JSON.stringify(g))),p=m(JSON.parse(JSON.stringify(b))),l=m(JSON.parse(JSON.stringify(A))),d=u=>(Number(u)||0).toLocaleString(),f=(u,t)=>u===0?"0.00":((t-u)/u*100).toFixed(2),C=B(()=>[...c.value,...p.value,...l.value].reduce((u,t)=>u+(Number(t.initialAmount)||0),0)),O=B(()=>[...c.value,...p.value,...l.value].reduce((u,t)=>u+(Number(t.currentAmount)||0),0)),_=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${N.INVENTORY_STRUCTURE}/${u}`);if(t.ok){const r=await t.json();r.success&&r.data&&(h.value=r.data.remarks||"",x.value=r.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",t)}},w=(u,t)=>(t.equipment&&Array.isArray(t.equipment)&&(u.equipment=g.map(r=>{const o=t.equipment.find(v=>v.customerType===r.customerType);return o?{...r,initialAmount:r.initialAmount,currentAmount:Number(o.currentAmount)||0}:r})),t.component&&Array.isArray(t.component)&&(u.component=b.map(r=>{const o=t.component.find(v=>v.customerType===r.customerType);return o?{...r,initialAmount:r.initialAmount,currentAmount:Number(o.currentAmount)||0}:r})),t.project&&Array.isArray(t.project)&&(u.project=A.map(r=>{const o=t.project.find(v=>v.customerType===r.customerType);return o?{...r,initialAmount:r.initialAmount,currentAmount:Number(o.currentAmount)||0}:r})),u),F=async u=>{try{const t=await fetch(`http://47.111.95.19:3000/inventory-structure/${u}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),c.value=JSON.parse(JSON.stringify(g)),p.value=JSON.parse(JSON.stringify(b)),l.value=JSON.parse(JSON.stringify(A));return}const r=await t.json();if(r.success&&r.data){const o=w({equipment:g,component:b,project:A},r.data);c.value=o.equipment,p.value=o.component,l.value=o.project}}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t)}};D(i,u=>{F(u),_(u)}),D(()=>y.query.period,u=>{u&&(i.value=u.toString(),F(u.toString()),_(u.toString()))}),D(i,(u,t)=>{u&&u!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${u}`),F(u),_(u))});const J=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/inventory-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:i.value,data:{equipment:c.value.map(t=>({customerType:t.customerType,initialAmount:t.initialAmount})),component:p.value.map(t=>({customerType:t.customerType,initialAmount:t.initialAmount})),project:l.value.map(t=>({customerType:t.customerType,initialAmount:t.initialAmount}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(N.INVENTORY_STRUCTURE,i.value,{equipment:c.value,component:p.value,project:l.value},h.value,x.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25")}},j=()=>{c.value=JSON.parse(JSON.stringify(g)),p.value=JSON.parse(JSON.stringify(b)),l.value=JSON.parse(JSON.stringify(A))};return U(()=>{y.query.period?(F(y.query.period.toString()),_(y.query.period.toString())):_(i.value)}),(u,t)=>(a(),s("div",z,[e("div",H,[t[3]||(t[3]=e("h1",{class:"text-2xl font-bold"},"\u5B58\u91CF\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),e("div",K,[$(e("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>i.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[M,i.value]])])]),e("div",Q,[e("table",W,[t[5]||(t[5]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u91D1\u989D"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u91D1\u989D"),e("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),e("tbody",null,[(a(!0),s(T,null,S(c.value,(r,o)=>(a(),s("tr",{key:`equipment-${o}`},[o===0?(a(),s("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u8BBE\u5907 ",8,X)):E("",!0),e("td",Z,n(r.customerType),1),e("td",P,[e("span",null,n(d(r.initialAmount)),1)]),e("td",tt,[e("span",rt,n(d(r.currentAmount)),1)]),e("td",et,n(f(r.initialAmount,r.currentAmount))+"% ",1)]))),128)),(a(!0),s(T,null,S(p.value,(r,o)=>(a(),s("tr",{key:`component-${o}`},[o===0?(a(),s("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5143\u4EF6 ",8,ut)):E("",!0),e("td",ot,n(r.customerType),1),e("td",nt,[e("span",null,n(d(r.initialAmount)),1)]),e("td",st,[e("span",at,n(d(r.currentAmount)),1)]),e("td",it,n(f(r.initialAmount,r.currentAmount))+"% ",1)]))),128)),(a(!0),s(T,null,S(l.value,(r,o)=>(a(),s("tr",{key:`project-${o}`},[o===0?(a(),s("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u5DE5\u7A0B ",8,ct)):E("",!0),e("td",pt,n(r.customerType),1),e("td",lt,[e("span",null,n(d(r.initialAmount)),1)]),e("td",dt,[e("span",mt,n(d(r.currentAmount)),1)]),e("td",yt,n(f(r.initialAmount,r.currentAmount))+"% ",1)]))),128)),e("tr",gt,[t[4]||(t[4]=e("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),e("td",bt,n(d(C.value)),1),e("td",At,n(d(O.value)),1),e("td",_t,n(f(C.value,O.value))+"% ",1)])])])]),V(Y,{"module-id":I(N).INVENTORY_STRUCTURE,period:i.value,remarks:h.value,"onUpdate:remarks":t[1]||(t[1]=r=>h.value=r),suggestions:x.value,"onUpdate:suggestions":t[2]||(t[2]=r=>x.value=r)},null,8,["module-id","period","remarks","suggestions"]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:J,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:j,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ft=q(vt,[["__scopeId","data-v-e9c1b984"]]);export{Ft as default};
