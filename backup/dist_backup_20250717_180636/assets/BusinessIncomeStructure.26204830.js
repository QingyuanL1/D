import{_ as N,d as P,r as g,c as $,B,o as O,b as x,e as o,y as w,A as M,F as V,g as j,t as l,k as q,h as L,G,v as f}from"./index.403d91d0.js";import{_ as J,r as z,M as I,l as H}from"./FormAttachmentAndRemarks.2282abac.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},W={class:"flex items-center space-x-4"},X={class:"overflow-x-auto my-6"},Y={class:"w-full border-collapse border border-gray-300"},Z={class:"border border-gray-300 px-4 py-2 text-center"},ee={class:"border border-gray-300 px-4 py-2"},ue={class:"border border-gray-300 px-4 py-2"},oe={class:"w-full px-2 py-1"},re={class:"border border-gray-300 px-4 py-2"},te=["onUpdate:modelValue"],se={class:"border border-gray-300 px-4 py-2"},ae={class:"w-full px-2 py-1"},ne={class:"border border-gray-300 px-4 py-2"},ce={class:"text-sm font-medium"},le={class:"bg-gray-50 font-bold"},de={class:"border border-gray-300 px-4 py-2"},ie={class:"border border-gray-300 px-4 py-2"},pe={class:"border border-gray-300 px-4 py-2"},ye={class:"border border-gray-300 px-4 py-2"},ge=P({__name:"BusinessIncomeStructure",setup(me){var S;const m=G(),t=g(((S=m.query.period)==null?void 0:S.toString())||new Date().toISOString().slice(0,7)),b=()=>[{id:1,category:"\u4E3B\u8425\u4E1A\u52A1",yearlyPlan:0,currentMonthIncome:0,accumulatedIncome:0},{id:2,category:"\u975E\u4E3B\u8425\u4E1A\u52A1",yearlyPlan:0,currentMonthIncome:0,accumulatedIncome:0}],s=g(b()),A=g([]),p=g(""),y=g(""),C=(e,u)=>!e||e===0?"0.00":(u/e*100).toFixed(2),D=async e=>{try{const[u,r]=e.split("-"),n=parseInt(r),a=[];for(let c=1;c<=n;c++){const i=`${u}-${c.toString().padStart(2,"0")}`;try{const d=await fetch(`http://47.111.95.19:3000/business-income/${i}`);if(d.ok){const _=await d.json();_.data&&Array.isArray(_.data)&&a.push({period:i,data:_.data})}}catch(d){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${i}:`,d)}}A.value=a,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",a)}catch(u){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",u)}},k=(e,u)=>{let r=0;const n=t.value;for(const c of A.value){if(c.period===n)continue;const i=c.data.find(d=>d.id===e||d.category===u);i&&i.currentMonthIncome&&(r+=parseFloat(i.currentMonthIncome.toString())||0)}const a=s.value.find(c=>c.id===e);return a&&a.currentMonthIncome&&(r+=parseFloat(a.currentMonthIncome.toString())||0),r},h=()=>{s.value.forEach(e=>{e.accumulatedIncome=k(e.id,e.category)})},E=$(()=>{const e={yearlyPlan:0,currentMonthIncome:0,accumulatedIncome:0,progress:0};return s.value.forEach(u=>{e.yearlyPlan+=u.yearlyPlan||0,e.currentMonthIncome+=u.currentMonthIncome||0,e.accumulatedIncome+=u.accumulatedIncome||0}),e.progress=e.yearlyPlan>0?e.accumulatedIncome/e.yearlyPlan*100:0,e.progress=parseFloat(e.progress.toFixed(2)),e}),U=(e,u)=>!Array.isArray(u)||u.length===0?e:e.map(r=>{const n=u.find(a=>a.id===r.id);return n?{id:r.id,category:r.category,yearlyPlan:n.yearlyPlan||0,currentMonthIncome:n.currentMonthIncome||0,accumulatedIncome:n.accumulatedIncome||0}:r}),F=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u8425\u4E1A\u6536\u5165\u7ED3\u6784\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const u=await fetch(`http://47.111.95.19:3000/business-income/${e}`);if(!u.ok){if(u.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),s.value=b(),await D(e),h();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const r=await u.json();console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data&&Array.isArray(r.data)&&(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."),s.value=U(b(),r.data),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",s.value)),await D(e),h()}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u);try{await D(e),h()}catch(r){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",r)}}};B(()=>m.query.period,e=>{e&&(t.value=e.toString(),F(e.toString()),v())}),B(t,e=>{F(e),v()});const R=async()=>{try{console.log("\u4FDD\u5B58\u6570\u636E:",{period:t.value,data:s.value});const e=await fetch("http://47.111.95.19:3000/business-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:t.value,data:s.value})});if(!e.ok){const u=await e.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${e.status} - ${u}`)}await z(I.BUSINESS_INCOME_STRUCTURE,t.value,s.value,p.value,y.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},T=()=>{s.value=b(),p.value="",y.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},v=async()=>{const{remarks:e,suggestions:u}=await H(I.BUSINESS_INCOME_STRUCTURE,t.value);p.value=e,y.value=u};return O(()=>{console.log("\u8425\u4E1A\u6536\u5165\u7ED3\u6784\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",t.value),m.query.period?F(m.query.period.toString()):F(t.value),v()}),(e,u)=>(f(),x("div",K,[o("div",Q,[u[3]||(u[3]=o("h1",{class:"text-2xl font-bold"},"\u8425\u4E1A\u6536\u5165\u7ED3\u6784\u4E0E\u8D28\u91CF",-1)),o("div",W,[w(o("input",{"onUpdate:modelValue":u[0]||(u[0]=r=>t.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[M,t.value]])])]),o("div",X,[o("table",Y,[u[6]||(u[6]=o("thead",{class:"sticky top-0 bg-white"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E8F\u53F7"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u8D22\u52A1\u79D1\u76EE"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u6536\u5165"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u6536\u5165"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),o("tbody",null,[(f(!0),x(V,null,j(s.value,(r,n)=>(f(),x("tr",{key:n},[o("td",Z,l(r.id),1),o("td",ee,l(r.category),1),o("td",ue,[o("span",oe,l(r.yearlyPlan),1)]),o("td",re,[w(o("input",{"onUpdate:modelValue":a=>r.currentMonthIncome=a,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:h},null,40,te),[[M,r.currentMonthIncome,void 0,{number:!0}]])]),o("td",se,[o("span",ae,l(r.accumulatedIncome),1)]),o("td",ne,[o("span",ce,l(C(r.yearlyPlan,r.accumulatedIncome))+"%",1)])]))),128)),o("tr",le,[u[4]||(u[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u[5]||(u[5]=o("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),o("td",de,l(E.value.yearlyPlan.toFixed(2)),1),o("td",ie,l(E.value.currentMonthIncome.toFixed(2)),1),o("td",pe,l(E.value.accumulatedIncome.toFixed(2)),1),o("td",ye,l(E.value.progress.toFixed(2))+"% ",1)])])])]),q(J,{"module-id":L(I).BUSINESS_INCOME_STRUCTURE,period:t.value,remarks:p.value,"onUpdate:remarks":u[1]||(u[1]=r=>p.value=r),suggestions:y.value,"onUpdate:suggestions":u[2]||(u[2]=r=>y.value=r)},null,8,["module-id","period","remarks","suggestions"]),o("div",{class:"mt-4 flex justify-end space-x-4"},[o("button",{onClick:R,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),o("button",{onClick:T,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ee=N(ge,[["__scopeId","data-v-133b93f7"]]);export{Ee as default};
