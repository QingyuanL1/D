import{_ as R,d as T,r as b,h as A,C as f,o as B,c as g,a as r,y as F,B as v,F as O,l as S,t as s,b as k,m as I,G as U,f as _,k as M}from"./index.bddaa12e.js";import{_ as $,M as x,r as V}from"./FormAttachmentAndRemarks.706a1ab0.js";const j={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},q={class:"flex justify-between items-center mb-6"},J={class:"flex items-center space-x-4"},H={class:"overflow-x-auto my-6"},L={class:"w-full border-collapse border border-gray-300"},G=["rowspan"],z={class:"border border-gray-300 px-4 py-2"},K={class:"border border-gray-300 px-4 py-2 text-right"},Q={class:"border border-gray-300 px-4 py-2"},W=["onUpdate:modelValue"],X={class:"border border-gray-300 px-4 py-2 text-right"},Y={class:"border border-gray-300 px-4 py-2 text-right"},Z={class:"text-sm font-medium"},P={class:"bg-gray-50 font-bold"},tt={class:"border border-gray-300 px-4 py-2 text-right"},et={class:"border border-gray-300 px-4 py-2 text-right"},rt={class:"border border-gray-300 px-4 py-2 text-right"},ot={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"text-sm font-bold"},at=T({__name:"OrderToIncome",setup(st){var E;const c=U(),u=b(((E=c.query.period)==null?void 0:E.toString())||new Date().toISOString().slice(0,7)),h={customers:[{customerName:"\u4E00\u5305\u9879\u76EE",newContractTotal:2678,current:0,accumulated:0,completionRate:0},{customerName:"\u4E8C\u5305\u9879\u76EE",newContractTotal:110,current:0,accumulated:0,completionRate:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",newContractTotal:200,current:0,accumulated:0,completionRate:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",newContractTotal:62,current:0,accumulated:0,completionRate:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",newContractTotal:482,current:0,accumulated:0,completionRate:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",newContractTotal:218,current:0,accumulated:0,completionRate:0},{customerName:"\u6295\u6807\u9879\u76EE",newContractTotal:0,current:0,accumulated:0,completionRate:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",newContractTotal:0,current:0,accumulated:0,completionRate:0},{customerName:"\u81EA\u5EFA\u9879\u76EE",newContractTotal:0,current:0,accumulated:0,completionRate:0}]},n=b(JSON.parse(JSON.stringify(h))),l=b(""),d=b(""),p=t=>t===0?"0.00":t.toFixed(2),D=(t,e)=>!t||t===0?"0.00":(e/t*100).toFixed(2),i=A(()=>{const t={newContractTotal:0,current:0,accumulated:0,completionRate:0};return n.value.customers.forEach(e=>{t.newContractTotal+=e.newContractTotal||0,t.current+=e.current||0,t.accumulated+=e.accumulated||0}),t.completionRate=t.newContractTotal>0?t.accumulated/t.newContractTotal*100:0,t.completionRate=parseFloat(t.completionRate.toFixed(2)),t}),m=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/nanhua-order-to-income/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");return}const o=await e.json();o.data&&o.data.customers&&(n.value.customers=o.data.customers.map(a=>({customerName:a.customerName,newContractTotal:Number(a.newContractTotal)||0,current:Number(a.current)||0,accumulated:Number(a.accumulated)||0,completionRate:Number(a.completionRate)||0})))}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e)}},y=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${x.NANHUA_ORDER_TO_INCOME}/${t}`);if(e.ok){const o=await e.json();o.success&&o.data&&(l.value=o.data.remarks||"",d.value=o.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};f(()=>c.query.period,t=>{t&&(u.value=t.toString(),m(t.toString()),y(t.toString()))}),f(u,(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),m(t),y(t))});const C=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-order-to-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:u.value,data:n.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await V(x.NANHUA_ORDER_TO_INCOME,u.value,n.value,l.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},w=()=>{n.value=JSON.parse(JSON.stringify(h)),l.value="",d.value=""};return B(()=>{c.query.period?(m(c.query.period.toString()),y(c.query.period.toString())):(m(u.value),y(u.value))}),(t,e)=>(_(),g("div",j,[r("div",q,[e[4]||(e[4]=r("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u2014\u2014\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165",-1)),r("div",J,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),F(r("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>u.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[v,u.value]])])]),r("div",H,[r("table",L,[e[6]||(e[6]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u5E74\u65B0\u7B7E\u5408\u540C\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165\u5B8C\u6210\u7387")])],-1)),r("tbody",null,[(_(!0),g(O,null,S(n.value.customers,(o,a)=>(_(),g("tr",{key:`customer-${a}`},[a===0?(_(),g("td",{key:0,rowspan:n.value.customers.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,G)):M("",!0),r("td",z,s(o.customerName),1),r("td",K,s(p(o.newContractTotal)),1),r("td",Q,[F(r("input",{"onUpdate:modelValue":N=>o.current=N,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,W),[[v,o.current]])]),r("td",X,s(p(o.accumulated)),1),r("td",Y,[r("span",Z,s(D(o.newContractTotal,o.accumulated))+"%",1)])]))),128)),r("tr",P,[e[5]||(e[5]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",tt,s(p(i.value.newContractTotal)),1),r("td",et,s(p(i.value.current)),1),r("td",rt,s(p(i.value.accumulated)),1),r("td",ot,[r("span",ut,s(i.value.completionRate)+"%",1)])])])])]),k($,{"module-id":I(x).NANHUA_ORDER_TO_INCOME,period:u.value,remarks:l.value,"onUpdate:remarks":e[1]||(e[1]=o=>l.value=o),suggestions:d.value,"onUpdate:suggestions":e[2]||(e[2]=o=>d.value=o)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:C,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:w,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var lt=R(at,[["__scopeId","data-v-2f4c2bfc"]]);export{lt as default};
