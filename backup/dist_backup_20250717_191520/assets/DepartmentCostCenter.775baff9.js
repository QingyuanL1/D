import{_ as M,d as N,r as c,B as D,o as $,b as m,e as u,y as B,A as R,F as U,g as V,t as d,k as j,h as q,G,v as C}from"./index.23f10bf8.js";import{_ as L,l as Y,M as P,r as J}from"./FormAttachmentAndRemarks.dc758b91.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},H={class:"flex justify-between items-center mb-6"},K={class:"flex items-center space-x-4"},Q={class:"overflow-x-auto my-6"},W={class:"w-full border-collapse border border-gray-300"},X={class:"border border-gray-300 px-4 py-2"},Z={class:"border border-gray-300 px-4 py-2"},tt={class:"w-full px-2 py-1"},et={class:"border border-gray-300 px-4 py-2"},ut=["onUpdate:modelValue"],rt={class:"border border-gray-300 px-4 py-2"},ot={class:"font-medium"},at={class:"border border-gray-300 px-4 py-2"},st={class:"w-full px-2 py-1"},nt={class:"border border-gray-300 px-4 py-2"},lt={class:"w-full px-2 py-1"},dt={class:"border border-gray-300 px-4 py-2"},ct={class:"w-full px-2 py-1"},pt={class:"bg-gray-50 font-bold"},it={class:"border border-gray-300 px-4 py-2"},gt={class:"w-full px-2 py-1 font-bold"},yt={class:"border border-gray-300 px-4 py-2"},bt={class:"border border-gray-300 px-4 py-2"},Et={class:"w-full px-2 py-1 font-bold"},_t={class:"border border-gray-300 px-4 py-2"},xt={class:"w-full px-2 py-1 font-bold"},ft={class:"border border-gray-300 px-4 py-2"},Dt={class:"w-full px-2 py-1 font-bold"},Tt={class:"border border-gray-300 px-4 py-2"},vt={class:"w-full px-2 py-1 font-bold"},Ft=N({__name:"DepartmentCostCenter",setup(ht){var A;const b=G(),s=c(((A=b.query.period)==null?void 0:A.toString())||new Date().toISOString().slice(0,7)),p=c(""),i=c(""),E=()=>[{department:"\u603B\u7ECF\u7406\u5BA4",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u4F01\u7BA1\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u8D22\u52A1\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u9500\u552E\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u5E02\u573A\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u8425\u8FD0\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u7814\u6280\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"C-GIS \u4E8B\u4E1A\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"},{department:"\u5DE5\u7A0B\u4E8B\u4E1A\u90E8",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"}],_=()=>({department:"\u5408\u8BA1",yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"}),n=c(E()),a=c(_()),T=c([]),v=async r=>{try{const t=[],e=r.substring(0,4),o=parseInt(r.substring(5,7));for(let l=1;l<o;l++){const y=`${e}-${l.toString().padStart(2,"0")}`;try{const f=await fetch(`http://47.111.95.19:3000/department-cost-center/${y}`);if(f.ok){const h=await f.json();h.success&&h.data&&t.push({period:y,data:h.data})}}catch(f){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${y}:`,f)}}T.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},O=r=>{let t=0;if(r==="\u5408\u8BA1"){for(const e of T.value)if(e.data.departments)for(const o of e.data.departments)o.currentPeriod&&(t+=parseFloat(o.currentPeriod)||0);for(const e of n.value)e.currentPeriod&&(t+=parseFloat(e.currentPeriod)||0)}else{for(const o of T.value){const l=o.data.departments.find(y=>y.department===r);l&&l.currentPeriod&&(t+=parseFloat(l.currentPeriod)||0)}const e=n.value.find(o=>o.department===r);e&&e.currentPeriod&&(t+=parseFloat(e.currentPeriod)||0)}return t.toString()},w=(r,t)=>{const e=parseFloat(r)||0,o=parseFloat(t)||0;return o===0?"0%":(e/o*100).toFixed(2)+"%"},g=()=>{n.value.forEach(t=>{t.currentTotal=O(t.department),t.executionProgress=w(t.currentTotal,t.yearlyBudget),t.budgetToOutputRatio="0%",t.actualToOutputRatio="0%"}),a.value.currentTotal=O("\u5408\u8BA1");const r=n.value.reduce((t,e)=>t+(parseFloat(e.yearlyBudget)||0),0);a.value.yearlyBudget=r.toString(),a.value.executionProgress=w(a.value.currentTotal,a.value.yearlyBudget),a.value.budgetToOutputRatio="0%",a.value.actualToOutputRatio="0%"},S=(r,t)=>!Array.isArray(t)||t.length===0?r:r.map(e=>{const o=t.find(l=>l.department===e.department);return o?{department:e.department,yearlyBudget:o.yearlyBudget||"0",currentPeriod:o.currentPeriod||"0",currentTotal:o.currentTotal||"0",executionProgress:o.executionProgress||"0%",budgetToOutputRatio:o.budgetToOutputRatio||"0%",actualToOutputRatio:o.actualToOutputRatio||"0%"}:{department:e.department,yearlyBudget:"0",currentPeriod:"0",currentTotal:"0",executionProgress:"0%",budgetToOutputRatio:"0%",actualToOutputRatio:"0%"}}),x=async r=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u90E8\u95E8\u6210\u672C\u4E2D\u5FC3\u6570\u636E\uFF0C\u671F\u95F4: ${r}`);const t=await fetch(`http://47.111.95.19:3000/department-cost-center/${r}`);if(!t.ok){if(t.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),n.value=E(),a.value=_(),await v(r),g();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const e=await t.json();console.log("API\u8FD4\u56DE\u6570\u636E:",e),e.success&&e.data&&(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."),e.data.departments&&(n.value=S(E(),e.data.departments)),e.data.total&&(a.value={..._(),...e.data.total}),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{departmentData:n.value,totalRow:a.value})),await v(r),g()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t);try{await v(r),g()}catch(e){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",e)}}},F=async()=>{const{remarks:r,suggestions:t}=await Y(P.DEPARTMENT_COST_CENTER,s.value);p.value=r,i.value=t};D(()=>b.query.period,r=>{r&&(s.value=r.toString(),x(r.toString()),F())}),D(s,r=>{x(r),F()}),D(n,()=>{g()},{deep:!0}),D(a,()=>{g()},{deep:!0});const k=async()=>{try{const r={departments:n.value,total:a.value};console.log("\u4FDD\u5B58\u6570\u636E:",{period:s.value,data:r});const t=await fetch("http://47.111.95.19:3000/department-cost-center",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:r})});if(!t.ok){const e=await t.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${t.status} - ${e}`)}await J(P.DEPARTMENT_COST_CENTER,s.value,r,p.value,i.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(r){console.error("\u4FDD\u5B58\u5931\u8D25:",r),alert("\u4FDD\u5B58\u5931\u8D25: "+(r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"))}},I=()=>{n.value=E(),a.value=_(),p.value="",i.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return $(()=>{console.log("\u90E8\u95E8\u6210\u672C\u4E2D\u5FC3\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",s.value),b.query.period?x(b.query.period.toString()):x(s.value),F()}),(r,t)=>(C(),m("div",z,[u("div",H,[t[4]||(t[4]=u("h1",{class:"text-2xl font-bold"},"\u90E8\u95E8\u6210\u672C\u4E2D\u5FC3\u5B9E\u9645\u53D1\u751F\u60C5\u51B5",-1)),u("div",K,[B(u("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>s.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[R,s.value]])])]),u("div",Q,[u("table",W,[t[6]||(t[6]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u90E8\u95E8\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u9884\u7B97"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u9884\u7B97\u5360\u4EA7\u503C\u6BD4"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5B9E\u9645\u5360\u4EA7\u503C\u6BD4")])],-1)),u("tbody",null,[(C(!0),m(U,null,V(n.value,(e,o)=>(C(),m("tr",{key:o},[u("td",X,d(e.department),1),u("td",Z,[u("span",tt,d(e.yearlyBudget),1)]),u("td",et,[B(u("input",{"onUpdate:modelValue":l=>e.currentPeriod=l,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,ut),[[R,e.currentPeriod]])]),u("td",rt,[u("span",ot,d(e.currentTotal),1)]),u("td",at,[u("span",st,d(e.executionProgress),1)]),u("td",nt,[u("span",lt,d(e.budgetToOutputRatio),1)]),u("td",dt,[u("span",ct,d(e.actualToOutputRatio),1)])]))),128)),u("tr",pt,[t[5]||(t[5]=u("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u("td",it,[u("span",gt,d(a.value.yearlyBudget),1)]),u("td",yt,[B(u("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>a.value.currentPeriod=e),type:"text",class:"w-full px-2 py-1 border rounded font-bold"},null,512),[[R,a.value.currentPeriod]])]),u("td",bt,[u("span",Et,d(a.value.currentTotal),1)]),u("td",_t,[u("span",xt,d(a.value.executionProgress),1)]),u("td",ft,[u("span",Dt,d(a.value.budgetToOutputRatio),1)]),u("td",Tt,[u("span",vt,d(a.value.actualToOutputRatio),1)])])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:k,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:I,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),j(L,{"module-id":q(P).DEPARTMENT_COST_CENTER,period:s.value,remarks:p.value,"onUpdate:remarks":t[2]||(t[2]=e=>p.value=e),suggestions:i.value,"onUpdate:suggestions":t[3]||(t[3]=e=>i.value=e)},null,8,["module-id","period","remarks","suggestions"])]))}});var Rt=M(Ft,[["__scopeId","data-v-4f817561"]]);export{Rt as default};
