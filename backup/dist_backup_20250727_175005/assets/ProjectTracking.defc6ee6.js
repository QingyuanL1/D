import{_ as z,d as Y,r as b,h as S,B as $,o as K,c as y,a as o,y as _,A as E,F as j,l as q,t as d,b as Q,m as W,G as X,f as p,k as N}from"./index.3ed95e87.js";import{M as Z,_ as ee,r as re,l as te}from"./FormAttachmentAndRemarks.1f80b5db.js";const ue={class:"project-tracking-container"},oe={class:"mx-auto bg-white rounded-lg shadow-lg"},ae={class:"p-6 border-b border-gray-200"},ne={class:"flex justify-between items-center"},se={class:"flex items-center space-x-4"},le={class:"p-6"},ce={class:"overflow-x-auto rounded-lg border border-gray-300"},de={class:"w-full border-collapse text-base"},ie=["rowspan"],ye={class:"border border-gray-300 px-4 py-2 text-center"},pe={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},ge={class:"border border-gray-300 px-4 py-2 text-right"},be=["onUpdate:modelValue"],me={class:"border border-gray-300 px-4 py-2 text-right"},he=["rowspan"],ve={class:"border border-gray-300 px-4 py-2 text-center"},De={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},xe={class:"border border-gray-300 px-4 py-2 text-right"},Fe=["onUpdate:modelValue"],Te={class:"border border-gray-300 px-4 py-2 text-right"},Pe=["rowspan"],_e={class:"border border-gray-300 px-4 py-2 text-center"},Ee={class:"border border-gray-300 px-4 py-2 text-right bg-gray-50"},fe={class:"border border-gray-300 px-4 py-2 text-right"},Ce=["onUpdate:modelValue"],Be={class:"border border-gray-300 px-4 py-2 text-right"},Ae={class:"bg-gray-50 font-bold"},we={class:"border border-gray-300 px-4 py-2 text-right"},ke={class:"border border-gray-300 px-4 py-2 text-right"},Se={class:"border border-gray-300 px-4 py-2 text-right"},$e=Y({__name:"ProjectTracking",setup(je){var R;const U=X(),i=b(((R=U.query.period)==null?void 0:R.toString())||new Date().toISOString().slice(0,7)),f=Z.PROJECT_TRACKING,v=b(""),D=b(""),x=()=>[{customerType:"\u4E0A\u6D77",yearlyPlan:5e5,currentPeriod:0,currentTotal:0},{customerType:"\u56FD\u7F51",yearlyPlan:105e4,currentPeriod:0,currentTotal:0},{customerType:"\u6C5F\u82CF",yearlyPlan:3e5,currentPeriod:0,currentTotal:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",yearlyPlan:0,currentPeriod:0,currentTotal:0},{customerType:"\u897F\u95E8\u5B50",yearlyPlan:0,currentPeriod:0,currentTotal:0},{customerType:"\u540C\u4E1A",yearlyPlan:0,currentPeriod:0,currentTotal:0},{customerType:"\u7528\u6237",yearlyPlan:2e4,currentPeriod:0,currentTotal:0},{customerType:"\u5176\u5B83",yearlyPlan:0,currentPeriod:0,currentTotal:0}],F=()=>[{customerType:"\u7528\u6237",yearlyPlan:0,currentPeriod:0,currentTotal:0}],T=()=>[{customerType:"\u4E00\u5305",yearlyPlan:15e4,currentPeriod:0,currentTotal:0},{customerType:"\u4E8C\u5305",yearlyPlan:600,currentPeriod:0,currentTotal:0},{customerType:"\u57DF\u5185\u5408\u4F5C",yearlyPlan:95e3,currentPeriod:0,currentTotal:0},{customerType:"\u57DF\u5916\u5408\u4F5C",yearlyPlan:5e3,currentPeriod:0,currentTotal:0},{customerType:"\u5176\u5B83",yearlyPlan:2e3,currentPeriod:0,currentTotal:0}],s=b(x()),l=b(F()),c=b(T()),O=S(()=>[...s.value,...l.value,...c.value].reduce((e,r)=>e+(r.yearlyPlan||0),0)),M=S(()=>[...s.value,...l.value,...c.value].reduce((e,r)=>e+(r.currentPeriod||0),0)),J=S(()=>[...s.value,...l.value,...c.value].reduce((e,r)=>e+(r.currentTotal||0),0)),V=b([]),I=async e=>{try{const r=[],t=e.substring(0,4),u=parseInt(e.substring(5,7));for(let n=1;n<u;n++){const a=`${t}-${n.toString().padStart(2,"0")}`;try{const g=await fetch(`http://47.111.95.19:3000/project-tracking/${a}`);if(g.ok){const h=await g.json();h.success&&h.data&&r.push({period:a,data:h.data})}}catch(g){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${a}:`,g)}}V.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(r){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",r)}},C=(e,r)=>{let t=0;for(const a of V.value)if(a.data[e]){const g=a.data[e].find(h=>h.customerType===r);g&&g.currentPeriod&&(t+=parseFloat(g.currentPeriod.toString())||0)}let u=[];e==="equipment"?u=s.value:e==="component"?u=l.value:e==="engineering"&&(u=c.value);const n=u.find(a=>a.customerType===r);return n&&n.currentPeriod&&(t+=parseFloat(n.currentPeriod.toString())||0),t},B=()=>{s.value.forEach(e=>{const r=C("equipment",e.customerType);e.currentTotal=r}),l.value.forEach(e=>{const r=C("component",e.customerType);e.currentTotal=r}),c.value.forEach(e=>{const r=C("engineering",e.customerType);e.currentTotal=r})},P=(e,r)=>!r||r===0?"0.00%":`${(e/r*100).toFixed(2)}%`,A=(e,r)=>!r||r===0?0:e/r*100,m=e=>e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),w=(e,r)=>e.map(t=>{const u=r.find(n=>n.customerType===t.customerType);return u?(console.log(`\u5339\u914D\u6210\u529F: ${t.customerType} -> \u5F53\u671F: ${u.currentPeriod}`),{customerType:t.customerType,yearlyPlan:t.yearlyPlan,currentPeriod:Number(u.currentPeriod)||0,currentTotal:0}):(console.log(`\u672A\u5339\u914D\u5230\u6570\u636E: ${t.customerType}`),t)}),k=async e=>{try{const r=`http://47.111.95.19:3000/project-tracking/${e}`;console.log(`\u6B63\u5728\u52A0\u8F7D\u671F\u95F4 ${e} \u7684\u6570\u636E...`),console.log(`API URL: ${r}`);const t=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("HTTP\u54CD\u5E94\u72B6\u6001:",t.status),console.log("HTTP\u54CD\u5E94\u5934:",Object.fromEntries(t.headers.entries())),!t.ok){if(t.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),s.value=x(),l.value=F(),c.value=T(),await I(e),B();return}const n=await t.text();throw console.error(`HTTP\u9519\u8BEF ${t.status}:`,n),new Error(`\u52A0\u8F7D\u6570\u636E\u5931\u8D25: ${t.status} - ${n}`)}const u=await t.json();console.log("API\u8FD4\u56DE\u7684\u5B8C\u6574\u6570\u636E:",JSON.stringify(u,null,2)),u.success&&u.data?(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5904\u7406..."),u.data.equipment&&Array.isArray(u.data.equipment)&&u.data.equipment.length>0&&(console.log("\u5904\u7406\u8BBE\u5907\u6570\u636E:",u.data.equipment),s.value=w(x(),u.data.equipment)),u.data.component&&Array.isArray(u.data.component)&&u.data.component.length>0&&(console.log("\u5904\u7406\u5143\u4EF6\u6570\u636E:",u.data.component),l.value=w(F(),u.data.component)),u.data.engineering&&Array.isArray(u.data.engineering)&&u.data.engineering.length>0&&(console.log("\u5904\u7406\u5DE5\u7A0B\u6570\u636E:",u.data.engineering),c.value=w(T(),u.data.engineering)),console.log("\u6570\u636E\u52A0\u8F7D\u5B8C\u6210\uFF01\u6700\u7EC8\u7ED3\u679C:"),console.log("equipmentData:",JSON.stringify(s.value,null,2)),console.log("componentData:",JSON.stringify(l.value,null,2)),console.log("engineeringData:",JSON.stringify(c.value,null,2))):console.log("API\u8FD4\u56DE\u683C\u5F0F\u4E0D\u6B63\u786E:",u),await I(e),B()}catch(r){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",r)}};$(()=>[s.value.map(e=>e.currentPeriod),l.value.map(e=>e.currentPeriod),c.value.map(e=>e.currentPeriod)],()=>{B()},{deep:!0}),$(i,e=>{k(e)}),$(()=>U.query.period,e=>{e&&(i.value=e.toString(),k(e.toString()))});const L=async()=>{try{const e=s.value.map(a=>({customer:a.customerType||"",yearlyPlan:a.yearlyPlan||0,currentPeriod:a.currentPeriod||0,currentTotal:a.currentTotal||0,progress:A(a.currentTotal||0,a.yearlyPlan||0)})),r=l.value.map(a=>({customer:a.customerType||"",yearlyPlan:a.yearlyPlan||0,currentPeriod:a.currentPeriod||0,currentTotal:a.currentTotal||0,progress:A(a.currentTotal||0,a.yearlyPlan||0)})),t=c.value.map(a=>({customer:a.customerType||"",yearlyPlan:a.yearlyPlan||0,currentPeriod:a.currentPeriod||0,currentTotal:a.currentTotal||0,progress:A(a.currentTotal||0,a.yearlyPlan||0)})),u={period:i.value,data:{equipment:e,component:r,engineering:t}};console.log("\u4FDD\u5B58\u6570\u636E:",u);const n=await fetch("http://47.111.95.19:3000/project-tracking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!n.ok){const a=await n.text();throw new Error(`\u4FDD\u5B58\u5230project_tracking\u8868\u5931\u8D25: ${n.status} - ${a}`)}await re(f,i.value,u.data,v.value,D.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},G=()=>{s.value=x(),l.value=F(),c.value=T(),console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},H=async()=>{const{remarks:e,suggestions:r}=await te(f,i.value);v.value=e,D.value=r};return K(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",i.value),k(i.value),H()}),(e,r)=>(p(),y("div",ue,[o("div",oe,[o("div",ae,[o("div",ne,[r[3]||(r[3]=o("h1",{class:"text-2xl font-bold"},"\u9879\u76EE\u8DDF\u8E2A\u60C5\u51B5(\u4E3B\u8868)\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09:",-1)),o("div",se,[_(o("input",{"onUpdate:modelValue":r[0]||(r[0]=t=>i.value=t),type:"month",class:"px-4 py-2 border rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[E,i.value]])])])]),o("div",le,[o("div",ce,[o("table",de,[r[5]||(r[5]=o("thead",{class:"sticky top-0 bg-white shadow-sm z-10"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u677F\u5757 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u5BA2\u6237\u5C5E\u6027 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u5E74\u5EA6\u8BA1\u5212 "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u5F53\u671F "),o("th",{class:"border border-gray-300 px-4 py-3 text-center font-semibold text-gray-600"}," \u6267\u884C\u8FDB\u5EA6 ")])],-1)),o("tbody",null,[(p(!0),y(j,null,q(s.value,(t,u)=>(p(),y("tr",{key:`equipment-${u}`},[u===0?(p(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:s.value.length}," \u8BBE\u5907 ",8,ie)):N("",!0),o("td",ye,d(t.customerType),1),o("td",pe,d(m(t.yearlyPlan)),1),o("td",ge,[_(o("input",{"onUpdate:modelValue":n=>t.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,be),[[E,t.currentPeriod,void 0,{number:!0}]])]),o("td",me,d(P(t.currentTotal,t.yearlyPlan)),1)]))),128)),(p(!0),y(j,null,q(l.value,(t,u)=>(p(),y("tr",{key:`component-${u}`},[u===0?(p(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:l.value.length}," \u5143\u4EF6 ",8,he)):N("",!0),o("td",ve,d(t.customerType),1),o("td",De,d(m(t.yearlyPlan)),1),o("td",xe,[_(o("input",{"onUpdate:modelValue":n=>t.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Fe),[[E,t.currentPeriod,void 0,{number:!0}]])]),o("td",Te,d(P(t.currentTotal,t.yearlyPlan)),1)]))),128)),(p(!0),y(j,null,q(c.value,(t,u)=>(p(),y("tr",{key:`engineering-${u}`},[u===0?(p(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:c.value.length}," \u5DE5\u7A0B ",8,Pe)):N("",!0),o("td",_e,d(t.customerType),1),o("td",Ee,d(m(t.yearlyPlan)),1),o("td",fe,[_(o("input",{"onUpdate:modelValue":n=>t.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ce),[[E,t.currentPeriod,void 0,{number:!0}]])]),o("td",Be,d(P(t.currentTotal,t.yearlyPlan)),1)]))),128)),o("tr",Ae,[r[4]||(r[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",we,d(m(O.value)),1),o("td",ke,d(m(M.value)),1),o("td",Se,d(P(J.value,O.value)),1)])])])])]),o("div",{class:"p-6 border-t border-gray-200"},[o("div",{class:"flex justify-end space-x-4"},[o("button",{onClick:L,class:"px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"}," \u4FDD\u5B58 "),o("button",{onClick:G,class:"px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"}," \u91CD\u7F6E ")])]),Q(ee,{"module-id":W(f),period:i.value,remarks:v.value,"onUpdate:remarks":r[1]||(r[1]=t=>v.value=t),suggestions:D.value,"onUpdate:suggestions":r[2]||(r[2]=t=>D.value=t)},null,8,["module-id","period","remarks","suggestions"])])]))}});var Ue=z($e,[["__scopeId","data-v-67c6e4a3"]]);export{Ue as default};
