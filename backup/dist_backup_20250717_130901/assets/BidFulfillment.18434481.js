import{_ as R,d as z,r as b,c as G,B as v,o as J,b as d,e as r,y as E,A as C,F as k,g as S,t as s,k as Y,h as H,G as K,v as m,f as N}from"./index.6c7f5ea0.js";import{_ as Q,M as $,r as W}from"./FormAttachmentAndRemarks.5e1970ec.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Z={class:"flex justify-between items-center mb-6"},P={class:"flex items-center space-x-4"},uu={class:"overflow-x-auto my-6"},tu={class:"w-full border-collapse border border-gray-300"},eu=["rowspan"],ru={class:"border border-gray-300 px-4 py-2"},ou={class:"border border-gray-300 px-4 py-2 text-right"},nu={class:"border border-gray-300 px-4 py-2"},su=["onUpdate:modelValue"],au={class:"border border-gray-300 px-4 py-2 text-right"},cu={class:"font-medium"},iu={class:"border border-gray-300 px-4 py-2 text-right"},lu=["rowspan"],pu={class:"border border-gray-300 px-4 py-2"},du={class:"border border-gray-300 px-4 py-2 text-right"},mu={class:"border border-gray-300 px-4 py-2"},yu=["onUpdate:modelValue"],bu={class:"border border-gray-300 px-4 py-2 text-right"},Au={class:"font-medium"},Fu={class:"border border-gray-300 px-4 py-2 text-right"},gu=["rowspan"],hu={class:"border border-gray-300 px-4 py-2"},_u={class:"border border-gray-300 px-4 py-2 text-right"},Du={class:"border border-gray-300 px-4 py-2"},vu=["onUpdate:modelValue"],fu={class:"border border-gray-300 px-4 py-2 text-right"},xu={class:"font-medium"},Eu={class:"border border-gray-300 px-4 py-2 text-right"},Cu={class:"bg-gray-50 font-bold"},Bu={class:"border border-gray-300 px-4 py-2 text-right"},qu={class:"border border-gray-300 px-4 py-2 text-right"},Tu={class:"border border-gray-300 px-4 py-2 text-right"},ju={class:"border border-gray-300 px-4 py-2 text-right"},wu=z({__name:"BidFulfillment",setup(ku){var L;const A=K(),c=b(((L=A.query.period)==null?void 0:L.toString())||new Date().toISOString().slice(0,7)),h=b(""),_=b(""),a={equipment:{\u4E0A\u6D77:31055.26,\u56FD\u7F51:2798.76,\u6C5F\u82CF:5085.93,\u8F93\u914D\u7535\u5185\u914D:0,\u897F\u95E8\u5B50:0,\u540C\u4E1A:0,\u7528\u6237:0,\u5176\u5B83:0},component:{\u7528\u6237:0},project:{\u4E00\u5305:8281.13,\u4E8C\u5305:444.83,\u57DF\u5185\u5408\u4F5C:702.04,\u57DF\u5916\u5408\u4F5C:0,\u5176\u5B83:21.93}},B=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialAmount:a.equipment.\u4E0A\u6D77,currentAmount:0},{customerType:"\u56FD\u7F51",initialAmount:a.equipment.\u56FD\u7F51,currentAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:a.equipment.\u6C5F\u82CF,currentAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:a.equipment.\u8F93\u914D\u7535\u5185\u914D,currentAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:a.equipment.\u897F\u95E8\u5B50,currentAmount:0},{customerType:"\u540C\u4E1A",initialAmount:a.equipment.\u540C\u4E1A,currentAmount:0},{customerType:"\u7528\u6237",initialAmount:a.equipment.\u7528\u6237,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:a.equipment.\u5176\u5B83,currentAmount:0}],component:[{customerType:"\u7528\u6237",initialAmount:a.component.\u7528\u6237,currentAmount:0}],project:[{customerType:"\u4E00\u5305",initialAmount:a.project.\u4E00\u5305,currentAmount:0},{customerType:"\u4E8C\u5305",initialAmount:a.project.\u4E8C\u5305,currentAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:a.project.\u57DF\u5185\u5408\u4F5C,currentAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:a.project.\u57DF\u5916\u5408\u4F5C,currentAmount:0},{customerType:"\u5176\u5B83",initialAmount:a.project.\u5176\u5B83,currentAmount:0}]}),M=(u,e)=>(!e||typeof e!="object"||(e.equipment&&Array.isArray(e.equipment)&&(u.equipment=u.equipment.map(t=>{const o=e.equipment.find(n=>n.customerType===t.customerType);return o?{...t,initialAmount:t.initialAmount,currentAmount:Number(o.currentAmount)||0}:t})),e.component&&Array.isArray(e.component)&&(u.component=u.component.map(t=>{const o=e.component.find(n=>n.customerType===t.customerType);return o?{...t,initialAmount:t.initialAmount,currentAmount:Number(o.currentAmount)||0}:t})),e.project&&Array.isArray(e.project)&&(u.project=u.project.map(t=>{const o=e.project.find(n=>n.customerType===t.customerType);return o?{...t,initialAmount:t.initialAmount,currentAmount:Number(o.currentAmount)||0}:t}))),u),U=()=>{const u=B();i.value=u.equipment,l.value=u.component,p.value=u.project},i=b([]),l=b([]),p=b([]),V=b([]),q=async u=>{try{const e=[],t=u.substring(0,4),o=parseInt(u.substring(5,7));for(let n=1;n<o;n++){const j=`${t}-${n.toString().padStart(2,"0")}`;try{const x=await fetch(`http://47.111.95.19:3000/bid-fulfillment/${j}`);if(x.ok){const w=await x.json();w.success&&w.data&&e.push({period:j,data:w.data})}}catch(x){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${j}:`,x)}}V.value=e,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",e)}catch(e){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",e)}},T=()=>{},f=(u,e)=>u===0?"0.00":((e-u)/u*100).toFixed(2),y=u=>isNaN(u)||u===null||u===void 0?"0.00":u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),D=G(()=>{const u={initialAmount:0,currentAmount:0};return i.value.forEach(e=>{u.initialAmount+=Number(e.initialAmount)||0,u.currentAmount+=Number(e.currentAmount)||0}),l.value.forEach(e=>{u.initialAmount+=Number(e.initialAmount)||0,u.currentAmount+=Number(e.currentAmount)||0}),p.value.forEach(e=>{u.initialAmount+=Number(e.initialAmount)||0,u.currentAmount+=Number(e.currentAmount)||0}),u}),F=async u=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${$.BID_FULFILLMENT}/${u}`);if(e.ok){const t=await e.json();t.success&&t.data&&(h.value=t.data.remarks||"",_.value=t.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",e)}},g=async u=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u6807\u4E66\u5C65\u7EA6\u72B6\u51B5\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const e=await fetch(`http://47.111.95.19:3000/bid-fulfillment/${u}`);if(!e.ok){if(e.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u521D\u59CB\u5316");const o=B();i.value=o.equipment,l.value=o.component,p.value=o.project,await q(u),T();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const t=await e.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",t),t.success&&t.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const o=B(),n=M(o,t.data);i.value=n.equipment,l.value=n.component,p.value=n.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:i.value,componentData:l.value,projectData:p.value})}await q(u),T()}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),U();try{await q(u),T()}catch(t){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",t)}}};v(()=>A.query.period,u=>{u&&(c.value=u.toString(),g(u.toString()),F(u.toString()))}),v(c,(u,e)=>{u&&u!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${u}`),g(u),F(u))});const I=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/bid-fulfillment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:{equipment:i.value,component:l.value,project:p.value}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await W($.BID_FULFILLMENT,c.value,{equipment:i.value,component:l.value,project:p.value},h.value,_.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25")}},O=()=>{U(),h.value="",_.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return v(()=>A.query.period,u=>{u&&(c.value=u.toString(),g(u.toString()),F(u.toString()))}),v(c,u=>{g(u),F(u)}),v([i,l,p],()=>{},{deep:!0}),J(()=>{console.log("\u6807\u4E66\u5C65\u7EA6\u72B6\u51B5\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",c.value),A.query.period?(g(A.query.period.toString()),F(A.query.period.toString())):(g(c.value),F(c.value))}),(u,e)=>(m(),d("div",X,[r("div",Z,[e[3]||(e[3]=r("h1",{class:"text-2xl font-bold"},"\u4E2D\u6807\u672A\u5C65\u7EA6\u60C5\u51B5\uFF08\u4E2D\u6807\u6807\u5305\u5C65\u7EA6\u7387\u8BE6\u89C1\u516C\u53F8\u9644\u8868\uFF09",-1)),r("div",P,[E(r("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,c.value]])])]),r("div",uu,[r("table",tu,[e[5]||(e[5]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u671F\u521D\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),r("tbody",null,[(m(!0),d(k,null,S(i.value,(t,o)=>(m(),d("tr",{key:`equipment-${o}`},[o===0?(m(),d("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u8BBE\u5907 ",8,eu)):N("",!0),r("td",ru,s(t.customerType),1),r("td",ou,[r("span",null,s(y(t.initialAmount)),1)]),r("td",nu,[E(r("input",{"onUpdate:modelValue":n=>t.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,su),[[C,t.currentPeriod,void 0,{number:!0}]])]),r("td",au,[r("span",cu,s(y(t.currentAmount)),1)]),r("td",iu,s(f(t.initialAmount,t.currentAmount||0))+"% ",1)]))),128)),(m(!0),d(k,null,S(l.value,(t,o)=>(m(),d("tr",{key:`component-${o}`},[o===0?(m(),d("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u5143\u4EF6 ",8,lu)):N("",!0),r("td",pu,s(t.customerType),1),r("td",du,[r("span",null,s(y(t.initialAmount)),1)]),r("td",mu,[E(r("input",{"onUpdate:modelValue":n=>t.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,yu),[[C,t.currentPeriod,void 0,{number:!0}]])]),r("td",bu,[r("span",Au,s(y(t.currentAmount)),1)]),r("td",Fu,s(f(t.initialAmount,t.currentAmount||0))+"% ",1)]))),128)),(m(!0),d(k,null,S(p.value,(t,o)=>(m(),d("tr",{key:`project-${o}`},[o===0?(m(),d("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5DE5\u7A0B ",8,gu)):N("",!0),r("td",hu,s(t.customerType),1),r("td",_u,[r("span",null,s(y(t.initialAmount)),1)]),r("td",Du,[E(r("input",{"onUpdate:modelValue":n=>t.currentPeriod=n,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,vu),[[C,t.currentPeriod,void 0,{number:!0}]])]),r("td",fu,[r("span",xu,s(y(t.currentAmount)),1)]),r("td",Eu,s(f(t.initialAmount,t.currentAmount||0))+"% ",1)]))),128)),r("tr",Cu,[e[4]||(e[4]=r("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),r("td",Bu,s(y(D.value.initialAmount)),1),r("td",qu,s(y(D.value.currentPeriod)),1),r("td",Tu,s(y(D.value.currentAmount)),1),r("td",ju,s(f(D.value.initialAmount,D.value.currentAmount))+"% ",1)])])])]),Y(Q,{"module-id":H($).BID_FULFILLMENT,period:c.value,remarks:h.value,"onUpdate:remarks":e[1]||(e[1]=t=>h.value=t),suggestions:_.value,"onUpdate:suggestions":e[2]||(e[2]=t=>_.value=t)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:O,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var $u=R(wu,[["__scopeId","data-v-3773cb68"]]);export{$u as default};
