import{_ as G,d as z,r as v,B as S,c as H,o as K,b as i,e as t,y as B,A as C,F as q,g as $,t as a,k as Q,h as W,G as X,v as m,f as M}from"./index.5ce2e658.js";import{_ as Z,l as P,M as T,r as ee}from"./FormAttachmentAndRemarks.43efd424.js";const oe={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},re={class:"flex justify-between items-center mb-6"},te={class:"flex items-center space-x-4"},ue={class:"overflow-x-auto my-6"},ne={class:"w-full border-collapse border border-gray-300"},se=["rowspan"],ae={class:"border border-gray-300 px-4 py-2"},ce={class:"border border-gray-300 px-4 py-2"},de={class:"border border-gray-300 px-4 py-2"},le=["onUpdate:modelValue"],ie={class:"border border-gray-300 px-4 py-2"},me={class:"font-medium"},pe={class:"border border-gray-300 px-4 py-2"},ge=["rowspan"],ye={class:"border border-gray-300 px-4 py-2"},be={class:"border border-gray-300 px-4 py-2"},Ee={class:"border border-gray-300 px-4 py-2"},fe=["onUpdate:modelValue"],Fe={class:"border border-gray-300 px-4 py-2"},he={class:"font-medium"},_e={class:"border border-gray-300 px-4 py-2"},De=["rowspan"],ve={class:"border border-gray-300 px-4 py-2"},xe={class:"border border-gray-300 px-4 py-2"},Oe={class:"border border-gray-300 px-4 py-2"},Ie=["onUpdate:modelValue"],Be={class:"border border-gray-300 px-4 py-2"},Ce={class:"font-medium"},Te={class:"border border-gray-300 px-4 py-2"},we={class:"bg-gray-50 font-bold"},Re={class:"border border-gray-300 px-4 py-2"},Ae={class:"border border-gray-300 px-4 py-2"},ke={class:"border border-gray-300 px-4 py-2"},Se={class:"border border-gray-300 px-4 py-2"},qe=z({__name:"OrderToIncome",setup($e){var V;const f=X(),p=v(((V=f.query.period)==null?void 0:V.toString())||new Date().toISOString().slice(0,7)),F=v(""),h=v(""),_=()=>({equipment:[{customer:"\u4E0A\u6D77",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u56FD\u7F51",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u6C5F\u82CF",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u8F93\u914D\u7535\u5185\u914D",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u897F\u95E8\u5B50",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u540C\u4E1A",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u7528\u6237",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u5176\u5B83",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0}],components:[{customer:"\u7528\u6237",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0}],engineering:[{customer:"\u4E00\u5305",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u4E8C\u5305",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u57DF\u5185\u5408\u4F5C",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u57DF\u5916\u5408\u4F5C",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0},{customer:"\u5176\u5B83",signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0}]}),J=(e,r)=>{const o=JSON.parse(JSON.stringify(e));return r.equipment&&o.equipment.forEach((s,u)=>{r.equipment[u]&&Object.assign(s,r.equipment[u])}),r.components&&o.components.forEach((s,u)=>{r.components[u]&&Object.assign(s,r.components[u])}),r.engineering&&o.engineering.forEach((s,u)=>{r.engineering[u]&&Object.assign(s,r.engineering[u])}),o},n=v(_()),N=v([]),w=e=>e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),U=async e=>{try{const r=e.substring(0,4),o=parseInt(e.substring(5,7)),s={\u4E0A\u6D77\u9879\u76EE:"\u4E0A\u6D77",\u56FD\u7F51\u9879\u76EE:"\u56FD\u7F51",\u6C5F\u82CF\u9879\u76EE:"\u6C5F\u82CF",\u8F93\u914D\u7535\u5185\u914D:"\u8F93\u914D\u7535\u5185\u914D",\u897F\u95E8\u5B50\u9879\u76EE:"\u897F\u95E8\u5B50",\u540C\u4E1A\u9879\u76EE:"\u540C\u4E1A",\u7528\u6237\u9879\u76EE:"\u7528\u6237",\u5176\u5B83\u9879\u76EE:"\u5176\u5B83",\u4E00\u5305\u9879\u76EE:"\u4E00\u5305",\u4E8C\u5305\u9879\u76EE:"\u4E8C\u5305",\u57DF\u5185\u5408\u4F5C\u9879\u76EE:"\u57DF\u5185\u5408\u4F5C",\u57DF\u5916\u5408\u4F5C\u9879\u76EE:"\u57DF\u5916\u5408\u4F5C"};for(let u=1;u<=o;u++){const d=`${r}-${u.toString().padStart(2,"0")}`;try{const c=await fetch(`http://47.111.95.19:3000/new-orders/${d}`);if(c.ok){const l=await c.json();if(l.success&&l.data){const g=l.data;g.equipment&&g.equipment.forEach(y=>{const b=s[y.customer];if(b){const E=n.value.equipment.find(D=>D.customer===b);E&&(E.signedOrder=y.cumulativeTotal||0)}}),g.components&&g.components.forEach(y=>{const b=s[y.customer];if(b){const E=n.value.components.find(D=>D.customer===b);E&&(E.signedOrder=y.cumulativeTotal||0)}}),g.engineering&&g.engineering.forEach(y=>{const b=s[y.customer];if(b){const E=n.value.engineering.find(D=>D.customer===b);E&&(E.signedOrder=y.cumulativeTotal||0)}})}}}catch(c){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${d}:`,c)}}console.log("\u5DF2\u66F4\u65B0\u65B0\u7B7E\u8BA2\u5355\u7D2F\u8BA1\u6570\u636E:",n.value)}catch(r){console.error("\u52A0\u8F7D\u65B0\u7B7E\u8BA2\u5355\u7D2F\u8BA1\u6570\u636E\u5931\u8D25:",r)}},j=async e=>{try{const r=[],o=e.substring(0,4),s=parseInt(e.substring(5,7));for(let u=1;u<s;u++){const d=`${o}-${u.toString().padStart(2,"0")}`;try{const c=await fetch(`http://47.111.95.19:3000/order-to-income/${d}`);if(c.ok){const l=await c.json();l.success&&l.data&&r.push({period:d,data:l.data})}}catch(c){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${d}:`,c)}}N.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(r){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",r)}},R=(e,r)=>{let o=0;for(const d of N.value){const c=d.data[e];if(c){const l=c.find(g=>g.customer===r);l&&l.currentIncome&&(o+=l.currentIncome)}}const u=n.value[e].find(d=>d.customer===r);return u&&u.currentIncome&&(o+=u.currentIncome),o},A=()=>{n.value.equipment.forEach(e=>{e.incomeTotal=R("equipment",e.customer)}),n.value.components.forEach(e=>{e.incomeTotal=R("components",e.customer)}),n.value.engineering.forEach(e=>{e.incomeTotal=R("engineering",e.customer)})},k=e=>{A(),e.signedOrder>0?e.incomeRate=parseFloat((e.incomeTotal/e.signedOrder*100).toFixed(2)):e.incomeRate=0};S(()=>n.value,()=>{n.value.equipment.forEach(e=>k(e)),n.value.components.forEach(e=>k(e)),n.value.engineering.forEach(e=>k(e))},{deep:!0});const x=H(()=>{const e={signedOrder:0,currentIncome:0,incomeTotal:0,incomeRate:0};return[...n.value.equipment,...n.value.components,...n.value.engineering].forEach(o=>{e.signedOrder+=o.signedOrder||0,e.currentIncome+=o.currentIncome||0,e.incomeTotal+=o.incomeTotal||0}),e.incomeRate=e.signedOrder>0?parseFloat((e.incomeTotal/e.signedOrder*100).toFixed(2)):0,e}),O=async e=>{try{const r=await P(T.ORDER_TO_INCOME,e);F.value=r.remarks||"",h.value=r.suggestions||""}catch(r){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",r)}},I=async e=>{var r;console.log("\u5F00\u59CB\u52A0\u8F7D\u8BA2\u5355\u8F6C\u6536\u5165\u6570\u636E:",e);try{const o=await fetch(`http://47.111.95.19:3000/order-to-income/${e}`);let s=null;o.ok&&(s=(await o.json()).data,console.log("\u4E13\u7528\u8868\u6570\u636E:",s));const u=await fetch(`http://47.111.95.19:3000/forms/submission/${T.ORDER_TO_INCOME}/${e}`);let d=null;u.ok&&(d=(r=(await u.json()).data)==null?void 0:r.formData,console.log("\u7CFB\u7EDF\u8868\u6570\u636E:",d));const c=s||d;c?(n.value=J(_(),c),console.log("\u5408\u5E76\u540E\u6570\u636E:",n.value)):(n.value=_(),console.log("\u4F7F\u7528\u9ED8\u8BA4\u6570\u636E")),await U(e),await j(e),A()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),n.value=_();try{await U(e),await j(e),A()}catch(s){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",s)}}};S(()=>f.query.period,e=>{e&&(p.value=e.toString(),I(e.toString()),O(e.toString()))}),S(p,e=>{I(e),O(e)});const L=async()=>{try{await(async()=>{if(!(await fetch("http://47.111.95.19:3000/order-to-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:p.value,data:n.value})})).ok)throw new Error("\u4FDD\u5B58\u4E13\u7528\u8868\u5931\u8D25")})(),await ee(T.ORDER_TO_INCOME,p.value,n.value,F.value,h.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},Y=()=>{n.value=_(),F.value="",h.value=""};return K(()=>{f.query.period?(I(f.query.period.toString()),O(f.query.period.toString())):(I(p.value),O(p.value))}),(e,r)=>(m(),i("div",oe,[t("div",re,[r[3]||(r[3]=t("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u2014\u2014\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165",-1)),t("div",te,[B(t("input",{"onUpdate:modelValue":r[0]||(r[0]=o=>p.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[C,p.value]])])]),t("div",ue,[t("table",ne,[r[6]||(r[6]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u5E74\u65B0\u7B7E\u8BA2\u5355\u7D2F\u8BA1"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u8F6C\u6536\u5165"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u8F6C\u6536\u5165"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u5E74\u8BA2\u5355\u8F6C\u6536\u5165\u6BD4\u7387")])],-1)),t("tbody",null,[(m(!0),i(q,null,$(n.value.equipment,(o,s)=>(m(),i("tr",{key:`equipment-${s}`},[s===0?(m(),i("td",{key:0,rowspan:n.value.equipment.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u8BBE\u5907 ",8,se)):M("",!0),t("td",ae,a(o.customer),1),t("td",ce,a(o.signedOrder.toFixed(2)),1),t("td",de,[B(t("input",{"onUpdate:modelValue":u=>o.currentIncome=u,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,le),[[C,o.currentIncome,void 0,{number:!0}]])]),t("td",ie,[t("span",me,a(w(o.incomeTotal||0)),1)]),t("td",pe,a(o.incomeRate)+"% ",1)]))),128)),(m(!0),i(q,null,$(n.value.components,(o,s)=>(m(),i("tr",{key:`components-${s}`},[s===0?(m(),i("td",{key:0,rowspan:n.value.components.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5143\u4EF6 ",8,ge)):M("",!0),t("td",ye,a(o.customer),1),t("td",be,a(o.signedOrder.toFixed(2)),1),t("td",Ee,[B(t("input",{"onUpdate:modelValue":u=>o.currentIncome=u,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,fe),[[C,o.currentIncome,void 0,{number:!0}]])]),t("td",Fe,[t("span",he,a(w(o.incomeTotal||0)),1)]),t("td",_e,a(o.incomeRate)+"% ",1)]))),128)),(m(!0),i(q,null,$(n.value.engineering,(o,s)=>(m(),i("tr",{key:`engineering-${s}`},[s===0?(m(),i("td",{key:0,rowspan:n.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,De)):M("",!0),t("td",ve,a(o.customer),1),t("td",xe,a(o.signedOrder.toFixed(2)),1),t("td",Oe,[B(t("input",{"onUpdate:modelValue":u=>o.currentIncome=u,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,Ie),[[C,o.currentIncome,void 0,{number:!0}]])]),t("td",Be,[t("span",Ce,a(w(o.incomeTotal||0)),1)]),t("td",Te,a(o.incomeRate)+"% ",1)]))),128)),t("tr",we,[r[4]||(r[4]=t("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r[5]||(r[5]=t("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),t("td",Re,a(x.value.signedOrder.toFixed(2)),1),t("td",Ae,a(x.value.currentIncome.toFixed(2)),1),t("td",ke,a(x.value.incomeTotal.toFixed(2)),1),t("td",Se,a(x.value.incomeRate.toFixed(2))+"%",1)])])])]),Q(Z,{"module-id":W(T).ORDER_TO_INCOME,period:p.value,remarks:F.value,"onUpdate:remarks":r[1]||(r[1]=o=>F.value=o),suggestions:h.value,"onUpdate:suggestions":r[2]||(r[2]=o=>h.value=o)},null,8,["module-id","period","remarks","suggestions"]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:L,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:Y,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ue=G(qe,[["__scopeId","data-v-e1304f44"]]);export{Ue as default};
