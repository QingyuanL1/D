import{_ as Q,d as W,r as F,c as X,B as T,o as Z,b as d,e as o,y as m,A as y,F as k,g as S,t as a,k as P,h as ee,G as ue,v as b,f as U}from"./index.cb792ad6.js";import{_ as te,l as re,M as w,r as oe}from"./FormAttachmentAndRemarks.0f239004.js";const ne={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},se={class:"flex justify-between items-center mb-6"},ae={class:"flex items-center space-x-4"},ce={class:"overflow-x-auto my-6"},le={class:"w-full border-collapse border border-gray-300"},ie=["rowspan"],pe={class:"border border-gray-300 px-4 py-2"},de={class:"border border-gray-300 px-4 py-2"},me=["onUpdate:modelValue"],ye={class:"border border-gray-300 px-4 py-2"},be=["onUpdate:modelValue"],Ae={class:"border border-gray-300 px-4 py-2"},ve=["onUpdate:modelValue"],De={class:"border border-gray-300 px-4 py-2 text-right"},Fe={class:"font-medium"},ge={class:"border border-gray-300 px-4 py-2 text-right"},_e=["rowspan"],he={class:"border border-gray-300 px-4 py-2"},xe={class:"border border-gray-300 px-4 py-2"},fe=["onUpdate:modelValue"],Ee={class:"border border-gray-300 px-4 py-2"},Ce=["onUpdate:modelValue"],Be={class:"border border-gray-300 px-4 py-2"},Ie=["onUpdate:modelValue"],Te={class:"border border-gray-300 px-4 py-2 text-right"},we={class:"font-medium"},Ne={class:"border border-gray-300 px-4 py-2 text-right"},je=["rowspan"],qe={class:"border border-gray-300 px-4 py-2"},Ve={class:"border border-gray-300 px-4 py-2"},ke=["onUpdate:modelValue"],Se={class:"border border-gray-300 px-4 py-2"},Ue=["onUpdate:modelValue"],Re={class:"border border-gray-300 px-4 py-2"},Oe=["onUpdate:modelValue"],$e={class:"border border-gray-300 px-4 py-2 text-right"},Me={class:"font-medium"},Ye={class:"border border-gray-300 px-4 py-2 text-right"},Le={class:"bg-gray-50 font-bold"},ze={class:"border border-gray-300 px-4 py-2 text-right"},Ge={class:"border border-gray-300 px-4 py-2 text-right"},Je={class:"border border-gray-300 px-4 py-2 text-right"},He={class:"border border-gray-300 px-4 py-2 text-right"},Ke=W({__name:"ContractInventory",setup(Qe){var M;const C=ue(),c=F(((M=C.query.period)==null?void 0:M.toString())||new Date().toISOString().slice(0,7)),s={equipment:{\u4E0A\u6D77:1200.5,\u56FD\u7F51:2300.75,\u6C5F\u82CF:800.25,\u8F93\u914D\u7535\u5185\u914D:150,\u897F\u95E8\u5B50:0,\u540C\u4E1A:950.6,\u7528\u6237:750.4,\u5176\u5B83:200.3},component:{\u7528\u6237:500.8},project:{\u4E00\u5305:300.2,\u4E8C\u5305:150.1,\u57DF\u5185\u5408\u4F5C:1100.9,\u57DF\u5916\u5408\u4F5C:650.75,\u5176\u5B83:400.5}},R=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialAmount:s.equipment.\u4E0A\u6D77,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u56FD\u7F51",initialAmount:s.equipment.\u56FD\u7F51,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u6C5F\u82CF",initialAmount:s.equipment.\u6C5F\u82CF,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialAmount:s.equipment.\u8F93\u914D\u7535\u5185\u914D,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u897F\u95E8\u5B50",initialAmount:s.equipment.\u897F\u95E8\u5B50,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u540C\u4E1A",initialAmount:s.equipment.\u540C\u4E1A,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u7528\u6237",initialAmount:s.equipment.\u7528\u6237,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u5176\u5B83",initialAmount:s.equipment.\u5176\u5B83,currentIncrease:0,currentDecrease:0,cumulativeAmount:0}],component:[{customerType:"\u7528\u6237",initialAmount:s.component.\u7528\u6237,currentIncrease:0,currentDecrease:0,cumulativeAmount:0}],project:[{customerType:"\u4E00\u5305",initialAmount:s.project.\u4E00\u5305,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u4E8C\u5305",initialAmount:s.project.\u4E8C\u5305,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialAmount:s.project.\u57DF\u5185\u5408\u4F5C,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialAmount:s.project.\u57DF\u5916\u5408\u4F5C,currentIncrease:0,currentDecrease:0,cumulativeAmount:0},{customerType:"\u5176\u5B83",initialAmount:s.project.\u5176\u5B83,currentIncrease:0,currentDecrease:0,cumulativeAmount:0}]}),G=(e,u)=>(!u||typeof u!="object"||(u.equipment&&Array.isArray(u.equipment)&&(e.equipment=e.equipment.map(t=>{const n=u.equipment.find(r=>r.customerType===t.customerType);return n?{...t,initialAmount:t.initialAmount,currentIncrease:Number(n.currentIncrease)||0,currentDecrease:Number(n.currentDecrease)||0,cumulativeAmount:0}:t})),u.component&&Array.isArray(u.component)&&(e.component=e.component.map(t=>{const n=u.component.find(r=>r.customerType===t.customerType);return n?{...t,initialAmount:t.initialAmount,currentIncrease:Number(n.currentIncrease)||0,currentDecrease:Number(n.currentDecrease)||0,cumulativeAmount:0}:t})),u.project&&Array.isArray(u.project)&&(e.project=e.project.map(t=>{const n=u.project.find(r=>r.customerType===t.customerType);return n?{...t,initialAmount:t.initialAmount,currentIncrease:Number(n.currentIncrease)||0,currentDecrease:Number(n.currentDecrease)||0,cumulativeAmount:0}:t}))),e),N=()=>{const e=R();l.value=e.equipment,i.value=e.component,p.value=e.project},l=F([]),i=F([]),p=F([]),h=F(""),x=F(""),O=F([]);F(null);const $=async e=>{try{const u=[],t=e.substring(0,4),n=parseInt(e.substring(5,7));for(let r=1;r<n;r++){const v=`${t}-${r.toString().padStart(2,"0")}`;try{const D=await fetch(`http://47.111.95.19:3000/contract-inventory/${v}`);if(D.ok){const _=await D.json();_.success&&_.data&&u.push({period:v,data:_.data})}}catch(D){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${v}:`,D)}}O.value=u,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",u)}catch(u){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",u)}},j=(e,u)=>{var _,Y,L,z;let t=0;e==="equipment"&&s.equipment[u]!==void 0?t=s.equipment[u]:e==="component"&&s.component[u]!==void 0?t=s.component[u]:e==="project"&&s.project[u]!==void 0&&(t=s.project[u]);let n=0,r=0;for(const I of O.value)if(I.data[e]){const V=I.data[e].find(K=>K.customerType===u);V&&(n+=parseFloat((_=V.currentIncrease)==null?void 0:_.toString())||0,r+=parseFloat((Y=V.currentDecrease)==null?void 0:Y.toString())||0)}let v=[];e==="equipment"?v=l.value:e==="component"?v=i.value:e==="project"&&(v=p.value);const D=v.find(I=>I.customerType===u);return D&&(n+=parseFloat((L=D.currentIncrease)==null?void 0:L.toString())||0,r+=parseFloat((z=D.currentDecrease)==null?void 0:z.toString())||0),t+n-r},A=()=>{l.value.forEach(e=>{const u=j("equipment",e.customerType);e.cumulativeAmount=u}),i.value.forEach(e=>{const u=j("component",e.customerType);e.cumulativeAmount=u}),p.value.forEach(e=>{const u=j("project",e.customerType);e.cumulativeAmount=u})},B=(e,u)=>e===0?u===0?"0.00":"N/A":((u-e)/e*100).toFixed(2),g=e=>isNaN(e)||e===null||e===void 0?"0.00":e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),f=X(()=>{const e={initialAmount:0,currentIncrease:0,currentDecrease:0,cumulativeAmount:0};return l.value.forEach(u=>{e.initialAmount+=Number(u.initialAmount)||0,e.currentIncrease+=Number(u.currentIncrease)||0,e.currentDecrease+=Number(u.currentDecrease)||0,e.cumulativeAmount+=Number(u.cumulativeAmount)||0}),i.value.forEach(u=>{e.initialAmount+=Number(u.initialAmount)||0,e.currentIncrease+=Number(u.currentIncrease)||0,e.currentDecrease+=Number(u.currentDecrease)||0,e.cumulativeAmount+=Number(u.cumulativeAmount)||0}),p.value.forEach(u=>{e.initialAmount+=Number(u.initialAmount)||0,e.currentIncrease+=Number(u.currentIncrease)||0,e.currentDecrease+=Number(u.currentDecrease)||0,e.cumulativeAmount+=Number(u.cumulativeAmount)||0}),e}),E=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u5408\u540C\u5B58\u91CF\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const u=await fetch(`http://47.111.95.19:3000/contract-inventory/${e}`);if(!u.ok){if(u.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),N(),await $(e),A();return}const t=await u.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",t),t.success&&t.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const n=R(),r=G(n,t.data);l.value=r.equipment,i.value=r.component,p.value=r.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:l.value,componentData:i.value,projectData:p.value})}await $(e),A()}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u),N()}},q=async()=>{const{remarks:e,suggestions:u}=await re(w.CONTRACT_INVENTORY,c.value);h.value=e,x.value=u};T(c,e=>{E(e),q()}),T(()=>C.query.period,e=>{e&&(c.value=e.toString(),E(e.toString()))}),T(()=>[l.value.map(e=>e.currentPeriod),i.value.map(e=>e.currentPeriod),p.value.map(e=>e.currentPeriod)],()=>{A()},{deep:!0}),T(c,(e,u)=>{e&&e!==u&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${u} -> ${e}`),E(e),q())});const J=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u5408\u540C\u5B58\u91CF\u6570\u636E ==="),console.log("\u671F\u95F4:",c.value),console.log("\u6A21\u5757ID:",w.CONTRACT_INVENTORY);const e={equipment:l.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentIncrease:r.currentIncrease||0,currentDecrease:r.currentDecrease||0,cumulativeAmount:r.cumulativeAmount})),component:i.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentIncrease:r.currentIncrease||0,currentDecrease:r.currentDecrease||0,cumulativeAmount:r.cumulativeAmount})),project:p.value.map(r=>({customerType:r.customerType,initialAmount:r.initialAmount,currentIncrease:r.currentIncrease||0,currentDecrease:r.currentDecrease||0,cumulativeAmount:r.cumulativeAmount}))};console.log("\u8868\u5355\u6570\u636E:",e),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const u=await fetch("http://47.111.95.19:3000/contract-inventory",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:e})});if(!u.ok){const r=await u.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",r),new Error("\u4FDD\u5B58\u5931\u8D25")}const t=await u.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",t),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const n=await oe(w.CONTRACT_INVENTORY,c.value,e,h.value,x.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",n),n?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(e){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},H=()=>{N(),h.value="",x.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return Z(()=>{console.log("\u5408\u540C\u5B58\u91CF\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",c.value),C.query.period?E(C.query.period.toString()):E(c.value),q()}),(e,u)=>(b(),d("div",ne,[o("div",se,[u[3]||(u[3]=o("h1",{class:"text-2xl font-bold"},"\u5E93\u5B58\u60C5\u51B5(\u5408\u540C\u5B58\u91CF)",-1)),o("div",ae,[m(o("input",{"onUpdate:modelValue":u[0]||(u[0]=t=>c.value=t),type:"month",class:"px-3 py-2 border rounded"},null,512),[[y,c.value]])])]),o("div",ce,[o("table",le,[u[5]||(u[5]=o("thead",{class:"sticky top-0 bg-white"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u91CF"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u65B0\u589E"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u51CF\u5C11"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u5E93\u5B58"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u6CE2\u52A8\u7387")])],-1)),o("tbody",null,[(b(!0),d(k,null,S(l.value,(t,n)=>(b(),d("tr",{key:`equipment-${n}`},[n===0?(b(),d("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u8BBE\u5907 ",8,ie)):U("",!0),o("td",pe,a(t.customerType),1),o("td",de,[m(o("input",{"onUpdate:modelValue":r=>t.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,me),[[y,t.initialAmount,void 0,{number:!0}]])]),o("td",ye,[m(o("input",{"onUpdate:modelValue":r=>t.currentIncrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:A},null,40,be),[[y,t.currentIncrease,void 0,{number:!0}]])]),o("td",Ae,[m(o("input",{"onUpdate:modelValue":r=>t.currentDecrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:A},null,40,ve),[[y,t.currentDecrease,void 0,{number:!0}]])]),o("td",De,[o("span",Fe,a(g(t.cumulativeAmount)),1)]),o("td",ge,a(B(t.initialAmount,t.cumulativeAmount))+"% ",1)]))),128)),(b(!0),d(k,null,S(i.value,(t,n)=>(b(),d("tr",{key:`component-${n}`},[n===0?(b(),d("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u5143\u4EF6 ",8,_e)):U("",!0),o("td",he,a(t.customerType),1),o("td",xe,[m(o("input",{"onUpdate:modelValue":r=>t.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,fe),[[y,t.initialAmount,void 0,{number:!0}]])]),o("td",Ee,[m(o("input",{"onUpdate:modelValue":r=>t.currentIncrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:A},null,40,Ce),[[y,t.currentIncrease,void 0,{number:!0}]])]),o("td",Be,[m(o("input",{"onUpdate:modelValue":r=>t.currentDecrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:A},null,40,Ie),[[y,t.currentDecrease,void 0,{number:!0}]])]),o("td",Te,[o("span",we,a(g(t.cumulativeAmount)),1)]),o("td",Ne,a(B(t.initialAmount,t.cumulativeAmount))+"% ",1)]))),128)),(b(!0),d(k,null,S(p.value,(t,n)=>(b(),d("tr",{key:`project-${n}`},[n===0?(b(),d("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5DE5\u7A0B ",8,je)):U("",!0),o("td",qe,a(t.customerType),1),o("td",Ve,[m(o("input",{"onUpdate:modelValue":r=>t.initialAmount=r,type:"number",class:"w-full px-2 py-1 border rounded text-right bg-gray-50",step:"0.01",readonly:""},null,8,ke),[[y,t.initialAmount,void 0,{number:!0}]])]),o("td",Se,[m(o("input",{"onUpdate:modelValue":r=>t.currentIncrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:A},null,40,Ue),[[y,t.currentIncrease,void 0,{number:!0}]])]),o("td",Re,[m(o("input",{"onUpdate:modelValue":r=>t.currentDecrease=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",onInput:A},null,40,Oe),[[y,t.currentDecrease,void 0,{number:!0}]])]),o("td",$e,[o("span",Me,a(g(t.cumulativeAmount)),1)]),o("td",Ye,a(B(t.initialAmount,t.cumulativeAmount))+"% ",1)]))),128)),o("tr",Le,[u[4]||(u[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",ze,a(g(f.value.initialAmount)),1),o("td",Ge,a(g(f.value.currentPeriod)),1),o("td",Je,a(g(f.value.cumulativeAmount)),1),o("td",He,a(B(f.value.initialAmount,f.value.cumulativeAmount))+"% ",1)])])])]),o("div",{class:"mt-4 flex justify-end space-x-4"},[o("button",{onClick:J,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),o("button",{onClick:H,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),P(te,{"module-id":ee(w).CONTRACT_INVENTORY,period:c.value,remarks:h.value,"onUpdate:remarks":u[1]||(u[1]=t=>h.value=t),suggestions:x.value,"onUpdate:suggestions":u[2]||(u[2]=t=>x.value=t)},null,8,["module-id","period","remarks","suggestions"])]))}});var Ze=Q(Ke,[["__scopeId","data-v-6a0c02b8"]]);export{Ze as default};
