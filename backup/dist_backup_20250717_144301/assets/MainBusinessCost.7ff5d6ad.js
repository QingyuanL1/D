import{_ as j,d as N,r as F,c as q,B as w,o as I,b as l,e as o,y as s,A as c,F as f,g as h,t as d,k as M,h as O,G as $,v as p,f as A}from"./index.ac64ed1b.js";import{_ as L,l as z,M as D,r as G}from"./FormAttachmentAndRemarks.ff320a31.js";const J={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},H={class:"flex justify-between items-center mb-6"},K={class:"flex items-center space-x-4"},Q={class:"overflow-x-auto my-6"},W={class:"w-full border-collapse border border-gray-300"},X=["rowspan"],Y={class:"border border-gray-300 px-4 py-2"},Z={class:"border border-gray-300 px-4 py-2"},ee=["onUpdate:modelValue"],ue={class:"border border-gray-300 px-4 py-2"},re=["onUpdate:modelValue"],oe={class:"border border-gray-300 px-4 py-2"},te={class:"border border-gray-300 px-4 py-2"},ae=["onUpdate:modelValue"],ne=["rowspan"],le={class:"border border-gray-300 px-4 py-2"},se={class:"border border-gray-300 px-4 py-2"},ce=["onUpdate:modelValue"],de={class:"border border-gray-300 px-4 py-2"},pe=["onUpdate:modelValue"],ye={class:"border border-gray-300 px-4 py-2"},ie={class:"border border-gray-300 px-4 py-2"},ve=["onUpdate:modelValue"],Fe=["rowspan"],be={class:"border border-gray-300 px-4 py-2"},ge={class:"border border-gray-300 px-4 py-2"},_e=["onUpdate:modelValue"],me={class:"border border-gray-300 px-4 py-2"},Te=["onUpdate:modelValue"],Ee={class:"border border-gray-300 px-4 py-2"},xe={class:"border border-gray-300 px-4 py-2"},De=["onUpdate:modelValue"],Be={class:"bg-gray-50 font-bold"},fe={class:"border border-gray-300 px-4 py-2"},he={class:"border border-gray-300 px-4 py-2"},Ae={class:"border border-gray-300 px-4 py-2"},Ce={class:"border border-gray-300 px-4 py-2"},Pe=N({__name:"MainBusinessCost",setup(Re){var R;const _=$(),n=F(((R=_.query.period)==null?void 0:R.toString())||new Date().toISOString().slice(0,7)),C=()=>({equipment:[{customerType:"\u4E0A\u6D77",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u56FD\u7F51",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u6C5F\u82CF",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u897F\u95E8\u5B50",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u540C\u4E1A",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u7528\u6237",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u5176\u5B83",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"}],component:[{customerType:"\u7528\u6237",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"}],project:[{customerType:"\u4E00\u5305",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u4E8C\u5305",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"},{customerType:"\u5176\u5B83",yearlyPlan:"0",currentTotal:0,revenueRatio:"0.00%"}]}),S=(t,u)=>(!u||typeof u!="object"||(u.equipment&&Array.isArray(u.equipment)&&(t.equipment=t.equipment.map(e=>{const a=u.equipment.find(r=>r.customerType===e.customerType);return a?{...e,yearlyPlan:a.yearlyPlan||"0",currentTotal:Number(a.currentTotal)||0,revenueRatio:a.revenueRatio||"0.00%"}:e})),u.component&&Array.isArray(u.component)&&(t.component=t.component.map(e=>{const a=u.component.find(r=>r.customerType===e.customerType);return a?{...e,yearlyPlan:a.yearlyPlan||"0",currentTotal:Number(a.currentTotal)||0,revenueRatio:a.revenueRatio||"0.00%"}:e})),u.project&&Array.isArray(u.project)&&(t.project=t.project.map(e=>{const a=u.project.find(r=>r.customerType===e.customerType);return a?{...e,yearlyPlan:a.yearlyPlan||"0",currentTotal:Number(a.currentTotal)||0,revenueRatio:a.revenueRatio||"0.00%"}:e}))),t),m=()=>{const t=C();y.value=t.equipment,i.value=t.component,v.value=t.project},y=F([]),i=F([]),v=F([]),b=F(""),g=F(""),T=(t,u)=>{if(t==="/"||!t)return"/";const e=parseFloat(t.toString().replace(/,/g,""));return isNaN(e)||e===0?"0.00%":(u/e*100).toFixed(2)+"%"},P=t=>t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),U=()=>{const t=[...y.value,...i.value,...v.value];let u=0,e=0,a=0;return t.forEach(r=>{r.revenueRatio&&r.revenueRatio!=="/"&&r.currentTotal>0&&(u+=(parseFloat(r.revenueRatio.replace(/%/g,""))||0)*r.currentTotal,e+=r.currentTotal,a++)}),e===0||a===0?"/":(u/e).toFixed(2)+"%"},E=q(()=>{const t={yearlyPlan:0,currentTotal:0,revenueRatio:0};return y.value.forEach(u=>{u.yearlyPlan!=="/"&&(t.yearlyPlan+=parseFloat(u.yearlyPlan.replace(/,/g,""))||0),t.currentTotal+=u.currentTotal||0}),i.value.forEach(u=>{u.yearlyPlan!=="/"&&(t.yearlyPlan+=parseFloat(u.yearlyPlan.replace(/,/g,""))||0),t.currentTotal+=u.currentTotal||0}),v.value.forEach(u=>{u.yearlyPlan!=="/"&&(t.yearlyPlan+=parseFloat(u.yearlyPlan.replace(/,/g,""))||0),t.currentTotal+=u.currentTotal||0}),t}),x=async t=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u6570\u636E\uFF0C\u671F\u95F4: ${t}`);const u=await fetch(`http://47.111.95.19:3000/main-business-cost/${t}`);if(!u.ok){if(u.status===404){console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),m();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const e=await u.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",e),e.success&&e.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const a=C(),r=S(a,e.data);y.value=r.equipment,i.value=r.component,v.value=r.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:y.value,componentData:i.value,projectData:v.value})}else console.log("\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),m()}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u),m()}},B=async()=>{const{remarks:t,suggestions:u}=await z(D.MAIN_BUSINESS_COST,n.value);b.value=t,g.value=u};w(()=>_.query.period,t=>{t&&(n.value=t.toString(),x(t.toString()),B())}),w(n,t=>{x(t),B()});const V=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u6570\u636E ==="),console.log("\u671F\u95F4:",n.value),console.log("\u6A21\u5757ID:",D.MAIN_BUSINESS_COST);const t={equipment:y.value.map(r=>({customerType:r.customerType,yearlyPlan:r.yearlyPlan,currentTotal:r.currentTotal,revenueRatio:r.revenueRatio})),component:i.value.map(r=>({customerType:r.customerType,yearlyPlan:r.yearlyPlan,currentTotal:r.currentTotal,revenueRatio:r.revenueRatio})),project:v.value.map(r=>({customerType:r.customerType,yearlyPlan:r.yearlyPlan,currentTotal:r.currentTotal,revenueRatio:r.revenueRatio}))};console.log("\u8868\u5355\u6570\u636E:",t),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const u=await fetch("http://47.111.95.19:3000/main-business-cost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:n.value,data:t})});if(!u.ok){const r=await u.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",r),new Error("\u4FDD\u5B58\u5931\u8D25")}const e=await u.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",e),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const a=await G(D.MAIN_BUSINESS_COST,n.value,t,b.value,g.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",a),a?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(t){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",t),alert("\u4FDD\u5B58\u5931\u8D25: "+(t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"))}},k=()=>{m(),b.value="",g.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return I(()=>{console.log("\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",n.value),_.query.period?x(_.query.period.toString()):x(n.value),B()}),(t,u)=>(p(),l("div",J,[o("div",H,[u[3]||(u[3]=o("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u7ED3\u6784\u4E0E\u8D28\u91CF\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09",-1)),o("div",K,[s(o("input",{"onUpdate:modelValue":u[0]||(u[0]=e=>n.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[c,n.value]])])]),o("div",Q,[u[6]||(u[6]=o("h2",{class:"text-xl font-semibold mb-3"},"\u5BF9\u5E94\u5E74\u5EA6\u8BA1\u5212:",-1)),o("table",W,[u[5]||(u[5]=o("thead",{class:"sticky top-0 bg-white"},[o("tr",{class:"bg-gray-50"},[o("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u5E74\u7D2F\u8BA1"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u8BA1\u5212\u6267\u884C\u8FDB\u5EA6"),o("th",{class:"border border-gray-300 px-4 py-2"},"\u5360\u4E3B\u8425\u6536\u5165\u6BD4")])],-1)),o("tbody",null,[(p(!0),l(f,null,h(y.value,(e,a)=>(p(),l("tr",{key:`equipment-${a}`},[a===0?(p(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:y.value.length}," \u8BBE\u5907 ",8,X)):A("",!0),o("td",Y,d(e.customerType),1),o("td",Z,[s(o("input",{"onUpdate:modelValue":r=>e.yearlyPlan=r,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,ee),[[c,e.yearlyPlan]])]),o("td",ue,[s(o("input",{"onUpdate:modelValue":r=>e.currentTotal=r,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,re),[[c,e.currentTotal,void 0,{number:!0}]])]),o("td",oe,d(T(e.yearlyPlan,e.currentTotal)),1),o("td",te,[s(o("input",{"onUpdate:modelValue":r=>e.revenueRatio=r,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,ae),[[c,e.revenueRatio]])])]))),128)),(p(!0),l(f,null,h(i.value,(e,a)=>(p(),l("tr",{key:`component-${a}`},[a===0?(p(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u5143\u4EF6 ",8,ne)):A("",!0),o("td",le,d(e.customerType),1),o("td",se,[s(o("input",{"onUpdate:modelValue":r=>e.yearlyPlan=r,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,ce),[[c,e.yearlyPlan]])]),o("td",de,[s(o("input",{"onUpdate:modelValue":r=>e.currentTotal=r,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,pe),[[c,e.currentTotal,void 0,{number:!0}]])]),o("td",ye,d(T(e.yearlyPlan,e.currentTotal)),1),o("td",ie,[s(o("input",{"onUpdate:modelValue":r=>e.revenueRatio=r,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,ve),[[c,e.revenueRatio]])])]))),128)),(p(!0),l(f,null,h(v.value,(e,a)=>(p(),l("tr",{key:`project-${a}`},[a===0?(p(),l("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:v.value.length}," \u5DE5\u7A0B ",8,Fe)):A("",!0),o("td",be,d(e.customerType),1),o("td",ge,[s(o("input",{"onUpdate:modelValue":r=>e.yearlyPlan=r,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,_e),[[c,e.yearlyPlan]])]),o("td",me,[s(o("input",{"onUpdate:modelValue":r=>e.currentTotal=r,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,Te),[[c,e.currentTotal,void 0,{number:!0}]])]),o("td",Ee,d(T(e.yearlyPlan,e.currentTotal)),1),o("td",xe,[s(o("input",{"onUpdate:modelValue":r=>e.revenueRatio=r,type:"text",class:"w-full px-2 py-1 border rounded"},null,8,De),[[c,e.revenueRatio]])])]))),128)),o("tr",Be,[u[4]||(u[4]=o("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),o("td",fe,d(P(E.value.yearlyPlan)),1),o("td",he,d(P(E.value.currentTotal)),1),o("td",Ae,d(T(E.value.yearlyPlan.toString(),E.value.currentTotal)),1),o("td",Ce,d(U()),1)])])])]),M(L,{"module-id":O(D).MAIN_BUSINESS_COST,period:n.value,remarks:b.value,"onUpdate:remarks":u[1]||(u[1]=e=>b.value=e),suggestions:g.value,"onUpdate:suggestions":u[2]||(u[2]=e=>g.value=e)},null,8,["module-id","period","remarks","suggestions"]),o("div",{class:"mt-4 flex justify-end space-x-4"},[o("button",{onClick:V,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),o("button",{onClick:k,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ve=j(Pe,[["__scopeId","data-v-8630bc3e"]]);export{Ve as default};
