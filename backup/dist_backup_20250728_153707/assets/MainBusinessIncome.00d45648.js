import{_ as J,d as L,r as b,B,c as F,o as G,b as d,e as r,y as _,A as I,F as S,g as w,t as c,k as Y,h as z,G as H,v as p,f as k}from"./index.e99f28b3.js";import{_ as K,M as v,l as Q,r as W}from"./FormAttachmentAndRemarks.d1afaf1c.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Z={class:"flex justify-between items-center mb-6"},ee={class:"flex items-center space-x-4"},ue={class:"overflow-x-auto my-6"},oe={class:"w-full border-collapse border border-gray-300"},re=["rowspan"],te={class:"border border-gray-300 px-4 py-2"},ne={class:"border border-gray-300 px-4 py-2"},se={class:"border border-gray-300 px-4 py-2"},ae=["onUpdate:modelValue"],ce={class:"border border-gray-300 px-4 py-2"},le={class:"font-medium"},de={class:"border border-gray-300 px-4 py-2"},pe=["rowspan"],me={class:"border border-gray-300 px-4 py-2"},ie={class:"border border-gray-300 px-4 py-2"},ge={class:"border border-gray-300 px-4 py-2"},ye=["onUpdate:modelValue"],he={class:"border border-gray-300 px-4 py-2"},be={class:"font-medium"},Ee={class:"border border-gray-300 px-4 py-2"},fe=["rowspan"],Fe={class:"border border-gray-300 px-4 py-2"},_e={class:"border border-gray-300 px-4 py-2"},Ie={class:"border border-gray-300 px-4 py-2"},ve=["onUpdate:modelValue"],xe={class:"border border-gray-300 px-4 py-2"},De={class:"font-medium"},Ae={class:"border border-gray-300 px-4 py-2"},Me={class:"bg-gray-50 font-bold"},Ce={class:"border border-gray-300 px-4 py-2"},Be={class:"border border-gray-300 px-4 py-2"},Se={class:"border border-gray-300 px-4 py-2"},we={class:"border border-gray-300 px-4 py-2"},ke=L({__name:"MainBusinessIncome",setup(qe){var U;const g=H(),m=b(((U=g.query.period)==null?void 0:U.toString())||new Date().toISOString().slice(0,7)),x=()=>({equipment:[{customer:"\u4E0A\u6D77",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u56FD\u7F51",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u6C5F\u82CF",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u8F93\u914D\u7535\u5185\u914D",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u897F\u95E8\u5B50",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u540C\u4E1A",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u7528\u6237",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u5176\u5B83",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"}],components:[{customer:"\u7528\u6237",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"}],engineering:[{customer:"\u4E00\u5305",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u4E8C\u5305",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u57DF\u5185\u5408\u4F5C",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u57DF\u5916\u5408\u4F5C",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"},{customer:"\u5176\u5B83",yearlyPlan:"\u7F3A\u5C11\u6570\u636E",currentMonthIncome:0,accumulatedIncome:0,progress:"/"}]}),O=(e,u)=>{const o=JSON.parse(JSON.stringify(e));return u.equipment&&o.equipment.forEach((t,s)=>{u.equipment[s]&&Object.assign(t,u.equipment[s])}),u.components&&o.components.forEach((t,s)=>{u.components[s]&&Object.assign(t,u.components[s])}),u.engineering&&o.engineering.forEach((t,s)=>{u.engineering[s]&&Object.assign(t,u.engineering[s])}),o},n=b(x()),q=b([]),y=b(""),h=b(""),N=async e=>{try{const u=[],o=e.substring(0,4),t=parseInt(e.substring(5,7));for(let s=1;s<t;s++){const l=`${o}-${s.toString().padStart(2,"0")}`;try{const a=await fetch(`http://47.111.95.19:3000/main-business-income/${l}`);if(a.ok){const i=await a.json();i.success&&i.data&&u.push({period:l,data:i.data})}}catch(a){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${l}:`,a)}}q.value=u,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",u)}catch(u){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",u)}},D=(e,u)=>{let o=0;for(const l of q.value){const a=l.data[e];if(a){const i=a.find(T=>T.customer===u);i&&i.currentMonthIncome&&(o+=i.currentMonthIncome)}}const s=n.value[e].find(l=>l.customer===u);return s&&s.currentMonthIncome&&(o+=s.currentMonthIncome),o},A=()=>{n.value.equipment.forEach(e=>{e.accumulatedIncome=D("equipment",e.customer)}),n.value.components.forEach(e=>{e.accumulatedIncome=D("components",e.customer)}),n.value.engineering.forEach(e=>{e.accumulatedIncome=D("engineering",e.customer)})},M=(e,u)=>{if(e==="\u7F3A\u5C11\u6570\u636E"||!e)return"/";const o=typeof e=="string"?parseFloat(e.replace(/,/g,""))||0:e;return o===0?"/":(u/o*100).toFixed(2)+"%"};B(n,()=>{A(),n.value.equipment.forEach(e=>{e.progress=M(e.yearlyPlan,e.accumulatedIncome)}),n.value.components.forEach(e=>{e.progress=M(e.yearlyPlan,e.accumulatedIncome)}),n.value.engineering.forEach(e=>{e.progress=M(e.yearlyPlan,e.accumulatedIncome)})},{deep:!0});const V=F(()=>{let e=0;return[...n.value.equipment,...n.value.components,...n.value.engineering].forEach(o=>{e+=o.currentMonthIncome||0}),e}),P=F(()=>{let e=0;return[...n.value.equipment,...n.value.components,...n.value.engineering].forEach(o=>{e+=o.accumulatedIncome||0}),e}),C=F(()=>{let e=0,u=!1;return[...n.value.equipment,...n.value.components,...n.value.engineering].forEach(t=>{t.yearlyPlan!=="\u7F3A\u5C11\u6570\u636E"&&t.yearlyPlan&&(e+=typeof t.yearlyPlan=="string"?parseFloat(t.yearlyPlan.replace(/,/g,""))||0:t.yearlyPlan,u=!0)}),u?e.toFixed(2):"\u7F3A\u5C11\u6570\u636E"}),$=F(()=>{if(C.value==="\u7F3A\u5C11\u6570\u636E")return"/";const e=parseFloat(C.value.toString().replace(/,/g,""))||0;return e===0?"/":(P.value/e*100).toFixed(2)+"%"}),E=async e=>{var u;console.log("\u5F00\u59CB\u52A0\u8F7D\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u5206\u89E3\u6570\u636E:",e);try{const o=await fetch(`http://47.111.95.19:3000/main-business-income/${e}`);let t=null;if(o.ok){const a=await o.json();a.success&&a.data&&(t=a.data,console.log("\u4E13\u7528\u8868\u6570\u636E:",t))}const s=await fetch(`http://47.111.95.19:3000/forms/submission/${v.MAIN_BUSINESS_INCOME}/${e}`);let l=null;s.ok&&(l=(u=(await s.json()).data)==null?void 0:u.formData,console.log("\u7CFB\u7EDF\u8868\u6570\u636E:",l)),t?(n.value=t,console.log("\u4F7F\u7528API\u6570\u636E:",n.value)):l?(n.value=O(x(),l),console.log("\u4F7F\u7528\u8868\u5355\u6570\u636E:",n.value)):(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u5E74\u5EA6\u8BA1\u5212\u4F46\u6E05\u7A7A\u5F53\u6708\u6536\u5165"),n.value.equipment.forEach(a=>{a.currentMonthIncome=0,a.progress="/"}),n.value.components.forEach(a=>{a.currentMonthIncome=0,a.progress="/"}),n.value.engineering.forEach(a=>{a.currentMonthIncome=0,a.progress="/"}),console.log("\u4FDD\u6301\u5E74\u5EA6\u8BA1\u5212\u6570\u636E:",n.value)),await N(e),A()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),n.value.equipment.forEach(t=>{t.currentMonthIncome=0,t.progress="/"}),n.value.components.forEach(t=>{t.currentMonthIncome=0,t.progress="/"}),n.value.engineering.forEach(t=>{t.currentMonthIncome=0,t.progress="/"});try{await N(e),A()}catch(t){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",t)}}},f=async e=>{try{const u=await Q(v.MAIN_BUSINESS_INCOME,e);y.value=u.remarks||"",h.value=u.suggestions||""}catch(u){console.error("\u52A0\u8F7D\u5907\u6CE8\u548C\u5EFA\u8BAE\u5931\u8D25:",u)}};B(()=>g.query.period,e=>{e&&(m.value=e.toString(),E(e.toString()),f(e.toString()))}),B(m,e=>{E(e),f(e)});const j=async()=>{try{await(async()=>{if(!(await fetch("http://47.111.95.19:3000/main-business-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:m.value,data:n.value})})).ok)throw new Error("\u4FDD\u5B58\u4E13\u7528\u8868\u5931\u8D25")})(),await W(v.MAIN_BUSINESS_INCOME,m.value,n.value,y.value,h.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},R=()=>{n.value=x(),y.value="",h.value=""};return G(()=>{g.query.period?(E(g.query.period.toString()),f(g.query.period.toString())):(E(m.value),f(m.value))}),(e,u)=>(p(),d("div",X,[r("div",Z,[u[3]||(u[3]=r("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u5206\u89E3\u60C5\u51B5\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),r("div",ee,[_(r("input",{"onUpdate:modelValue":u[0]||(u[0]=o=>m.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[I,m.value]])])]),r("div",ue,[r("table",oe,[u[6]||(u[6]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u6536\u5165"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u6536\u5165"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),r("tbody",null,[(p(!0),d(S,null,w(n.value.equipment,(o,t)=>(p(),d("tr",{key:`equipment-${t}`},[t===0?(p(),d("td",{key:0,rowspan:n.value.equipment.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u8BBE\u5907 ",8,re)):k("",!0),r("td",te,c(o.customer),1),r("td",ne,c(o.yearlyPlan),1),r("td",se,[_(r("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,ae),[[I,o.currentMonthIncome,void 0,{number:!0}]])]),r("td",ce,[r("span",le,c(o.accumulatedIncome.toFixed(2)),1)]),r("td",de,c(o.progress),1)]))),128)),(p(!0),d(S,null,w(n.value.components,(o,t)=>(p(),d("tr",{key:`components-${t}`},[t===0?(p(),d("td",{key:0,rowspan:n.value.components.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5143\u4EF6 ",8,pe)):k("",!0),r("td",me,c(o.customer),1),r("td",ie,c(o.yearlyPlan),1),r("td",ge,[_(r("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,ye),[[I,o.currentMonthIncome,void 0,{number:!0}]])]),r("td",he,[r("span",be,c(o.accumulatedIncome.toFixed(2)),1)]),r("td",Ee,c(o.progress),1)]))),128)),(p(!0),d(S,null,w(n.value.engineering,(o,t)=>(p(),d("tr",{key:`engineering-${t}`},[t===0?(p(),d("td",{key:0,rowspan:n.value.engineering.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,fe)):k("",!0),r("td",Fe,c(o.customer),1),r("td",_e,c(o.yearlyPlan),1),r("td",Ie,[_(r("input",{"onUpdate:modelValue":s=>o.currentMonthIncome=s,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01"},null,8,ve),[[I,o.currentMonthIncome,void 0,{number:!0}]])]),r("td",xe,[r("span",De,c(o.accumulatedIncome.toFixed(2)),1)]),r("td",Ae,c(o.progress),1)]))),128)),r("tr",Me,[u[4]||(u[4]=r("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),u[5]||(u[5]=r("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),r("td",Ce,c(C.value),1),r("td",Be,c(V.value.toFixed(2)),1),r("td",Se,c(P.value.toFixed(2)),1),r("td",we,c($.value),1)])])])]),Y(K,{"module-id":z(v).MAIN_BUSINESS_INCOME,period:m.value,remarks:y.value,"onUpdate:remarks":u[1]||(u[1]=o=>y.value=o),suggestions:h.value,"onUpdate:suggestions":u[2]||(u[2]=o=>h.value=o)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:j,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:R,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ue=J(ke,[["__scopeId","data-v-1eaa2764"]]);export{Ue as default};
