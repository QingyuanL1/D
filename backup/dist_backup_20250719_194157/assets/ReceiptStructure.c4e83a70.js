import{_ as $,d as O,r as g,c as I,B,o as J,b as x,e as r,y as C,A as k,F as j,g as V,t as n,k as M,h as q,G as H,v as b,f as L}from"./index.7a9c7972.js";import{_ as G,M as v,r as z}from"./FormAttachmentAndRemarks.7f3870f1.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},W={class:"flex items-center space-x-4"},X={class:"overflow-x-auto my-6"},Y={class:"w-full border-collapse border border-gray-300"},Z=["rowspan"],ee={class:"border border-gray-300 px-4 py-2"},te={class:"border border-gray-300 px-4 py-2 text-right"},re={class:"border border-gray-300 px-4 py-2"},ue=["onUpdate:modelValue"],ae={class:"border border-gray-300 px-4 py-2 text-right"},se={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"text-sm font-medium"},ce={class:"bg-gray-50 font-bold"},ne={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"border border-gray-300 px-4 py-2 text-right"},de={class:"border border-gray-300 px-4 py-2 text-right"},ie={class:"border border-gray-300 px-4 py-2 text-right"},ye={class:"text-sm font-bold"},pe=O({__name:"ReceiptStructure",setup(me){var P;const E=H(),o=g(((P=E.query.period)==null?void 0:P.toString())||new Date().toISOString().slice(0,7)),h={customers:[{customerName:"\u4E00\u5305\u9879\u76EE",yearlyPlan:4500,current:0,accumulated:0,executionProgress:0},{customerName:"\u4E8C\u5305\u9879\u76EE",yearlyPlan:2500,current:0,accumulated:0,executionProgress:0},{customerName:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearlyPlan:3500,current:0,accumulated:0,executionProgress:0},{customerName:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearlyPlan:3e3,current:0,accumulated:0,executionProgress:0},{customerName:"\u8BBE\u5907\u5916\u670D",yearlyPlan:270,current:0,accumulated:0,executionProgress:0},{customerName:"\u65B0\u80FD\u6E90\u9879\u76EE",yearlyPlan:3e3,current:0,accumulated:0,executionProgress:0},{customerName:"\u82CF\u5DDE\u9879\u76EE",yearlyPlan:1e3,current:0,accumulated:0,executionProgress:0},{customerName:"\u62A2\u4FEE\u9879\u76EE",yearlyPlan:110,current:0,accumulated:0,executionProgress:0},{customerName:"\u8FD0\u68C0\u9879\u76EE",yearlyPlan:900,current:0,accumulated:0,executionProgress:0},{customerName:"\u81EA\u5EFA\u9879\u76EE",yearlyPlan:0,current:0,accumulated:0,executionProgress:0}]},a=g(JSON.parse(JSON.stringify(h))),l=g(""),d=g(""),i=e=>e===0?"0.00":e.toFixed(2),N=e=>e===0?"0.00":e.toFixed(2),_=async e=>{try{const[t,u]=e.split("-"),s=parseInt(u);for(let c of a.value.customers){let A=0;for(let F=1;F<=s;F++){const S=`${t}-${F.toString().padStart(2,"0")}`;try{const m=await fetch(`http://47.111.95.19:3000/nanhua-receipt-structure/${S}`);if(m.ok){const w=(await m.json()).data.customers.find(T=>T.customerName===c.customerName);w&&(A+=w.current||0)}}catch(m){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${S}\u7684\u6570\u636E:`,m)}}c.accumulated=A,c.executionProgress=c.yearlyPlan>0?c.accumulated/c.yearlyPlan*100:0}}catch(t){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u6570\u636E\u5931\u8D25:",t),a.value.customers.forEach(u=>{u.accumulated=0,u.executionProgress=0})}},p=I(()=>{const e={yearlyPlan:0,current:0,accumulated:0,executionProgress:0};return a.value.customers.forEach(t=>{e.yearlyPlan+=t.yearlyPlan||0,e.current+=t.current||0,e.accumulated+=t.accumulated||0}),e.executionProgress=e.yearlyPlan>0?e.accumulated/e.yearlyPlan*100:0,e}),f=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/nanhua-receipt-structure/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${e}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),y();return}const u=await t.json();u.data&&u.data.customers&&(a.value.customers=u.data.customers.map(s=>({customerName:s.customerName,yearlyPlan:Number(s.yearlyPlan)||0,current:Number(s.current)||0,accumulated:Number(s.accumulated)||0,executionProgress:Number(s.executionProgress)||0})))}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),y()}},y=()=>{a.value=JSON.parse(JSON.stringify(h))},D=async e=>{try{const t=await fetch(`http://47.111.95.19:3000/forms/submission/${v.NANHUA_RECEIPT_STRUCTURE}/${e}`);if(t.ok){const u=await t.json();u.success&&u.data&&(l.value=u.data.remarks||"",d.value=u.data.suggestions||"")}}catch(t){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",t)}};B(()=>E.query.period,async e=>{e&&(o.value=e.toString(),y(),await f(e.toString()),await _(e.toString()),D(e.toString()))}),B(o,async(e,t)=>{e&&e!==t&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${t} -> ${e}`),y(),await f(e),await _(e),D(e))});const R=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-receipt-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:o.value,data:a.value})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await z(v.NANHUA_RECEIPT_STRUCTURE,o.value,a.value,l.value,d.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25")}},U=()=>{a.value=JSON.parse(JSON.stringify(h)),l.value="",d.value=""};return J(async()=>{var t;y();const e=((t=E.query.period)==null?void 0:t.toString())||o.value;await f(e),await _(e),D(e)}),(e,t)=>(b(),x("div",K,[r("div",Q,[t[4]||(t[4]=r("h1",{class:"text-2xl font-bold"},"\u6536\u6B3E\u7ED3\u6784\u4E0E\u8D28\u91CF",-1)),r("div",W,[t[3]||(t[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3\uFF09\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),C(r("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>o.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[k,o.value]])])]),r("div",X,[r("table",Y,[t[6]||(t[6]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),r("tbody",null,[(b(!0),x(j,null,V(a.value.customers,(u,s)=>(b(),x("tr",{key:`customer-${s}`},[s===0?(b(),x("td",{key:0,rowspan:a.value.customers.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Z)):L("",!0),r("td",ee,n(u.customerName),1),r("td",te,n(i(u.yearlyPlan)),1),r("td",re,[C(r("input",{"onUpdate:modelValue":c=>u.current=c,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ue),[[k,u.current]])]),r("td",ae,n(i(u.accumulated)),1),r("td",se,[r("span",oe,n(N(u.executionProgress))+"%",1)])]))),128)),r("tr",ce,[t[5]||(t[5]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",ne,n(i(p.value.yearlyPlan)),1),r("td",le,n(i(p.value.current)),1),r("td",de,n(i(p.value.accumulated)),1),r("td",ie,[r("span",ye,n(N(p.value.executionProgress))+"%",1)])])])])]),M(G,{"module-id":q(v).NANHUA_RECEIPT_STRUCTURE,period:o.value,remarks:l.value,"onUpdate:remarks":t[1]||(t[1]=u=>l.value=u),suggestions:d.value,"onUpdate:suggestions":t[2]||(t[2]=u=>d.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:R,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:U,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Ee=$(pe,[["__scopeId","data-v-879f1e54"]]);export{Ee as default};
