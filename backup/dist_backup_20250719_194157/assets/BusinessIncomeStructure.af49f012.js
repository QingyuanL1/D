import{_ as $,d as N,r as g,c as P,B as S,o as j,b as E,e as t,y as q,A as O,F as V,g as L,t as l,k as G,h as J,G as z,v as m}from"./index.7a9c7972.js";import{_ as H,r as K,M as _,l as Q}from"./FormAttachmentAndRemarks.7f3870f1.js";const W={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},X={class:"flex justify-between items-center mb-6"},Y={class:"flex items-center space-x-4"},Z={class:"overflow-x-auto my-6"},uu={class:"w-full border-collapse border border-gray-300"},eu={class:"border border-gray-300 px-4 py-2 text-center"},ou={class:"border border-gray-300 px-4 py-2"},tu={class:"border border-gray-300 px-4 py-2"},ru={class:"w-full px-2 py-1"},su={class:"border border-gray-300 px-4 py-2"},au={key:0,class:"w-full px-2 py-1 bg-gray-100 rounded border text-gray-600"},nu={key:1,class:"w-full px-2 py-1"},cu={class:"border border-gray-300 px-4 py-2"},lu={class:"w-full px-2 py-1"},du={class:"border border-gray-300 px-4 py-2"},iu={class:"text-sm font-medium"},yu={class:"bg-gray-50 font-bold"},pu={class:"border border-gray-300 px-4 py-2"},gu={class:"border border-gray-300 px-4 py-2"},Eu={class:"border border-gray-300 px-4 py-2"},mu={class:"border border-gray-300 px-4 py-2"},hu=N({__name:"BusinessIncomeStructure",setup(Fu){var I;const h=z(),c=g(((I=h.query.period)==null?void 0:I.toString())||new Date().toISOString().slice(0,7)),F=()=>[{id:1,category:"\u4E3B\u8425\u4E1A\u52A1",yearlyPlan:0,currentMonthIncome:0,accumulatedIncome:0},{id:2,category:"\u975E\u4E3B\u8425\u4E1A\u52A1",yearlyPlan:0,currentMonthIncome:0,accumulatedIncome:0}],i=g(F()),v=g([]),y=g(""),p=g(""),w=(u,e)=>!u||u===0?"0.00":(e/u*100).toFixed(2),M=async u=>{try{const e=await fetch(`http://47.111.95.19:3000/main-business-income/${u}`);if(e.ok){const o=await e.json();if(o.success&&o.data){let s=0;const r=o.data;return r.equipment&&Array.isArray(r.equipment)&&r.equipment.forEach(a=>{s+=a.accumulatedIncome||0}),r.components&&Array.isArray(r.components)&&r.components.forEach(a=>{s+=a.accumulatedIncome||0}),r.engineering&&Array.isArray(r.engineering)&&r.engineering.forEach(a=>{s+=a.accumulatedIncome||0}),console.log("\u4E3B\u8425\u4E1A\u52A1\u7D2F\u79EF\u6536\u5165\u5408\u8BA1:",s),s}}}catch(e){console.error("\u83B7\u53D6\u4E3B\u8425\u4E1A\u52A1\u7D2F\u79EF\u6536\u5165\u5931\u8D25:",e)}return 0},C=async u=>{try{const e=await fetch(`http://47.111.95.19:3000/non-main-business/${u}`);if(e.ok){const o=await e.json();if(o.success&&o.data&&Array.isArray(o.data)){let s=0;return o.data.forEach(r=>{s+=r.cumulative||0}),console.log("\u975E\u4E3B\u8425\u4E1A\u52A1\u7D2F\u79EF\u6536\u5165\u5408\u8BA1:",s),s}}}catch(e){console.error("\u83B7\u53D6\u975E\u4E3B\u8425\u4E1A\u52A1\u7D2F\u79EF\u6536\u5165\u5931\u8D25:",e)}return 0},x=async u=>{try{const[e,o]=u.split("-"),s=parseInt(o),r=[];for(let a=1;a<=s;a++){const d=`${e}-${a.toString().padStart(2,"0")}`;try{const n=await fetch(`http://47.111.95.19:3000/business-income/${d}`);if(n.ok){const D=await n.json();D.data&&Array.isArray(D.data)&&r.push({period:d,data:D.data})}}catch(n){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${d}:`,n)}}v.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(e){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",e)}},k=(u,e)=>{let o=0;const s=c.value;for(const a of v.value){if(a.period===s)continue;const d=a.data.find(n=>n.id===u||n.category===e);d&&d.currentMonthIncome&&(o+=parseFloat(d.currentMonthIncome.toString())||0)}const r=i.value.find(a=>a.id===u);return r&&r.currentMonthIncome&&(o+=parseFloat(r.currentMonthIncome.toString())||0),o},B=()=>{i.value.forEach(u=>{u.accumulatedIncome=k(u.id,u.category)})},b=P(()=>{const u={yearlyPlan:0,currentMonthIncome:0,accumulatedIncome:0,progress:0};return i.value.forEach(e=>{u.yearlyPlan+=e.yearlyPlan||0,u.currentMonthIncome+=e.currentMonthIncome||0,u.accumulatedIncome+=e.accumulatedIncome||0}),u.progress=u.yearlyPlan>0?u.accumulatedIncome/u.yearlyPlan*100:0,u.progress=parseFloat(u.progress.toFixed(2)),u}),T=(u,e)=>!Array.isArray(e)||e.length===0?u:u.map(o=>{const s=e.find(r=>r.id===o.id);return s?{id:o.id,category:o.category,yearlyPlan:s.yearlyPlan||0,currentMonthIncome:s.currentMonthIncome||0,accumulatedIncome:s.accumulatedIncome||0}:o}),A=async u=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u8425\u4E1A\u6536\u5165\u7ED3\u6784\u6570\u636E\uFF0C\u671F\u95F4: ${u}`);const e=await fetch(`http://47.111.95.19:3000/business-income/${u}`);let o=F();if(e.ok){const n=await e.json();console.log("API\u8FD4\u56DE\u6570\u636E:",n),n.success&&n.data&&Array.isArray(n.data)&&(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."),o=T(F(),n.data),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",o))}else e.status===404&&console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F");const[s,r]=await Promise.all([M(u),C(u)]),a=o.find(n=>n.category==="\u4E3B\u8425\u4E1A\u52A1"),d=o.find(n=>n.category==="\u975E\u4E3B\u8425\u4E1A\u52A1");a&&(a.currentMonthIncome=s,console.log("\u4E3B\u8425\u4E1A\u52A1\u5F53\u6708\u6536\u5165\u8BBE\u7F6E\u4E3A:",s)),d&&(d.currentMonthIncome=r,console.log("\u975E\u4E3B\u8425\u4E1A\u52A1\u5F53\u6708\u6536\u5165\u8BBE\u7F6E\u4E3A:",r)),i.value=o,await x(u),B()}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e);try{await x(u),B()}catch(o){console.error("\u52A0\u8F7D\u5386\u53F2\u6570\u636E\u5931\u8D25:",o)}}};S(()=>h.query.period,u=>{u&&(c.value=u.toString(),A(u.toString()),f())}),S(c,u=>{A(u),f()});const U=async()=>{try{console.log("\u4FDD\u5B58\u6570\u636E:",{period:c.value,data:i.value});const u=await fetch("http://47.111.95.19:3000/business-income",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:c.value,data:i.value})});if(!u.ok){const e=await u.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${u.status} - ${e}`)}await K(_.BUSINESS_INCOME_STRUCTURE,c.value,i.value,y.value,p.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(u){console.error("\u4FDD\u5B58\u5931\u8D25:",u),alert("\u4FDD\u5B58\u5931\u8D25: "+(u instanceof Error?u.message:"\u672A\u77E5\u9519\u8BEF"))}},R=()=>{i.value=F(),y.value="",p.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},f=async()=>{const{remarks:u,suggestions:e}=await Q(_.BUSINESS_INCOME_STRUCTURE,c.value);y.value=u,p.value=e};return j(()=>{console.log("\u8425\u4E1A\u6536\u5165\u7ED3\u6784\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",c.value),h.query.period?A(h.query.period.toString()):A(c.value),f()}),(u,e)=>(m(),E("div",W,[t("div",X,[e[3]||(e[3]=t("h1",{class:"text-2xl font-bold"},"\u8425\u4E1A\u6536\u5165\u7ED3\u6784\u4E0E\u8D28\u91CF",-1)),t("div",Y,[q(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>c.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[O,c.value]])])]),t("div",Z,[t("table",uu,[e[6]||(e[6]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E8F\u53F7"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u8D22\u52A1\u79D1\u76EE"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u6708\u6536\u5165"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u6536\u5165"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),t("tbody",null,[(m(!0),E(V,null,L(i.value,(o,s)=>(m(),E("tr",{key:s},[t("td",eu,l(o.id),1),t("td",ou,l(o.category),1),t("td",tu,[t("span",ru,l(o.yearlyPlan),1)]),t("td",su,[o.category==="\u4E3B\u8425\u4E1A\u52A1"||o.category==="\u975E\u4E3B\u8425\u4E1A\u52A1"?(m(),E("span",au,l(o.currentMonthIncome.toFixed(2))+" (\u81EA\u52A8\u8BFB\u53D6) ",1)):(m(),E("span",nu,l(o.currentMonthIncome),1))]),t("td",cu,[t("span",lu,l(o.accumulatedIncome),1)]),t("td",du,[t("span",iu,l(w(o.yearlyPlan,o.accumulatedIncome))+"%",1)])]))),128)),t("tr",yu,[e[4]||(e[4]=t("td",{class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),e[5]||(e[5]=t("td",{class:"border border-gray-300 px-4 py-2"},null,-1)),t("td",pu,l(b.value.yearlyPlan.toFixed(2)),1),t("td",gu,l(b.value.currentMonthIncome.toFixed(2)),1),t("td",Eu,l(b.value.accumulatedIncome.toFixed(2)),1),t("td",mu,l(b.value.progress.toFixed(2))+"% ",1)])])])]),G(H,{"module-id":J(_).BUSINESS_INCOME_STRUCTURE,period:c.value,remarks:y.value,"onUpdate:remarks":e[1]||(e[1]=o=>y.value=o),suggestions:p.value,"onUpdate:suggestions":e[2]||(e[2]=o=>p.value=o)},null,8,["module-id","period","remarks","suggestions"]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:U,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:R,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var fu=$(hu,[["__scopeId","data-v-874f8020"]]);export{fu as default};
