import{_ as L,d as O,r as g,B as _,h as T,o as M,c as B,a as r,y as N,A as k,F as P,l as j,t as n,b as J,m as q,G as Y,f,k as G}from"./index.d631cc9b.js";import{_ as z,M as D,r as H}from"./FormAttachmentAndRemarks.53a80494.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},W={class:"flex items-center space-x-4"},X={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},tt=["rowspan"],et={class:"border border-gray-300 px-4 py-2"},rt={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"border border-gray-300 px-4 py-2"},ut=["onUpdate:modelValue"],st={class:"border border-gray-300 px-4 py-2 text-right"},ot={class:"border border-gray-300 px-4 py-2 text-right"},nt={class:"text-sm font-medium"},lt={class:"bg-gray-50 font-bold"},it={class:"border border-gray-300 px-4 py-2 text-right"},ct={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},pt={class:"border border-gray-300 px-4 py-2 text-right"},bt={class:"text-sm font-bold"},yt=O({__name:"BidFulfillment",setup(mt){var w;const v=Y(),o=g(((w=v.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),A={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",initialBalance:4200,currentPeriodValue:0,currentBalance:4200,volatilityRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",initialBalance:0,currentPeriodValue:0,currentBalance:0,volatilityRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",initialBalance:0,currentPeriodValue:0,currentBalance:0,volatilityRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",initialBalance:2800,currentPeriodValue:0,currentBalance:2800,volatilityRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",initialBalance:0,currentPeriodValue:0,currentBalance:0,volatilityRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",initialBalance:200,currentPeriodValue:0,currentBalance:200,volatilityRate:0}]},s=g(JSON.parse(JSON.stringify(A))),i=g(""),c=g(""),d=t=>t===0?"0.00":t.toFixed(2),E=t=>t===0?"0.00":t.toFixed(2),R=t=>t===0?!0:s.value.items[t].segmentAttribute!==s.value.items[t-1].segmentAttribute,U=t=>s.value.items.filter(e=>e.segmentAttribute===t).length,p=async t=>{try{const[e]=t.split("-"),a=parseInt(t.split("-")[1]);for(let u of s.value.items){let y=0;for(let h=1;h<=a;h++){const S=`${e}-${h.toString().padStart(2,"0")}`;try{const m=await fetch(`http://47.111.95.19:3000/tuoyuan-bid-fulfillment/${S}`);if(m.ok){const V=(await m.json()).data.items.find(C=>C.segmentAttribute===u.segmentAttribute&&C.customerAttribute===u.customerAttribute);V&&(y+=V.currentPeriodValue||0)}}catch(m){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${S}\u7684\u6570\u636E:`,m)}}u.currentBalance=u.initialBalance-y,u.volatilityRate=u.initialBalance>0?(u.currentBalance-u.initialBalance)/u.initialBalance*100:0}}catch(e){console.error("\u8BA1\u7B97\u5F53\u671F\u4F59\u989D\u548C\u6CE2\u52A8\u7387\u5931\u8D25:",e)}};_(()=>s.value.items,async t=>{await p(o.value)},{deep:!0});const b=T(()=>{const t={initialBalance:0,currentPeriodValue:0,currentBalance:0,volatilityRate:0};return s.value.items.forEach(e=>{t.initialBalance+=e.initialBalance||0,t.currentPeriodValue+=e.currentPeriodValue||0,t.currentBalance+=e.currentBalance||0}),t.volatilityRate=t.initialBalance>0?(t.currentBalance-t.initialBalance)/t.initialBalance*100:0,t}),F=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-bid-fulfillment/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),l();return}const a=await e.json();a.data&&a.data.items&&(s.value.items=a.data.items.map(u=>({segmentAttribute:u.segmentAttribute,customerAttribute:u.customerAttribute,initialBalance:Number(u.initialBalance)||0,currentPeriodValue:Number(u.currentPeriodValue)||0,currentBalance:Number(u.currentBalance)||0,volatilityRate:Number(u.volatilityRate)||0}))),await p(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),l()}},l=()=>{s.value=JSON.parse(JSON.stringify(A))},x=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${D.TUOYUAN_BID_FULFILLMENT}/${t}`);if(e.ok){const a=await e.json();a.success&&a.data&&(i.value=a.data.remarks||"",c.value=a.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};_(()=>v.query.period,async t=>{t&&(o.value=t.toString(),l(),await F(t.toString()),await p(t.toString()),x(t.toString()))}),_(o,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),l(),await F(t),await p(t),x(t))});const I=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-bid-fulfillment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:o.value,data:{items:s.value.items}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await H(D.TUOYUAN_BID_FULFILLMENT,o.value,{items:s.value.items},i.value,c.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},$=()=>{l(),i.value="",c.value=""};return M(async()=>{var e;l();const t=((e=v.query.period)==null?void 0:e.toString())||o.value;await F(t),await p(t),x(t)}),(t,e)=>(f(),B("div",K,[r("div",Q,[e[5]||(e[5]=r("h1",{class:"text-2xl font-bold"},"\u4E2D\u6807\u672A\u5C65\u7EA6\u60C5\u51B5",-1)),r("div",W,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[4]||(e[4]=r("span",{class:"text-xs text-gray-500"},"\u8BA1\u7B97\u503C = \u671F\u521D\u4F59\u989D - \u6240\u6709\u5F53\u671F\u503C",-1)),N(r("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>o.value=a),type:"month",class:"px-3 py-2 border rounded"},null,512),[[k,o.value]])])]),r("div",X,[r("table",Z,[e[7]||(e[7]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-24"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u671F\u521D\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u503C"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u4F59\u989D(\u8BA1\u7B97\u503C)"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u6CE2\u52A8\u7387")])],-1)),r("tbody",null,[(f(!0),B(P,null,j(s.value.items,(a,u)=>(f(),B("tr",{key:`bid-${u}`},[R(u)?(f(),B("td",{key:0,rowspan:U(a.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},n(a.segmentAttribute),9,tt)):G("",!0),r("td",et,n(a.customerAttribute),1),r("td",rt,n(d(a.initialBalance)),1),r("td",at,[N(r("input",{"onUpdate:modelValue":y=>a.currentPeriodValue=y,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ut),[[k,a.currentPeriodValue]])]),r("td",st,n(d(a.currentBalance)),1),r("td",ot,[r("span",nt,n(E(a.volatilityRate))+"%",1)])]))),128)),r("tr",lt,[e[6]||(e[6]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",it,n(d(b.value.initialBalance)),1),r("td",ct,n(d(b.value.currentPeriodValue)),1),r("td",dt,n(d(b.value.currentBalance)),1),r("td",pt,[r("span",bt,n(E(b.value.volatilityRate))+"%",1)])])])])]),J(z,{"module-id":q(D).TUOYUAN_BID_FULFILLMENT,period:o.value,remarks:i.value,"onUpdate:remarks":e[1]||(e[1]=a=>i.value=a),suggestions:c.value,"onUpdate:suggestions":e[2]||(e[2]=a=>c.value=a)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:$,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var vt=L(yt,[["__scopeId","data-v-38aa2a74"]]);export{vt as default};
