import{_ as W,d as X,r as _,c as D,B as P,o as Y,b,e as a,y as R,A,F as S,g as V,t as o,k as Z,h as ee,G as ae,v as m,f as $}from"./index.0fe187ee.js";import{_ as ue,r as te,M as N,l as re}from"./FormAttachmentAndRemarks.ea7d1baa.js";const se={class:"max-w-[1600px] mx-auto bg-white rounded-lg shadow-lg p-6"},oe={class:"flex justify-between items-center mb-6"},ne={class:"flex items-center space-x-4"},le={class:"overflow-x-auto my-6"},ce={class:"w-full border-collapse border border-gray-300"},de=["rowspan"],ie={class:"border border-gray-300 px-4 py-2"},pe={class:"border border-gray-300 px-4 py-2"},ve={class:"w-full px-2 py-1"},ye={class:"border border-gray-300 px-4 py-2"},be={class:"w-full px-2 py-1"},me={class:"border border-gray-300 px-4 py-2"},Be=["onUpdate:modelValue","onInput"],_e={class:"border border-gray-300 px-4 py-2"},ge={class:"w-full px-2 py-1"},De={class:"border border-gray-300 px-4 py-2"},Fe=["rowspan"],fe={class:"border border-gray-300 px-4 py-2"},he={class:"border border-gray-300 px-4 py-2"},Ee={class:"w-full px-2 py-1"},xe={class:"border border-gray-300 px-4 py-2"},we={class:"w-full px-2 py-1"},Re={class:"border border-gray-300 px-4 py-2"},Ae=["onUpdate:modelValue","onInput"],Ce={class:"border border-gray-300 px-4 py-2"},Te={class:"w-full px-2 py-1"},ke={class:"border border-gray-300 px-4 py-2"},Ie=["rowspan"],Se={class:"border border-gray-300 px-4 py-2"},Ve={class:"border border-gray-300 px-4 py-2"},$e={class:"w-full px-2 py-1"},Ne={class:"border border-gray-300 px-4 py-2"},Oe={class:"w-full px-2 py-1"},Ue={class:"border border-gray-300 px-4 py-2"},Me=["onUpdate:modelValue","onInput"],qe={class:"border border-gray-300 px-4 py-2"},Pe={class:"w-full px-2 py-1"},je={class:"border border-gray-300 px-4 py-2"},Le={class:"bg-gray-50 font-bold"},ze={class:"border border-gray-300 px-4 py-2"},Ge={class:"border border-gray-300 px-4 py-2"},Je={class:"border border-gray-300 px-4 py-2"},He={class:"border border-gray-300 px-4 py-2"},Ke={class:"border border-gray-300 px-4 py-2"},Qe=X({__name:"BadDebtProvision",setup(We){var q;const O=ae(),v=_(((q=O.query.period)==null?void 0:q.toString())||new Date().toISOString().slice(0,7)),F=_(""),f=_(""),U=_([]),h=()=>[{customerType:"\u4E0A\u6D77",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u56FD\u7F51",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u6C5F\u82CF",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u897F\u95E8\u5B50",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u540C\u4E1A",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u7528\u6237",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u5176\u5B83",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0}],E=()=>[{customerType:"\u7528\u6237",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0}],x=()=>[{customerType:"\u4E00\u5305",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u4E8C\u5305",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0},{customerType:"\u5176\u5B83",initialBalance:0,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0}],l=_(h()),c=_(E()),d=_(x()),j=D(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.initialBalance||0),0)),L=D(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.newAddition||0),0)),z=D(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.currentReversal||0),0)),G=D(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.accumulatedReversal||0),0)),J=D(()=>[...l.value,...c.value,...d.value].reduce((e,t)=>e+(t.finalBalance||0),0)),M=async e=>{try{const[t,u]=e.split("-"),s=parseInt(u),r=[];for(let i=1;i<=s;i++){const p=`${t}-${i.toString().padStart(2,"0")}`;try{const y=await fetch(`http://47.111.95.19:3000/bad-debt-provision/${p}`);if(y.ok){const B=await y.json();B.data&&Array.isArray(B.data)&&r.push({period:p,data:B.data})}}catch(y){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${p}:`,y)}}U.value=r,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",r)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},C=(e,t)=>{let u=0;const s=v.value;for(const p of U.value){if(p.period===s)continue;const y=p.data.find(B=>B.segment===e&&B.customerType===t);y&&y.currentReversal&&(u+=parseFloat(y.currentReversal.toString())||0)}let r=[];e==="\u8BBE\u5907"?r=l.value:e==="\u5143\u4EF6"?r=c.value:e==="\u5DE5\u7A0B"&&(r=d.value);const i=r.find(p=>p.customerType===t);return i&&i.currentReversal&&(u+=parseFloat(i.currentReversal.toString())||0),u},w=()=>{l.value.forEach(e=>{e.accumulatedReversal=C("\u8BBE\u5907",e.customerType)}),c.value.forEach(e=>{e.accumulatedReversal=C("\u5143\u4EF6",e.customerType)}),d.value.forEach(e=>{e.accumulatedReversal=C("\u5DE5\u7A0B",e.customerType)})},T=e=>{w(),e.finalBalance=(e.initialBalance||0)+(e.newAddition||0)-(e.accumulatedReversal||0)},n=e=>e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),H={\u8BBE\u5907:{\u4E0A\u6D77:235.75,\u56FD\u7F51:76.77,\u6C5F\u82CF:79.63,\u8F93\u914D\u7535\u5185\u914D:163.42,\u897F\u95E8\u5B50:0,\u540C\u4E1A:10.33,\u7528\u6237:1490.63,\u5176\u5B83:381.37},\u5143\u4EF6:{\u7528\u6237:14.76},\u5DE5\u7A0B:{\u4E00\u5305:13.94,\u4E8C\u5305:66.5,\u57DF\u5185\u5408\u4F5C:71.29,\u57DF\u5916\u5408\u4F5C:76.52,\u5176\u5B83:16.89}},g=(e,t,u)=>e.map(s=>{var p;const r=t==null?void 0:t.find(y=>y.segment===u&&y.customerType===s.customerType),i=((p=H[u])==null?void 0:p[s.customerType])||0;return r?{customerType:s.customerType,initialBalance:i,newAddition:Number(r.newAddition)||0,currentReversal:Number(r.currentReversal)||0,accumulatedReversal:Number(r.accumulatedReversal)||0,finalBalance:Number(r.finalBalance)||0,yearlyPlan:i}:{customerType:s.customerType,initialBalance:i,newAddition:0,currentReversal:0,accumulatedReversal:0,finalBalance:0,yearlyPlan:i}}),k=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u574F\u8D26\u51C6\u5907\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const t=await fetch(`http://47.111.95.19:3000/bad-debt-provision/${e}`);let u=[];if(t.ok){const r=await t.json();console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data&&Array.isArray(r.data)&&(u=r.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else t.status===404?console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145"):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");l.value=g(h(),u,"\u8BBE\u5907"),c.value=g(E(),u,"\u5143\u4EF6"),d.value=g(x(),u,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:l.value,componentData:c.value,engineeringData:d.value}),await M(e),w(),[...l.value,...c.value,...d.value].forEach(r=>{r.finalBalance=(r.initialBalance||0)+(r.newAddition||0)-(r.accumulatedReversal||0)})}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),l.value=g(h(),[],"\u8BBE\u5907"),c.value=g(E(),[],"\u5143\u4EF6"),d.value=g(x(),[],"\u5DE5\u7A0B"),await M(e),w()}};P(()=>O.query.period,e=>{e&&(v.value=e.toString(),k(e.toString()),I())}),P(v,e=>{e&&(k(e),I())});const K=async()=>{try{w();const e=[...l.value.map(s=>({...s,segment:"\u8BBE\u5907"})),...c.value.map(s=>({...s,segment:"\u5143\u4EF6"})),...d.value.map(s=>({...s,segment:"\u5DE5\u7A0B"}))],t={period:v.value,data:e};console.log("\u4FDD\u5B58\u6570\u636E:",t);const u=await fetch("http://47.111.95.19:3000/bad-debt-provision",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!u.ok){const s=await u.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${u.status} - ${s}`)}await te(N.BAD_DEBT_PROVISION,v.value,e,F.value,f.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert(`\u4FDD\u5B58\u5931\u8D25: ${e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"}`)}},Q=()=>{l.value=h(),c.value=E(),d.value=x(),console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},I=async()=>{const{remarks:e,suggestions:t}=await re(N.BAD_DEBT_PROVISION,v.value);F.value=e,f.value=t};return Y(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",v.value),k(v.value),I()}),(e,t)=>(m(),b("div",se,[a("div",oe,[t[3]||(t[3]=a("h1",{class:"text-2xl font-bold"},"\u574F\u8D26\u51C6\u5907\u60C5\u51B5",-1)),a("div",ne,[R(a("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>v.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[A,v.value]])])]),a("div",le,[a("table",ce,[t[5]||(t[5]=a("thead",{class:"sticky top-0 bg-white"},[a("tr",{class:"bg-gray-50"},[a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),a("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u521D\u4F59\u989D"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u672C\u5E74\u65B0\u589E"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u6708\u8F6C\u56DE"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u7D2F\u8BA1\u8F6C\u56DE"),a("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u574F\u8D26\u51C6\u5907\u4F59\u989D")])],-1)),a("tbody",null,[(m(!0),b(S,null,V(l.value,(u,s)=>(m(),b("tr",{key:`equipment-${s}`},[s===0?(m(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:l.value.length}," \u8BBE\u5907 ",8,de)):$("",!0),a("td",ie,o(u.customerType),1),a("td",pe,[a("span",ve,o(n(u.initialBalance)),1)]),a("td",ye,[a("span",be,o(n(u.newAddition)),1)]),a("td",me,[R(a("input",{"onUpdate:modelValue":r=>u.currentReversal=r,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:r=>T(u)},null,40,Be),[[A,u.currentReversal,void 0,{number:!0}]])]),a("td",_e,[a("span",ge,o(n(u.accumulatedReversal)),1)]),a("td",De,o(n(u.finalBalance)),1)]))),128)),(m(!0),b(S,null,V(c.value,(u,s)=>(m(),b("tr",{key:`component-${s}`},[s===0?(m(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:c.value.length}," \u5143\u4EF6 ",8,Fe)):$("",!0),a("td",fe,o(u.customerType),1),a("td",he,[a("span",Ee,o(n(u.initialBalance)),1)]),a("td",xe,[a("span",we,o(n(u.newAddition)),1)]),a("td",Re,[R(a("input",{"onUpdate:modelValue":r=>u.currentReversal=r,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:r=>T(u)},null,40,Ae),[[A,u.currentReversal,void 0,{number:!0}]])]),a("td",Ce,[a("span",Te,o(n(u.accumulatedReversal)),1)]),a("td",ke,o(n(u.finalBalance)),1)]))),128)),(m(!0),b(S,null,V(d.value,(u,s)=>(m(),b("tr",{key:`engineering-${s}`},[s===0?(m(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center font-medium",rowspan:d.value.length}," \u5DE5\u7A0B ",8,Ie)):$("",!0),a("td",Se,o(u.customerType),1),a("td",Ve,[a("span",$e,o(n(u.initialBalance)),1)]),a("td",Ne,[a("span",Oe,o(n(u.newAddition)),1)]),a("td",Ue,[R(a("input",{"onUpdate:modelValue":r=>u.currentReversal=r,type:"number",class:"w-full px-2 py-1 border rounded",step:"0.01",onInput:r=>T(u)},null,40,Me),[[A,u.currentReversal,void 0,{number:!0}]])]),a("td",qe,[a("span",Pe,o(n(u.accumulatedReversal)),1)]),a("td",je,o(n(u.finalBalance)),1)]))),128)),a("tr",Le,[t[4]||(t[4]=a("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"}," \u5408\u8BA1 ",-1)),a("td",ze,o(n(j.value)),1),a("td",Ge,o(n(L.value)),1),a("td",Je,o(n(z.value)),1),a("td",He,o(n(G.value)),1),a("td",Ke,o(n(J.value)),1)])])])]),a("div",{class:"mt-4 flex justify-end space-x-4"},[a("button",{onClick:K,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),a("button",{onClick:Q,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),Z(ue,{"module-id":ee(N).BAD_DEBT_PROVISION,period:v.value,remarks:F.value,"onUpdate:remarks":t[1]||(t[1]=u=>F.value=u),suggestions:f.value,"onUpdate:suggestions":t[2]||(t[2]=u=>f.value=u)},null,8,["module-id","period","remarks","suggestions"])]))}});var Ze=W(Qe,[["__scopeId","data-v-2396cbe0"]]);export{Ze as default};
