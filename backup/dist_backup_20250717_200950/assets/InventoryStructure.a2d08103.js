import{_ as $,d as I,r as v,B as _,c as V,o as j,b as B,e as r,y as R,A as N,F as Y,g as J,t as i,k as M,h as q,G as L,v as f,f as G}from"./index.0fe187ee.js";import{_ as z,M as F,r as H}from"./FormAttachmentAndRemarks.ea7d1baa.js";const K={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Q={class:"flex justify-between items-center mb-6"},W={class:"flex items-center space-x-4"},X={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},tt=["rowspan"],et={class:"border border-gray-300 px-4 py-2"},rt={class:"border border-gray-300 px-4 py-2 text-right"},ut={class:"border border-gray-300 px-4 py-2"},nt=["onUpdate:modelValue"],ot={class:"border border-gray-300 px-4 py-2 text-right"},st={class:"border border-gray-300 px-4 py-2 text-right"},at={class:"text-sm font-medium"},it={class:"bg-gray-50 font-bold"},ct={class:"border border-gray-300 px-4 py-2 text-right"},lt={class:"border border-gray-300 px-4 py-2 text-right"},dt={class:"border border-gray-300 px-4 py-2 text-right"},mt={class:"border border-gray-300 px-4 py-2 text-right"},gt={class:"text-sm font-bold"},yt=I({__name:"InventoryStructure",setup(pt){var P;const D=L(),a=v(((P=D.query.period)==null?void 0:P.toString())||new Date().toISOString().slice(0,7)),x={items:[{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7535\u4E1A\u9879\u76EE",yearBeginningAmount:5304.53,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:5304.53,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u7528\u6237\u9879\u76EE",yearBeginningAmount:374.66,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:374.66,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u8D38\u6613",yearBeginningAmount:0,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:0,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u5907",yearBeginningAmount:3661.89,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:3661.89,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u5DE5\u7A0B",yearBeginningAmount:0,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:0,fluctuationRate:0},{segmentAttribute:"\u8BBE\u5907",customerAttribute:"\u4EE3\u7406\u8BBE\u8BA1",yearBeginningAmount:200,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:200,fluctuationRate:0}]},s=v(JSON.parse(JSON.stringify(x))),d=v(""),m=v(""),g=t=>t===0?"0.00":t.toFixed(2),C=t=>t===0?"0.00":t.toFixed(2),k=t=>t===0?!0:s.value.items[t].segmentAttribute!==s.value.items[t-1].segmentAttribute,U=t=>s.value.items.filter(e=>e.segmentAttribute===t).length,y=async t=>{try{const[e]=t.split("-"),u=parseInt(t.split("-")[1]);for(let n of s.value.items){let o=0;for(let l=1;l<u;l++){const p=`${e}-${l.toString().padStart(2,"0")}`;try{const A=await fetch(`http://47.111.95.19:3000/tuoyuan-inventory-structure/${p}`);if(A.ok){const w=(await A.json()).data.items.find(S=>S.segmentAttribute===n.segmentAttribute&&S.customerAttribute===n.customerAttribute);w&&(o+=w.currentPeriodAmount||0)}}catch(A){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${p}\u7684\u6570\u636E:`,A)}}o+=n.currentPeriodAmount||0,n.currentPeriodCumulative=o,n.currentPeriodCalculated=n.yearBeginningAmount-n.currentPeriodCumulative,n.fluctuationRate=n.yearBeginningAmount>0?-n.currentPeriodCumulative/n.yearBeginningAmount*100:0}}catch(e){console.error("\u8BA1\u7B97\u5F53\u671F\u91D1\u989D\u7D2F\u8BA1\u5931\u8D25:",e)}};_(()=>s.value.items,async t=>{await y(a.value)},{deep:!0});const b=V(()=>{const t={yearBeginningAmount:0,currentPeriodAmount:0,currentPeriodCumulative:0,currentPeriodCalculated:0,fluctuationRate:0};return s.value.items.forEach(e=>{t.yearBeginningAmount+=e.yearBeginningAmount||0,t.currentPeriodAmount+=e.currentPeriodAmount||0,t.currentPeriodCumulative+=e.currentPeriodCumulative||0}),t.currentPeriodCalculated=t.yearBeginningAmount-t.currentPeriodCumulative,t.fluctuationRate=t.yearBeginningAmount>0?-t.currentPeriodCumulative/t.yearBeginningAmount*100:0,t}),E=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/tuoyuan-inventory-structure/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),c();return}const u=await e.json();if(u.data&&u.data.items){const n=u.data.items;s.value.items=x.items.map(o=>{const l=n.find(p=>p.segmentAttribute===o.segmentAttribute&&p.customerAttribute===o.customerAttribute);return{segmentAttribute:o.segmentAttribute,customerAttribute:o.customerAttribute,yearBeginningAmount:o.yearBeginningAmount,currentPeriodAmount:l&&Number(l.currentPeriodAmount)||0,currentPeriodCumulative:0,currentPeriodCalculated:o.yearBeginningAmount,fluctuationRate:0}})}await y(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),c()}},c=()=>{s.value=JSON.parse(JSON.stringify(x))},h=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${F.TUOYUAN_INVENTORY_STRUCTURE}/${t}`);if(e.ok){const u=await e.json();u.success&&u.data&&(d.value=u.data.remarks||"",m.value=u.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};_(()=>D.query.period,async t=>{t&&(a.value=t.toString(),c(),await E(t.toString()),await y(t.toString()),h(t.toString()))}),_(a,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),c(),await E(t),await y(t),h(t))});const T=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/tuoyuan-inventory-structure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:a.value,data:{items:s.value.items.map(e=>({segmentAttribute:e.segmentAttribute,customerAttribute:e.customerAttribute,yearBeginningAmount:e.yearBeginningAmount,currentPeriodAmount:e.currentPeriodAmount}))}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await H(F.TUOYUAN_INVENTORY_STRUCTURE,a.value,{items:s.value.items},d.value,m.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},O=()=>{c(),d.value="",m.value=""};return j(async()=>{var e;c();const t=((e=D.query.period)==null?void 0:e.toString())||a.value;await E(t),await y(t),h(t)}),(t,e)=>(f(),B("div",K,[r("div",Q,[e[6]||(e[6]=r("h1",{class:"text-2xl font-bold"},"\u62D3\u6E90\u5B58\u91CF\u7ED3\u6784\u4E0E\u8D28\u91CF",-1)),r("div",W,[e[3]||(e[3]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[4]||(e[4]=r("span",{class:"text-xs text-gray-500"},"\u6309\u5E74\u5EA6\u8BA1\u5212\u53E3\u5F84\u5206\u89E3",-1)),e[5]||(e[5]=r("span",{class:"text-xs text-gray-500"},"\u5F53\u671F\u91D1\u989D\u7D2F\u8BA1 = \u5F53\u671F\u91D1\u989D + \u4E4B\u524D\u5404\u6708\u7D2F\u8BA1",-1)),R(r("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>a.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[N,a.value]])])]),r("div",X,[r("table",Z,[e[8]||(e[8]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5E74\u521D\u91D1\u989D"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u5F53\u671F\u91D1\u989D"),r("th",{class:"border border-gray-300 px-4 py-2 w-40"},"\u5F53\u671F\u91D1\u989D(\u8BA1\u7B97\u503C)"),r("th",{class:"border border-gray-300 px-4 py-2 w-32"},"\u6CE2\u52A8\u7387")])],-1)),r("tbody",null,[(f(!0),B(Y,null,J(s.value.items,(u,n)=>(f(),B("tr",{key:`item-${n}`},[k(n)?(f(),B("td",{key:0,rowspan:U(u.segmentAttribute),class:"border border-gray-300 px-4 py-2 font-medium text-center"},i(u.segmentAttribute),9,tt)):G("",!0),r("td",et,i(u.customerAttribute),1),r("td",rt,i(g(u.yearBeginningAmount)),1),r("td",ut,[R(r("input",{"onUpdate:modelValue":o=>u.currentPeriodAmount=o,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,nt),[[N,u.currentPeriodAmount]])]),r("td",ot,i(g(u.currentPeriodCalculated)),1),r("td",st,[r("span",at,i(C(u.fluctuationRate))+"%",1)])]))),128)),r("tr",it,[e[7]||(e[7]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",ct,i(g(b.value.yearBeginningAmount)),1),r("td",lt,i(g(b.value.currentPeriodAmount)),1),r("td",dt,i(g(b.value.currentPeriodCalculated)),1),r("td",mt,[r("span",gt,i(C(b.value.fluctuationRate))+"%",1)])])])])]),M(z,{"module-id":q(F).TUOYUAN_INVENTORY_STRUCTURE,period:a.value,remarks:d.value,"onUpdate:remarks":e[1]||(e[1]=u=>d.value=u),suggestions:m.value,"onUpdate:suggestions":e[2]||(e[2]=u=>m.value=u)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:T,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:O,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var Bt=$(yt,[["__scopeId","data-v-804ec236"]]);export{Bt as default};
