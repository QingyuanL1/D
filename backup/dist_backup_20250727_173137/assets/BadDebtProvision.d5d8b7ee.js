import{_ as I,d as U,r as w,B as v,h as V,o as T,c as f,a as r,y as _,A as F,F as R,l as J,t as i,b as M,m as q,G as H,f as x,k as L}from"./index.a1c43a78.js";import{_ as Y,M as P,r as G}from"./FormAttachmentAndRemarks.e6065ef7.js";const z={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},K={class:"flex justify-between items-center mb-6"},Q={class:"flex items-center space-x-4"},W={class:"overflow-x-auto my-6"},X={class:"w-full border-collapse border border-gray-300"},Z=["rowspan"],ee={class:"border border-gray-300 px-4 py-2"},te={class:"border border-gray-300 px-4 py-2 text-right"},re={class:"border border-gray-300 px-4 py-2"},ae=["onUpdate:modelValue"],ne={class:"border border-gray-300 px-4 py-2 text-right"},oe={class:"border border-gray-300 px-4 py-2 text-right"},ue={class:"text-sm font-medium"},ie={class:"border border-gray-300 px-4 py-2 text-right"},se={class:"border border-gray-300 px-4 py-2"},de={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"border border-gray-300 px-4 py-2 text-right"},ce={class:"text-sm font-medium"},ye={class:"bg-gray-50 font-bold"},pe={class:"border border-gray-300 px-4 py-2 text-right"},ge={class:"border border-gray-300 px-4 py-2 text-right"},Be={class:"border border-gray-300 px-4 py-2 text-right"},be={class:"border border-gray-300 px-4 py-2 text-right"},Ae={class:"text-sm font-bold"},we=U({__name:"BadDebtProvision",setup(me){var C;const E=H(),s=w(((C=E.query.period)==null?void 0:C.toString())||new Date().toISOString().slice(0,7)),S={items:[{customerAttribute:"\u4E00\u5305\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0},{customerAttribute:"\u4E8C\u5305\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0},{customerAttribute:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",yearBeginningBalance:7.48,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:7.48},{customerAttribute:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0},{customerAttribute:"\u65B0\u80FD\u6E90\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0},{customerAttribute:"\u82CF\u5DDE\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0},{customerAttribute:"\u62A2\u4FEE\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0},{customerAttribute:"\u8FD0\u68C0\u9879\u76EE",yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0}]},l=w(JSON.parse(JSON.stringify(S))),n=w({yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0}),B=w(""),b=w(""),d=t=>t===0?"0.00":t.toFixed(2),y=async t=>{try{const[e]=t.split("-"),a=parseInt(t.split("-")[1]);for(let u of l.value.items){let g=0;for(let c=1;c<a;c++){const A=`${e}-${c.toString().padStart(2,"0")}`;try{const N=await fetch(`http://47.111.95.19:3000/nanhua-bad-debt-provision/${A}`);if(N.ok){const k=(await N.json()).data.items.find(O=>O.customerAttribute===u.customerAttribute);k&&(g+=k.currentPeriodNewAddition||0)}}catch(N){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${A}\u7684\u6570\u636E:`,N)}}g+=u.currentPeriodNewAddition||0,u.yearNewAddition=g,u.endBalance=u.yearBeginningBalance+u.yearNewAddition}let o=0;for(let u=1;u<a;u++){const g=`${e}-${u.toString().padStart(2,"0")}`;try{const c=await fetch(`http://47.111.95.19:3000/nanhua-bad-debt-provision/${g}`);if(c.ok){const A=await c.json();A.data.selfBuiltProject&&(o+=A.data.selfBuiltProject.currentPeriodNewAddition||0)}}catch(c){console.warn(`\u65E0\u6CD5\u52A0\u8F7D${g}\u7684\u81EA\u5EFA\u9879\u76EE\u6570\u636E:`,c)}}o+=n.value.currentPeriodNewAddition||0,n.value.yearNewAddition=o,n.value.endBalance=n.value.yearBeginningBalance+n.value.yearNewAddition}catch(e){console.error("\u8BA1\u7B97\u672C\u5E74\u65B0\u589E\u5931\u8D25:",e)}};v(()=>l.value.items,async t=>{await y(s.value)},{deep:!0}),v(()=>n.value,async t=>{await y(s.value)},{deep:!0});const m=V(()=>{const t={yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0};return l.value.items.forEach(e=>{t.yearBeginningBalance+=e.yearBeginningBalance||0,t.currentPeriodNewAddition+=e.currentPeriodNewAddition||0,t.yearNewAddition+=e.yearNewAddition||0,t.endBalance+=e.endBalance||0}),t.yearBeginningBalance+=n.value.yearBeginningBalance||0,t.currentPeriodNewAddition+=n.value.currentPeriodNewAddition||0,t.yearNewAddition+=n.value.yearNewAddition||0,t.endBalance+=n.value.endBalance||0,t}),D=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/nanhua-bad-debt-provision/${t}`);if(!e.ok){if(e.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log(`${t}\u671F\u95F4\u65E0\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u72B6\u6001`),p();return}const a=await e.json();a.data&&(a.data.items&&(l.value.items=a.data.items.map(o=>({customerAttribute:o.customerAttribute,yearBeginningBalance:Number(o.yearBeginningBalance)||0,currentPeriodNewAddition:Number(o.currentPeriodNewAddition)||0,yearNewAddition:Number(o.yearNewAddition)||0,endBalance:Number(o.endBalance)||0}))),a.data.selfBuiltProject&&(n.value={yearBeginningBalance:Number(a.data.selfBuiltProject.yearBeginningBalance)||0,currentPeriodNewAddition:Number(a.data.selfBuiltProject.currentPeriodNewAddition)||0,yearNewAddition:Number(a.data.selfBuiltProject.yearNewAddition)||0,endBalance:Number(a.data.selfBuiltProject.endBalance)||0})),await y(t)}catch(e){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",e),p()}},p=()=>{l.value=JSON.parse(JSON.stringify(S)),n.value={yearBeginningBalance:0,currentPeriodNewAddition:0,yearNewAddition:0,endBalance:0}},h=async t=>{try{const e=await fetch(`http://47.111.95.19:3000/forms/submission/${P.NANHUA_BAD_DEBT_PROVISION}/${t}`);if(e.ok){const a=await e.json();a.success&&a.data&&(B.value=a.data.remarks||"",b.value=a.data.suggestions||"")}}catch(e){console.error("\u52A0\u8F7D\u5907\u6CE8\u5931\u8D25:",e)}};v(()=>E.query.period,async t=>{t&&(s.value=t.toString(),p(),await D(t.toString()),await y(t.toString()),h(t.toString()))}),v(s,async(t,e)=>{t&&t!==e&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${e} -> ${t}`),p(),await D(t),await y(t),h(t))});const j=async()=>{try{if(!(await fetch("http://47.111.95.19:3000/nanhua-bad-debt-provision",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s.value,data:{items:l.value.items,selfBuiltProject:n.value}})})).ok)throw new Error("\u4FDD\u5B58\u5931\u8D25");await G(P.NANHUA_BAD_DEBT_PROVISION,s.value,{items:l.value.items,selfBuiltProject:n.value},B.value,b.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25")}},$=()=>{p(),B.value="",b.value=""};return T(async()=>{var e;p();const t=((e=E.query.period)==null?void 0:e.toString())||s.value;await D(t),await y(t),h(t)}),(t,e)=>(x(),f("div",z,[r("div",K,[e[6]||(e[6]=r("h1",{class:"text-2xl font-bold"},"\u574F\u8D26\u51C6\u5907\u60C5\u51B5",-1)),r("div",Q,[e[4]||(e[4]=r("span",{class:"text-sm text-gray-600"},"\uFF08\u5355\u4F4D\uFF1A\u4E07\u5143\uFF09",-1)),e[5]||(e[5]=r("span",{class:"text-xs text-gray-500"},"\u672C\u5E74\u65B0\u589E = \u5F53\u671F\u4E4B\u524D\u5404\u6708\u7684\u672C\u671F\u65B0\u589E\u6570\u636E\u81EA\u52A8\u7D2F\u8BA1",-1)),_(r("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.value=a),type:"month",class:"px-3 py-2 border rounded"},null,512),[[F,s.value]])])]),r("div",W,[r("table",X,[e[10]||(e[10]=r("thead",{class:"sticky top-0 bg-white"},[r("tr",{class:"bg-gray-50"},[r("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u989D"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u671F\u65B0\u589E"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u5E74\u65B0\u589E"),r("th",{class:"border border-gray-300 px-4 py-2"},"\u574F\u8D26\u51C6\u5907\u4F59\u989D")])],-1)),r("tbody",null,[(x(!0),f(R,null,J(l.value.items,(a,o)=>(x(),f("tr",{key:`item-${o}`},[o===0?(x(),f("td",{key:0,rowspan:l.value.items.length,class:"border border-gray-300 px-4 py-2 font-medium text-center"}," \u5DE5\u7A0B ",8,Z)):L("",!0),r("td",ee,i(a.customerAttribute),1),r("td",te,i(d(a.yearBeginningBalance)),1),r("td",re,[_(r("input",{"onUpdate:modelValue":u=>a.currentPeriodNewAddition=u,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,ae),[[F,a.currentPeriodNewAddition]])]),r("td",ne,i(d(a.yearNewAddition)),1),r("td",oe,[r("span",ue,i(d(a.endBalance)),1)])]))),128)),r("tr",null,[e[7]||(e[7]=r("td",{class:"border border-gray-300 px-4 py-2 font-medium text-center"},"\u81EA\u5EFA\u9879\u76EE",-1)),e[8]||(e[8]=r("td",{class:"border border-gray-300 px-4 py-2"},"\u81EA\u5EFA\u9879\u76EE",-1)),r("td",ie,i(d(n.value.yearBeginningBalance)),1),r("td",se,[_(r("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>n.value.currentPeriodNewAddition=a),type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,512),[[F,n.value.currentPeriodNewAddition]])]),r("td",de,i(d(n.value.yearNewAddition)),1),r("td",le,[r("span",ce,i(d(n.value.endBalance)),1)])]),r("tr",ye,[e[9]||(e[9]=r("td",{colspan:"2",class:"border border-gray-300 px-4 py-2 text-center"},"\u5408\u8BA1",-1)),r("td",pe,i(d(m.value.yearBeginningBalance)),1),r("td",ge,i(d(m.value.currentPeriodNewAddition)),1),r("td",Be,i(d(m.value.yearNewAddition)),1),r("td",be,[r("span",Ae,i(d(m.value.endBalance)),1)])])])])]),M(Y,{"module-id":q(P).NANHUA_BAD_DEBT_PROVISION,period:s.value,remarks:B.value,"onUpdate:remarks":e[2]||(e[2]=a=>B.value=a),suggestions:b.value,"onUpdate:suggestions":e[3]||(e[3]=a=>b.value=a)},null,8,["module-id","period","remarks","suggestions"]),r("div",{class:"mt-4 flex justify-end space-x-4"},[r("button",{onClick:j,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),r("button",{onClick:$,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")])]))}});var xe=I(we,[["__scopeId","data-v-17d723ba"]]);export{xe as default};
