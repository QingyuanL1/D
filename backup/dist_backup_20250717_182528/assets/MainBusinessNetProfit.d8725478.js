import{_ as Q,d as W,r as v,c as X,B as L,o as Y,b,e,y as k,A as I,F as j,g as R,t as c,k as Z,h as uu,G as tu,v as F,f as U}from"./index.0a104486.js";import{_ as eu,r as ou,M as q,l as au}from"./FormAttachmentAndRemarks.c9683b81.js";const ru={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},su={class:"flex justify-between items-center mb-6"},nu={class:"flex items-center space-x-4"},lu={class:"overflow-x-auto my-6"},cu={class:"w-full border-collapse border border-gray-300"},pu=["rowspan"],du={class:"border border-gray-300 px-4 py-2"},iu={class:"border border-gray-300 px-4 py-2"},yu=["onUpdate:modelValue"],gu={class:"border border-gray-300 px-4 py-2"},Eu={class:"font-medium"},bu={class:"border border-gray-300 px-4 py-2"},Fu={class:"font-medium"},mu={class:"border border-gray-300 px-4 py-2"},hu=["rowspan"],Du={class:"border border-gray-300 px-4 py-2"},_u={class:"border border-gray-300 px-4 py-2"},vu=["onUpdate:modelValue"],fu={class:"border border-gray-300 px-4 py-2"},Bu={class:"font-medium"},xu={class:"border border-gray-300 px-4 py-2"},Cu={class:"font-medium"},Au={class:"border border-gray-300 px-4 py-2"},Mu=["rowspan"],wu={class:"border border-gray-300 px-4 py-2"},Vu={class:"border border-gray-300 px-4 py-2"},Tu=["onUpdate:modelValue"],Su={class:"border border-gray-300 px-4 py-2"},ku={class:"font-medium"},Iu={class:"border border-gray-300 px-4 py-2"},$u={class:"font-medium"},Nu={class:"border border-gray-300 px-4 py-2"},ju={class:"bg-gray-50 font-bold"},Ru={class:"border border-gray-300 px-4 py-2"},Uu={class:"border border-gray-300 px-4 py-2"},qu={class:"border border-gray-300 px-4 py-2"},Ou={class:"border border-gray-300 px-4 py-2"},Pu=W({__name:"MainBusinessNetProfit",setup(Lu){var P;const w=tu(),p=v(((P=w.query.period)==null?void 0:P.toString())||new Date().toISOString().slice(0,7)),f=v(""),B=v(""),x=()=>[{customerType:"\u4E0A\u6D77",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u56FD\u7F51",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u540C\u4E1A",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],C=()=>[{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],A=()=>[{customerType:"\u4E00\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u4E8C\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],d=v(x()),i=v(C()),y=v(A()),D=t=>t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),O=async(t,o,u)=>{try{let r=0,a=0,n=0;try{const s=await fetch(`http://47.111.95.19:3000/main-business-income/${u}`);if(s.ok){const g=await s.json();if(g.success&&g.data){const M={\u8BBE\u5907:"equipment",\u5143\u4EF6:"component",\u5DE5\u7A0B:"project"},E=g.data[M[o]];if(E&&Array.isArray(E)){const h={\u4E0A\u6D77:"\u4E0A\u6D77\u9879\u76EE",\u56FD\u7F51:"\u56FD\u7F51\u9879\u76EE",\u6C5F\u82CF:"\u6C5F\u82CF\u9879\u76EE",\u8F93\u914D\u7535\u5185\u914D:"\u8F93\u914D\u7535\u5185\u914D",\u897F\u95E8\u5B50:"\u897F\u95E8\u5B50\u9879\u76EE",\u540C\u4E1A:"\u540C\u4E1A\u9879\u76EE",\u7528\u6237:"\u7528\u6237\u9879\u76EE",\u5176\u5B83:"\u5176\u5B83\u9879\u76EE",\u4E00\u5305:"\u4E00\u5305\u9879\u76EE",\u4E8C\u5305:"\u4E8C\u5305\u9879\u76EE",\u57DF\u5185\u5408\u4F5C:"\u57DF\u5185\u5408\u4F5C\u9879\u76EE",\u57DF\u5916\u5408\u4F5C:"\u57DF\u5916\u5408\u4F5C\u9879\u76EE"}[t.customerType],S=E.find(K=>K.customer===h);S&&(r=parseFloat(S.monthlyRevenue)||0)}}}}catch(s){console.log(`\u83B7\u53D6\u4E3B\u8425\u4E1A\u52A1\u6536\u5165\u6570\u636E\u5931\u8D25 ${u}:`,s)}try{const s=await fetch(`http://47.111.95.19:3000/main-business-cost/${u}`);if(s.ok){const g=await s.json();if(g.success&&g.data){const M={\u8BBE\u5907:"equipment",\u5143\u4EF6:"component",\u5DE5\u7A0B:"project"},E=g.data[M[o]];if(E&&Array.isArray(E)){const m=E.find(h=>h.customerType===t.customerType);if(m){const h=parseFloat(m.currentMaterialCost)||0,S=parseFloat(m.currentLaborCost)||0;a=h+S}}}}}catch(s){console.log(`\u83B7\u53D6\u4E3B\u8425\u4E1A\u52A1\u6210\u672C\u6570\u636E\u5931\u8D25 ${u}:`,s)}try{const s=await fetch(`http://47.111.95.19:3000/cost-center-structure/${u}`);if(s.ok){const g=await s.json();if(g.success&&g.data){const M={\u8BBE\u5907:"equipment",\u5143\u4EF6:"component",\u5DE5\u7A0B:"project"},E=g.data[M[o]];if(E&&Array.isArray(E)){const m=E.find(h=>h.customerType===t.customerType);m&&(n=parseFloat(m.actual)||0)}}}}catch(s){console.log(`\u83B7\u53D6\u6210\u672C\u4E2D\u5FC3\u7ED3\u6784\u6570\u636E\u5931\u8D25 ${u}:`,s)}const l=r-a-n;return console.log(`${u} ${o} ${t.customerType}:`,{mainBusinessIncome:r,mainBusinessCost:a,costCenterActual:n,netProfit:l}),l}catch(r){return console.error("\u8BA1\u7B97\u5F53\u6708\u51C0\u5229\u6DA6\u5931\u8D25:",r),0}},$=async t=>{try{const[o]=p.value.split("-"),u=parseInt(p.value.split("-")[1]);let r=0;const a=G(t);for(let l=1;l<=u;l++){const s=`${o}-${l.toString().padStart(2,"0")}`;r+=await O(t,a,s)}const n=await O(t,a,p.value);t.currentMonthValue=n.toFixed(2),t.actual=r.toFixed(2)}catch(o){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",o),t.currentMonthValue="0",t.actual="0"}},G=t=>d.value.includes(t)?"\u8BBE\u5907":i.value.includes(t)?"\u5143\u4EF6":y.value.includes(t)?"\u5DE5\u7A0B":"\u8BBE\u5907",V=X(()=>{let t=0,o=0,u=0;d.value.forEach(a=>{var n,l,s;t+=parseFloat((n=a.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((l=a.currentMonthValue)==null?void 0:l.replace(/,/g,""))||0,u+=parseFloat((s=a.actual)==null?void 0:s.replace(/,/g,""))||0}),i.value.forEach(a=>{var n,l,s;t+=parseFloat((n=a.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((l=a.currentMonthValue)==null?void 0:l.replace(/,/g,""))||0,u+=parseFloat((s=a.actual)==null?void 0:s.replace(/,/g,""))||0}),y.value.forEach(a=>{var n,l,s;t+=parseFloat((n=a.plan)==null?void 0:n.replace(/,/g,""))||0,o+=parseFloat((l=a.currentMonthValue)==null?void 0:l.replace(/,/g,""))||0,u+=parseFloat((s=a.actual)==null?void 0:s.replace(/,/g,""))||0});let r="0.00%";return t!==0&&(r=`${(u/t*100).toFixed(2)}%`),{plan:t,currentMonthValue:o,actual:u,contribution:r}}),_=(t,o,u)=>t.map(r=>{var n;const a=o==null?void 0:o.find(l=>l.segment===u&&l.customerType===r.customerType);return a?{customerType:r.customerType,plan:((n=a.yearlyPlan)==null?void 0:n.toString())||"0",currentMonthValue:"0",actual:"0",contribution:"0.00%",yearlyPlan:a.yearlyPlan||0}:r}),T=async t=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u6570\u636E\uFF0C\u671F\u95F4: ${t}`);const o=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${t}`);let u=[];if(o.ok){const r=await o.json();console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data&&Array.isArray(r.data)&&(u=r.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else o.status===404?(console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4F7F\u7528\u521D\u59CB\u6A21\u677F"),d.value=x(),i.value=C(),y.value=A()):console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");d.value=_(x(),u,"\u8BBE\u5907"),i.value=_(C(),u,"\u5143\u4EF6"),y.value=_(A(),u,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:d.value,componentData:i.value,projectData:y.value}),await J()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),d.value=_(x(),[],"\u8BBE\u5907"),i.value=_(C(),[],"\u5143\u4EF6"),y.value=_(A(),[],"\u5DE5\u7A0B")}},J=async()=>{for(const t of d.value)await $(t);for(const t of i.value)await $(t);for(const t of y.value)await $(t)};L(()=>w.query.period,t=>{t&&(p.value=t.toString(),T(t.toString()),N())}),L(p,t=>{T(t),N()});const z=async()=>{try{const t=[...d.value.map(a=>({...a,segment:"\u8BBE\u5907"})),...i.value.map(a=>({...a,segment:"\u5143\u4EF6"})),...y.value.map(a=>({...a,segment:"\u5DE5\u7A0B"}))],o={period:p.value,data:t};console.log("\u4FDD\u5B58\u6570\u636E:",o);const u=await fetch("http://47.111.95.19:3000/main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!u.ok){const a=await u.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${u.status} - ${a}`)}const r={equipment:d.value,component:i.value,project:y.value};await ou(q.MAIN_BUSINESS_NET_PROFIT,p.value,r,f.value,B.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25: "+(t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"))}},H=()=>{d.value=x(),i.value=C(),y.value=A(),f.value="",B.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},N=async()=>{const{remarks:t,suggestions:o}=await au(q.MAIN_BUSINESS_NET_PROFIT,p.value);f.value=t,B.value=o};return Y(()=>{console.log("\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",p.value),w.query.period?T(w.query.period.toString()):T(p.value),N()}),(t,o)=>(F(),b("div",ru,[e("div",su,[o[3]||(o[3]=e("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),e("div",nu,[k(e("input",{"onUpdate:modelValue":o[0]||(o[0]=u=>p.value=u),type:"month",class:"px-3 py-2 border rounded"},null,512),[[I,p.value]])])]),e("div",lu,[e("table",cu,[o[5]||(o[5]=e("thead",{class:"sticky top-0 bg-white"},[e("tr",{class:"bg-gray-50"},[e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u677F\u5757"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5E74\u5EA6\u8BA1\u5212"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u6708\u503C"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u7D2F\u8BA1\u503C"),e("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4")])],-1)),e("tbody",null,[(F(!0),b(j,null,R(d.value,(u,r)=>{var a;return F(),b("tr",{key:`equipment-${r}`},[r===0?(F(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u8BBE\u5907 ",8,pu)):U("",!0),e("td",du,c(u.customerType),1),e("td",iu,[k(e("input",{"onUpdate:modelValue":n=>u.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,yu),[[I,u.plan]])]),e("td",gu,[e("span",Eu,c(D(parseFloat((a=u.currentMonthValue)==null?void 0:a.replace(/,/g,""))||0)),1)]),e("td",bu,[e("span",Fu,c(u.actual),1)]),e("td",mu,c(u.contribution),1)])}),128)),(F(!0),b(j,null,R(i.value,(u,r)=>{var a;return F(),b("tr",{key:`component-${r}`},[r===0?(F(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:i.value.length}," \u5143\u4EF6 ",8,hu)):U("",!0),e("td",Du,c(u.customerType),1),e("td",_u,[k(e("input",{"onUpdate:modelValue":n=>u.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,vu),[[I,u.plan]])]),e("td",fu,[e("span",Bu,c(D(parseFloat((a=u.currentMonthValue)==null?void 0:a.replace(/,/g,""))||0)),1)]),e("td",xu,[e("span",Cu,c(u.actual),1)]),e("td",Au,c(u.contribution),1)])}),128)),(F(!0),b(j,null,R(y.value,(u,r)=>{var a;return F(),b("tr",{key:`project-${r}`},[r===0?(F(),b("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:y.value.length}," \u5DE5\u7A0B ",8,Mu)):U("",!0),e("td",wu,c(u.customerType),1),e("td",Vu,[k(e("input",{"onUpdate:modelValue":n=>u.plan=n,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Tu),[[I,u.plan]])]),e("td",Su,[e("span",ku,c(D(parseFloat((a=u.currentMonthValue)==null?void 0:a.replace(/,/g,""))||0)),1)]),e("td",Iu,[e("span",$u,c(u.actual),1)]),e("td",Nu,c(u.contribution),1)])}),128)),e("tr",ju,[o[4]||(o[4]=e("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),e("td",Ru,c(D(V.value.plan)),1),e("td",Uu,c(D(V.value.currentMonthValue)),1),e("td",qu,c(D(V.value.actual)),1),e("td",Ou,c(V.value.contribution),1)])])])]),e("div",{class:"mt-4 flex justify-end space-x-4"},[e("button",{onClick:z,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),e("button",{onClick:H,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),Z(eu,{"module-id":uu(q).MAIN_BUSINESS_NET_PROFIT,period:p.value,remarks:f.value,"onUpdate:remarks":o[1]||(o[1]=u=>f.value=u),suggestions:B.value,"onUpdate:suggestions":o[2]||(o[2]=u=>B.value=u)},null,8,["module-id","period","remarks","suggestions"])]))}});var zu=Q(Pu,[["__scopeId","data-v-af195a32"]]);export{zu as default};
