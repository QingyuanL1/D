import{_ as T,d as U,r as p,c as R,B as P,o as V,b as f,e as t,y as C,A as k,F as j,g as L,t as c,k as q,h as G,G as J,v as E}from"./index.0a104486.js";import{_ as z,r as H,M as h,l as K}from"./FormAttachmentAndRemarks.c9683b81.js";const Q={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},W={class:"flex justify-between items-center mb-6"},X={class:"flex items-center space-x-4"},Y={class:"overflow-x-auto my-6"},Z={class:"w-full border-collapse border border-gray-300"},ee={class:"border border-gray-300 px-4 py-2 text-center"},ue={class:"border border-gray-300 px-4 py-2"},re={class:"border border-gray-300 px-4 py-2"},te={class:"w-full px-2 py-1"},ae={class:"border border-gray-300 px-4 py-2"},oe=["onUpdate:modelValue","onInput"],se={class:"border border-gray-300 px-4 py-2"},ne={class:"w-full px-2 py-1"},le={class:"border border-gray-300 px-4 py-2"},ce={class:"w-full px-2 py-1"},de={class:"bg-gray-50 font-bold"},ie={class:"border border-gray-300 px-4 py-2"},pe={class:"border border-gray-300 px-4 py-2"},ge={class:"border border-gray-300 px-4 py-2"},ye={class:"border border-gray-300 px-4 py-2"},Fe=U({__name:"NonMainBusinessNetProfit",setup(me){var w;const x=J(),n=p(((w=x.query.period)==null?void 0:w.toString())||new Date().toISOString().slice(0,7)),g=p(""),y=p(""),A=p([]),_=()=>[{id:1,name:"\u56FA\u5E9F\u6536\u5165",plan:"0",currentPeriod:"0",accumulated:"0",progress:"0.00%"},{id:2,name:"\u623F\u5C4B\u79DF\u91D1",plan:"0",currentPeriod:"0",accumulated:"0",progress:"0.00%"},{id:3,name:"\u5229\u606F\u6536\u5165",plan:"0",currentPeriod:"0",accumulated:"0",progress:"0.00%"},{id:4,name:"\u6295\u8D44\u6536\u76CA",plan:"0",currentPeriod:"0",accumulated:"0",progress:"0.00%"},{id:5,name:"\u8865\u8D34\u6536\u5165",plan:"0",currentPeriod:"0",accumulated:"0",progress:"0.00%"},{id:6,name:"\u5176\u4ED6",plan:"0",currentPeriod:"0",accumulated:"0",progress:"0.00%"}],s=p(_()),b=e=>e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),B=async e=>{try{const[u,r]=e.split("-"),a=parseInt(r),o=[];for(let l=1;l<=a;l++){const i=`${u}-${l.toString().padStart(2,"0")}`;try{const d=await fetch(`http://47.111.95.19:3000/non-main-business-net-profit/${i}`);if(d.ok){const v=await d.json();v.data&&Array.isArray(v.data)&&o.push({period:i,data:v.data})}}catch(d){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${i}:`,d)}}A.value=o,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",o)}catch(u){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",u)}},I=(e,u)=>{let r=0;const a=n.value;for(const l of A.value){if(l.period===a)continue;const i=l.data.find(d=>d.id===e||d.name===u);i&&i.currentPeriod&&(r+=parseFloat(i.currentPeriod.toString().replace(/,/g,""))||0)}const o=s.value.find(l=>l.id===e);return o&&o.currentPeriod&&(r+=parseFloat(o.currentPeriod.toString().replace(/,/g,""))||0),r.toFixed(2)},F=()=>{s.value.forEach(e=>{e.accumulated=I(e.id,e.name)})},S=e=>{F();const u=parseFloat(s.value[e].plan.replace(/,/g,"")),r=parseFloat(s.value[e].accumulated.replace(/,/g,""));if(!isNaN(u)&&!isNaN(r)&&u!==0){const a=(r/u*100).toFixed(2);s.value[e].progress=`${a}%`}else r>0,s.value[e].progress="0.00%"},m=R(()=>{let e=0,u=0,r=0;s.value.forEach(o=>{e+=parseFloat(o.plan.replace(/,/g,""))||0,u+=parseFloat(o.currentPeriod.replace(/,/g,""))||0,r+=parseFloat(o.accumulated.replace(/,/g,""))||0});let a="0.00%";return e!==0&&(a=`${(r/e*100).toFixed(2)}%`),{plan:e,currentPeriod:u,accumulated:r,progress:a}}),$=(e,u)=>!Array.isArray(u)||u.length===0?e:e.map(r=>{const a=u.find(o=>o.id===r.id||o.name===r.name);return a?{id:r.id,name:r.name,plan:a.yearlyPlan?a.yearlyPlan.toString():a.plan||"0",currentPeriod:a.currentPeriod?a.currentPeriod.toString():a.actual||"0",accumulated:a.accumulated?a.accumulated.toString():"0",progress:a.progress||"0.00%"}:r}),D=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u975E\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const u=await fetch(`http://47.111.95.19:3000/non-main-business-net-profit/${e}`);if(!u.ok){if(u.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u5E74\u5EA6\u8BA1\u5212\u4F46\u6E05\u7A7A\u5F53\u671F\u503C"),s.value=s.value.map(a=>({...a,currentPeriod:"0",accumulated:"0",progress:"0.00%"})),await B(e),F();return}throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25")}const r=await u.json();console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data&&Array.isArray(r.data)&&(console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."),s.value=$(_(),r.data),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",s.value)),await B(e),F(),s.value.forEach((a,o)=>{S(o)})}catch(u){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",u)}};P(()=>x.query.period,e=>{e&&(n.value=e.toString(),D(e.toString()))}),P(n,(e,u)=>{e&&e!==u&&(console.log(`\u671F\u95F4\u53D1\u751F\u53D8\u5316: ${u} -> ${e}`),D(e),N())});const M=async()=>{try{F();const e={period:n.value,data:s.value};console.log("\u4FDD\u5B58\u6570\u636E:",e);const u=await fetch("http://47.111.95.19:3000/non-main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!u.ok){const r=await u.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${u.status} - ${r}`)}await H(h.NON_MAIN_BUSINESS_NET_PROFIT,n.value,s.value,g.value,y.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},O=()=>{s.value=_(),console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},N=async()=>{const{remarks:e,suggestions:u}=await K(h.NON_MAIN_BUSINESS_NET_PROFIT,n.value);g.value=e,y.value=u};return V(()=>{console.log("\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",n.value),D(n.value),N()}),(e,u)=>(E(),f("div",Q,[t("div",W,[u[3]||(u[3]=t("h1",{class:"text-2xl font-bold"},"\u975E\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),t("div",X,[C(t("input",{"onUpdate:modelValue":u[0]||(u[0]=r=>n.value=r),type:"month",class:"px-3 py-2 border rounded"},null,512),[[k,n.value]])])]),t("div",Y,[t("table",Z,[u[5]||(u[5]=t("thead",{class:"sticky top-0 bg-white"},[t("tr",{class:"bg-gray-50"},[t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E8F\u53F7"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u8D22\u52A1\u79D1\u76EE"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u5EA6\u8BA1\u5212"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1"),t("th",{class:"border border-gray-300 px-4 py-2"},"\u6267\u884C\u8FDB\u5EA6")])],-1)),t("tbody",null,[(E(!0),f(j,null,L(s.value,(r,a)=>(E(),f("tr",{key:a},[t("td",ee,c(r.id),1),t("td",ue,c(r.name),1),t("td",re,[t("span",te,c(r.plan),1)]),t("td",ae,[C(t("input",{"onUpdate:modelValue":o=>r.currentPeriod=o,type:"text",class:"w-full px-2 py-1 border rounded",onInput:o=>S(a)},null,40,oe),[[k,r.currentPeriod]])]),t("td",se,[t("span",ne,c(r.accumulated),1)]),t("td",le,[t("span",ce,c(r.progress),1)])]))),128)),t("tr",de,[u[4]||(u[4]=t("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),t("td",ie,c(b(m.value.plan)),1),t("td",pe,c(b(m.value.currentPeriod)),1),t("td",ge,c(b(m.value.accumulated)),1),t("td",ye,c(m.value.progress),1)])])])]),t("div",{class:"mt-4 flex justify-end space-x-4"},[t("button",{onClick:M,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),t("button",{onClick:O,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),q(z,{"module-id":G(h).NON_MAIN_BUSINESS_NET_PROFIT,period:n.value,remarks:g.value,"onUpdate:remarks":u[1]||(u[1]=r=>g.value=r),suggestions:y.value,"onUpdate:suggestions":u[2]||(u[2]=r=>y.value=r)},null,8,["module-id","period","remarks","suggestions"])]))}});var De=T(Fe,[["__scopeId","data-v-9dbe1fae"]]);export{De as default};
