import{_ as z,d as H,r as F,c as K,B as R,o as Q,b as i,e as u,y as b,A as g,F as N,g as U,t as p,k as W,h as X,G as Y,v as y,f as $}from"./index.e1fb695f.js";import{_ as Z,r as ee,M as P,l as te}from"./FormAttachmentAndRemarks.83d7d95e.js";const ue={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},ae={class:"flex justify-between items-center mb-6"},oe={class:"flex items-center space-x-4"},re={class:"overflow-x-auto my-6"},ne={class:"w-full border-collapse border border-gray-300"},se=["rowspan"],le={class:"border border-gray-300 px-4 py-2"},ce={class:"border border-gray-300 px-4 py-2"},pe=["onUpdate:modelValue"],de={class:"border border-gray-300 px-4 py-2"},ie=["onUpdate:modelValue","onInput"],ye={class:"border border-gray-300 px-4 py-2"},be={class:"font-medium"},ge={class:"border border-gray-300 px-4 py-2"},he=["rowspan"],_e={class:"border border-gray-300 px-4 py-2"},Fe={class:"border border-gray-300 px-4 py-2"},ve=["onUpdate:modelValue"],me={class:"border border-gray-300 px-4 py-2"},De=["onUpdate:modelValue","onInput"],Ee={class:"border border-gray-300 px-4 py-2"},fe={class:"font-medium"},xe={class:"border border-gray-300 px-4 py-2"},Be=["rowspan"],Ve={class:"border border-gray-300 px-4 py-2"},we={class:"border border-gray-300 px-4 py-2"},Ae=["onUpdate:modelValue"],Me={class:"border border-gray-300 px-4 py-2"},Ce=["onUpdate:modelValue","onInput"],Te={class:"border border-gray-300 px-4 py-2"},Se={class:"font-medium"},ke={class:"border border-gray-300 px-4 py-2"},Ie={class:"bg-gray-50 font-bold"},Ne={class:"border border-gray-300 px-4 py-2"},Ue={class:"border border-gray-300 px-4 py-2"},$e={class:"border border-gray-300 px-4 py-2"},Pe={class:"border border-gray-300 px-4 py-2"},je=H({__name:"MainBusinessNetProfit",setup(qe){var j;const E=Y(),d=F(((j=E.query.period)==null?void 0:j.toString())||new Date().toISOString().slice(0,7)),v=F(""),m=F(""),f=()=>[{customerType:"\u4E0A\u6D77",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u56FD\u7F51",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u6C5F\u82CF",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u8F93\u914D\u7535\u5185\u914D",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u897F\u95E8\u5B50",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u540C\u4E1A",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],x=()=>[{customerType:"\u7528\u6237",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],B=()=>[{customerType:"\u4E00\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u4E8C\u5305",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5185\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u57DF\u5916\u5408\u4F5C",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"},{customerType:"\u5176\u5B83",plan:"0",currentMonthValue:"0",actual:"0",contribution:"0.00%"}],n=F(f()),s=F(x()),l=F(B()),C=t=>t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),T=async t=>{await V(t);const o=parseFloat(t.plan.replace(/,/g,"")),e=parseFloat(t.actual.replace(/,/g,""));if(!isNaN(o)&&!isNaN(e)&&o!==0){const r=(e/o*100).toFixed(2);t.contribution=`${r}%`}else t.contribution="0.00%"},V=async t=>{var o,e;try{const[r]=d.value.split("-");let a=0;const c=O(t);for(let _=1;_<=12;_++){const k=`${r}-${_.toString().padStart(2,"0")}`;if(k===d.value)a+=parseFloat((o=t.currentMonthValue)==null?void 0:o.replace(/,/g,""))||0;else try{const D=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${k}`);if(D.ok){const M=await D.json();if(M.success&&M.data&&Array.isArray(M.data)){const q=M.data.find(I=>I.segment===c&&I.customerType===t.customerType);q&&(a+=parseFloat((e=q.currentMonthValue)==null?void 0:e.replace(/,/g,""))||0)}}}catch(D){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${k} \u7684\u6570\u636E\u8BA1\u7B97:`,D)}}t.actual=a.toFixed(2)}catch(r){console.error("\u8BA1\u7B97\u7D2F\u8BA1\u503C\u5931\u8D25:",r),t.actual=t.currentMonthValue||"0"}},O=t=>n.value.includes(t)?"\u8BBE\u5907":s.value.includes(t)?"\u5143\u4EF6":l.value.includes(t)?"\u5DE5\u7A0B":"\u8BBE\u5907",w=K(()=>{let t=0,o=0,e=0;n.value.forEach(a=>{var c;t+=parseFloat(a.plan.replace(/,/g,""))||0,o+=parseFloat((c=a.currentMonthValue)==null?void 0:c.replace(/,/g,""))||0,e+=parseFloat(a.actual.replace(/,/g,""))||0}),s.value.forEach(a=>{var c;t+=parseFloat(a.plan.replace(/,/g,""))||0,o+=parseFloat((c=a.currentMonthValue)==null?void 0:c.replace(/,/g,""))||0,e+=parseFloat(a.actual.replace(/,/g,""))||0}),l.value.forEach(a=>{var c;t+=parseFloat(a.plan.replace(/,/g,""))||0,o+=parseFloat((c=a.currentMonthValue)==null?void 0:c.replace(/,/g,""))||0,e+=parseFloat(a.actual.replace(/,/g,""))||0});let r="0.00%";return t!==0&&(r=`${(e/t*100).toFixed(2)}%`),{plan:t,currentMonthValue:o,actual:e,contribution:r}}),h=(t,o,e)=>t.map(r=>{var c;const a=o==null?void 0:o.find(_=>_.segment===e&&_.customerType===r.customerType);return a?{customerType:r.customerType,plan:((c=a.yearlyPlan)==null?void 0:c.toString())||"0",currentMonthValue:a.currentMonthValue||"0",actual:a.actual||"0",contribution:a.contribution||"0.00%",yearlyPlan:a.yearlyPlan||0}:r}),A=async t=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u6570\u636E\uFF0C\u671F\u95F4: ${t}`);const o=await fetch(`http://47.111.95.19:3000/main-business-net-profit/${t}`);let e=[];if(o.ok){const r=await o.json();console.log("API\u8FD4\u56DE\u6570\u636E:",r),r.success&&r.data&&Array.isArray(r.data)&&(e=r.data,console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76..."))}else if(o.status===404){console.log("\u8BE5\u671F\u95F4\u6682\u65E0\u6570\u636E\uFF0C\u4FDD\u6301\u5E74\u5EA6\u8BA1\u5212\u4F46\u6E05\u7A7A\u5F53\u671F\u7D2F\u8BA1"),n.value=n.value.map(r=>({...r,actual:"0",progress:"0.00%"})),s.value=s.value.map(r=>({...r,actual:"0",progress:"0.00%"})),l.value=l.value.map(r=>({...r,actual:"0",progress:"0.00%"}));return}else console.log("\u52A0\u8F7D\u6570\u636E\u5931\u8D25\uFF0C\u4F7F\u7528\u9884\u7B97\u6570\u636E\u586B\u5145");n.value=h(f(),e,"\u8BBE\u5907"),s.value=h(x(),e,"\u5143\u4EF6"),l.value=h(B(),e,"\u5DE5\u7A0B"),console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:n.value,componentData:s.value,projectData:l.value}),await L()}catch(o){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",o),n.value=h(f(),[],"\u8BBE\u5907"),s.value=h(x(),[],"\u5143\u4EF6"),l.value=h(B(),[],"\u5DE5\u7A0B")}},L=async()=>{for(const t of n.value)await V(t);for(const t of s.value)await V(t);for(const t of l.value)await V(t)};R(()=>E.query.period,t=>{t&&(d.value=t.toString(),A(t.toString()),S())}),R(d,t=>{A(t),S()});const G=async()=>{try{const t=[...n.value.map(a=>({...a,segment:"\u8BBE\u5907"})),...s.value.map(a=>({...a,segment:"\u5143\u4EF6"})),...l.value.map(a=>({...a,segment:"\u5DE5\u7A0B"}))],o={period:d.value,data:t};console.log("\u4FDD\u5B58\u6570\u636E:",o);const e=await fetch("http://47.111.95.19:3000/main-business-net-profit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok){const a=await e.text();throw new Error(`\u4FDD\u5B58\u5931\u8D25: ${e.status} - ${a}`)}const r={equipment:n.value,component:s.value,project:l.value};await ee(P.MAIN_BUSINESS_NET_PROFIT,d.value,r,v.value,m.value),alert("\u4FDD\u5B58\u6210\u529F")}catch(t){console.error("\u4FDD\u5B58\u5931\u8D25:",t),alert("\u4FDD\u5B58\u5931\u8D25: "+(t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"))}},J=()=>{n.value=f(),s.value=x(),l.value=B(),v.value="",m.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")},S=async()=>{const{remarks:t,suggestions:o}=await te(P.MAIN_BUSINESS_NET_PROFIT,d.value);v.value=t,m.value=o};return Q(()=>{console.log("\u4E3B\u8425\u51C0\u5229\u6DA6\u8D21\u732E\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",d.value),E.query.period?A(E.query.period.toString()):A(d.value),S()}),(t,o)=>(y(),i("div",ue,[u("div",ae,[o[3]||(o[3]=u("h1",{class:"text-2xl font-bold"},"\u4E3B\u8425\u4E1A\u52A1\u51C0\u5229\u6DA6\u8D21\u732E\u60C5\u51B5",-1)),u("div",oe,[b(u("input",{"onUpdate:modelValue":o[0]||(o[0]=e=>d.value=e),type:"month",class:"px-3 py-2 border rounded"},null,512),[[g,d.value]])])]),u("div",re,[u("table",ne,[o[5]||(o[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5E74\u5EA6\u8BA1\u5212"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5F53\u6708\u503C"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u7D2F\u8BA1\u503C"),u("th",{class:"border border-gray-300 px-4 py-2",rowspan:"2"},"\u5206\u7C7B\u8D21\u732E\u5360\u6BD4")])],-1)),u("tbody",null,[(y(!0),i(N,null,U(n.value,(e,r)=>(y(),i("tr",{key:`equipment-${r}`},[r===0?(y(),i("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:n.value.length}," \u8BBE\u5907 ",8,se)):$("",!0),u("td",le,p(e.customerType),1),u("td",ce,[b(u("input",{"onUpdate:modelValue":a=>e.plan=a,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,pe),[[g,e.plan]])]),u("td",de,[b(u("input",{"onUpdate:modelValue":a=>e.currentMonthValue=a,type:"text",class:"w-full px-2 py-1 border rounded",onInput:a=>T(e)},null,40,ie),[[g,e.currentMonthValue]])]),u("td",ye,[u("span",be,p(e.actual),1)]),u("td",ge,p(e.contribution),1)]))),128)),(y(!0),i(N,null,U(s.value,(e,r)=>(y(),i("tr",{key:`component-${r}`},[r===0?(y(),i("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:s.value.length}," \u5143\u4EF6 ",8,he)):$("",!0),u("td",_e,p(e.customerType),1),u("td",Fe,[b(u("input",{"onUpdate:modelValue":a=>e.plan=a,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,ve),[[g,e.plan]])]),u("td",me,[b(u("input",{"onUpdate:modelValue":a=>e.currentMonthValue=a,type:"text",class:"w-full px-2 py-1 border rounded",onInput:a=>T(e)},null,40,De),[[g,e.currentMonthValue]])]),u("td",Ee,[u("span",fe,p(e.actual),1)]),u("td",xe,p(e.contribution),1)]))),128)),(y(!0),i(N,null,U(l.value,(e,r)=>(y(),i("tr",{key:`project-${r}`},[r===0?(y(),i("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:l.value.length}," \u5DE5\u7A0B ",8,Be)):$("",!0),u("td",Ve,p(e.customerType),1),u("td",we,[b(u("input",{"onUpdate:modelValue":a=>e.plan=a,type:"text",class:"w-full px-2 py-1 border rounded bg-gray-100",readonly:""},null,8,Ae),[[g,e.plan]])]),u("td",Me,[b(u("input",{"onUpdate:modelValue":a=>e.currentMonthValue=a,type:"text",class:"w-full px-2 py-1 border rounded",onInput:a=>T(e)},null,40,Ce),[[g,e.currentMonthValue]])]),u("td",Te,[u("span",Se,p(e.actual),1)]),u("td",ke,p(e.contribution),1)]))),128)),u("tr",Ie,[o[4]||(o[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",Ne,p(C(w.value.plan)),1),u("td",Ue,p(C(w.value.currentMonthValue)),1),u("td",$e,p(C(w.value.actual)),1),u("td",Pe,p(w.value.contribution),1)])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:G,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:J,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),W(Z,{"module-id":X(P).MAIN_BUSINESS_NET_PROFIT,period:d.value,remarks:v.value,"onUpdate:remarks":o[1]||(o[1]=e=>v.value=e),suggestions:m.value,"onUpdate:suggestions":o[2]||(o[2]=e=>m.value=e)},null,8,["module-id","period","remarks","suggestions"])]))}});var Le=z(je,[["__scopeId","data-v-8327def2"]]);export{Le as default};
