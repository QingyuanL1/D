import{_ as M,d as L,r as m,c as Y,B as E,o as z,b as y,e as u,y as F,A as _,F as k,g as $,t as a,k as G,h as J,G as H,v as b,f as N}from"./index.14f46279.js";import{_ as K,l as Q,M as T,r as W}from"./FormAttachmentAndRemarks.7bbbc46d.js";const X={class:"max-w-[1500px] mx-auto bg-white rounded-lg shadow-lg p-6"},Z={class:"flex justify-between items-center mb-6"},ee={class:"flex items-center space-x-4"},oe={class:"overflow-x-auto my-6"},te={class:"w-full border-collapse border border-gray-300"},re=["rowspan"],ue={class:"border border-gray-300 px-4 py-2"},ne={class:"border border-gray-300 px-4 py-2 text-right"},ae={class:"border border-gray-300 px-4 py-2"},se=["onUpdate:modelValue"],ie={class:"border border-gray-300 px-4 py-2 text-right"},le={class:"font-medium"},de={class:"border border-gray-300 px-4 py-2 text-right"},ce={class:"font-medium"},pe={class:"border border-gray-300 px-4 py-2"},ye=["onUpdate:modelValue"],be=["rowspan"],ve={class:"border border-gray-300 px-4 py-2"},ge={class:"border border-gray-300 px-4 py-2 text-right"},me={class:"border border-gray-300 px-4 py-2"},Fe=["onUpdate:modelValue"],_e={class:"border border-gray-300 px-4 py-2 text-right"},he={class:"font-medium"},Be={class:"border border-gray-300 px-4 py-2 text-right"},De={class:"font-medium"},Ae={class:"border border-gray-300 px-4 py-2"},xe=["onUpdate:modelValue"],Ee=["rowspan"],Te={class:"border border-gray-300 px-4 py-2"},fe={class:"border border-gray-300 px-4 py-2 text-right"},we={class:"border border-gray-300 px-4 py-2"},Ce=["onUpdate:modelValue"],Pe={class:"border border-gray-300 px-4 py-2 text-right"},Re={class:"font-medium"},Se={class:"border border-gray-300 px-4 py-2 text-right"},ke={class:"font-medium"},$e={class:"border border-gray-300 px-4 py-2"},Ne=["onUpdate:modelValue"],je={class:"bg-gray-50 font-bold"},qe={class:"border border-gray-300 px-4 py-2 text-right"},Ve={class:"border border-gray-300 px-4 py-2 text-right"},Ue={class:"border border-gray-300 px-4 py-2 text-right"},Ie={class:"border border-gray-300 px-4 py-2 text-right"},Oe={class:"border border-gray-300 px-4 py-2 text-right"},Me=L({__name:"CostEstimation",setup(Le){var V;const A=H(),i=m(((V=A.query.period)==null?void 0:V.toString())||new Date().toISOString().slice(0,7)),h=m(""),B=m(""),j=()=>({equipment:[{customerType:"\u4E0A\u6D77",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u56FD\u7F51",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u6C5F\u82CF",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u8F93\u914D\u7535\u5185\u914D",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u897F\u95E8\u5B50",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u540C\u4E1A",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u7528\u6237",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u5176\u5B83",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0}],component:[{customerType:"\u7528\u6237",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0}],project:[{customerType:"\u4E00\u5305",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u4E8C\u5305",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u57DF\u5185\u5408\u4F5C",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u57DF\u5916\u5408\u4F5C",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0},{customerType:"\u5176\u5B83",initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,provisionRate:0}]}),U=(e,t)=>(!t||typeof t!="object"||(t.equipment&&Array.isArray(t.equipment)&&(e.equipment=e.equipment.map(o=>{const n=t.equipment.find(r=>r.customerType===o.customerType);return n?{...o,initialBalance:Number(n.initialBalance)||0,currentPeriod:Number(n.currentPeriod)||0,newAddition:0,yearTotal:0,provisionRate:Number(n.provisionRate)||0}:o})),t.component&&Array.isArray(t.component)&&(e.component=e.component.map(o=>{const n=t.component.find(r=>r.customerType===o.customerType);return n?{...o,initialBalance:Number(n.initialBalance)||0,currentPeriod:Number(n.currentPeriod)||0,newAddition:0,yearTotal:0,provisionRate:Number(n.provisionRate)||0}:o})),t.project&&Array.isArray(t.project)&&(e.project=e.project.map(o=>{const n=t.project.find(r=>r.customerType===o.customerType);return n?{...o,initialBalance:Number(n.initialBalance)||0,currentPeriod:Number(n.currentPeriod)||0,newAddition:0,yearTotal:0,provisionRate:Number(n.provisionRate)||0}:o}))),e),f=()=>{const e=j();d.value=e.equipment,c.value=e.component,p.value=e.project},d=m([]),c=m([]),p=m([]),w=m([]),q=async e=>{try{const t=[],o=e.substring(0,4),n=parseInt(e.substring(5,7));for(let r=1;r<n;r++){const l=`${o}-${r.toString().padStart(2,"0")}`;try{const v=await fetch(`http://47.111.95.19:3000/cost-estimation/${l}`);if(v.ok){const g=await v.json();g.success&&g.data&&t.push({period:l,data:g.data})}}catch(v){console.log(`\u8DF3\u8FC7\u6708\u4EFD ${l}:`,v)}}w.value=t,console.log("\u52A0\u8F7D\u7684\u6240\u6709\u6708\u4EFD\u6570\u636E:",t)}catch(t){console.error("\u52A0\u8F7D\u6240\u6709\u6708\u4EFD\u6570\u636E\u5931\u8D25:",t)}},C=(e,t)=>{let o=0;console.log(`\u{1F50D} \u8BA1\u7B97\u7D2F\u8BA1\u65B0\u589E: ${e}-${t}`),console.log(`\u{1F4CA} \u5386\u53F2\u6570\u636E\u6708\u4EFD\u6570\u91CF: ${w.value.length}`);for(const l of w.value)if(l.data[e]){const v=l.data[e].find(g=>g.customerType===t);if(v&&v.currentPeriod){const g=parseFloat(v.currentPeriod.toString())||0;o+=g,console.log(`\u{1F4C5} ${l.period}: ${t} \u5F53\u671F=${g}, \u7D2F\u8BA1=${o}`)}}let n=[];e==="equipment"?n=d.value:e==="component"?n=c.value:e==="project"&&(n=p.value);const r=n.find(l=>l.customerType===t);if(r&&r.currentPeriod){const l=parseFloat(r.currentPeriod.toString())||0;o+=l,console.log(`\u{1F4DD} \u5F53\u524D\u6708\u4EFD: ${t} \u5F53\u671F=${l}, \u6700\u7EC8\u7D2F\u8BA1=${o}`)}return console.log(`\u2705 ${e}-${t} \u7D2F\u8BA1\u65B0\u589E\u8BA1\u7B97\u5B8C\u6210: ${o}`),o},P=()=>{d.value.forEach(e=>{const t=C("equipment",e.customerType);e.newAddition=t,R(e)}),c.value.forEach(e=>{const t=C("component",e.customerType);e.newAddition=t,R(e)}),p.value.forEach(e=>{const t=C("project",e.customerType);e.newAddition=t,R(e)})},R=e=>{e.yearTotal=(e.initialBalance||0)+(e.newAddition||0)},s=e=>isNaN(e)||e===null||e===void 0?"0.00":e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),D=Y(()=>{const e=[...d.value,...c.value,...p.value],t={initialBalance:0,currentPeriod:0,newAddition:0,yearTotal:0,averageProvisionRate:0};let o=0,n=0;return e.forEach(r=>{t.initialBalance+=r.initialBalance||0,t.currentPeriod+=r.currentPeriod||0,t.newAddition+=r.newAddition||0,t.yearTotal+=r.yearTotal||0,r.provisionRate>0&&(o+=r.provisionRate,n++)}),t.averageProvisionRate=n>0?o/n:0,t}),x=async e=>{try{console.log(`\u6B63\u5728\u52A0\u8F7D\u6210\u672C\u6682\u4F30\u6570\u636E\uFF0C\u671F\u95F4: ${e}`);const t=await fetch(`http://47.111.95.19:3000/cost-estimation/${e}`);if(!t.ok){if(t.status!==404)throw new Error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25");console.log("\u672A\u627E\u5230\u6570\u636E\uFF0C\u91CD\u7F6E\u4E3A\u521D\u59CB\u6A21\u677F"),f(),await q(e),P();return}const o=await t.json();if(console.log("API\u8FD4\u56DE\u6570\u636E:",o),o.success&&o.data){console.log("\u6210\u529F\u83B7\u53D6\u6570\u636E\uFF0C\u5F00\u59CB\u5408\u5E76...");const n=j(),r=U(n,o.data);d.value=r.equipment,c.value=r.component,p.value=r.project,console.log("\u5408\u5E76\u540E\u7684\u6570\u636E:",{equipmentData:d.value,componentData:c.value,projectData:p.value})}await q(e),P()}catch(t){console.error("\u52A0\u8F7D\u6570\u636E\u5931\u8D25:",t),f()}},S=async()=>{const{remarks:e,suggestions:t}=await Q(T.COST_ESTIMATION,i.value);h.value=e,B.value=t};E(i,e=>{x(e),S()}),E(()=>A.query.period,e=>{e&&(i.value=e.toString())}),E(()=>[d.value.map(e=>e.currentPeriod),c.value.map(e=>e.currentPeriod),p.value.map(e=>e.currentPeriod)],()=>{P()},{deep:!0}),E(i,e=>{x(e),S()});const I=async()=>{try{console.log("=== \u5F00\u59CB\u4FDD\u5B58\u6210\u672C\u6682\u4F30\u6570\u636E ==="),console.log("\u671F\u95F4:",i.value),console.log("\u6A21\u5757ID:",T.COST_ESTIMATION);const e={equipment:d.value.map(r=>({customerType:r.customerType,initialBalance:r.initialBalance,currentPeriod:r.currentPeriod,newAddition:r.newAddition,yearTotal:r.yearTotal,provisionRate:r.provisionRate})),component:c.value.map(r=>({customerType:r.customerType,initialBalance:r.initialBalance,currentPeriod:r.currentPeriod,newAddition:r.newAddition,yearTotal:r.yearTotal,provisionRate:r.provisionRate})),project:p.value.map(r=>({customerType:r.customerType,initialBalance:r.initialBalance,currentPeriod:r.currentPeriod,newAddition:r.newAddition,yearTotal:r.yearTotal,provisionRate:r.provisionRate}))};console.log("\u8868\u5355\u6570\u636E:",e),console.log("\u6B65\u9AA41\uFF1A\u4FDD\u5B58\u5230\u4E13\u7528\u8868...");const t=await fetch("http://47.111.95.19:3000/cost-estimation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:i.value,data:e})});if(!t.ok){const r=await t.text();throw console.error("\u4E13\u7528\u8868\u4FDD\u5B58\u5931\u8D25\uFF0C\u54CD\u5E94:",r),new Error("\u4FDD\u5B58\u5931\u8D25")}const o=await t.json();console.log("\u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F:",o),console.log("\u6B65\u9AA42\uFF1A\u8BB0\u5F55\u63D0\u4EA4\u72B6\u6001...");const n=await W(T.COST_ESTIMATION,i.value,e,h.value,B.value);console.log("\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u7ED3\u679C:",n),n?(console.log("=== \u4FDD\u5B58\u5B8C\u6210\uFF0C\u6240\u6709\u6B65\u9AA4\u6210\u529F ==="),alert("\u4FDD\u5B58\u6210\u529F")):(console.warn("=== \u4E13\u7528\u8868\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25 ==="),alert("\u4FDD\u5B58\u6210\u529F\uFF0C\u4F46\u63D0\u4EA4\u72B6\u6001\u8BB0\u5F55\u5931\u8D25"))}catch(e){console.error("=== \u4FDD\u5B58\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF ===",e),alert("\u4FDD\u5B58\u5931\u8D25: "+(e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"))}},O=()=>{f(),h.value="",B.value="",console.log("\u5DF2\u91CD\u7F6E\u4E3A\u521D\u59CB\u6570\u636E")};return z(()=>{console.log("\u6210\u672C\u6682\u4F30\u7EC4\u4EF6\u6302\u8F7D\uFF0C\u5F53\u524D\u671F\u95F4:",i.value),A.query.period?x(A.query.period.toString()):x(i.value),S()}),(e,t)=>(b(),y("div",X,[u("div",Z,[t[3]||(t[3]=u("h1",{class:"text-2xl font-bold"},"\u6210\u672C\u6682\u4F30\u5165\u5E93\u548C\u8BA1\u63D0\u60C5\u51B5",-1)),u("div",ee,[F(u("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>i.value=o),type:"month",class:"px-3 py-2 border rounded"},null,512),[[_,i.value]])])]),u("div",oe,[u("table",te,[t[5]||(t[5]=u("thead",{class:"sticky top-0 bg-white"},[u("tr",{class:"bg-gray-50"},[u("th",{class:"border border-gray-300 px-4 py-2"},"\u677F\u5757"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5BA2\u6237\u5C5E\u6027"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5E74\u521D\u4F59\u989D"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u5F53\u671F\u65B0\u589E"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u7D2F\u8BA1\u65B0\u589E"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u672C\u5E74\u7D2F\u8BA1"),u("th",{class:"border border-gray-300 px-4 py-2"},"\u8BA1\u63D0\u7387")])],-1)),u("tbody",null,[(b(!0),y(k,null,$(d.value,(o,n)=>(b(),y("tr",{key:`equipment-${n}`},[n===0?(b(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:d.value.length}," \u8BBE\u5907 ",8,re)):N("",!0),u("td",ue,a(o.customerType),1),u("td",ne,[u("span",null,a(s(o.initialBalance)),1)]),u("td",ae,[F(u("input",{"onUpdate:modelValue":r=>o.currentPeriod=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,se),[[_,o.currentPeriod,void 0,{number:!0}]])]),u("td",ie,[u("span",le,a(s(o.newAddition)),1)]),u("td",de,[u("span",ce,a(s(o.yearTotal)),1)]),u("td",pe,[F(u("input",{"onUpdate:modelValue":r=>o.provisionRate=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",min:"0",max:"100"},null,8,ye),[[_,o.provisionRate,void 0,{number:!0}]])])]))),128)),(b(!0),y(k,null,$(c.value,(o,n)=>(b(),y("tr",{key:`component-${n}`},[n===0?(b(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:c.value.length}," \u5143\u4EF6 ",8,be)):N("",!0),u("td",ve,a(o.customerType),1),u("td",ge,[u("span",null,a(s(o.initialBalance)),1)]),u("td",me,[F(u("input",{"onUpdate:modelValue":r=>o.currentPeriod=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Fe),[[_,o.currentPeriod,void 0,{number:!0}]])]),u("td",_e,[u("span",he,a(s(o.newAddition)),1)]),u("td",Be,[u("span",De,a(s(o.yearTotal)),1)]),u("td",Ae,[F(u("input",{"onUpdate:modelValue":r=>o.provisionRate=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",min:"0",max:"100"},null,8,xe),[[_,o.provisionRate,void 0,{number:!0}]])])]))),128)),(b(!0),y(k,null,$(p.value,(o,n)=>(b(),y("tr",{key:`project-${n}`},[n===0?(b(),y("td",{key:0,class:"border border-gray-300 px-4 py-2 text-center",rowspan:p.value.length}," \u5DE5\u7A0B ",8,Ee)):N("",!0),u("td",Te,a(o.customerType),1),u("td",fe,[u("span",null,a(s(o.initialBalance)),1)]),u("td",we,[F(u("input",{"onUpdate:modelValue":r=>o.currentPeriod=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01"},null,8,Ce),[[_,o.currentPeriod,void 0,{number:!0}]])]),u("td",Pe,[u("span",Re,a(s(o.newAddition)),1)]),u("td",Se,[u("span",ke,a(s(o.yearTotal)),1)]),u("td",$e,[F(u("input",{"onUpdate:modelValue":r=>o.provisionRate=r,type:"number",class:"w-full px-2 py-1 border rounded text-right",step:"0.01",min:"0",max:"100"},null,8,Ne),[[_,o.provisionRate,void 0,{number:!0}]])])]))),128)),u("tr",je,[t[4]||(t[4]=u("td",{class:"border border-gray-300 px-4 py-2 text-center",colspan:"2"},"\u5408\u8BA1",-1)),u("td",qe,a(s(D.value.initialBalance)),1),u("td",Ve,a(s(D.value.currentPeriod)),1),u("td",Ue,a(s(D.value.newAddition)),1),u("td",Ie,a(s(D.value.yearTotal)),1),u("td",Oe,a(s(D.value.averageProvisionRate))+"%",1)])])])]),u("div",{class:"mt-4 flex justify-end space-x-4"},[u("button",{onClick:I,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," \u4FDD\u5B58 "),u("button",{onClick:O,class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"}," \u91CD\u7F6E ")]),G(K,{"module-id":J(T).COST_ESTIMATION,period:i.value,remarks:h.value,"onUpdate:remarks":t[1]||(t[1]=o=>h.value=o),suggestions:B.value,"onUpdate:suggestions":t[2]||(t[2]=o=>B.value=o)},null,8,["module-id","period","remarks","suggestions"])]))}});var Ge=M(Me,[["__scopeId","data-v-0b831abd"]]);export{Ge as default};
