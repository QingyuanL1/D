# 累计值自动计算功能使用说明

## 功能概述

常州拓源利润表现在支持累计值自动计算功能，用户只需要输入当月数据，系统会自动计算并显示累计值。

## 界面说明

### 表格结构
- **项目列**: 显示利润表的各个科目
- **当月列**: 用户输入的当月金额（可编辑）
- **累计列**: 系统自动计算的累计金额（只读显示）

### 按钮功能
- **刷新累计值**: 手动触发累计值重新计算
- **保存**: 保存当月数据，系统会自动计算并保存累计值

## 使用流程

### 1. 输入当月数据
- 在"当月"列的输入框中输入各科目的当月金额
- 系统会清除相应行的计算标记

### 2. 查看累计值
- 切换期间或加载数据时，系统会自动计算累计值
- 累计值以格式化的数字显示在"累计"列
- 自动计算的累计值会以绿色字体显示

### 3. 刷新累计值
- 如需手动更新累计值，点击"刷新累计值"按钮
- 系统会根据当前输入的当月数据重新计算累计值

### 4. 保存数据
- 点击"保存"按钮保存数据
- 系统会在保存前自动计算最新的累计值
- 保存成功后会显示确认消息

## 计算逻辑

### 累计值计算公式
```
累计值 = 当年1月当月值 + 当年2月当月值 + ... + 当前月当月值
```

### 计算规则
- **按年度计算**: 累计值从每年1月开始累计，到12月结束
- **包含当月**: 累计值包含当前月份的当月金额
- **历史数据**: 基于数据库中已保存的历史月份数据进行计算
- **实时更新**: 加载数据或切换期间时自动重新计算

### 计算示例
假设某科目的数据如下：
- 2025年1月当月: 1,000,000 → 累计: 1,000,000
- 2025年2月当月: 1,200,000 → 累计: 2,200,000
- 2025年3月当月: 1,500,000 → 累计: 3,700,000

## 技术特性

### 自动触发场景
1. **页面加载**: 组件挂载时自动计算累计值
2. **期间切换**: 选择不同月份时自动重新计算
3. **数据保存**: 保存前自动计算确保数据准确性

### 错误处理
- 网络错误或计算失败时会显示错误消息
- 错误消息会在5秒后自动消失
- 计算失败不会影响当月数据的输入和保存

### 性能优化
- 使用防抖机制避免频繁计算
- 只在必要时触发重新计算
- 计算状态显示，避免重复操作

## API接口

### 计算累计值
```http
POST /changzhou-tuoyuan-income-statement/calculate-cumulative
Content-Type: application/json

{
  "period": "2025-03",
  "data": {
    "field_name": {
      "current_amount": 1500000,
      "cumulative_amount": null
    }
  }
}
```

### 自动计算保存
```http
POST /changzhou-tuoyuan-income-statement
Content-Type: application/json

{
  "period": "2025-03",
  "data": { /* 数据对象 */ },
  "autoCalculateCumulative": true
}
```

## 测试验证

使用以下命令验证功能：

```bash
# 运行累计值计算测试
cd financial-backend
node scripts/test-cumulative-calculation.js test

# 查看计算逻辑演示
node scripts/test-cumulative-calculation.js demo
```

## 注意事项

1. **数据依赖**: 累计值依赖于历史月份数据，确保前面月份数据已正确保存
2. **年度边界**: 每年1月开始重新累计，不会跨年累加
3. **数据修改**: 如果修改了历史月份数据，建议重新计算后续月份的累计值
4. **网络要求**: 计算功能需要后端API支持，确保网络连接正常 